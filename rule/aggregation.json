{
  "ruleChain": {
    "additionalInfo": {
      "description": ""
    },
    "name": "Aggregation",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": null,
    "nodes": [
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 55,
          "layoutY": 850
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "CustomerL1 Power Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": false,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": "TENANT",
          "rootEntityId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "parentRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 2,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageRaw",
              "targetKey": "TP_TotalPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageHour",
              "targetKey": "TP_TotalPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageDay",
              "targetKey": "TP_TotalPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakRaw",
              "targetKey": "TP_PowerPeakRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakHour",
              "targetKey": "TP_PowerPeakHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakDay",
              "targetKey": "TP_PowerPeakDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkPowerUsageRaw",
              "targetKey": "TP_WorkPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitPowerUsageRaw",
              "targetKey": "TP_WaitPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkPowerUsageHour",
              "targetKey": "TP_WorkPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitPowerUsageHour",
              "targetKey": "TP_WaitPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkPowerUsageDay",
              "targetKey": "TP_WorkPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitPowerUsageDay",
              "targetKey": "TP_WaitPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 60,
          "layoutY": 775
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "Tenant Power Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": true,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": "TENANT",
          "rootEntityId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "parentRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 3,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageRaw",
              "targetKey": "TP_TotalPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageHour",
              "targetKey": "TP_TotalPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageDay",
              "targetKey": "TP_TotalPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakRaw",
              "targetKey": "TP_PowerPeakRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakHour",
              "targetKey": "TP_PowerPeakHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakDay",
              "targetKey": "TP_PowerPeakDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkPowerUsageRaw",
              "targetKey": "TP_WorkPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitPowerUsageRaw",
              "targetKey": "TP_WaitPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkPowerUsageHour",
              "targetKey": "TP_WorkPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitPowerUsageHour",
              "targetKey": "TP_WaitPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkPowerUsageDay",
              "targetKey": "TP_WorkPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitPowerUsageDay",
              "targetKey": "TP_WaitPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 422,
          "layoutY": 841
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Time Post Progress",
        "debugMode": false,
        "configuration": {
          "jsScript": "var now = new Date();\nnow.setSeconds(0);\nnow.setMilliseconds(0);\n\nvar hourTs = new Date(now.getTime());\nhourTs.setMinutes(0);\n\nvar dayTs = new Date(hourTs.getTime());\nvar dayHour = dayTs.getHours();\nif (dayHour >= 15) {\n  dayTs.setHours(15);\n} else {\n  dayTs.setDate(dayTs.getDate() - 1);\n  dayTs.setHours(15);\n}\n\nvar newMsg = [\n  {\n    ts: now.getTime(),\n    values: {\n      TP_TotalPowerUsageRaw: msg.TP_TotalPowerUsageRaw || 0,\n      TP_WorkPowerUsageRaw: msg.TP_WorkPowerUsageRaw || 0,\n      TP_WaitPowerUsageRaw: msg.TP_WaitPowerUsageRaw || 0,\n      TP_PowerPeakRaw: msg.TP_PowerPeakRaw || 0\n    }\n  },\n  {\n    ts: hourTs.getTime(),\n    values: {\n      TP_TotalPowerUsageHour: msg.TP_TotalPowerUsageHour || 0,\n      TP_WorkPowerUsageHour: msg.TP_WorkPowerUsageHour || 0,\n      TP_WaitPowerUsageHour: msg.TP_WaitPowerUsageHour || 0,\n      TP_PowerPeakHour: msg.TP_PowerPeakHour || 0\n    }\n  },\n  {\n    ts: dayTs.getTime(),\n    values: {\n      TP_TotalPowerUsageDay: msg.TP_TotalPowerUsageDay || 0,\n      TP_WorkPowerUsageDay: msg.TP_WorkPowerUsageDay || 0,\n      TP_WaitPowerUsageDay: msg.TP_WaitPowerUsageDay || 0,\n      TP_PowerPeakDay: msg.TP_PowerPeakDay || 0\n    }\n  }\n];\n\nreturn { msg: newMsg, metadata: metadata, msgType: msgType };\n\nfunction round(value, pos) {\n  return Math.round(value * Math.pow(10, pos)) / Math.pow(10, pos);\n}\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 56,
          "layoutY": 917
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "CustomerL2 Power Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": false,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": "TENANT",
          "rootEntityId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "parentRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 2,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageRaw",
              "targetKey": "TP_TotalPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageHour",
              "targetKey": "TP_TotalPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_TotalPowerUsageDay",
              "targetKey": "TP_TotalPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakRaw",
              "targetKey": "TP_PowerPeakRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakHour",
              "targetKey": "TP_PowerPeakHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "MAX",
              "sourceKey": "TP_PowerPeakDay",
              "targetKey": "TP_PowerPeakDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "sourceKey": "TP_WorkPowerUsageRaw",
              "targetKey": "TP_WorkPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "sourceKey": "TP_WaitPowerUsageRaw",
              "targetKey": "TP_WaitPowerUsageRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "sourceKey": "TP_WorkPowerUsageHour",
              "targetKey": "TP_WorkPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "sourceKey": "TP_WaitPowerUsageHour",
              "targetKey": "TP_WaitPowerUsageHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "sourceKey": "TP_WorkPowerUsageDay",
              "targetKey": "TP_WorkPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "sourceKey": "TP_WaitPowerUsageDay",
              "targetKey": "TP_WaitPowerUsageDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 53,
          "layoutY": 592
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "CustomerL1 Time Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": false,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": "TENANT",
          "rootEntityId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "parentRelationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 2,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeRaw",
              "targetKey": "TP_WorkTimeRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": "0"
              },
              "useLatestTelemetry": true,
              "aggScope": null,
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeRaw",
              "targetKey": "TP_WaitTimeRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeHour",
              "targetKey": "TP_WorkTimeHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeHour",
              "targetKey": "TP_WaitTimeHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeDay",
              "targetKey": "TP_WorkTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeDay",
              "targetKey": "TP_WaitTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_PlannedWorkTimeDay",
              "targetKey": "TP_PlannedWorkTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 53,
          "layoutY": 673
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "CustomerL2 Time Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": false,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": "TENANT",
          "rootEntityId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "parentRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 2,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeRaw",
              "targetKey": "TP_WorkTimeRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": "0"
              },
              "useLatestTelemetry": true,
              "aggScope": null,
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeRaw",
              "targetKey": "TP_WaitTimeRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeHour",
              "targetKey": "TP_WorkTimeHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeHour",
              "targetKey": "TP_WaitTimeHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeDay",
              "targetKey": "TP_WorkTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeDay",
              "targetKey": "TP_WaitTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_PlannedWorkTimeDay",
              "targetKey": "TP_PlannedWorkTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 52,
          "layoutY": 518
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "Tenant Time Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": true,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": null,
          "rootEntityId": null,
          "parentRelationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": []
              }
            ],
            "fetchLastLevelOnly": false
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 3,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeRaw",
              "targetKey": "TP_WorkTimeRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": "0"
              },
              "useLatestTelemetry": true,
              "aggScope": null,
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeRaw",
              "targetKey": "TP_WaitTimeRaw",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeHour",
              "targetKey": "TP_WorkTimeHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeHour",
              "targetKey": "TP_WaitTimeHour",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WorkTimeDay",
              "targetKey": "TP_WorkTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "sourceKey": "TP_WaitTimeDay",
              "targetKey": "TP_WaitTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            },
            {
              "operation": "SUM",
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "sourceKey": "TP_PlannedWorkTimeDay",
              "targetKey": "TP_PlannedWorkTimeDay",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false';"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 421,
          "layoutY": 583
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Time Post Progress",
        "debugMode": false,
        "configuration": {
          "jsScript": "var now = new Date();\nnow.setSeconds(0);\nnow.setMilliseconds(0);\n\nvar hourTs = new Date(now.getTime());\nhourTs.setMinutes(0);\n\nvar dayTs = new Date(hourTs.getTime());\nvar dayHour = dayTs.getHours();\nif (dayHour >= 15) {\n  dayTs.setHours(15);\n} else {\n  dayTs.setDate(dayTs.getDate() - 1);\n  dayTs.setHours(15);\n}\n\nvar ratio = 0\nif(msg.TP_WorkTimeDay && msg.TP_PlannedWorkTimeDay && msg.TP_PlannedWorkTimeDay != 0){\n    ratio = round((msg.TP_WorkTimeDay / msg.TP_PlannedWorkTimeDay) * 100, 2)\n}\n\nvar newMsg = [\n  {\n    ts: now.getTime(),\n    values: {\n      TP_WorkTimeRaw: msg.TP_WorkTimeRaw || 0,\n      TP_WaitTimeRaw: msg.TP_WaitTimeRaw || 0\n    }\n  },\n  {\n    ts: hourTs.getTime(),\n    values: {\n      TP_WorkTimeHour: msg.TP_WorkTimeHour || 0,\n      TP_WaitTimeHour: msg.TP_WaitTimeHour || 0\n    },\n  },\n{\n    ts: dayTs.getTime(),\n    values: {\n      TP_WorkTimeDay: msg.TP_WorkTimeDay || 0,\n      TP_WaitTimeDay: msg.TP_WaitTimeDay || 0,\n      TP_PlannedWorkTimeDay: msg.TP_PlannedWorkTimeDay || 0,\n      TP_WorkRatioDay: ratio\n    },\n  },\n];\n\nreturn { msg: newMsg, metadata: metadata, msgType: msgType };\n\nfunction round(value, pos) {\n  return Math.round(value * Math.pow(10, pos)) / Math.pow(10, pos);\n}\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 49,
          "layoutY": 349
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "CustomerL1 State Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": false,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": "TENANT",
          "rootEntityId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "parentRelationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 2,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "COUNT",
              "sourceKey": "active",
              "targetKey": "TP_TotalDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": "0"
              },
              "useLatestTelemetry": false,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": false,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [],
              "jsScript": "return metadata.temperature > 20;"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_WorkingDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'WORK'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_StoppedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'STOP'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_ConnectionState",
              "targetKey": "TP_UnconnectedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState == 'false'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_ActivationState",
              "targetKey": "TP_InactivatedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState == 'false'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_WaitingDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'WAIT'"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 49,
          "layoutY": 421
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "CustomerL2 State Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": false,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": "TENANT",
          "rootEntityId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "parentRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 2,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "COUNT",
              "sourceKey": "active",
              "targetKey": "TP_TotalDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": "0"
              },
              "useLatestTelemetry": false,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": false,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [],
              "jsScript": "return metadata.temperature > 20;"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_WorkingDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'WORK'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_StoppedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'STOP'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_ConnectionState",
              "targetKey": "TP_UnconnectedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState == 'false'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_ActivationState",
              "targetKey": "TP_InactivatedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState == 'false'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_WaitingDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'WAIT'"
            }
          ]
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 419,
          "layoutY": 358
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "State Post Progress",
        "debugMode": false,
        "configuration": {
          "jsScript": "var now = new Date();\nnow.setSeconds(0);\nnow.setMilliseconds(0);\n\nvar newMsg = [\n  {\n    ts: now.getTime(),\n    values: {\n      TP_TotalDevice: msg.TP_TotalDevice || 0,\n      TP_WorkingDevice: msg.TP_WorkingDevice || 0,\n      TP_WaitingDevice: msg.TP_WaitingDevice || 0,\n      TP_StoppedDevice: msg.TP_StoppedDevice || 0,\n      TP_UnconnectedDevice: msg.TP_UnconnectedDevice || 0,\n      TP_InactivatedDevice: msg.TP_InactivatedDevice || 0,\n    },\n  }\n];\n\nreturn { msg: newMsg, metadata: metadata, msgType: msgType };\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 810,
          "layoutY": 582
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 52,
          "layoutY": 275
        },
        "type": "org.thingsboard.rule.engine.aggregation.TbAggregateDoubleNode",
        "name": "Tenant State Aggregation",
        "debugMode": false,
        "configuration": {
          "interval": 1,
          "intervalTimeUnit": "MINUTES",
          "singleEntity": true,
          "originatorType": "TENANT",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "rootEntityType": null,
          "rootEntityId": null,
          "parentRelationsQuery": {
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": []
              }
            ],
            "fetchLastLevelOnly": false
          },
          "childRelationsQuery": {
            "fetchLastLevelOnly": true,
            "direction": "FROM",
            "maxLevel": 3,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          },
          "aggregationParamsList": [
            {
              "operation": "COUNT",
              "sourceKey": "active",
              "targetKey": "TP_TotalDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": "0"
              },
              "useLatestTelemetry": false,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": false,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [],
              "jsScript": "return metadata.temperature > 20;"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_WorkingDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'WORK'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_StoppedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'STOP'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_ConnectionState",
              "targetKey": "TP_UnconnectedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState == 'false'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_ActivationState",
              "targetKey": "TP_InactivatedDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState"
              ],
              "jsScript": "return metadata.TP_ActivationState == 'false'"
            },
            {
              "operation": "COUNT",
              "sourceKey": "TP_OperationState",
              "targetKey": "TP_WaitingDevice",
              "defaultValue": {
                "isEnable": true,
                "dvalue": 0
              },
              "useLatestTelemetry": true,
              "aggScope": "SERVER_SCOPE",
              "useFilterEntities": true,
              "clientAttributeNames": [],
              "serverAttributeNames": [],
              "sharedAttributeNames": [],
              "latestTsKeyNames": [
                "TP_ActivationState",
                "TP_ConnectionState",
                "TP_OperationState"
              ],
              "jsScript": "return metadata.TP_ActivationState != 'false' && metadata.TP_ConnectionState != 'false' && metadata.TP_OperationState == 'WAIT'"
            }
          ]
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 3,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 10,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 12,
        "toIndex": 10,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}