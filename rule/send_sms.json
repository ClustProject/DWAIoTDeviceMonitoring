{
  "ruleChain": {
    "additionalInfo": {
      "description": ""
    },
    "name": "Send SMS",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": 2,
    "nodes": [
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 943,
          "layoutY": 490
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check Send",
        "debugMode": false,
        "configuration": {
          "jsScript": "return metadata.route == 'send'"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1251,
          "layoutY": 489
        },
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Send SMS",
        "debugMode": false,
        "configuration": {
          "restEndpointUrlPattern": "https://tp-external.thingplus.net/sms",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": true,
          "enableProxy": false,
          "useSystemProxyProperties": false,
          "proxyScheme": null,
          "proxyHost": null,
          "proxyPort": 0,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 0,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json"
          },
          "useRedisQueueForMsgPersistence": false,
          "trimQueue": false,
          "maxQueueSize": 0,
          "credentials": {
            "type": "anonymous"
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 330,
          "layoutY": 151
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetTenantDetailsNode",
        "name": "Get Sender",
        "debugMode": false,
        "configuration": {
          "detailsList": [
            "PHONE"
          ],
          "addToMetadata": true
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 941,
          "layoutY": 255
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Get Alarm Info",
        "debugMode": false,
        "configuration": {
          "tellFailureIfAbsent": false,
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [
            "isEnable",
            "receiver",
            "typeList",
            "customerL2",
            "device",
            "customerL1"
          ],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": false
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 941,
          "layoutY": 382
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Make Body",
        "debugMode": false,
        "configuration": {
          "jsScript": "if (metadata.ss_isEnable == 'true') {\n    if (metadata.ss_typeList.indexOf(msg.type) != -1) {\n        if (metadata.ss_device == msg.originator.id) {\n            metadata.route = 'send'\n        } else if (!metadata.ss_device || metadata\n            .ss_device == '')\n            if (!metadata.ss_customerL2 || metadata\n                .ss_customerL2 == '' || metadata\n                .ss_customerL2 == msg.customerId.id) {\n                metadata.route = 'send'\n            }\n    }\n}\n\nvar newMsg = {};\n\nif(metadata.route == 'send'){\n    var typeMap = {\n        delayed: \"지연\",\n        unconnected: \"통신이상\",\n        \"over-current\": \"과전류\",\n        \"low-voltage\": \"저전압\",\n        \"high-voltage\": \"과전압\",\n        \"volt-imbalance\": \"전압 불평형\",\n        \"curr-imbalance\": \"전류 불평형\",\n        \"thd\": \"고조파 이상\",\n        \"power-factor\": \"역률 이상\"\n    }\n    newMsg.type = 'SMS'\n    newMsg.to = metadata.ss_receiver\n    newMsg.from = metadata.tenant_phone;\n    newMsg.api_key = 'NCSPESGJIZN5I9RN';\n    newMsg.api_secret = '8OLDIQOJ8RQ0XS3YPI9W6VTLZUHGX9UP';\n    newMsg.text = `${msg.details.originatorLabel}에 ${typeMap[msg.type]} 알람이 발생했습니다.`;\n}\n\nreturn {\n    msg: newMsg,\n    metadata: metadata,\n    msgType: msgType\n};"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 625,
          "layoutY": 147
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "To CustomerL2",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 625,
          "layoutY": 255
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "To CustomerL1",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "CUSTOMER"
                ]
              }
            ]
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 627,
          "layoutY": 379
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "To Tenant",
        "debugMode": false,
        "configuration": {
          "originatorSource": "TENANT",
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "TENANT"
                ]
              }
            ]
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 939,
          "layoutY": 148
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "To Asset",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "FROM",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Alarms",
                "entityTypes": [
                  "ASSET"
                ]
              }
            ]
          }
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 1,
        "type": "True"
      },
      {
        "fromIndex": 2,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 3,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 3,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}