{
  "ruleChain": {
    "additionalInfo": {
      "description": ""
    },
    "name": "Analysis",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": 16,
    "nodes": [
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 526,
          "layoutY": 459
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Get Trial Info",
        "debugMode": false,
        "configuration": {
          "tellFailureIfAbsent": false,
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [
            "trialConfig"
          ],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": false
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 823,
          "layoutY": 461
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check Trial",
        "debugMode": false,
        "configuration": {
          "jsScript": "if(metadata.ss_trialConfig){\n    let trialConfig = JSON.parse(metadata.ss_trialConfig)\n    return trialConfig.isActive;\n}\nreturn false;"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 933,
          "layoutY": 992
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsSwitchNode",
        "name": "Route",
        "debugMode": false,
        "configuration": {
          "jsScript": "return metadata.next"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1296,
          "layoutY": 1067
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create Body",
        "debugMode": false,
        "configuration": {
          "jsScript": "var now = new Date(+metadata.ts);\nvar newMsg = {\n  service: 'moldmecca_analysis',\n  body: {\n    token: metadata.jwtToken,\n    device_id: metadata.originatorId,\n    end_ts: new Date('2023-08-08').getTime(),\n    start_ts: new Date('2023-05-12').getTime(),\n    trial_hour_start:7,\n    trial_hour_end:12,\n    trial_time_min:\"20m\",\n    trial_time_max:\"60m\"\n  }\n};\nreturn { msg: newMsg, metadata: metadata, msgType: msgType };\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 43,
          "layoutY": 1077
        },
        "type": "org.thingsboard.rule.engine.debug.TbMsgGeneratorNode",
        "name": "Request Analysis Trial",
        "debugMode": false,
        "configuration": {
          "msgCount": 1,
          "periodInSeconds": 2,
          "useEndtime": false,
          "endTime": "23:01:59",
          "jsScript": "var msg = { temp: 42, humidity: 77 };\nvar metadata = { next: 'Request Analysis Trial' };\nvar msgType = \"POST_TELEMETRY_REQUEST\";\n\nreturn { msg: msg, metadata: metadata, msgType: msgType };",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "originatorType": "TENANT"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 46,
          "layoutY": 368
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsSwitchNode",
        "name": "Route",
        "debugMode": false,
        "configuration": {
          "jsScript": "return metadata.next"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1146,
          "layoutY": 462
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create Body",
        "debugMode": false,
        "configuration": {
          "jsScript": "var now = new Date(+metadata.ts);\n\nlet trialConfig = JSON.parse(metadata.ss_trialConfig)\nlet trial_time_min = trialConfig.trialMin + 'm';\nlet trial_time_max = trialConfig.trialMax + 'm';\n\nvar newMsg = {\n  service: 'moldmecca_analysis',\n  body: {\n    token: metadata.jwtToken,\n    device_id: metadata.originatorId,\n    end_ts: now.getTime(),\n    start_ts: now.getTime() - 24 * 60 * 60 * 1000,\n    trial_hour_start:7,\n    trial_hour_end:12,\n    trial_time_min: trial_time_min,\n    trial_time_max: trial_time_max\n  }\n};\nreturn { msg: newMsg, metadata: metadata, msgType: msgType };\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1469,
          "layoutY": 462
        },
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Request Analysis Trial",
        "debugMode": false,
        "configuration": {
          "restEndpointUrlPattern": "http://ec2-3-36-225-254.ap-northeast-2.compute.amazonaws.com:3000/trial_analysis",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": true,
          "enableProxy": false,
          "useSystemProxyProperties": false,
          "proxyScheme": null,
          "proxyHost": null,
          "proxyPort": 0,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 0,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json"
          },
          "useRedisQueueForMsgPersistence": false,
          "trimQueue": false,
          "maxQueueSize": 0,
          "credentials": {
            "type": "anonymous"
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 52,
          "layoutY": 904
        },
        "type": "org.thingsboard.rule.engine.debug.TbMsgGeneratorNode",
        "name": "Request Analysis State",
        "debugMode": false,
        "configuration": {
          "msgCount": 1,
          "periodInSeconds": 1,
          "useEndtime": false,
          "endTime": "23:01:59",
          "jsScript": "var msg = { temp: 42, humidity: 77 };\nvar metadata = { next: 'Request Analysis State' };\nvar msgType = \"POST_TELEMETRY_REQUEST\";\n\nreturn { msg: msg, metadata: metadata, msgType: msgType };",
          "originatorId": "08a3e6b0-96f0-11ed-8d0d-21e1d787e420",
          "originatorType": "TENANT"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 355,
          "layoutY": 902
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetTenantAttributeNode",
        "name": "Get Token",
        "debugMode": false,
        "configuration": {
          "telemetry": false,
          "attrMapping": {
            "token": "jwtToken"
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 355,
          "layoutY": 996
        },
        "type": "org.thingsboard.rule.engine.transform.TbDuplicateRelatedNode",
        "name": "To Device",
        "debugMode": false,
        "configuration": {
          "relationsQuery": {
            "fetchLastLevelOnly": false,
            "direction": "FROM",
            "maxLevel": 3,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "DEVICE"
                ]
              }
            ]
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1294,
          "layoutY": 908
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create Body",
        "debugMode": false,
        "configuration": {
          "jsScript": "var now = new Date();\nnow.setMinutes(0);\nnow.setSeconds(0);\nnow.setMilliseconds(0);\nvar newMsg = {\n  service: 'moldmecca_analysis',\n  body: {\n    init: false,\n    token: metadata.jwtToken,\n    device_id: metadata.originatorId,\n    end_ts: '2023-08-04 17:00:00',\n    start_ts: '2023-08-01 00:00:00',\n    margin_time: '1h',\n    unconnected_time: '30m',\n    value_section_a: Number(metadata.ss_waitPowerLimit),\n    value_section_b: Number(metadata.ss_workPowerLimit),\n    pattern_smoothing_config: {\n      priority: [0, 1, 2, 3, 4, 5, 6, 7],\n      status1: [2, 2, 0, 2, 1, 2, 1, 0],\n      status2: [1, 0, 1, 1, 0, 0, 0, 1],\n      status3: [2, 2, 2, 0, 2, 1, 1, 0],\n      limit_time: ['60m', '60m', '60m', '30m', '30m', '30m', '30m', '30m'],\n      to_status: [2, 2, 2, 2, 1, 1, 1, 0]\n    }\n  }\n};\nreturn { msg: newMsg, metadata: metadata, msgType: msgType };\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 634,
          "layoutY": 895
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetOriginatorFieldsNode",
        "name": "Get ID",
        "debugMode": false,
        "configuration": {
          "fieldsMapping": {
            "id": "originatorId"
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 633,
          "layoutY": 992
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Get Limit",
        "debugMode": false,
        "configuration": {
          "tellFailureIfAbsent": false,
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [
            "waitPowerLimit",
            "workPowerLimit"
          ],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": false
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 820,
          "layoutY": 286
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create Body",
        "debugMode": false,
        "configuration": {
          "jsScript": "var now = new Date(+metadata.ts);\nvar newMsg = {\n  service: 'moldmecca_analysis',\n  body: {\n    init: metadata.TP_AnalysisState == undefined || metadata.TP_AnalysisState == null,\n    token: metadata.jwtToken,\n    device_id: metadata.originatorId,\n    end_ts: now.getTime() - 60 * 60 * 1000,\n    start_ts: now.getTime() - 2 * 60 * 60 * 1000,\n    margin_time: '1h',\n    unconnected_time: '30m',\n    value_section_a: JSON.parse(metadata.TP_WaitPowerLimit).value,\n    value_section_b: JSON.parse(metadata.TP_WorkPowerLimit).value,\n    pattern_smoothing_config: {\n      priority: [0, 1, 2, 3, 4, 5, 6, 7],\n      status1: [2, 2, 0, 2, 1, 2, 1, 0],\n      status2: [1, 0, 1, 1, 0, 0, 0, 1],\n      status3: [2, 2, 2, 0, 2, 1, 1, 0],\n      limit_time: ['60m', '60m', '60m', '30m', '30m', '30m', '30m', '30m'],\n      to_status: [2, 2, 2, 2, 1, 1, 1, 0]\n    }\n  }\n};\nreturn { msg: newMsg, metadata: metadata, msgType: msgType };\n"
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1143,
          "layoutY": 286
        },
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Request Analysis State",
        "debugMode": true,
        "configuration": {
          "restEndpointUrlPattern": "http://ec2-3-36-225-254.ap-northeast-2.compute.amazonaws.com:3000/analysis",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": true,
          "enableProxy": false,
          "useSystemProxyProperties": false,
          "proxyScheme": null,
          "proxyHost": null,
          "proxyPort": 0,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 0,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json"
          },
          "useRedisQueueForMsgPersistence": false,
          "trimQueue": false,
          "maxQueueSize": 0,
          "credentials": {
            "type": "anonymous"
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 49,
          "layoutY": 255
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetOriginatorFieldsNode",
        "name": "Get ID",
        "debugMode": false,
        "configuration": {
          "fieldsMapping": {
            "id": "originatorId"
          }
        }
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 530,
          "layoutY": 289
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Get State Info",
        "debugMode": false,
        "configuration": {
          "tellFailureIfAbsent": false,
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [],
          "latestTsKeyNames": [
            "TP_AnalysisState",
            "TP_WaitPowerLimit",
            "TP_WorkPowerLimit"
          ],
          "getLatestValueWithTs": false
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 6,
        "type": "True"
      },
      {
        "fromIndex": 2,
        "toIndex": 11,
        "type": "Request Analysis State"
      },
      {
        "fromIndex": 2,
        "toIndex": 3,
        "type": "Request Analysis Trial"
      },
      {
        "fromIndex": 4,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 17,
        "type": "Request Analysis State"
      },
      {
        "fromIndex": 5,
        "toIndex": 0,
        "type": "Request Analysis Trial"
      },
      {
        "fromIndex": 6,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 10,
        "type": "Success"
      },
      {
        "fromIndex": 10,
        "toIndex": 12,
        "type": "Success"
      },
      {
        "fromIndex": 12,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 13,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 14,
        "toIndex": 15,
        "type": "Success"
      },
      {
        "fromIndex": 16,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 17,
        "toIndex": 14,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}