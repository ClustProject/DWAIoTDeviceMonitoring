{
  "widgetsBundle": {
    "alias": "moldmecca_report_widgets",
    "title": "Moldmecca Report Widgets",
    "image": null,
    "description": null
  },
  "widgetTypes": [
    {
      "alias": "total_operation",
      "name": "Total Operation",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 4.5,
        "sizeY": 5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"operation-section\" fxLayout=\"column\" fxLayoutAlign=\"space-between center\">\n      <div fxFlex class=\"progress-container\">\n        <svg viewBox=\"0 0 200 200\" class=\"circle-box\">\n          <path class=\"circle background-circle\" [attr.d]=\"path\" />\n        </svg>\n        <svg viewBox=\"0 0 200 200\" class=\"circle-box\">\n          <path\n            class=\"circle foreground-circle\"\n            [attr.d]=\"path\"\n            [ngStyle]=\"{'stroke-dasharray': gauge, 'stroke': ratioColor}\"\n            [ngClass]=\"{'diabled': inactivated}\"\n          />\n        </svg>\n        <div class=\"content-box\" fxLayout=\"column\" fxLayoutAlign=\"center center\" fxLayoutGap=\"0.5em\">\n          <div class=\"value-box\" fxLayoutAlign=\"center end\" fxLayoutGap=\"0.1em\">\n            <div class=\"value\">{{ratio}}</div>\n            <div class=\"unit\">%</div>\n          </div>\n          <div class=\"label-box\" translate>thingplus.label.operation-rate</div>\n        </div>\n      </div>\n      <div class=\"detail-container\" fxLayoutAlign=\"center center\">\n        <div class=\"detail-box\" *ngFor=\"let detail of detailList\" fxLayoutAlign=\"center center\" fxLayoutGap=\"0.4em\">\n          <div class=\"detail-label\">{{detail.label}}</div>\n          <div class=\"detail-value\" [innerHTML]=\"detail.value\"></div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-0);\n}\n/* widget-header-right-section */\n.widget-header-right-section .widget-date {\n  font-size: 1.2em;\n  font-weight: 500;\n  color: var(--tb-service-font-3);\n  white-space: nowrap;\n}\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/* operation-section */\n.operation-section {\n  width: 100%;\n  height: 100%;\n}\n.operation-section .progress-container {\n  position: relative;\n  width: 100%;\n  height: 100%;\n}\n.operation-section .circle-box {\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  height: 75%;\n  aspect-ratio: 1 / 1;\n}\n.operation-section .circle {\n  stroke-width: 7;\n  fill: none;\n}\n.operation-section .background-circle {\n  stroke: var(--tb-service-background-3);\n}\n.operation-section .foreground-circle {\n  stroke: var(--tb-service-background-3);\n  transition-property: stroke, stroke-dasharray;\n  transition-duration: var(--tb-config-color-duration);\n}\n.operation-section .foreground-circle.disabled {\n  stroke: var(--tb-service-inactivated);\n}\n.operation-section .content-box {\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  width: 50%;\n  height: 50%;\n}\n.operation-section .value-box {\n  color: var(--tb-service-font-5);\n}\n.operation-section .value {\n  font-size: 2.4em;\n  font-weight: 500;\n}\n.operation-section .unit {\n  font-size: 1.6em;\n  font-weight: 600;\n  line-height: 1.5em;\n}\n.operation-section .label-box {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.operation-section .detail-box {\n  padding: 0 1.2em;\n}\n.operation-section .detail-box:first-child {\n  border-right: 1px solid var(--tb-service-border-4);\n}\n.operation-section .detail-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.operation-section .detail-value {\n  font-size: 1.2em;\n  font-weight: 600;\n  color: var(--tb-service-font-5);\n}\n",
        "controllerScript": "const RADIUS = 100;\nconst BORDER = 20;\nconst HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  createGauge(RADIUS - BORDER);\n  self.onResize();\n  custom.mainData = await loadData();\n  setData();\n  self.ctx.detectChanges();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.detailList = [\n    {\n      label: t('thingplus.energy.operation-time'),\n      value: 0,\n    },\n    {\n      label: t('thingplus.energy.planned-time'),\n      value: 0,\n    },\n  ];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.t = t;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).endOf('day').valueOf() + 1;\n  custom.computedStyle = getComputedStyle($container[0]);\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction createGauge(radius) {\n  let { $scope } = self.ctx;\n  $scope.path = `M${RADIUS} ${RADIUS - radius} a ${radius} ${radius} 0 0 1 0 ${\n    radius * 2\n  } a ${radius} ${radius} 0 0 1 0 ${radius * -2}`;\n}\n\nfunction loadData() {\n  let { custom } = self.ctx;\n  return new Promise(resolve => {\n    self.ctx.attributeService\n      .getEntityTimeseries(\n        custom.mainDatasources[0].entity.id,\n        ['TP_PlannedWorkTimeDay', 'TP_WorkTimeDay'],\n        custom.searchStart,\n        custom.searchEnd,\n        50000,\n        'NONE',\n        0,\n        'ASC',\n        true\n      )\n      .subscribe(datas => {\n        resolve(datas);\n      });\n  });\n}\n\nfunction setData() {\n  let { custom, $scope } = self.ctx;\n  let result = {\n    TP_PlannedWorkTimeDay: 0,\n    TP_WorkTimeDay: 0,\n  };\n  for (let i in result) {\n    for (let j = custom.searchStart; j < custom.searchEnd; j += DAY_MS) {\n      let acc = 0;\n      if (custom.mainData[i]) {\n        let targetArray = custom.mainData[i].filter(x => x.ts >= j && x.ts < j + DAY_MS).map(x => x.value);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i] += acc;\n      }\n    }\n  }\n\n  $scope.ratio = _.round((result.TP_WorkTimeDay / result.TP_PlannedWorkTimeDay) * 100, 1);\n\n  if ($scope.ratio < 0) {\n    $scope.ratio = 0;\n  }\n  $scope.ratioColor = getHsl($scope.ratio);\n\n  $scope.detailList[0].value = _.round(result.TP_WorkTimeDay / HOUR_MS, 0) + t('thingplus.time-format.hours');\n  $scope.detailList[1].value = _.round(result.TP_PlannedWorkTimeDay / HOUR_MS, 0) + t('thingplus.time-format.hours');\n\n  let circleLength = 2 * (RADIUS - BORDER) * Math.PI;\n  $scope.gauge = `${(($scope.ratio > 100 ? 100 : $scope.ratio) * circleLength) / 100}, ${circleLength}`;\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction getHsl(value) {\n  if (value > 100) {\n    value = 100;\n  }\n  return tinycolor(getStyle('--tb-service-progress'))\n    .brighten(_.round((100 - value) / 4))\n    .toHexString();\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.27689369443101963,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Total Operation\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "power_usage_rank",
      "name": "Delay Rank",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <section class=\"page-section\" fxLayoutAlign=\"end center\" fxLayoutGap=\"-1px\">\n        <div class=\"current-page\">{{currentPage}}</div>\n        <div class=\"material-icons page-button prev-button\" (click)=\"getPrevPage()\">keyboard_arrow_left</div>\n        <div class=\"material-icons page-button next-button\" (click)=\"getNextPage()\">keyboard_arrow_right</div>\n      </section>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n              <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <span class=\"th-label\">{{th.label}}</span>\n                <i class=\"th-sort material-icons\">arrow_upward</i>\n              </div>\n            </th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr *ngFor=\"let tr of trList\">\n            <td *ngFor=\"let td of tr.tdList\">{{td.value}}</td>\n          </tr>\n        </tbody>\n      </table>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n/* page-section */\n.page-section .current-page {\n  font-size: 1.2em;\n  padding-right: 1em;\n  letter-spacing: 0.05em;\n  color: var(--tb-service-font-5);\n}\n.page-section .page-button {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 1.5em;\n  min-width: 20px;\n  height: 1.5em;\n  min-height: 20px;\n  font-size: 1.6em;\n  background-color: var(--tb-service-background-0);\n  border: 1px solid var(--tb-service-border-0);\n  cursor: pointer;\n  color: var(--tb-service-accent);\n  transition-property: border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.page-section .page-button:hover {\n  border: 1px solid var(--tb-service-accent-hover);\n  z-index: 1;\n}\n.page-section .page-button:active {\n  border: 1px solid var(--tb-service-accent-pressed);\n  z-index: 1;\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  height: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 0em 1.2em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  self.ctx.timewindowFunctions.onUpdateTimewindow(custom.searchStart, custom.searchEnd);\n  linkEvent();\n  loadAlarm();\n  makeHead();\n  makeBody();\n  self.onResize();\n  initPage();\n\n  custom.isInitialized = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (custom.isInitialized) {\n    custom.mainData = preprocessData();\n    sortData();\n    insertData();\n  }\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$table = $('.table', $container);\n  custom.$theadTr = $('.table thead tr', $container);\n  custom.$tbody = $('.table tbody', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.pageList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).endOf('day').valueOf() + 1;\n  custom.selectedIndex = 0;\n  custom.currentPage = 1;\n  custom.countPerPage = 5;\n  custom.alarms = [];\n  custom.t = t;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.getPrevPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage--;\n      initPage();\n      insertData();\n    }\n  };\n  $scope.getNextPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage++;\n      initPage();\n      insertData();\n    }\n  };\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    initPage();\n    sortData();\n    insertData();\n  };\n}\n\nfunction loadAlarm() {\n  let { custom, $scope, $container } = self.ctx;\n  let observables = [];\n  for (let i in custom.mainDatasources) {\n    observables.push(\n      self.ctx.http.get(\n        `/api/alarm/DEVICE/${custom.mainDatasources[i].entityId}?textSearch=delayed&startTime=${custom.searchStart}&endTime=${custom.searchEnd}&page=0&pageSize=50000`\n      )\n    );\n  }\n  self.ctx.rxjs.forkJoin(observables).subscribe(alarms => {\n    custom.alarms = alarms.map(x => x.totalElements);\n    self.onDataUpdated();\n  });\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'rank',\n      label: t('thingplus.label.rank'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'label',\n      label: t('thingplus.label.device-name'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'alarmCount',\n      label: t('thingplus.label.alarm-count'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'waitTime',\n      label: t('thingplus.label.waiting-time'),\n      order: '',\n    },\n    {\n      index: 3,\n      key: 'waitPowerUsage',\n      label: t('thingplus.label.usage-with-unit-2'),\n      order: '',\n    },\n  ];\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  // 현재 페이지의 데이터 수 만큼 행 출력\n  for (let i = 0; i < custom.countPerPage; i++) {\n    let tdList = [\n      { index: 0, name: $scope.thList[0].key, style: '', value: '-' },\n      { index: 1, name: $scope.thList[1].key, style: '', value: '-' },\n      { index: 2, name: $scope.thList[2].key, style: '', value: '-' },\n      { index: 3, name: $scope.thList[3].key, style: '', value: '-' },\n      { index: 4, name: $scope.thList[4].key, style: '', value: '-' },\n    ];\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\n// 페이지에 맞는 데이터 출력 및 페이지 표시\nfunction initPage() {\n  let { custom, $scope } = self.ctx;\n  custom.totalPage = Math.ceil(custom.mainDatasources.length / custom.countPerPage);\n\n  custom.startIndex = (custom.currentPage - 1) * custom.countPerPage;\n  custom.endIndex = custom.currentPage * custom.countPerPage - 1;\n  // 끝 페이지가 데이터 소스의 길이보다 많으면 데이터 소스의 길이로 변경\n  if (custom.endIndex > custom.mainDatasources.length - 1) {\n    custom.endIndex = custom.mainDatasources.length - 1;\n  }\n  custom.targetDatasources = custom.mainDatasources.slice(custom.startIndex, custom.endIndex + 1);\n  $scope.currentPage = custom.currentPage + ' of ' + custom.totalPage;\n}\n\nfunction preprocessData() {\n  let { custom } = self.ctx;\n  let result = [];\n  for (let i in custom.mainDatasources) {\n    result.push({\n      id: custom.mainDatasources[i].entity.id,\n      name: custom.mainDatasources[i].entityName,\n      label: custom.mainDatasources[i].entityLabel,\n    });\n  }\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let entityId = target.datasource.entityId;\n      let name = target.dataKey.name;\n      let data = target.data;\n      let datasourceIndex = result.findIndex(x => x.id.id == entityId);\n      if (datasourceIndex !== -1) {\n        result[datasourceIndex][name] = data;\n      }\n    }\n  }\n  for (let i in result) {\n    result[i].alarmCount = custom.alarms[i] || 0;\n    result[i].waitTime = 0;\n    result[i].waitPowerUsage = 0;\n\n    for (let j = custom.searchStart; j < custom.searchEnd; j += DAY_MS) {\n      if (result[i].TP_WaitTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].waitTime += acc;\n      }\n      if (result[i].TP_WaitPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc += targetArray[k];\n        }\n        result[i].waitPowerUsage += acc;\n      }\n    }\n    result[i].waitPowerUsage = result[i].waitPowerUsage / 1000;\n    result[i].waitTime = toTime(result[i].waitTime / 1000);\n  }\n  result.sort((a, b) => {\n    if (a.waitTime > b.waitTime) return -1;\n    if (a.waitTime < b.waitTime) return 1;\n    return 0;\n  });\n  result.sort((a, b) => {\n    if (a.alarmCount > b.alarmCount) return -1;\n    if (a.alarmCount < b.alarmCount) return 1;\n    return 0;\n  });\n  for (let i in result) {\n    result[i].rank = +i + 1;\n  }\n  return result;\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  for (let i in $scope.trList) {\n    for (let j in $scope.trList[i].tdList) {\n      $scope.trList[i].tdList[j].value = '-';\n    }\n  }\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n      if (key == 'operationTime') {\n        let date = toDate(Math.floor(data * HOUR_MS));\n        data = t('thingplus.time-format.hm-acc', {\n          hour: date[0],\n          minute: date[1],\n        });\n      }\n      $scope.trList[i - custom.startIndex].tdList[j].value = data;\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction toDate(value) {\n  if (isNaN(Number(value))) return [0, 0];\n  let hour = Math.floor(value / 3600000);\n  let temp = value % 3600000;\n  let min = Math.floor(temp / 60000);\n  return [hour, min];\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{\n  \"schema\": {\n    \"type\": \"object\",\n    \"title\": \"DataKeySettings\",\n    \"properties\": {\n      \"hidden\": {\n        \"title\": \"Hide from table\",\n        \"type\": \"boolean\",\n        \"default\": false\n      }\n    },\n    \"required\": []\n  },\n  \"form\": [\"hidden\"]\n}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"First\",\"color\":\"#2196f3\",\"settings\":{\"showLines\":true,\"fillLines\":true,\"showPoints\":false},\"_hash\":0.8587686344902596,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Second\",\"color\":\"#ffc107\",\"settings\":{\"showLines\":true,\"fillLines\":false,\"showPoints\":false},\"_hash\":0.12775350966079668,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.13484586547323252,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":1,\"history\":{\"historyType\":1,\"fixedTimewindow\":{\"startTimeMs\":1676818800000,\"endTimeMs\":1676905200000},\"interval\":173000},\"aggregation\":{\"type\":\"NONE\",\"limit\":50000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Delay Rank\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":false,\"displayTimewindow\":false,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false}}"
      }
    },
    {
      "alias": "operation_rank",
      "name": "Operation Rank",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <section class=\"page-section\" fxLayoutAlign=\"end center\" fxLayoutGap=\"-1px\">\n        <div class=\"current-page\">{{currentPage}}</div>\n        <div class=\"material-icons page-button prev-button\" (click)=\"getPrevPage()\">keyboard_arrow_left</div>\n        <div class=\"material-icons page-button next-button\" (click)=\"getNextPage()\">keyboard_arrow_right</div>\n      </section>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n              <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <span class=\"th-label\">{{th.label}}</span>\n                <i class=\"th-sort material-icons\">arrow_upward</i>\n              </div>\n            </th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr *ngFor=\"let tr of trList\">\n            <td *ngFor=\"let td of tr.tdList\">{{td.value}}</td>\n            <td>\n              <div class=\"td-operation\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n                <div class=\"td-progress-box\">\n                  <div class=\"background\"></div>\n                  <div\n                    class=\"foreground\"\n                    [ngStyle]=\"{'width': tr.operationRatio + '%', 'backgroundColor': tr.ratioColor}\"\n                  ></div>\n                </div>\n                <span class=\"td-operation-value\">{{tr.operationRatio}} %</span>\n              </div>\n            </td>\n          </tr>\n        </tbody>\n      </table>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n/* page-section */\n.page-section .current-page {\n  font-size: 1.2em;\n  padding-right: 1em;\n  letter-spacing: 0.05em;\n  color: var(--tb-service-font-5);\n}\n.page-section .page-button {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 1.5em;\n  min-width: 20px;\n  height: 1.5em;\n  min-height: 20px;\n  font-size: 1.6em;\n  background-color: var(--tb-service-background-0);\n  border: 1px solid var(--tb-service-border-0);\n  cursor: pointer;\n  color: var(--tb-service-accent);\n  transition-property: border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.page-section .page-button:hover {\n  border: 1px solid var(--tb-service-accent-hover);\n  z-index: 1;\n}\n.page-section .page-button:active {\n  border: 1px solid var(--tb-service-accent-pressed);\n  z-index: 1;\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  height: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 0em 1.2em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .td-operation {\n  font-size: calc(1em / 1.4);\n}\n.table-section .td-operation {\n  width: 100%;\n}\n.table-section .td-progress-box {\n  width: 100%;\n  position: relative;\n}\n.table-section .td-operation-value {\n  font-size: 1.2em;\n}\n.table-section .background,\n.table-section .foreground {\n  position: absolute;\n  top: 50%;\n  left: 0%;\n  transform: translateY(-50%);\n  height: 0.4em;\n}\n.table-section .background {\n  width: 100%;\n  background-color: var(--tb-service-background-3);\n}\n.table-section .foreground {\n  background-color: var(--tb-service-operation-mid);\n  transition-property: width, background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\nconst COLUMN = [\n  { label: 'thingplus.label.rank', key: 'rank' },\n  { label: 'thingplus.label.device-name', key: 'label' },\n  { label: 'thingplus.label.operation-time', key: 'operationTime' },\n  { label: 'thingplus.label.planned-time', key: 'plannedTime' },\n];\n\nself.onInit = function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  self.ctx.timewindowFunctions.onUpdateTimewindow(custom.searchStart, custom.searchEnd);\n  linkEvent();\n  makeHead();\n  makeBody();\n  self.onResize();\n  initPage();\n  custom.isInitialized = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (custom.isInitialized) {\n    custom.mainData = preprocessData();\n    sortData();\n    insertData();\n  }\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$table = $('.table', $container);\n  custom.$theadTr = $('.table thead tr', $container);\n  custom.$tbody = $('.table tbody', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.pageList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).endOf('day').valueOf() + 1;\n  custom.selectedIndex = 0;\n  custom.currentPage = 1;\n  custom.countPerPage = 5;\n  custom.computedStyle = getComputedStyle($container[0]);\n  custom.t = t;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.getPrevPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage--;\n      initPage();\n      insertData();\n    }\n  };\n  $scope.getNextPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage++;\n      initPage();\n      insertData();\n    }\n  };\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    initPage();\n    sortData();\n    insertData();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'rank',\n      label: t('thingplus.label.rank'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'label',\n      label: t('thingplus.label.device-name'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'operationTime',\n      label: t('thingplus.label.operation-time'),\n      order: '',\n    },\n    {\n      index: 3,\n      key: 'plannedTime',\n      label: t('thingplus.label.planned-time'),\n      order: '',\n    },\n    {\n      index: 4,\n      key: 'operationRatio',\n      label: t('thingplus.label.operation-rate'),\n      order: '',\n    },\n  ];\n}\n\n// 페이지에 맞는 데이터 출력 및 페이지 표시\nfunction initPage() {\n  let { custom, $scope } = self.ctx;\n  custom.totalPage = Math.ceil(custom.mainDatasources.length / custom.countPerPage);\n\n  custom.startIndex = (custom.currentPage - 1) * custom.countPerPage;\n  custom.endIndex = custom.currentPage * custom.countPerPage - 1;\n  // 끝 페이지가 데이터 소스의 길이보다 많으면 데이터 소스의 길이로 변경\n  if (custom.endIndex > custom.mainDatasources.length - 1) {\n    custom.endIndex = custom.mainDatasources.length - 1;\n  }\n  custom.targetDatasources = custom.mainDatasources.slice(custom.startIndex, custom.endIndex + 1);\n  $scope.currentPage = custom.currentPage + ' of ' + custom.totalPage;\n}\n\nfunction preprocessData() {\n  let { custom } = self.ctx;\n  let result = [];\n  for (let i in custom.mainDatasources) {\n    result.push({\n      id: custom.mainDatasources[i].entity.id,\n      name: custom.mainDatasources[i].entityName,\n      label: custom.mainDatasources[i].entityLabel,\n    });\n  }\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let entityId = target.datasource.entityId;\n      let name = target.dataKey.name;\n      let data = target.data;\n      let datasourceIndex = result.findIndex(x => x.id.id == entityId);\n      if (datasourceIndex !== -1) {\n        result[datasourceIndex][name] = data;\n      }\n    }\n  }\n\n  for (let i in result) {\n    result[i].operationTime = 0;\n    result[i].plannedTime = 0;\n    for (let j = custom.searchStart; j < custom.searchEnd; j += DAY_MS) {\n      if (result[i].TP_WorkTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WorkTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].operationTime += acc;\n      }\n      if (result[i].TP_PlannedWorkTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_PlannedWorkTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].plannedTime += acc;\n      }\n    }\n    result[i].operationRatio = _.round((result[i].operationTime / result[i].plannedTime) * 100, 1) || 0;\n\n    result[i].operationTime = toTime(result[i].operationTime / 1000);\n    result[i].plannedTime = toTime(result[i].plannedTime / 1000);\n\n    result[i].ratioColor = getHsl(result[i].operationRatio);\n  }\n\n  result.sort((a, b) => {\n    if (a.operationRatio > b.operationRatio) return -1;\n    if (a.operationRatio < b.operationRatio) return 1;\n    return 0;\n  });\n  for (let i in result) {\n    result[i].rank = +i + 1;\n  }\n  return result;\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  // 현재 페이지의 데이터 수 만큼 행 출력\n  for (let i = 0; i < custom.countPerPage; i++) {\n    let tdList = [\n      { index: 0, name: $scope.thList[0].key, style: '', value: '-' },\n      { index: 1, name: $scope.thList[1].key, style: '', value: '-' },\n      { index: 2, name: $scope.thList[2].key, style: '', value: '-' },\n      { index: 3, name: $scope.thList[3].key, style: '', value: '-' },\n    ];\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  for (let i in $scope.trList) {\n    $scope.trList[i].operationRatio = 0;\n    for (let j in $scope.trList[i].tdList) {\n      $scope.trList[i].tdList[j].value = '-';\n    }\n  }\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    for (let j in COLUMN) {\n      let key = COLUMN[j].key;\n      let data = custom.mainData[i][key];\n\n      $scope.trList[i - custom.startIndex].tdList[j].value = data;\n    }\n    if (custom.mainData[i].operationRatio > 100) {\n      custom.mainData[i].operationRatio = 100;\n    }\n\n    $scope.trList[i - custom.startIndex].operationRatio = custom.mainData[i].operationRatio;\n    $scope.trList[i - custom.startIndex].ratioColor = custom.mainData[i].ratioColor;\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction getHsl(value) {\n  if (value > 100) {\n    value = 100;\n  }\n  return tinycolor(getStyle('--tb-service-progress'))\n    .brighten(_.round((100 - value) / 4))\n    .toHexString();\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":null},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.9917010416235046,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":1,\"history\":{\"historyType\":1,\"fixedTimewindow\":{\"startTimeMs\":1676905200000,\"endTimeMs\":1676991600000},\"interval\":173000},\"aggregation\":{\"type\":\"NONE\",\"limit\":50000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Operation Rank\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":false,\"displayTimewindow\":false,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false}}"
      }
    },
    {
      "alias": "total_usage",
      "name": "Total Usage",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 5,
        "sizeY": 6.5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"card-section\" fxLayout=\"column\" fxLayoutAlign=\"space-between stretch\">\n      <div\n        class=\"card-container\"\n        fxFlex\n        fxLayout=\"column\"\n        fxLayoutAlign=\"center center\"\n        fxLayoutGap=\"2em\"\n        *ngFor=\"let card of cardList\"\n      >\n        <img class=\"card-icon\" [src]=\"card.icon\" />\n        <div class=\"card-value-box\" fxLayout=\"column\" fxLayoutAlign=\"center center\">\n          <label class=\"card-label\">{{card.label}}</label>\n          <div class=\"card-value\">{{card.value}}</div>\n          <div class=\"card-unit\">{{card.unit}}</div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-0);\n}\n/*\n  Widget Content Area\n*/\n\nmain.widget-content {\n  width: 100%;\n}\n\n/* card-section */\nsection.card-section {\n  width: 100%;\n  height: 100%;\n}\n.card-section .card-container {\n  width: 100%;\n  border-bottom: 1px solid var(--tb-service-border-1);\n  padding: var(--tb-config-padding);\n}\n.card-section .card-container:last-child {\n  border-bottom: none;\n}\n.card-section .card-icon {\n  width: 3.2em;\n  height: 3.2em;\n}\n.card-section .card-label {\n  font-size: 1.4em;\n  color: var(--tb-service-font-4);\n}\n.card-section .card-value {\n  font-size: 2.4em;\n  font-weight: 600;\n  color: var(--tb-service-font-5);\n}\n.card-section .card-unit {\n  font-size: 1.4em;\n  color: var(--tb-service-font-3);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  self.ctx.timewindowFunctions.onUpdateTimewindow(custom.searchStart, custom.searchEnd);\n  self.onResize();\n  custom.isInitialized = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (custom.isInitialized) {\n    custom.mainData = preprocessData();\n    insertData();\n  }\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.cardList = [\n    {\n      label: t('thingplus.page.report.total-usage'),\n      value: 0,\n      unit: 'Wh',\n      icon: self.ctx.sanitizer.bypassSecurityTrustResourceUrl(SVG_ICON[0]),\n    },\n    {\n      label: t('thingplus.page.report.avg-usage'),\n      value: 0,\n      unit: 'Wh',\n      icon: self.ctx.sanitizer.bypassSecurityTrustResourceUrl(SVG_ICON[1]),\n    },\n  ];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys;\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).endOf('day').valueOf() + 1;\n  custom.totalDevice = 1;\n  custom.t = t;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction preprocessData() {\n  let { custom, $scope } = self.ctx;\n  let result = [];\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (target.data[0]) {\n      let key = target.dataKey.name;\n      let data = target.data;\n      if (key == 'TP_TotalPowerUsageDay') {\n        result = result.concat(data);\n      }\n      if (key == 'TP_TotalDevice') {\n        let targetIndex = data.findLastIndex(x => x[0] < custom.searchEnd);\n        if (targetIndex != -1) {\n          custom.totalDevice = data[targetIndex][1];\n        } else {\n          custom.totalDevice = data[data.length - 1][1];\n        }\n      }\n      if (key == 'TP_InactivatedDevice') {\n        let targetIndex = data.findLastIndex(x => x[0] < custom.searchEnd);\n        if (targetIndex != -1) {\n          custom.inactivatedDevice = data[targetIndex][1];\n        } else {\n          custom.inactivatedDevice = data[data.length - 1][1];\n        }\n      }\n    }\n  }\n  custom.totalDevice -= custom.inactivatedDevice;\n  return result;\n}\n\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  let mainData = [0, 0];\n  for (let i = custom.searchStart; i < custom.searchEnd; i += DAY_MS) {\n    let acc = 0;\n    let targetArray = custom.mainData.filter(x => x[0] >= i && x[0] < i + DAY_MS).map(x => x[1]);\n    for (let j in targetArray) {\n      acc += targetArray[j];\n    }\n    mainData[0] += acc;\n  }\n  mainData[1] = mainData[0] / custom.totalDevice;\n  for (let i in $scope.cardList) {\n    if (mainData[i] > 1000000) {\n      $scope.cardList[i].value = _.round(mainData[i] / 1000000, 3);\n      $scope.cardList[i].unit = 'MWh';\n    } else if (mainData[i] > 1000) {\n      $scope.cardList[i].value = _.round(mainData[i] / 1000, 3);\n      $scope.cardList[i].unit = 'kWh';\n    } else {\n      $scope.cardList[i].value = _.round(mainData[i], 3);\n      $scope.cardList[i].unit = 'Wh';\n    }\n  }\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nconst SVG_ICON = [\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE3NDY5NCI+CiAgICAgICAgPGcgZGF0YS1uYW1lPSLqt7jro7kgMTc0NjkzIj4KICAgICAgICAgICAgPGcgZGF0YS1uYW1lPSLtjKjsiqQgODQ5NTkiIHN0eWxlPSJmaWxsOiNmNWY1ZjciPgogICAgICAgICAgICAgICAgPHBhdGggZD0iTTE4NzQzLjUgNDMzMi40OThoLTUuMDAydi00Ljk5OGg1LjAwMnY0Ljk5OHptLTggMGgtNC45OTh2LTQuOTk4aDQuOTk4djQuOTk4em04LTcuOTk3aC01LjAwMnYtNS4wMDJoNS4wMDJ2NS4wMDJ6bS04IDBoLTQuOTk4di01LjAwMmg0Ljk5OHY1LjAwMnoiIHN0eWxlPSJzdHJva2U6bm9uZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE4NzIwLjk5NiAtNDMxMC4wMDEpIi8+CiAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMTg3NDMgNDMzMS45OThWNDMyOGgtNC4wMDJ2My45OThoNC4wMDJtLTggMFY0MzI4aC0zLjk5OHYzLjk5OGgzLjk5OG04LTcuOTk3di00LjAwMmgtNC4wMDJWNDMyNGg0LjAwMm0tOCAwdi00LjAwMmgtMy45OThWNDMyNGgzLjk5OG05IDguOTk3aC02LjAwMlY0MzI3aDYuMDAydjUuOTk4em0tOCAwaC01Ljk5OFY0MzI3aDUuOTk4djUuOTk4em04LTcuOTk3aC02LjAwMnYtNi4wMDJoNi4wMDJWNDMyNXptLTggMGgtNS45OTh2LTYuMDAyaDUuOTk4VjQzMjV6IiBzdHlsZT0iZmlsbDojOWJhMmE4O3N0cm9rZTpub25lIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTg3MjAuOTk2IC00MzEwLjAwMSkiLz4KICAgICAgICAgICAgPC9nPgogICAgICAgICAgICA8cGF0aCBkYXRhLW5hbWU9Iu2MqOyKpCA4NDk1OCIgZD0iTTE4NzU0IDQzNDN2LTJoLTJ2MmgybS0yMCAwdi0yaC0ydjJoMm0yMC0yMHYtMmgtMnYyaDJtLTIwIDB2LTJoLTJ2MmgybTIxIDIxaC00di00aDR6bS0yMCAwaC00di00aDR6bTE1LTFoLTJ2LTJoMnptLTMgMGgtMnYtMmgyem0tMyAwaC0ydi0yaDJ6bS0zIDBoLTJ2LTJoMnptLTMgMGgtMnYtMmgyem0xNi00aC0ydi0yaDJ6bS0yMCAwaC0ydi0yaDJ6bTIwLTNoLTJ2LTJoMnptLTIwIDBoLTJ2LTJoMnptMjAtM2gtMnYtMmgyem0tMjAgMGgtMnYtMmgyem0yMC0zaC0ydi0yaDJ6bS0yMCAwaC0ydi0yaDJ6bTIwLTNoLTJ2LTJoMnptLTIwIDBoLTJ2LTJoMnptMjEtM2gtNHYtNGg0em0tMjAgMGgtNHYtNGg0em0xNS0xaC0ydi0yaDJ6bS0zIDBoLTJ2LTJoMnptLTMgMGgtMnYtMmgyem0tMyAwaC0ydi0yaDJ6bS0zIDBoLTJ2LTJoMnoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xODcyNi45OTYgLTQzMTYuMDAxKSIgc3R5bGU9ImZpbGw6I2VkNmQwMCIvPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+Cg==',\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE3NDYwNyI+CiAgICAgICAgPGcgZGF0YS1uYW1lPSLtjKjsiqQgODQ5NjAiIHN0eWxlPSJmaWxsOiNmNWY1ZjciPgogICAgICAgICAgICA8cGF0aCBkPSJNMTg3NDcuNTAyIDQzMzYuNWgtNS4wMDR2LTQuOTk5aDUuMDA0djQuOTk5em0tMTIuMDA0IDBoLTQuOTk4di00Ljk5OWg0Ljk5OHY0Ljk5OXptMTIuMDA0LTExLjk5OGgtNS4wMDR2LTUuMDA0aDUuMDA0djUuMDA0em0tMTIuMDA0IDBoLTQuOTk4di01LjAwNGg0Ljk5OHY1LjAwNHoiIHN0eWxlPSJzdHJva2U6bm9uZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE4NzIzIC00MzExLjk5OCkiLz4KICAgICAgICAgICAgPHBhdGggZD0iTTE4NzQ3LjAwMiA0MzM2di0zLjk5OWgtNC4wMDRWNDMzNmg0LjAwNG0tMTIuMDA0IDB2LTMuOTk5SDE4NzMxVjQzMzZoMy45OThtMTIuMDA0LTExLjk5OHYtNC4wMDRoLTQuMDA0djQuMDA0aDQuMDA0bS0xMi4wMDQgMHYtNC4wMDRIMTg3MzF2NC4wMDRoMy45OThtMTMuMDA0IDEyLjk5OGgtNi4wMDR2LTUuOTk5aDYuMDA0VjQzMzd6bS0xMi4wMDQgMEgxODczMHYtNS45OTloNS45OThWNDMzN3ptMTIuMDA0LTExLjk5OGgtNi4wMDR2LTYuMDA0aDYuMDA0djYuMDA0em0tMTIuMDA0IDBIMTg3MzB2LTYuMDA0aDUuOTk4djYuMDA0eiIgc3R5bGU9ImZpbGw6IzliYTJhODtzdHJva2U6bm9uZSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE4NzIzIC00MzExLjk5OCkiLz4KICAgICAgICA8L2c+CiAgICAgICAgPHBhdGggZGF0YS1uYW1lPSLtjKjsiqQgODQ5NjEiIGQ9Ik0xODc0NSA0MzM0di0yaC0ydjJoMm0wIDEzaC0ydi0yaDJ6bTAtM2gtMnYtMmgyem0wLTNoLTJ2LTJoMnptMC0zaC0ydi0yaDJ6bTEtM2gtNHYtNGg0em0xMi0xaC0ydi0yaDJ6bS0zIDBoLTJ2LTJoMnptLTMgMGgtMnYtMmgyem0tMyAwaC0ydi0yaDJ6bS04IDBoLTJ2LTJoMnptLTMgMGgtMnYtMmgyem0tMyAwaC0ydi0yaDJ6bS0zIDBoLTJ2LTJoMnptMTMtNGgtMnYtMmgyem0wLTNoLTJ2LTJoMnptMC0zaC0ydi0yaDJ6bTAtM2gtMnYtMmgyeiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE4NzI4IC00MzE3KSIgc3R5bGU9ImZpbGw6I2VkNmQwMCIvPgogICAgPC9nPgo8L3N2Zz4K',\n];\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":null},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.031478052278559154,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":1,\"history\":{\"historyType\":1,\"fixedTimewindow\":{\"startTimeMs\":1689087600000,\"endTimeMs\":1689174000000},\"interval\":173000},\"aggregation\":{\"type\":\"NONE\",\"limit\":50000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Total Usage\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":false,\"displayTimewindow\":false,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false}}"
      }
    },
    {
      "alias": "usage_details",
      "name": "Usage Details",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [
          {
            "url": "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"
          }
        ],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <section class=\"page-section\" fxLayoutAlign=\"end center\" fxLayoutGap=\"-1px\">\n        <div class=\"current-page\">{{currentPage}}</div>\n        <div class=\"material-icons page-button prev-button\" (click)=\"getPrevPage()\">keyboard_arrow_left</div>\n        <div class=\"material-icons page-button next-button\" (click)=\"getNextPage()\">keyboard_arrow_right</div>\n      </section>\n    </section>\n  </header>\n  <main class=\"widget-content\" fxLayoutAlign=\"space-between center\">\n    <section fxFlex=\"45\" class=\"chart-section\" fxLayout=\"column\" fxLayoutAlign=\"space-between stretch\" fxFlex.xs=\"100\">\n      <div class=\"chart-container\" fxFlex=\"5 1 80%\">\n        <canvas class=\"chart\"></canvas>\n      </div>\n      <div\n        class=\"legend-container\"\n        fxFlex=\"2 1 20%\"\n        fxLayout=\"row wrap\"\n        fxLayoutAlign=\"center center\"\n        fxLayoutGap=\"2em\"\n      >\n        <div class=\"legend-box\" *ngFor=\"let legend of legendList\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n          <div class=\"legend-circle\" [ngStyle]=\"{'color': legend.color}\"></div>\n          <div class=\"legend-label\">{{legend.label}}</div>\n          <div class=\"legend-value\">{{legend.value}}</div>\n        </div>\n      </div>\n    </section>\n    <section fxFlex=\"55\" class=\"table-section\" fxShow.xs=\"false\">\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n              <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <span class=\"th-label\">{{th.label}}</span>\n                <i class=\"th-sort material-icons\">arrow_upward</i>\n              </div>\n            </th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr *ngFor=\"let tr of trList\">\n            <td *ngFor=\"let td of tr.tdList\">\n              <span *ngIf=\"td.name != 'label'\">{{td.value}}</span>\n              <div class=\"td-state\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\" *ngIf=\"td.name == 'label'\">\n                <div class=\"td-state-color\" *ngIf=\"td.value != '-'\" [ngStyle]=\"{color: tr.color}\"></div>\n                <div class=\"td-state-label\">{{td.value}}</div>\n              </div>\n            </td>\n          </tr>\n        </tbody>\n      </table>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n/* page-section */\n.page-section .current-page {\n  font-size: 1.2em;\n  padding-right: 1em;\n  letter-spacing: 0.05em;\n  color: var(--tb-service-font-5);\n}\n.page-section .page-button {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 1.5em;\n  min-width: 20px;\n  height: 1.5em;\n  min-height: 20px;\n  font-size: 1.6em;\n  background-color: var(--tb-service-background-0);\n  border: 1px solid var(--tb-service-border-0);\n  cursor: pointer;\n  color: var(--tb-service-accent);\n  transition-property: border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.page-section .page-button:hover {\n  border: 1px solid var(--tb-service-accent-hover);\n  z-index: 1;\n}\n.page-section .page-button:active {\n  border: 1px solid var(--tb-service-accent-pressed);\n  z-index: 1;\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* chart-section */\n.chart-section {\n  width: 100%;\n  height: 100%;\n  padding: var(--tb-config-padding);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.chart-section .chart-container {\n  width: 100%;\n}\n.chart-section .legend-circle {\n  width: 0.6em;\n  height: 0.6em;\n  background-color: currentColor;\n}\n.chart-section .legend-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.chart-section .legend-value {\n  font-size: 1.2em;\n  font-weight: bold;\n  color: var(--tb-service-font-5);\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  height: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em 0.14em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: pre;\n  font-size: 1em;\n  line-height: 1;\n}\n.table-section th:first-child {\n  padding-left: 1.68em;\n}\n.table-section th:last-child {\n  padding-right: 1.68em;\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 0em 0.1em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n}\n.table-section td:first-child {\n  padding-left: 1.2em;\n}\n.table-section td:last-child {\n  padding-right: 1.2em;\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .td-state {\n  font-size: calc(1em / 1.4);\n}\n.table-section .td-state-color {\n  width: 0.8em;\n  height: 0.4em;\n  background-color: currentColor;\n}\n.table-section .td-state-label {\n  font-size: 1.4em;\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\nconst COLOR = [\n  '--tb-service-cold-line-0',\n  '--tb-service-cold-line-1',\n  '--tb-service-cold-line-2',\n  '--tb-service-cold-line-3',\n  '--tb-service-cold-line-4',\n];\n\nself.onInit = function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  self.ctx.timewindowFunctions.onUpdateTimewindow(custom.searchStart, custom.searchEnd);\n  linkEvent();\n  createDataset();\n  createChart();\n  makeHead();\n  makeBody();\n  self.onResize();\n  initPage();\n  custom.isInitialized = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (custom.isInitialized) {\n    custom.mainData = preprocessData();\n    sortData();\n    insertData();\n    custom.chart.update();\n  }\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$chart = $('.chart', $container);\n  custom.$table = $('.table', $container);\n  custom.$theadTr = $('.table thead tr', $container);\n  custom.$tbody = $('.table tbody', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.pageList = [];\n  $scope.legendList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).valueOf() + 1;\n  custom.selectedIndex = 0;\n  custom.currentPage = 1;\n  custom.countPerPage = 5;\n  custom.computedStyle = getComputedStyle($container[0]);\n  custom.chartLabels = [];\n  custom.chartData = [];\n  custom.t = t;\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.getPrevPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage--;\n      initPage();\n      insertData();\n      custom.chart.update();\n      self.ctx.detectChanges();\n    }\n  };\n  $scope.getNextPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage++;\n      initPage();\n      insertData();\n      custom.chart.update();\n      self.ctx.detectChanges();\n    }\n  };\n  $scope.changeSort = function (e, th) {\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    initPage();\n    sortData();\n    insertData();\n    custom.chart.update();\n    self.ctx.detectChanges();\n  };\n}\n\nfunction createDataset() {\n  let { custom } = self.ctx;\n  custom.dataSet = {\n    labels: custom.chartLabels,\n    datasets: [\n      {\n        label: '',\n        data: custom.chartData,\n        backgroundColor: [\n          getStyle(COLOR[0]),\n          getStyle(COLOR[1]),\n          getStyle(COLOR[2]),\n          getStyle(COLOR[3]),\n          getStyle(COLOR[4]),\n        ],\n        hoverBackgroundColor: [\n          getStyle(COLOR[0]),\n          getStyle(COLOR[1]),\n          getStyle(COLOR[2]),\n          getStyle(COLOR[3]),\n          getStyle(COLOR[4]),\n        ],\n        fill: true,\n        borderWidth: 0,\n        categoryPercentage: 0.15,\n      },\n    ],\n  };\n}\n\n// 차트생성\nfunction createChart() {\n  let { custom, $scope } = self.ctx;\n  custom.chart = new Chart(custom.$chart, {\n    type: 'horizontalBar',\n    data: custom.dataSet,\n    options: {\n      responsive: true,\n      maintainAspectRatio: false,\n      tooltips: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n        xPadding: custom.widgetFontSize,\n        yPadding: custom.widgetFontSize,\n        bodySpacing: custom.widgetFontSize * 0.9,\n        titleMarginBottom: custom.widgetFontSize,\n        callbacks: {\n          label: function (tooltipItem, data) {\n            let label = data.datasets[tooltipItem.datasetIndex].label || '';\n            if (label) {\n              label += ': ';\n            }\n            label += tooltipItem.xLabel + ' %';\n\n            return label;\n          },\n        },\n      },\n      hover: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n      },\n      legend: {\n        display: false,\n      },\n      scales: {\n        xAxes: [\n          {\n            display: true,\n            ticks: {\n              min: 0,\n              max: 100,\n              fontColor: getStyle('--tb-service-font-2'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n            },\n            gridLines: {\n              display: true,\n              color: getStyle('--tb-service-border-1'),\n              zeroLineColor: getStyle('--tb-service-border-1'),\n            },\n          },\n        ],\n        yAxes: [\n          {\n            display: true,\n            type: 'category',\n            ticks: {\n              fontColor: getStyle('--tb-service-font-5'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n              sampleSize: 10,\n            },\n            gridLines: {\n              display: false,\n            },\n          },\n        ],\n      },\n    },\n  });\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'rank',\n      label: t('thingplus.label.rank'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'label',\n      label: t('thingplus.label.device-name'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'totalPowerUsage',\n      label: t('thingplus.label.usage-with-unit'),\n      order: '',\n    },\n    {\n      index: 3,\n      key: 'totalPowerUsagePerHour',\n      label: t('thingplus.label.usage-hour-with-unit'),\n      order: '',\n    },\n    {\n      index: 4,\n      key: 'operationPowerUsagePerHour',\n      label: t('thingplus.label.usage-operation-with-unit'),\n      order: '',\n    },\n    {\n      index: 5,\n      key: 'workPowerUsagePerHour',\n      label: t('thingplus.label.usage-work-with-unit'),\n      order: '',\n    },\n    {\n      index: 6,\n      key: 'waitPowerUsagePerHour',\n      label: t('thingplus.label.usage-wait-with-unit'),\n      order: '',\n    },\n  ];\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  // 현재 페이지의 데이터 수 만큼 행 출력\n  for (let i = 0; i < custom.countPerPage; i++) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      color: getStyle(COLOR[i]),\n      tdList: tdList,\n    });\n  }\n}\n\n// 페이지에 맞는 데이터 출력 및 페이지 표시\nfunction initPage() {\n  let { custom, $scope } = self.ctx;\n  custom.totalPage = Math.ceil(custom.mainDatasources.length / custom.countPerPage);\n\n  custom.startIndex = (custom.currentPage - 1) * custom.countPerPage;\n  custom.endIndex = custom.currentPage * custom.countPerPage - 1;\n  // 끝 페이지가 데이터 소스의 길이보다 많으면 데이터 소스의 길이로 변경\n  if (custom.endIndex > custom.mainDatasources.length - 1) {\n    custom.endIndex = custom.mainDatasources.length - 1;\n  }\n  custom.targetDatasources = custom.mainDatasources.slice(custom.startIndex, custom.endIndex + 1);\n  $scope.currentPage = custom.currentPage + ' of ' + custom.totalPage;\n}\n\nfunction preprocessData() {\n  let { custom } = self.ctx;\n  let result = [];\n  for (let i in custom.mainDatasources) {\n    result.push({\n      id: custom.mainDatasources[i].entity.id,\n      name: custom.mainDatasources[i].entityName,\n      label: custom.mainDatasources[i].entityLabel,\n    });\n  }\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let entityId = target.datasource.entityId;\n      let name = target.dataKey.name;\n      let data = target.data;\n      let datasourceIndex = result.findIndex(x => x.id.id == entityId);\n      if (datasourceIndex !== -1) {\n        result[datasourceIndex][name] = data;\n      }\n    }\n  }\n  let totalPowerUsage = 0;\n  for (let i in result) {\n    result[i].totalPowerUsage = 0;\n    result[i].workTimeDay = 0;\n    result[i].waitTimeDay = 0;\n    result[i].workPowerUsage = 0;\n    result[i].waitPowerUsage = 0;\n    for (let j = custom.searchStart; j < custom.searchEnd; j += DAY_MS) {\n      if (result[i].TP_WorkTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WorkTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc += targetArray[k];\n        }\n        result[i].workTimeDay += acc;\n      }\n      if (result[i].TP_WaitTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc += targetArray[k];\n        }\n        result[i].waitTimeDay += acc;\n      }\n      if (result[i].TP_TotalPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_TotalPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].totalPowerUsage += acc;\n      }\n      if (result[i].TP_WorkPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WorkPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].workPowerUsage += acc;\n      }\n      if (result[i].TP_WaitPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].waitPowerUsage += acc;\n      }\n    }\n    result[i].totalPowerUsage = _.round(result[i].totalPowerUsage / 1000, 1) || 0;\n    result[i].totalPowerUsagePerHour = _.round(\n      result[i].totalPowerUsage / ((custom.searchEnd - custom.searchStart) / HOUR_MS),\n      1\n    );\n    result[i].workTimeDay = _.round(result[i].workTimeDay / HOUR_MS, 1);\n    result[i].operationPowerUsagePerHour = _.round(result[i].workPowerUsage / 1000 / result[i].workTimeDay, 1) || 0;\n    result[i].workPowerUsagePerHour = result[i].operationPowerUsagePerHour || 0;\n    result[i].waitTimeDay = _.round(result[i].waitTimeDay / HOUR_MS, 1);\n    result[i].waitPowerUsagePerHour = _.round(result[i].waitPowerUsage / 1000 / result[i].waitTimeDay, 1) || 0;\n\n    totalPowerUsage += result[i].totalPowerUsage;\n  }\n  result.sort((a, b) => {\n    if (a.totalPowerUsage > b.totalPowerUsage) return -1;\n    if (a.totalPowerUsage < b.totalPowerUsage) return 1;\n    return 0;\n  });\n  for (let i in result) {\n    result[i].rank = +i + 1;\n    result[i].percentage = _.round((result[i].totalPowerUsage / totalPowerUsage) * 100, 1);\n  }\n  let max = Math.max(...result.map(x => x.percentage));\n  if (isNaN(max)) {\n    max = 100;\n  }\n  custom.chart.options.scales.xAxes[0].ticks.max = max;\n  return result;\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  custom.chartLabels.length = 0;\n  custom.chartData.length = 0;\n  $scope.legendList.length = 0;\n  for (let i in $scope.trList) {\n    for (let j in $scope.trList[i].tdList) {\n      $scope.trList[i].tdList[j].value = '-';\n    }\n  }\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    custom.chartLabels.push(custom.mainData[i].label);\n    custom.chartData.push(custom.mainData[i].percentage);\n    $scope.legendList.push({\n      color: getStyle(COLOR[i - custom.startIndex]),\n      label: custom.mainData[i].label,\n      value: custom.mainData[i].percentage + '%',\n    });\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n\n      $scope.trList[i - custom.startIndex].tdList[j].value = data;\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  if (custom.chart) {\n    custom.chart.options.scales.xAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.scales.yAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.tooltips.xPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.yPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.bodySpacing = custom.widgetFontSize * 0.9;\n    custom.chart.options.tooltips.titleMarginBottom = custom.widgetFontSize;\n    custom.chart.resize();\n  }\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n\nfunction toDate(value) {\n  if (isNaN(Number(value))) return [0, 0];\n  let hour = Math.floor(value / 3600000);\n  let temp = value % 3600000;\n  let min = Math.floor(temp / 60000);\n  return [hour, min];\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":null},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.12387360100073619,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":1,\"history\":{\"historyType\":1,\"fixedTimewindow\":{\"startTimeMs\":1676905200000,\"endTimeMs\":1676991600000},\"interval\":173000},\"aggregation\":{\"type\":\"NONE\",\"limit\":50000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Usage Details\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":false,\"displayTimewindow\":false,\"showTitleIcon\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false},\"titleTooltip\":\"\"}"
      }
    },
    {
      "alias": "total_report",
      "name": "Total Report",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n              <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <span class=\"th-label\">{{th.label}}</span>\n                <i class=\"th-sort material-icons\">arrow_upward</i>\n              </div>\n            </th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr *ngFor=\"let tr of trList\">\n            <td *ngFor=\"let td of tr.tdList\">{{td.value}}</td>\n          </tr>\n        </tbody>\n        <tfoot>\n          <tr>\n            <td colspan=\"2\">합계</td>\n            <td *ngFor=\"let tfoot of tfootList\" [innerHTML]=\"tfoot.value\"></td>\n          </tr>\n        </tfoot>\n      </table>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section tbody td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.2em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section tfoot tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tfoot tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tfoot tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section tfoot td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.2em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section tfoot tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n\n.table-section tfoot b {\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  self.ctx.timewindowFunctions.onUpdateTimewindow(custom.searchStart, custom.searchEnd);\n  linkEvent();\n  makeHead();\n  makeBody();\n  makeFoot();\n  self.onResize();\n  custom.attributes = await getAttribute();\n  custom.isInitialized = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (custom.isInitialized) {\n    custom.mainData = preprocessData();\n    sortData();\n    insertData();\n  }\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$table = $('.table', $container);\n  custom.$theadTr = $('.table thead tr', $container);\n  custom.$tbody = $('.table tbody', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).endOf('day').valueOf() + 1;\n  custom.selectedIndex = 0;\n  custom.t = t;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    sortData();\n    insertData();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'customerL2Name',\n      label: t('thingplus.label.customerL2-name'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'label',\n      label: t('thingplus.label.device-name'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'plannedWorkTime',\n      label: t('thingplus.label.planned-time'),\n      order: '',\n    },\n    {\n      index: 3,\n      key: 'operationTime',\n      label: t('thingplus.label.operation-time'),\n      order: '',\n    },\n    {\n      index: 4,\n      key: 'workingTime',\n      label: t('thingplus.label.working-time'),\n      order: '',\n    },\n    {\n      index: 5,\n      key: 'trialTime',\n      label: t('thingplus.label.trial-time'),\n      order: '',\n    },\n    {\n      index: 6,\n      key: 'waitingTime',\n      label: t('thingplus.label.waiting-time'),\n      order: '',\n    },\n    {\n      index: 7,\n      key: 'etcTime',\n      label: t('thingplus.label.etc-time'),\n      order: '',\n    },\n    {\n      index: 8,\n      key: 'operationRatio',\n      label: t('thingplus.label.operation-rate-with-unit'),\n      order: '',\n    },\n    {\n      index: 9,\n      key: 'powerUsage',\n      label: t('thingplus.label.usage-with-unit'),\n      order: '',\n    },\n  ];\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  // 현재 페이지의 데이터 수 만큼 행 출력\n  for (i in custom.mainDatasources) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\nfunction makeFoot() {\n  let { custom, $scope } = self.ctx;\n  $scope.tfootList = $scope.thList.slice(2).map(x => {\n    return {\n      key: x.key,\n      value: '',\n    };\n  });\n}\n\nfunction getAttribute() {\n  let { custom } = self.ctx;\n  return new Promise(resolve => {\n    let observables = [];\n    for (let i in custom.mainDatasources) {\n      observables.push(\n        self.ctx.attributeService.getEntityAttributes(custom.mainDatasources[i].entity.id, 'SERVER_SCOPE', [\n          'customerL2Name',\n        ])\n      );\n    }\n    self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n      resolve(datas);\n    });\n  });\n}\n\nfunction preprocessData() {\n  let { custom, $scope } = self.ctx;\n  let result = [];\n  for (let i in custom.mainDatasources) {\n    result.push({\n      id: custom.mainDatasources[i].entity.id,\n      name: custom.mainDatasources[i].entityName,\n      label: custom.mainDatasources[i].entityLabel,\n      customerL2Name: custom.attributes[i][0] ? custom.attributes[i][0].value : '-',\n    });\n  }\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let entityId = target.datasource.entityId;\n      let name = target.dataKey.name;\n      let data = target.data;\n      let datasourceIndex = result.findIndex(x => x.id.id == entityId);\n      if (datasourceIndex !== -1) {\n        result[datasourceIndex][name] = data;\n      }\n    }\n  }\n  let total = {};\n  for (let i in $scope.tfootList) {\n    total[$scope.tfootList[i].key] = 0;\n  }\n\n  for (let i in result) {\n    for (let j in $scope.tfootList) {\n      result[i][$scope.tfootList[j].key] = 0;\n    }\n\n    for (let j = custom.searchStart; j < custom.searchEnd; j += DAY_MS) {\n      let acc = 0;\n      if (result[i].TP_PlannedWorkTimeDay) {\n        let targetArray = result[i].TP_PlannedWorkTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].plannedWorkTime += acc;\n      }\n      if (result[i].TP_WorkTimeDay) {\n        let targetArray = result[i].TP_WorkTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].operationTime += acc;\n      }\n      if (result[i].TP_WaitTimeDay) {\n        let targetArray = result[i].TP_WaitTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].waitingTime += acc;\n      }\n      if (result[i].TP_TotalPowerUsageDay) {\n        let targetArray = result[i].TP_TotalPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].powerUsage += acc;\n      }\n    }\n\n    result[i].workingTime = result[i].operationTime;\n    if (result[i].TP_ModifiedState) {\n      console.log(result[i].TP_ModifiedState);\n    }\n    result[i].powerUsage = result[i].powerUsage / 1000;\n    result[i].operationRatio = _.round((result[i].operationTime / result[i].plannedWorkTime) * 100, 1) || 0;\n\n    total.plannedWorkTime += result[i].plannedWorkTime;\n    total.operationTime += result[i].operationTime;\n    total.workingTime += result[i].workingTime;\n    total.trialTime += result[i].trialTime;\n    total.waitingTime += result[i].waitingTime;\n    total.etcTime += result[i].etcTime;\n    total.powerUsage += result[i].powerUsage;\n\n    for (let j in $scope.tfootList) {\n      if ($scope.tfootList[j].key != 'operationRatio') {\n        result[i][$scope.tfootList[j].key] = toTime(result[i][$scope.tfootList[j].key] / 1000);\n      }\n    }\n  }\n\n  for (let i in total) {\n    let targetIndex = $scope.tfootList.findIndex(x => x.key == i);\n    if (targetIndex !== -1) {\n      if (i == 'operationRatio') {\n        $scope.tfootList[targetIndex].value = '-';\n      } else {\n        $scope.tfootList[targetIndex].value = toStringTime(total[i] / 1000);\n      }\n    }\n  }\n\n  return result;\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  for (let i in $scope.trList) {\n    for (let j in $scope.trList[i].tdList) {\n      $scope.trList[i].tdList[j].value = '-';\n    }\n  }\n  for (let i in custom.mainData) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n      $scope.trList[i].tdList[j].value = data;\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction toStringTime(value) {\n  let hour = Math.floor(value / 3600);\n  let minute = Math.floor((value % 3600) / 60);\n  return t('thingplus.time-format.hm-acc-em', { hour, minute });\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":null},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.9606224457303985,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":1,\"history\":{\"historyType\":1,\"fixedTimewindow\":{\"startTimeMs\":1691074800000,\"endTimeMs\":1691161200000},\"interval\":173000},\"aggregation\":{\"type\":\"NONE\",\"limit\":50000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Total Report\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":false,\"displayTimewindow\":false,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false}}"
      }
    },
    {
      "alias": "work_report",
      "name": "Work Report",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-action\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n        <div\n          class=\"widget-header-action\"\n          *ngFor=\"let headerAction of headerActionList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (click)=\"headerAction.action($event)\"\n        >\n          <i class=\"material-icons\">{{headerAction.icon}}</i>\n        </div>\n      </div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <div class=\"table thead\">\n        <div class=\"tr\">\n          <div class=\"th\" *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n            <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n              <span class=\"th-label\">{{th.label}}</span>\n              <i class=\"th-sort material-icons\">arrow_upward</i>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"table tbody\">\n        <div class=\"tr\" *ngFor=\"let tr of trList\">\n          <div class=\"td\" *ngFor=\"let td of tr.tdList\"><span>{{td.value}}</span></div>\n        </div>\n      </div>\n      <div class=\"table tfoot\">\n        <div class=\"tr\">\n          <div class=\"td\" colspan=\"1\"><span>합계</span></div>\n          <div class=\"td\" *ngFor=\"let tfoot of tfootList\"><span [innerHTML]=\"tfoot.value\"></span></div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n.widget-header-right-section .widget-header-action {\n  padding: 0.6em;\n  padding-right: 0;\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .widget-header-action i {\n  font-size: 2em;\n  font-weight: bold;\n}\n.widget-header-right-section .widget-header-action:hover {\n  color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .widget-header-action:active {\n  color: var(--tb-service-accent-pressed);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow-x: auto;\n  overflow-y: hidden;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  width: 100%;\n  min-width: 100em;\n  box-sizing: border-box;\n  white-space: nowrap;\n}\n.table-section .tr {\n  width: 100%;\n  display: flex;\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .tbody .tr:last-child {\n  border-bottom: none;\n}\n.table-section .th,\n.table-section .td {\n  flex: 1 1 auto;\n  width: 15em;\n}\n.table-section .th:first-child,\n.table-section .td:first-child {\n  width: 25em;\n}\n.table-section .thead {\n  overflow-y: scroll;\n}\n.table-section .thead::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n  background-color: var(--tb-service-background-1);\n}\n.table-section .thead::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .thead::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .thead .tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section .th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section .th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section .th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section .th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section .tbody {\n  overflow-y: scroll;\n}\n.table-section .tbody::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section .tbody::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tbody::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tbody .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tbody .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tbody .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tbody .td span {\n  font-size: 1.4em;\n}\n.table-section .tbody .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .tfoot {\n  overflow-y: scroll;\n}\n.table-section .tfoot::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tfoot .tr {\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tfoot .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tfoot .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .td span {\n  font-size: 1.4em;\n}\n.table-section .tfoot .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n\n.table-section .tfoot b {\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  linkEvent();\n  makeHead();\n\n  if (!custom.isSample) {\n    let loadedInitialData = await loadInitialData();\n    let loadedData = await loadData();\n    custom.mainData = preprocessData(loadedInitialData, loadedData);\n  }\n\n  makeBody();\n  makeFoot();\n  insertData();\n  resize();\n  self.ctx.detectChanges();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$thead = $('.thead', $container);\n  custom.$tbody = $('.tbody', $container);\n  custom.$tfoot = $('.tfoot', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasource = custom.mainDatasources[0];\n  let now = moment().valueOf();\n  custom.startTs = moment(now).startOf('month').valueOf();\n  custom.endTs = now;\n  custom.dateGroup = 'DAY';\n  custom.selectedIndex = 0;\n  custom.t = t;\n  custom.mainData = [];\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.startTs = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.endTs = custom.dashboardParams.endTs;\n    }\n    if (custom.dashboardParams.dateGroup) {\n      custom.dateGroup = custom.dashboardParams.dateGroup;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    sortData();\n    insertData();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'dateRange',\n      label: t('thingplus.label.date-range'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'operationTime',\n      label: t('thingplus.label.operation-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 2,\n      key: 'workingTime',\n      label: t('thingplus.label.working-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 3,\n      key: 'trialTime',\n      label: t('thingplus.label.trial-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 4,\n      key: 'waitingTime',\n      label: t('thingplus.label.waiting-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 5,\n      key: 'operationRatio',\n      label: t('thingplus.label.operation-rate-with-unit'),\n      order: '',\n      formatter: d => {\n        return _.round(d * 100, 1);\n      },\n    },\n  ];\n}\n\nfunction loadInitialData() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'TP_AnalysisState';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=1&agg=NONE&keys=${key}&startTs=0&endTs=${custom.startTs}&useStrictDataTypes=true&orderBy=ASC`\n      )\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction loadData() {\n  let { custom, $scope } = self.ctx;\n  let entityId = custom.targetDatasource.entity.id;\n  let key = 'TP_AnalysisState,TP_PlannedWorkTimeDay';\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.http\n        .get(\n          `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=50000&agg=NONE&keys=${key}&startTs=${custom.startTs}&endTs=${custom.endTs}&useStrictDataTypes=true&orderBy=ASC`\n        )\n        .subscribe(datas => {\n          resolve(datas);\n        });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction preprocessData(loadedInitialData, loadedData) {\n  let { custom, $scope } = self.ctx;\n  let result = [];\n  let analysisState = [];\n  let plannedWorkTimeDay = loadedData.TP_PlannedWorkTimeDay;\n  if (loadedInitialData.TP_AnalysisState) {\n    loadedInitialData.TP_AnalysisState[0].ts = custom.startTs;\n    analysisState = analysisState.concat(loadedInitialData.TP_AnalysisState);\n  }\n  if (loadedData.TP_AnalysisState) {\n    analysisState = analysisState.concat(loadedData.TP_AnalysisState);\n  }\n  analysisState = _.orderBy(analysisState, ['ts'], ['asc']);\n  // analysisState 를 기간별로 구분하기\n\n  let startTs = moment(custom.startTs).valueOf();\n  let endTs = moment(custom.endTs).valueOf();\n  let lastState = analysisState[0].value;\n  while (startTs < endTs) {\n    let newObj = {\n      dateRange: '-',\n      operationTime: 0,\n      workingTime: 0,\n      trialTime: 0,\n      waitingTime: 0,\n      operationRatio: 0,\n    };\n    let targetEnd = moment(startTs).add(1, 'day').valueOf();\n    if (custom.dateGroup == 'DAY') {\n      targetEnd = moment(startTs).add(1, 'day').valueOf();\n      newObj.dateRange = moment(startTs).format('YYYY-MM-DD');\n    } else if (custom.dateGroup == 'WEEK') {\n      targetEnd = moment(startTs).add(1, 'week').valueOf();\n      newObj.dateRange =\n        moment(startTs).format('YYYY-MM-DD') + ' ~ ' + moment(startTs + 6 * DAY_MS).format('YYYY-MM-DD');\n    } else if (custom.dateGroup == 'MONTH') {\n      targetEnd = moment(startTs).add(1, 'month').valueOf();\n      newObj.dateRange = moment(startTs).format('YYYY-MM');\n    }\n\n    let tempPlannedWorkTimeDay = plannedWorkTimeDay.filter(d => {\n      return d.ts >= startTs && d.ts < targetEnd;\n    });\n    let tempAnalysisState = [];\n    for (let i = 0; i < analysisState.length; i++) {\n      if (analysisState[i].ts >= startTs && analysisState[i].ts < targetEnd) {\n        lastState = analysisState[i].value;\n        tempAnalysisState.push(analysisState[i]);\n      }\n      if (analysisState[i].ts < startTs && analysisState[i + 1] && analysisState[i + 1].ts > startTs) {\n        let newState = _.cloneDeep(analysisState[i]);\n        newState.ts = startTs;\n        lastState = analysisState[i].value;\n        tempAnalysisState.push(newState);\n      }\n    }\n    if (tempAnalysisState.length == 0) {\n      tempAnalysisState.push({\n        ts: startTs,\n        value: lastState,\n      });\n    }\n    for (let i = 0; i < tempAnalysisState.length; i++) {\n      // 대기, 작업, 시운전인 경우\n      if (tempAnalysisState[i].value == '1' || tempAnalysisState[i].value == '2' || tempAnalysisState[i].value == '3') {\n        let start = tempAnalysisState[i].ts;\n        let end = custom.endTs;\n        // 변화한 데이터로 구성되므로 다음 데이터는 항상 전과 다른 상태 (기존 상태가 끝난 시점)\n        if (!_.isNil(tempAnalysisState[i + 1])) {\n          end = tempAnalysisState[i + 1].ts;\n        } else {\n          // 분석이 매 시간 0분에 진행되므로 조회 마지막 날이 오늘이면 현재시간의 0분까지로 설정\n          end = targetEnd;\n          if (\n            moment(end - 1)\n              .startOf('day')\n              .valueOf() == moment().startOf('day').valueOf()\n          ) {\n            end = moment().startOf().valueOf();\n          }\n        }\n        if (tempAnalysisState[i].value == '1') {\n          newObj.waitingTime += end - start;\n        }\n        if (tempAnalysisState[i].value == '2' || tempAnalysisState[i].value == '3') {\n          newObj.operationTime += end - start;\n        }\n        if (tempAnalysisState[i].value == '2') {\n          newObj.workingTime += end - start;\n        }\n        if (tempAnalysisState[i].value == '3') {\n          newObj.trialTime += end - start;\n        }\n      }\n    }\n\n    let plannedWorkTime = 0;\n    for (let i in tempPlannedWorkTimeDay) {\n      plannedWorkTime += tempPlannedWorkTimeDay[i].value;\n    }\n\n    if (plannedWorkTime != 0) {\n      newObj.operationRatio = newObj.operationTime / plannedWorkTime;\n    } else {\n      newObj.operationRatio = 0;\n    }\n\n    result.push(newObj);\n\n    if (custom.dateGroup == 'DAY') {\n      startTs = moment(startTs).add(1, 'day').valueOf();\n    } else if (custom.dateGroup == 'WEEK') {\n      startTs = moment(startTs).add(1, 'week').valueOf();\n    } else if (custom.dateGroup == 'MONTH') {\n      startTs = moment(startTs).add(1, 'month').valueOf();\n    }\n  }\n\n  return result;\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n\n  let start = moment(custom.startTs);\n  let end = moment(custom.endTs);\n  while (start.valueOf() < end.valueOf()) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      tdList: tdList,\n    });\n    if (custom.dateGroup == 'DAY') {\n      start = start.add(1, 'day');\n    } else if (custom.dateGroup == 'WEEK') {\n      start = start.add(1, 'week');\n    } else if (custom.dateGroup == 'MONTH') {\n      start = start.add(1, 'month');\n    }\n  }\n}\n\nfunction makeFoot() {\n  let { custom, $scope } = self.ctx;\n  $scope.tfootList = $scope.thList.slice(1).map(x => {\n    return {\n      key: x.key,\n      value: '',\n    };\n  });\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  let total = {};\n  for (let i in $scope.tfootList) {\n    total[$scope.tfootList[i].key] = 0;\n  }\n\n  for (let i in custom.mainData) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n      $scope.trList[i].tdList[j].value = data;\n      if ($scope.thList[j].formatter) {\n        $scope.trList[i].tdList[j].value = $scope.thList[j].formatter(data);\n      }\n\n      // 만약 키가 tfootList에 존재한다면 total에 더해줌\n      if (total[key] !== undefined) {\n        total[key] += data;\n      }\n    }\n  }\n\n  for (let i in total) {\n    let targetIndex = $scope.tfootList.findIndex(x => x.key == i);\n    if (targetIndex !== -1) {\n      if (i != 'operationRatio') {\n        $scope.tfootList[targetIndex].value = toStringTime(total[i] / 1000);\n      } else {\n        $scope.tfootList[targetIndex].value = _.round((total[i] * 100) / custom.mainDatasources.length, 1);\n      }\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  let theadHeight = custom.$thead.outerHeight(true);\n  let tfootHeight = custom.$tfoot.outerHeight(true);\n  custom.$tbody.css('max-height', `calc(100% - ${theadHeight + tfootHeight}px)`);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction toStringTime(value) {\n  let hour = Math.floor(value / 3600);\n  let minute = Math.floor((value % 3600) / 60);\n  return t('thingplus.time-format.hm-acc-em', { hour, minute });\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainDatasources[0].entity.id,\n    custom.mainDatasources[0].entityName,\n    {},\n    custom.mainDatasources[0].entityLabel\n  );\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"First\",\"color\":\"#2196f3\",\"settings\":{\"showLines\":true,\"fillLines\":true,\"showPoints\":false},\"_hash\":0.8587686344902596,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Second\",\"color\":\"#ffc107\",\"settings\":{\"showLines\":true,\"fillLines\":false,\"showPoints\":false},\"_hash\":0.12775350966079668,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.7219388570037923,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Work Report\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":true,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false}}"
      }
    },
    {
      "alias": "delay_report",
      "name": "Delay Report",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-action\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n        <div\n          class=\"widget-header-action\"\n          *ngFor=\"let headerAction of headerActionList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (click)=\"headerAction.action($event)\"\n        >\n          <i class=\"material-icons\">{{headerAction.icon}}</i>\n        </div>\n      </div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <div class=\"table thead\">\n        <div class=\"tr\">\n          <div class=\"th\" *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n            <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n              <span class=\"th-label\">{{th.label}}</span>\n              <i class=\"th-sort material-icons\">arrow_upward</i>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"table tbody\">\n        <div class=\"tr\" *ngFor=\"let tr of trList\">\n          <div class=\"td\" *ngFor=\"let td of tr.tdList\"><span>{{td.value}}</span></div>\n        </div>\n      </div>\n      <div class=\"table tfoot\">\n        <div class=\"tr\">\n          <div class=\"td\" colspan=\"2\"><span>합계</span></div>\n          <div class=\"td\" *ngFor=\"let tfoot of tfootList\"><span [innerHTML]=\"tfoot.value\"></span></div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n.widget-header-right-section .widget-header-action {\n  padding: 0.6em;\n  padding-right: 0;\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .widget-header-action i {\n  font-size: 2em;\n  font-weight: bold;\n}\n.widget-header-right-section .widget-header-action:hover {\n  color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .widget-header-action:active {\n  color: var(--tb-service-accent-pressed);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow-x: auto;\n  overflow-y: hidden;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  width: 100%;\n  min-width: 100em;\n  box-sizing: border-box;\n  white-space: nowrap;\n}\n.table-section .tr {\n  width: 100%;\n  display: flex;\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .tbody .tr:last-child {\n  border-bottom: none;\n}\n.table-section .th,\n.table-section .td {\n  width: 25em;\n  flex: 1 1 25%;\n}\n.table-section .tfoot .td:first-child {\n  width: 50em;\n  flex: 1 1 50%;\n}\n.table-section .thead {\n  overflow-y: scroll;\n}\n.table-section .thead::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n  background-color: var(--tb-service-background-1);\n}\n.table-section .thead::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .thead::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .thead .tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section .th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section .th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section .th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section .th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section .tbody {\n  overflow-y: scroll;\n}\n.table-section .tbody::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section .tbody::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tbody::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tbody .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tbody .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tbody .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tbody .td span {\n  font-size: 1.4em;\n}\n.table-section .tbody .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .tfoot {\n  overflow-y: scroll;\n}\n.table-section .tfoot::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tfoot .tr {\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tfoot .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tfoot .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .td {\n  font-size: 1.4em;\n}\n.table-section .tfoot .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n\n.table-section .tfoot b {\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  linkEvent();\n  makeHead();\n\n  if (!custom.isSample) {\n    let loadedData = await loadData();\n    custom.mainData = preprocessData(loadedData);\n  }\n\n  sortData();\n  makeBody();\n  makeFoot();\n  insertData();\n  self.ctx.detectChanges();\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$thead = $('.thead', $container);\n  custom.$tbody = $('.tbody', $container);\n  custom.$tfoot = $('.tfoot', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasource = custom.mainDatasources[0];\n  let now = moment().valueOf();\n  custom.startTs = moment(now).startOf('month').valueOf();\n  custom.endTs = now;\n  custom.selectedIndex = 0;\n  custom.t = t;\n  custom.mainData = [];\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.startTs = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.endTs = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    sortData();\n    insertData();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'waitStart',\n      label: t('thingplus.label.wait-start'),\n      order: 'ASC',\n      formatter: d => {\n        return moment(d).format('YYYY-MM-DD HH:mm:ss');\n      },\n    },\n    {\n      index: 1,\n      key: 'waitEnd',\n      label: t('thingplus.label.wait-end'),\n      order: '',\n      formatter: d => {\n        return moment(d).format('YYYY-MM-DD HH:mm:ss');\n      },\n    },\n    {\n      index: 2,\n      key: 'waitingTime',\n      label: t('thingplus.label.waiting-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 3,\n      key: 'powerUsage',\n      label: t('thingplus.label.usage-with-unit-2'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n  ];\n}\n\nfunction loadData() {\n  let { custom, $scope } = self.ctx;\n  let entityId = custom.targetDatasource.entity.id;\n  let key = 'TP_AnalysisState,TP_TotalPowerUsageRaw';\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.http\n        .get(\n          `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=50000&agg=NONE&keys=${key}&startTs=${custom.startTs}&endTs=${custom.endTs}&useStrictDataTypes=true&orderBy=ASC`\n        )\n        .subscribe(datas => {\n          resolve(datas);\n        });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  for (let i in custom.mainData) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\nfunction makeFoot() {\n  let { custom, $scope } = self.ctx;\n  $scope.tfootList = $scope.thList.slice(2).map(x => {\n    return {\n      key: x.key,\n      value: '',\n    };\n  });\n}\n\nfunction preprocessData(loadedData) {\n  let { custom, $scope } = self.ctx;\n  let result = [];\n\n  if (_.isNil(loadedData.TP_AnalysisState)) return [];\n  // TP_AnalysisState 상태값에 따라서 데이터 행 생성\n  for (let i = 0; i < loadedData.TP_AnalysisState.length; i++) {\n    // 대기 상태인 경우만 조회\n    if (loadedData.TP_AnalysisState[i].value == '1') {\n      let newObj = {\n        waitStart: loadedData.TP_AnalysisState[i].ts,\n        waitEnd: '',\n        waitingTime: 0,\n        powerUsage: 0,\n      };\n      // 변화한 데이터로 구성되므로 다음 데이터는 항상 대기가 아닌 상태 (곧 대기가 끝난 상태)\n      if (!_.isNil(loadedData.TP_AnalysisState[i + 1])) {\n        newObj.waitEnd = loadedData.TP_AnalysisState[i + 1].ts;\n      } else {\n        // 분석이 매 시간 0분에 진행되고 미래시간 1시간을 margin으로 가지므로 조회 마지막 날이 오늘이면 현재시간의 1시간전 0분까지로 설정 (1 ~ 2시간의 데이터가 없으므로)\n        newObj.waitEnd = custom.endTs;\n        if (moment(custom.endTs).startOf('day').valueOf() == moment().startOf('day').valueOf()) {\n          newObj.waitEnd = moment().subtract(1, 'hours').startOf('hour').valueOf();\n        }\n      }\n      newObj.waitingTime = newObj.waitEnd - newObj.waitStart;\n      result.push(newObj);\n    }\n  }\n\n  // TP_TotalPowerUsageRaw 데이터를 통해 전력 사용량 계산\n  for (let i in result) {\n    for (let j = 0; j < loadedData.TP_TotalPowerUsageRaw.length; j++) {\n      if (\n        result[i].waitStart <= loadedData.TP_TotalPowerUsageRaw[j].ts &&\n        loadedData.TP_TotalPowerUsageRaw[j].ts < result[i].waitEnd\n      ) {\n        result[i].powerUsage += loadedData.TP_TotalPowerUsageRaw[j].value;\n      }\n    }\n  }\n  return result;\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  let total = {};\n  for (let i in $scope.tfootList) {\n    total[$scope.tfootList[i].key] = 0;\n  }\n\n  for (let i in custom.mainData) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n      $scope.trList[i].tdList[j].value = $scope.thList[j].formatter(data);\n      // 만약 키가 tfootList에 존재한다면 total에 더해줌\n      if (total[key] !== undefined) {\n        total[key] += data;\n      }\n    }\n  }\n\n  for (let i in total) {\n    let targetIndex = $scope.tfootList.findIndex(x => x.key == i);\n    if (targetIndex !== -1) {\n      if (i == 'waitingTime') {\n        $scope.tfootList[targetIndex].value = toStringTime(total[i] / 1000);\n      } else {\n        $scope.tfootList[targetIndex].value = _.round(total[i] / 1000, 1) + ' kWh';\n      }\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  let theadHeight = custom.$thead.outerHeight(true);\n  let tfootHeight = custom.$tfoot.outerHeight(true);\n  custom.$tbody.css('max-height', `calc(100% - ${theadHeight + tfootHeight}px)`);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction toStringTime(value) {\n  let hour = Math.floor(value / 3600);\n  let minute = Math.floor((value % 3600) / 60);\n  return t('thingplus.time-format.hm-acc-em', { hour, minute });\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainDatasources[0].entity.id,\n    custom.mainDatasources[0].entityName,\n    {},\n    custom.mainDatasources[0].entityLabel\n  );\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"First\",\"color\":\"#2196f3\",\"settings\":{\"showLines\":true,\"fillLines\":true,\"showPoints\":false},\"_hash\":0.8587686344902596,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Second\",\"color\":\"#ffc107\",\"settings\":{\"showLines\":true,\"fillLines\":false,\"showPoints\":false},\"_hash\":0.12775350966079668,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.3363904951325092,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Delay Report\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false},\"useDashboardTimewindow\":true}"
      }
    },
    {
      "alias": "total_work_report",
      "name": "Total Work Report",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-action\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n        <div\n          class=\"widget-header-action\"\n          *ngFor=\"let headerAction of headerActionList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (click)=\"headerAction.action($event)\"\n        >\n          <i class=\"material-icons\">{{headerAction.icon}}</i>\n        </div>\n      </div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <div class=\"table thead\">\n        <div class=\"tr\">\n          <div class=\"th\" *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n            <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n              <span class=\"th-label\">{{th.label}}</span>\n              <i class=\"th-sort material-icons\">arrow_upward</i>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"table tbody\">\n        <div class=\"tr\" *ngFor=\"let tr of trList\">\n          <div class=\"td\" *ngFor=\"let td of tr.tdList\"><span>{{td.value}}</span></div>\n        </div>\n      </div>\n      <div class=\"table tfoot\">\n        <div class=\"tr\">\n          <div class=\"td\" colspan=\"2\"><span>합계</span></div>\n          <div class=\"td\" *ngFor=\"let tfoot of tfootList\"><span [innerHTML]=\"tfoot.value\"></span></div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n.widget-header-right-section .widget-header-action {\n  padding: 0.6em;\n  padding-right: 0;\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .widget-header-action i {\n  font-size: 2em;\n  font-weight: bold;\n}\n.widget-header-right-section .widget-header-action:hover {\n  color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .widget-header-action:active {\n  color: var(--tb-service-accent-pressed);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow-x: auto;\n  overflow-y: hidden;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  width: 100%;\n  min-width: 100em;\n  box-sizing: border-box;\n  white-space: nowrap;\n}\n.table-section .tr {\n  width: 100%;\n  display: flex;\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .tbody .tr:last-child {\n  border-bottom: none;\n}\n.table-section .th,\n.table-section .td {\n  flex: 1 1 20%;\n  width: 20em;\n}\n.table-section .tfoot .td:first-child {\n  flex: 1 1 40%;\n  width: 40em;\n}\n.table-section .thead {\n  overflow-y: scroll;\n}\n.table-section .thead::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n  background-color: var(--tb-service-background-1);\n}\n.table-section .thead::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .thead::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .thead .tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section .th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section .th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section .th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section .th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section .tbody {\n  overflow-y: scroll;\n}\n.table-section .tbody::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section .tbody::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tbody::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tbody .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tbody .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tbody .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tbody .td span {\n  font-size: 1.4em;\n}\n.table-section .tbody .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .tfoot {\n  overflow-y: scroll;\n}\n.table-section .tfoot::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tfoot .tr {\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tfoot .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tfoot .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .td {\n  font-size: 1.4em;\n}\n.table-section .tfoot .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n\n.table-section .tfoot b {\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  linkEvent();\n  makeHead();\n\n  if (!custom.isSample) {\n    let loadedAttribute = await loadAttribute();\n    let loadedInitialData = await loadInitialData();\n    let loadedData = await loadData();\n    custom.mainData = preprocessData(loadedAttribute, loadedInitialData, loadedData);\n  }\n  sortData();\n  makeBody();\n  makeFoot();\n  insertData();\n  self.onResize();\n  self.ctx.detectChanges();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$thead = $('.thead', $container);\n  custom.$tbody = $('.tbody', $container);\n  custom.$tfoot = $('.tfoot', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  let now = moment().valueOf();\n  custom.startTs = moment(now).startOf('month').valueOf();\n  custom.endTs = now;\n  custom.selectedIndex = 0;\n  custom.t = t;\n  custom.mainData = [];\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.startTs = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.endTs = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    sortData();\n    insertData();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'customerL2Name',\n      label: t('thingplus.label.customerL2-name'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'deviceName',\n      label: t('thingplus.label.device-name'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'operationTime',\n      label: t('thingplus.label.operation-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 3,\n      key: 'waitingTime',\n      label: t('thingplus.label.waiting-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 4,\n      key: 'operationRatio',\n      label: t('thingplus.label.operation-rate-with-unit'),\n      order: '',\n      formatter: d => {\n        return _.round(d, 1);\n      },\n    },\n  ];\n}\n\nfunction loadAttribute() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'customerL2Name';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(`/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/attributes?keys=${key}`)\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction loadInitialData() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'TP_AnalysisState';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=1&agg=NONE&keys=${key}&startTs=0&endTs=${custom.startTs}&useStrictDataTypes=true&orderBy=ASC`\n      )\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction loadData() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'TP_AnalysisState,TP_PlannedWorkTimeDay';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=50000&agg=NONE&keys=${key}&startTs=${custom.startTs}&endTs=${custom.endTs}&useStrictDataTypes=true&orderBy=ASC`\n      )\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction preprocessData(loadedAttribute, loadedInitialData, loadedData) {\n  let { custom, $scope } = self.ctx;\n  let result = [];\n\n  // 데이터 정리\n  let analysisState = [];\n  let plannedWorkTimeDay = [];\n  for (let i in custom.mainDatasources) {\n    if (_.isNil(analysisState[i])) {\n      analysisState[i] = [];\n    }\n    if (loadedInitialData[i].TP_AnalysisState) {\n      loadedInitialData[i].TP_AnalysisState[0].ts = custom.startTs;\n      analysisState[i] = analysisState[i].concat(loadedInitialData[i].TP_AnalysisState);\n    }\n    if (loadedData[i].TP_AnalysisState) {\n      analysisState[i] = analysisState[i].concat(loadedData[i].TP_AnalysisState);\n    }\n    analysisState[i] = _.orderBy(analysisState[i], ['ts'], ['asc']);\n\n    if (_.isNil(plannedWorkTimeDay[i])) {\n      plannedWorkTimeDay[i] = 0;\n    }\n    for (let j in loadedData[i].TP_PlannedWorkTimeDay) {\n      plannedWorkTimeDay[i] += loadedData[i].TP_PlannedWorkTimeDay[j].value;\n    }\n  }\n\n  // TP_AnalysisState 상태값에 따라서 데이터 행 생성\n  for (let i in analysisState) {\n    let newObj = {\n      customerL2Name: loadedAttribute[i][0].value,\n      deviceName: custom.mainDatasources[i].entityLabel,\n      operationTime: 0,\n      waitingTime: 0,\n      operationRatio: 0,\n    };\n    for (let j = 0; j < analysisState[i].length; j++) {\n      // 대기, 가동상태인 경우만 조회\n      if (analysisState[i][j].value == '1' || analysisState[i][j].value == '2' || analysisState[i][j].value == '3') {\n        let start = analysisState[i][j].ts;\n        let end = custom.endTs;\n        // 변화한 데이터로 구성되므로 다음 데이터는 항상 전과 다른 상태 (기존 상태가 끝난 시점)\n        if (!_.isNil(analysisState[i][j + 1])) {\n          end = analysisState[i][j + 1].ts;\n        } else {\n          // 분석이 매 시간 0분에 진행되므로 조회 마지막 날이 오늘이면 현재시간의 0분까지로 설정\n          end = custom.endTs;\n          if (moment(end).startOf('day').valueOf() == moment().startOf('day').valueOf()) {\n            end = moment().startOf('hour').valueOf();\n          }\n        }\n        if (analysisState[i][j].value == '1') {\n          newObj.waitingTime += end - start;\n        }\n        if (analysisState[i][j].value == '2' || analysisState[i][j].value == '3') {\n          newObj.operationTime += end - start;\n        }\n      }\n    }\n    if (plannedWorkTimeDay[i] != 0) {\n      newObj.operationRatio = (newObj.operationTime / plannedWorkTimeDay[i]) * 100;\n    }\n\n    result.push(newObj);\n  }\n  return result;\n}\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  for (let i in custom.mainData) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\nfunction makeFoot() {\n  let { custom, $scope } = self.ctx;\n  $scope.tfootList = $scope.thList.slice(2).map(x => {\n    return {\n      key: x.key,\n      value: '',\n    };\n  });\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  let total = {};\n  for (let i in $scope.tfootList) {\n    total[$scope.tfootList[i].key] = 0;\n  }\n\n  for (let i in custom.mainData) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n      $scope.trList[i].tdList[j].value = data;\n      if ($scope.thList[j].formatter) {\n        $scope.trList[i].tdList[j].value = $scope.thList[j].formatter(data);\n      }\n\n      // 만약 키가 tfootList에 존재한다면 total에 더해줌\n      if (total[key] !== undefined) {\n        total[key] += data;\n      }\n    }\n  }\n\n  for (let i in total) {\n    let targetIndex = $scope.tfootList.findIndex(x => x.key == i);\n    if (targetIndex !== -1) {\n      if (i == 'waitingTime' || i == 'operationTime') {\n        $scope.tfootList[targetIndex].value = toStringTime(total[i] / 1000);\n      } else {\n        $scope.tfootList[targetIndex].value = _.round(total[i] / custom.mainDatasources.length, 1);\n      }\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  let theadHeight = custom.$thead.outerHeight(true);\n  let tfootHeight = custom.$tfoot.outerHeight(true);\n  custom.$tbody.css('max-height', `calc(100% - ${theadHeight + tfootHeight}px)`);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction toStringTime(value) {\n  let hour = Math.floor(value / 3600);\n  let minute = Math.floor((value % 3600) / 60);\n  return t('thingplus.time-format.hm-acc-em', { hour, minute });\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainDatasources[0].entity.id,\n    custom.mainDatasources[0].entityName,\n    {},\n    custom.mainDatasources[0].entityLabel\n  );\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.9670066538212023,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Total Work Report\",\"showTitleIcon\":false,\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"titleTooltip\":\"\",\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"}}"
      }
    },
    {
      "alias": "cost_report",
      "name": "Cost Report",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-action\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n        <div\n          class=\"widget-header-action\"\n          *ngFor=\"let headerAction of headerActionList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (click)=\"headerAction.action($event)\"\n        >\n          <i class=\"material-icons\">{{headerAction.icon}}</i>\n        </div>\n      </div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <div class=\"table thead\">\n        <div class=\"tr\">\n          <div class=\"th\" *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n            <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n              <span class=\"th-label\">{{th.label}}</span>\n              <i class=\"th-sort material-icons\">arrow_upward</i>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"table tbody\">\n        <div class=\"tr\" *ngFor=\"let tr of trList\">\n          <div class=\"td\" *ngFor=\"let td of tr.tdList\"><span>{{td.value}}</span></div>\n        </div>\n      </div>\n      <div class=\"table tfoot\">\n        <div class=\"tr\">\n          <div class=\"td\" colspan=\"2\"><span>합계</span></div>\n          <div class=\"td\" *ngFor=\"let tfoot of tfootList\"><span [innerHTML]=\"tfoot.value\"></span></div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n.widget-header-right-section .widget-header-action {\n  padding: 0.6em;\n  padding-right: 0;\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .widget-header-action i {\n  font-size: 2em;\n  font-weight: bold;\n}\n.widget-header-right-section .widget-header-action:hover {\n  color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .widget-header-action:active {\n  color: var(--tb-service-accent-pressed);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow-x: auto;\n  overflow-y: hidden;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  width: fit-content;\n  box-sizing: border-box;\n  white-space: nowrap;\n}\n.table-section .tr {\n  width: 100%;\n  display: flex;\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .tbody .tr:last-child {\n  border-bottom: none;\n}\n.table-section .th,\n.table-section .td {\n  flex: 0 1 auto;\n  width: 15em;\n}\n.table-section .th:nth-child(2),\n.table-section .tbody .td:nth-child(2) {\n  width: 25em;\n}\n.table-section .tfoot .td:first-child {\n  width: 40em;\n}\n.table-section .thead {\n  overflow-y: scroll;\n}\n.table-section .thead::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n  background-color: var(--tb-service-background-1);\n}\n.table-section .thead::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .thead::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .thead .tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section .th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section .th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section .th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section .th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section .tbody {\n  overflow-y: scroll;\n}\n.table-section .tbody::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section .tbody::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tbody::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tbody .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tbody .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tbody .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tbody .td span {\n  font-size: 1.4em;\n}\n.table-section .tbody .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .tfoot {\n  overflow-y: scroll;\n}\n.table-section .tfoot::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tfoot .tr {\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tfoot .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tfoot .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .td span {\n  font-size: 1.4em;\n}\n.table-section .tfoot .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n\n.table-section .tfoot b {\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  linkEvent();\n  makeHead();\n\n  if (!custom.isSample) {\n    let loadedAttribute = await loadAttribute();\n    let loadedInitialData = await loadInitialData();\n    let loadedData = await loadData();\n    custom.mainData = preprocessData(loadedAttribute, loadedInitialData, loadedData);\n  }\n  sortData();\n  makeBody();\n  makeFoot();\n  insertData();\n  self.onResize();\n  self.ctx.detectChanges();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$thead = $('.thead', $container);\n  custom.$tbody = $('.tbody', $container);\n  custom.$tfoot = $('.tfoot', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  let now = moment().valueOf();\n  custom.startTs = moment(now).startOf('month').valueOf();\n  custom.endTs = now;\n  custom.selectedIndex = 0;\n  custom.t = t;\n  custom.mainData = [];\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.startTs = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.endTs = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    sortData();\n    insertData();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'customerL2Name',\n      label: t('thingplus.label.customerL2-name'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'deviceName',\n      label: t('thingplus.label.device-name'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'operationTime',\n      label: t('thingplus.label.operation-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 3,\n      key: 'workingTime',\n      label: t('thingplus.label.working-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 4,\n      key: 'trialTime',\n      label: t('thingplus.label.trial-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 5,\n      key: 'waitingTime',\n      label: t('thingplus.label.waiting-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 6,\n      key: 'stoppedTime',\n      label: t('thingplus.label.stopped-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 7,\n      key: 'operationRatio',\n      label: t('thingplus.label.operation-rate-with-unit'),\n      order: '',\n      formatter: d => {\n        return _.round(d, 1);\n      },\n    },\n    {\n      index: 8,\n      key: 'powerUsage',\n      label: t('thingplus.label.power-usage'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 9,\n      key: 'operationPowerUsage',\n      label: t('thingplus.label.operation-power-usage'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 10,\n      key: 'workPowerUsage',\n      label: t('thingplus.label.work-power-usage'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 11,\n      key: 'trialPowerUsage',\n      label: t('thingplus.label.trial-power-usage'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 12,\n      key: 'waitPowerUsage',\n      label: t('thingplus.label.wait-power-usage'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 13,\n      key: 'stopPowerUsage',\n      label: t('thingplus.label.stop-power-usage'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 9,\n      key: 'operationPowerUsageHour',\n      label: t('thingplus.label.operation-power-usage-hour'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 10,\n      key: 'workPowerUsageHour',\n      label: t('thingplus.label.work-power-usage-hour'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 11,\n      key: 'trialPowerUsageHour',\n      label: t('thingplus.label.trial-power-usage-hour'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 12,\n      key: 'waitPowerUsageHour',\n      label: t('thingplus.label.wait-power-usage-hour'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n    {\n      index: 13,\n      key: 'stopPowerUsageHour',\n      label: t('thingplus.label.stop-power-usage-hour'),\n      order: '',\n      formatter: d => {\n        return _.round(d / 1000, 1);\n      },\n    },\n  ];\n}\n\nfunction loadAttribute() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'customerL2Name';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(`/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/attributes?keys=${key}`)\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction loadInitialData() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'TP_AnalysisState';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=1&agg=NONE&keys=${key}&startTs=0&endTs=${custom.startTs}&useStrictDataTypes=true&orderBy=ASC`\n      )\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction loadData() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'TP_AnalysisState,TP_PlannedWorkTimeDay,TP_TotalPowerUsageRaw';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=50000&agg=NONE&keys=${key}&startTs=${custom.startTs}&endTs=${custom.endTs}&useStrictDataTypes=true&orderBy=ASC`\n      )\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction preprocessData(loadedAttribute, loadedInitialData, loadedData) {\n  let { custom, $scope } = self.ctx;\n  let result = [];\n\n  console.log(loadedAttribute, loadedInitialData, loadedData);\n\n  // 데이터 정리\n  let analysisState = [];\n  let plannedWorkTimeDay = [];\n  let totalPowerUsageRaw = [];\n  for (let i in custom.mainDatasources) {\n    if (_.isNil(analysisState[i])) {\n      analysisState[i] = [];\n    }\n    if (loadedInitialData[i].TP_AnalysisState) {\n      loadedInitialData[i].TP_AnalysisState[0].ts = custom.startTs;\n      analysisState[i] = analysisState[i].concat(loadedInitialData[i].TP_AnalysisState);\n    }\n    if (loadedData[i].TP_AnalysisState) {\n      analysisState[i] = analysisState[i].concat(loadedData[i].TP_AnalysisState);\n    }\n    analysisState[i] = _.orderBy(analysisState[i], ['ts'], ['asc']);\n\n    if (_.isNil(plannedWorkTimeDay[i])) {\n      plannedWorkTimeDay[i] = 0;\n    }\n    for (let j in loadedData[i].TP_PlannedWorkTimeDay) {\n      plannedWorkTimeDay[i] += loadedData[i].TP_PlannedWorkTimeDay[j].value;\n    }\n    if (_.isNil(totalPowerUsageRaw[i])) {\n      totalPowerUsageRaw[i] = [];\n    }\n    if (loadedData[i].TP_TotalPowerUsageRaw) {\n      totalPowerUsageRaw[i] = loadedData[i].TP_TotalPowerUsageRaw;\n    }\n  }\n\n  // TP_AnalysisState 상태값에 따라서 데이터 행 생성\n  for (let i in analysisState) {\n    let newObj = {\n      customerL2Name: loadedAttribute[i][0].value,\n      deviceName: custom.mainDatasources[i].entityLabel,\n      operationTime: 0,\n      workingTime: 0,\n      trialTime: 0,\n      waitingTime: 0,\n      stoppedTime: 0,\n      operationRatio: 0,\n      powerUsage: 0,\n      operationPowerUsage: 0,\n      workPowerUsage: 0,\n      trialPowerUsage: 0,\n      waitPowerUsage: 0,\n      stopPowerUsage: 0,\n      operationPowerUsageHour: 0,\n      workPowerUsageHour: 0,\n      trialPowerUsageHour: 0,\n      waitPowerUsageHour: 0,\n      stopPowerUsageHour: 0,\n    };\n    for (let j = 0; j < analysisState[i].length; j++) {\n      if (analysisState[i][j].value != '4') {\n        let start = analysisState[i][j].ts;\n        let end = custom.endTs;\n        // 변화한 데이터로 구성되므로 다음 데이터는 항상 전과 다른 상태 (기존 상태가 끝난 시점)\n        if (!_.isNil(analysisState[i][j + 1])) {\n          end = analysisState[i][j + 1].ts;\n        } else {\n          // 분석이 매 시간 0분에 진행되므로 조회 마지막 날이 오늘이면 현재시간의 0분까지로 설정\n          end = custom.endTs;\n          if (moment(end).startOf('day').valueOf() == moment().startOf('day').valueOf()) {\n            end = moment().startOf('hour').valueOf();\n          }\n        }\n        console.log(analysisState[i][j].value, start, end, end - start);\n        if (analysisState[i][j].value == '0') {\n          newObj.stoppedTime += end - start;\n        }\n        if (analysisState[i][j].value == '1') {\n          newObj.waitingTime += end - start;\n        }\n        if (analysisState[i][j].value == '2' || analysisState[i][j].value == '3') {\n          newObj.operationTime += end - start;\n        }\n        if (analysisState[i][j].value == '2') {\n          newObj.workingTime += end - start;\n        }\n        if (analysisState[i][j].value == '3') {\n          newObj.trialTime += end - start;\n        }\n        for (let k = 0; k < totalPowerUsageRaw[i].length; k++) {\n          if (start <= totalPowerUsageRaw[i][k].ts && totalPowerUsageRaw[i][k].ts < end) {\n            newObj.powerUsage += totalPowerUsageRaw[i][k].value;\n            if (analysisState[i][j].value == '0') {\n              newObj.stopPowerUsage += totalPowerUsageRaw[i][k].value;\n            }\n            if (analysisState[i][j].value == '1') {\n              newObj.waitPowerUsage += totalPowerUsageRaw[i][k].value;\n            }\n            if (analysisState[i][j].value == '2' || analysisState[i][j].value == '3') {\n              newObj.operationPowerUsage += totalPowerUsageRaw[i][k].value;\n            }\n            if (analysisState[i][j].value == '2') {\n              newObj.workPowerUsage += totalPowerUsageRaw[i][k].value;\n            }\n            if (analysisState[i][j].value == '3') {\n              newObj.trialPowerUsage += totalPowerUsageRaw[i][k].value;\n            }\n          }\n        }\n      }\n    }\n    if (plannedWorkTimeDay[i] != 0) {\n      newObj.operationRatio = (newObj.operationTime / plannedWorkTimeDay[i]) * 100;\n    }\n\n    newObj.operationPowerUsageHour = newObj.operationPowerUsage / (newObj.operationTime / HOUR_MS);\n    newObj.workPowerUsageHour = newObj.workPowerUsage / (newObj.workingTime / HOUR_MS);\n    newObj.trialPowerUsageHour = newObj.trialPowerUsage / (newObj.trialTime / HOUR_MS);\n    newObj.waitPowerUsageHour = newObj.waitPowerUsage / (newObj.waitingTime / HOUR_MS);\n    newObj.stopPowerUsageHour = newObj.stopPowerUsage / (newObj.stoppedTime / HOUR_MS);\n\n    if (newObj.operationTime == 0) {\n      newObj.operationPowerUsageHour = newObj.operationPowerUsage;\n    }\n    if (newObj.workingTime == 0) {\n      newObj.workPowerUsageHour = newObj.workPowerUsage;\n    }\n    if (newObj.trialTime == 0) {\n      newObj.trialPowerUsageHour = newObj.trialPowerUsage;\n    }\n    if (newObj.waitingTime == 0) {\n      newObj.waitPowerUsageHour = newObj.waitPowerUsage;\n    }\n    if (newObj.stoppedTime == 0) {\n      newObj.stopPowerUsageHour = newObj.stopPowerUsage;\n    }\n\n    result.push(newObj);\n  }\n  return result;\n}\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  for (let i in custom.mainData) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\nfunction makeFoot() {\n  let { custom, $scope } = self.ctx;\n  $scope.tfootList = $scope.thList.slice(2).map(x => {\n    return {\n      key: x.key,\n      value: '',\n    };\n  });\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  let total = {};\n  for (let i in $scope.tfootList) {\n    total[$scope.tfootList[i].key] = 0;\n  }\n\n  for (let i in custom.mainData) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n      $scope.trList[i].tdList[j].value = data;\n      if ($scope.thList[j].formatter) {\n        $scope.trList[i].tdList[j].value = $scope.thList[j].formatter(data);\n      }\n\n      // 만약 키가 tfootList에 존재한다면 total에 더해줌\n      if (total[key] !== undefined) {\n        total[key] += data;\n      }\n    }\n  }\n\n  for (let i in total) {\n    let targetIndex = $scope.tfootList.findIndex(x => x.key == i);\n    if (targetIndex !== -1) {\n      if (i.includes('Time')) {\n        $scope.tfootList[targetIndex].value = toStringTime(total[i] / 1000);\n      } else if (i.includes('PowerUsage')) {\n        $scope.tfootList[targetIndex].value = _.round(total[i] / 1000, 1);\n      } else {\n        $scope.tfootList[targetIndex].value = _.round(total[i] / custom.mainDatasources.length, 1);\n      }\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  let theadHeight = custom.$thead.outerHeight(true);\n  let tfootHeight = custom.$tfoot.outerHeight(true);\n  custom.$tbody.css('max-height', `calc(100% - ${theadHeight + tfootHeight}px)`);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction toStringTime(value) {\n  let hour = Math.floor(value / 3600);\n  let minute = Math.floor((value % 3600) / 60);\n  return t('thingplus.time-format.hm-acc-em', { hour, minute });\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainDatasources[0].entity.id,\n    custom.mainDatasources[0].entityName,\n    {},\n    custom.mainDatasources[0].entityLabel\n  );\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.5329584866465744,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Cost Report\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "usage_rank_chart",
      "name": "Usage Rank Chart",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [
          {
            "url": "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"
          }
        ],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\">title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"chart-section\" fxLayout=\"column\" fxLayoutAlign=\"space-between center\">\n      <div fxFlex=\"5 1 80%\" class=\"chart-container\">\n        <canvas class=\"chart\"></canvas>\n      </div>\n      <div class=\"legend-container\" fxLayout=\"row wrap\" fxLayoutAlign=\"center center\" fxLayoutGap=\"2em\">\n        <div class=\"legend-box\" *ngFor=\"let legend of legendList\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n          <div class=\"legend-circle\" [ngStyle]=\"{'color': legend.color}\"></div>\n          <div class=\"legend-label\">{{legend.label}}</div>\n          <div class=\"legend-value\">{{legend.value}}</div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* chart-section */\n.chart-section {\n  width: 100%;\n  height: 100%;\n  padding: var(--tb-config-padding);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.chart-section .chart-container {\n  width: 100%;\n}\n.chart-section .legend-circle {\n  width: 0.6em;\n  height: 0.6em;\n  background-color: currentColor;\n}\n.chart-section .legend-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.chart-section .legend-value {\n  font-size: 1.2em;\n  font-weight: bold;\n  color: var(--tb-service-font-5);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\nconst COLOR = [\n  '--tb-service-cold-line-0',\n  '--tb-service-cold-line-1',\n  '--tb-service-cold-line-2',\n  '--tb-service-cold-line-3',\n  '--tb-service-cold-line-4',\n];\nconst PAGE_SIZE = 5;\n\nself.onInit = function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  self.ctx.timewindowFunctions.onUpdateTimewindow(custom.searchStart, custom.searchEnd);\n  createDataset();\n  createChart();\n  self.onResize();\n  custom.isInitialized = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (custom.isInitialized) {\n    custom.mainData = preprocessData();\n    insertData();\n    custom.chart.update();\n  }\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$chart = $('.chart', $container);\n\n  $scope.legendList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.isInitialized = false;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).valueOf() + 1;\n  custom.computedStyle = getComputedStyle($container[0]);\n  custom.chartLabels = [];\n  custom.chartData = [];\n  custom.t = t;\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(t(self.ctx.widget.config.title));\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction createDataset() {\n  let { custom } = self.ctx;\n  custom.dataSet = {\n    labels: custom.chartLabels,\n    datasets: [\n      {\n        label: '',\n        data: custom.chartData,\n        backgroundColor: [\n          getStyle(COLOR[0]),\n          getStyle(COLOR[1]),\n          getStyle(COLOR[2]),\n          getStyle(COLOR[3]),\n          getStyle(COLOR[4]),\n        ],\n        hoverBackgroundColor: [\n          getStyle(COLOR[0]),\n          getStyle(COLOR[1]),\n          getStyle(COLOR[2]),\n          getStyle(COLOR[3]),\n          getStyle(COLOR[4]),\n        ],\n        fill: true,\n        borderWidth: 0,\n        categoryPercentage: 0.15,\n      },\n    ],\n  };\n}\n\n// 차트생성\nfunction createChart() {\n  let { custom, $scope } = self.ctx;\n  custom.chart = new Chart(custom.$chart, {\n    type: 'horizontalBar',\n    data: custom.dataSet,\n    options: {\n      responsive: true,\n      maintainAspectRatio: false,\n      tooltips: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n        xPadding: custom.widgetFontSize,\n        yPadding: custom.widgetFontSize,\n        bodySpacing: custom.widgetFontSize * 0.9,\n        titleMarginBottom: custom.widgetFontSize,\n        callbacks: {\n          label: function (tooltipItem, data) {\n            let label = data.datasets[tooltipItem.datasetIndex].label || '';\n            if (label) {\n              label += ': ';\n            }\n            label += tooltipItem.xLabel + ' %';\n\n            return label;\n          },\n        },\n      },\n      hover: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n      },\n      legend: {\n        display: false,\n      },\n      scales: {\n        xAxes: [\n          {\n            display: true,\n            ticks: {\n              min: 0,\n              max: 100,\n              fontColor: getStyle('--tb-service-font-2'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n            },\n            gridLines: {\n              display: true,\n              color: getStyle('--tb-service-border-1'),\n              zeroLineColor: getStyle('--tb-service-border-1'),\n            },\n          },\n        ],\n        yAxes: [\n          {\n            display: true,\n            type: 'category',\n            ticks: {\n              fontColor: getStyle('--tb-service-font-5'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n              sampleSize: 10,\n            },\n            gridLines: {\n              display: false,\n            },\n          },\n        ],\n      },\n    },\n  });\n}\n\nfunction preprocessData() {\n  let { custom } = self.ctx;\n  let result = [];\n  for (let i in custom.mainDatasources) {\n    result.push({\n      id: custom.mainDatasources[i].entity.id,\n      name: custom.mainDatasources[i].entityName,\n      label: custom.mainDatasources[i].entityLabel,\n    });\n  }\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let entityId = target.datasource.entityId;\n      let name = target.dataKey.name;\n      let data = target.data;\n      let datasourceIndex = result.findIndex(x => x.id.id == entityId);\n      if (datasourceIndex !== -1) {\n        result[datasourceIndex][name] = data;\n      }\n    }\n  }\n  let totalPowerUsage = 0;\n  for (let i in result) {\n    result[i].totalPowerUsage = 0;\n    result[i].workTimeDay = 0;\n    result[i].waitTimeDay = 0;\n    result[i].workPowerUsage = 0;\n    result[i].waitPowerUsage = 0;\n    for (let j = custom.searchStart; j < custom.searchEnd; j += DAY_MS) {\n      if (result[i].TP_WorkTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WorkTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc += targetArray[k];\n        }\n        result[i].workTimeDay += acc;\n      }\n      if (result[i].TP_WaitTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc += targetArray[k];\n        }\n        result[i].waitTimeDay += acc;\n      }\n      if (result[i].TP_TotalPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_TotalPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].totalPowerUsage += acc;\n      }\n      if (result[i].TP_WorkPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WorkPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].workPowerUsage += acc;\n      }\n      if (result[i].TP_WaitPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].waitPowerUsage += acc;\n      }\n    }\n    result[i].totalPowerUsage = _.round(result[i].totalPowerUsage / 1000, 1) || 0;\n    result[i].totalPowerUsagePerHour = _.round(\n      result[i].totalPowerUsage / ((custom.searchEnd - custom.searchStart) / HOUR_MS),\n      1\n    );\n    result[i].workTimeDay = _.round(result[i].workTimeDay / HOUR_MS, 1);\n    result[i].operationPowerUsagePerHour = _.round(result[i].workPowerUsage / 1000 / result[i].workTimeDay, 1) || 0;\n    result[i].workPowerUsagePerHour = result[i].operationPowerUsagePerHour || 0;\n    result[i].waitTimeDay = _.round(result[i].waitTimeDay / HOUR_MS, 1);\n    result[i].waitPowerUsagePerHour = _.round(result[i].waitPowerUsage / 1000 / result[i].waitTimeDay, 1) || 0;\n\n    totalPowerUsage += result[i].totalPowerUsage;\n  }\n  result.sort((a, b) => {\n    if (a.totalPowerUsage > b.totalPowerUsage) return -1;\n    if (a.totalPowerUsage < b.totalPowerUsage) return 1;\n    return 0;\n  });\n  for (let i in result) {\n    result[i].rank = +i + 1;\n    result[i].percentage = _.round((result[i].totalPowerUsage / totalPowerUsage) * 100, 1);\n  }\n  let max = Math.max(...result.map(x => x.percentage));\n  if (isNaN(max)) {\n    max = 100;\n  }\n  custom.chart.options.scales.xAxes[0].ticks.max = max;\n  return result;\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  custom.chartLabels.length = 0;\n  custom.chartData.length = 0;\n  $scope.legendList.length = 0;\n\n  let targetIndex = PAGE_SIZE;\n  if (custom.mainData.length < PAGE_SIZE) {\n    targetIndex = custom.mainData.length;\n  }\n  for (let i = 0; i < targetIndex; i++) {\n    custom.chartLabels.push(custom.mainData[i].label);\n    custom.chartData.push(custom.mainData[i].percentage);\n    $scope.legendList.push({\n      color: getStyle(COLOR[i]),\n      label: custom.mainData[i].label,\n      value: custom.mainData[i].percentage + '%',\n    });\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  if (custom.chart) {\n    custom.chart.options.scales.xAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.scales.yAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.tooltips.xPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.yPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.bodySpacing = custom.widgetFontSize * 0.9;\n    custom.chart.options.tooltips.titleMarginBottom = custom.widgetFontSize;\n    custom.chart.resize();\n  }\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":null},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.12387360100073619,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":1,\"history\":{\"historyType\":1,\"fixedTimewindow\":{\"startTimeMs\":1676905200000,\"endTimeMs\":1676991600000},\"interval\":173000},\"aggregation\":{\"type\":\"NONE\",\"limit\":50000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Usage Rank Chart\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":false,\"displayTimewindow\":false,\"showTitleIcon\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false},\"titleTooltip\":\"\"}"
      }
    },
    {
      "alias": "usage_rank_table",
      "name": "Usage Rank Table",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 5,
        "resources": [
          {
            "url": "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"
          }
        ],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\">title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <section class=\"page-section\" fxLayoutAlign=\"end center\" fxLayoutGap=\"-1px\">\n        <div class=\"current-page\">{{currentPage}}</div>\n        <div class=\"material-icons page-button prev-button\" (click)=\"getPrevPage()\">keyboard_arrow_left</div>\n        <div class=\"material-icons page-button next-button\" (click)=\"getNextPage()\">keyboard_arrow_right</div>\n      </section>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n              <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <span class=\"th-label\">{{th.label}}</span>\n                <i class=\"th-sort material-icons\">arrow_upward</i>\n              </div>\n            </th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr *ngFor=\"let tr of trList\">\n            <td *ngFor=\"let td of tr.tdList\">\n              <span>{{td.value}}</span>\n            </td>\n          </tr>\n        </tbody>\n      </table>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n/* page-section */\n.page-section .current-page {\n  font-size: 1.2em;\n  padding-right: 1em;\n  letter-spacing: 0.05em;\n  color: var(--tb-service-font-5);\n}\n.page-section .page-button {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 1.5em;\n  min-width: 20px;\n  height: 1.5em;\n  min-height: 20px;\n  font-size: 1.6em;\n  background-color: var(--tb-service-background-0);\n  border: 1px solid var(--tb-service-border-0);\n  cursor: pointer;\n  color: var(--tb-service-accent);\n  transition-property: border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.page-section .page-button:hover {\n  border: 1px solid var(--tb-service-accent-hover);\n  z-index: 1;\n}\n.page-section .page-button:active {\n  border: 1px solid var(--tb-service-accent-pressed);\n  z-index: 1;\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  height: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em 0.14em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: pre;\n  font-size: 1em;\n  line-height: 1;\n}\n.table-section th:first-child {\n  padding-left: 1.68em;\n}\n.table-section th:last-child {\n  padding-right: 1.68em;\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 0em 0.1em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n}\n.table-section td:first-child {\n  padding-left: 1.2em;\n}\n.table-section td:last-child {\n  padding-right: 1.2em;\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .td-state {\n  font-size: calc(1em / 1.4);\n}\n.table-section .td-state-color {\n  width: 0.8em;\n  height: 0.4em;\n  background-color: currentColor;\n}\n.table-section .td-state-label {\n  font-size: 1.4em;\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  self.ctx.timewindowFunctions.onUpdateTimewindow(custom.searchStart, custom.searchEnd);\n  linkEvent();\n  makeHead();\n  makeBody();\n  self.onResize();\n  initPage();\n  custom.isInitialized = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (custom.isInitialized) {\n    custom.mainData = preprocessData();\n    sortData();\n    insertData();\n  }\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$table = $('.table', $container);\n  custom.$theadTr = $('.table thead tr', $container);\n  custom.$tbody = $('.table tbody', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.pageList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.isInitialized = false;\n  let now = moment().valueOf();\n  custom.searchStart = moment(now).startOf('day').valueOf();\n  custom.searchEnd = moment(now).valueOf() + 1;\n  custom.selectedIndex = 0;\n  custom.currentPage = 1;\n  custom.countPerPage = 5;\n  custom.t = t;\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(t(self.ctx.widget.config.title));\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.searchStart = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.searchEnd = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.getPrevPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage--;\n      initPage();\n      insertData();\n      self.ctx.detectChanges();\n    }\n  };\n  $scope.getNextPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage++;\n      initPage();\n      insertData();\n      self.ctx.detectChanges();\n    }\n  };\n  $scope.changeSort = function (e, th) {\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    initPage();\n    sortData();\n    insertData();\n    self.ctx.detectChanges();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'label',\n      label: t('thingplus.label.device-name'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'totalPowerUsage',\n      label: t('thingplus.label.usage-with-unit'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'totalPowerUsagePerHour',\n      label: t('thingplus.label.usage-hour-with-unit'),\n      order: '',\n    },\n    {\n      index: 3,\n      key: 'operationPowerUsagePerHour',\n      label: t('thingplus.label.usage-operation-with-unit'),\n      order: '',\n    },\n    {\n      index: 4,\n      key: 'workPowerUsagePerHour',\n      label: t('thingplus.label.usage-work-with-unit'),\n      order: '',\n    },\n    {\n      index: 5,\n      key: 'waitPowerUsagePerHour',\n      label: t('thingplus.label.usage-wait-with-unit'),\n      order: '',\n    },\n  ];\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  // 현재 페이지의 데이터 수 만큼 행 출력\n  for (let i = 0; i < custom.countPerPage; i++) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\n// 페이지에 맞는 데이터 출력 및 페이지 표시\nfunction initPage() {\n  let { custom, $scope } = self.ctx;\n  custom.totalPage = Math.ceil(custom.mainDatasources.length / custom.countPerPage);\n\n  custom.startIndex = (custom.currentPage - 1) * custom.countPerPage;\n  custom.endIndex = custom.currentPage * custom.countPerPage - 1;\n  // 끝 페이지가 데이터 소스의 길이보다 많으면 데이터 소스의 길이로 변경\n  if (custom.endIndex > custom.mainDatasources.length - 1) {\n    custom.endIndex = custom.mainDatasources.length - 1;\n  }\n  custom.targetDatasources = custom.mainDatasources.slice(custom.startIndex, custom.endIndex + 1);\n  $scope.currentPage = custom.currentPage + ' of ' + custom.totalPage;\n}\n\nfunction preprocessData() {\n  let { custom } = self.ctx;\n  let result = [];\n  for (let i in custom.mainDatasources) {\n    result.push({\n      id: custom.mainDatasources[i].entity.id,\n      name: custom.mainDatasources[i].entityName,\n      label: custom.mainDatasources[i].entityLabel,\n    });\n  }\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let entityId = target.datasource.entityId;\n      let name = target.dataKey.name;\n      let data = target.data;\n      let datasourceIndex = result.findIndex(x => x.id.id == entityId);\n      if (datasourceIndex !== -1) {\n        result[datasourceIndex][name] = data;\n      }\n    }\n  }\n  let totalPowerUsage = 0;\n  for (let i in result) {\n    result[i].totalPowerUsage = 0;\n    result[i].workTimeDay = 0;\n    result[i].waitTimeDay = 0;\n    result[i].workPowerUsage = 0;\n    result[i].waitPowerUsage = 0;\n    for (let j = custom.searchStart; j < custom.searchEnd; j += DAY_MS) {\n      if (result[i].TP_WorkTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WorkTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc += targetArray[k];\n        }\n        result[i].workTimeDay += acc;\n      }\n      if (result[i].TP_WaitTimeDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitTimeDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc += targetArray[k];\n        }\n        result[i].waitTimeDay += acc;\n      }\n      if (result[i].TP_TotalPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_TotalPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].totalPowerUsage += acc;\n      }\n      if (result[i].TP_WorkPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WorkPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].workPowerUsage += acc;\n      }\n      if (result[i].TP_WaitPowerUsageDay) {\n        let acc = 0;\n        let targetArray = result[i].TP_WaitPowerUsageDay.filter(x => x[0] >= j && x[0] < j + DAY_MS).map(x => x[1]);\n        for (let k in targetArray) {\n          acc = targetArray[k];\n        }\n        result[i].waitPowerUsage += acc;\n      }\n    }\n    result[i].totalPowerUsage = _.round(result[i].totalPowerUsage / 1000, 1) || 0;\n    result[i].totalPowerUsagePerHour = _.round(\n      result[i].totalPowerUsage / ((custom.searchEnd - custom.searchStart) / HOUR_MS),\n      1\n    );\n    result[i].workTimeDay = _.round(result[i].workTimeDay / HOUR_MS, 1);\n    result[i].operationPowerUsagePerHour = _.round(result[i].workPowerUsage / 1000 / result[i].workTimeDay, 1) || 0;\n    result[i].workPowerUsagePerHour = result[i].operationPowerUsagePerHour || 0;\n    result[i].waitTimeDay = _.round(result[i].waitTimeDay / HOUR_MS, 1);\n    result[i].waitPowerUsagePerHour = _.round(result[i].waitPowerUsage / 1000 / result[i].waitTimeDay, 1) || 0;\n\n    totalPowerUsage += result[i].totalPowerUsage;\n  }\n  result.sort((a, b) => {\n    if (a.totalPowerUsage > b.totalPowerUsage) return -1;\n    if (a.totalPowerUsage < b.totalPowerUsage) return 1;\n    return 0;\n  });\n  for (let i in result) {\n    result[i].percentage = _.round((result[i].totalPowerUsage / totalPowerUsage) * 100, 1);\n  }\n  let max = Math.max(...result.map(x => x.percentage));\n  if (isNaN(max)) {\n    max = 100;\n  }\n  return result;\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  for (let i in $scope.trList) {\n    for (let j in $scope.trList[i].tdList) {\n      $scope.trList[i].tdList[j].value = '-';\n    }\n  }\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n\n      $scope.trList[i - custom.startIndex].tdList[j].value = data;\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":null},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.12387360100073619,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":1,\"history\":{\"historyType\":1,\"fixedTimewindow\":{\"startTimeMs\":1692889200000,\"endTimeMs\":1692957176954},\"interval\":173000},\"aggregation\":{\"type\":\"NONE\",\"limit\":50000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Usage Rank Table\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"useDashboardTimewindow\":false,\"displayTimewindow\":false,\"showTitleIcon\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false},\"titleTooltip\":\"\"}"
      }
    },
    {
      "alias": "total_work_report_test",
      "name": "Total Work Report Test",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-action\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n        <div\n          class=\"widget-header-action\"\n          *ngFor=\"let headerAction of headerActionList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (click)=\"headerAction.action($event)\"\n        >\n          <i class=\"material-icons\">{{headerAction.icon}}</i>\n        </div>\n      </div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <div class=\"table thead\">\n        <div class=\"tr\">\n          <div class=\"th\" *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n            <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n              <span class=\"th-label\">{{th.label}}</span>\n              <i class=\"th-sort material-icons\">arrow_upward</i>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"table tbody\">\n        <div class=\"tr\" *ngFor=\"let tr of trList\">\n          <div class=\"td\" *ngFor=\"let td of tr.tdList\"><span>{{td.value}}</span></div>\n        </div>\n      </div>\n      <div class=\"table tfoot\">\n        <div class=\"tr\">\n          <div class=\"td\" colspan=\"2\"><span>합계</span></div>\n          <div class=\"td\" *ngFor=\"let tfoot of tfootList\"><span [innerHTML]=\"tfoot.value\"></span></div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n.widget-header-right-section .widget-header-action {\n  padding: 0.6em;\n  padding-right: 0;\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .widget-header-action i {\n  font-size: 2em;\n  font-weight: bold;\n}\n.widget-header-right-section .widget-header-action:hover {\n  color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .widget-header-action:active {\n  color: var(--tb-service-accent-pressed);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow-x: auto;\n  overflow-y: hidden;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  width: 100%;\n  min-width: 100em;\n  box-sizing: border-box;\n  white-space: nowrap;\n}\n.table-section .tr {\n  width: 100%;\n  display: flex;\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .tbody .tr:last-child {\n  border-bottom: none;\n}\n.table-section .th,\n.table-section .td {\n  flex: 1 1 20%;\n  width: 20em;\n}\n.table-section .tfoot .td:first-child {\n  flex: 1 1 40%;\n  width: 40em;\n}\n.table-section .thead {\n  overflow-y: scroll;\n}\n.table-section .thead::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n  background-color: var(--tb-service-background-1);\n}\n.table-section .thead::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .thead::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .thead .tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section .th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section .th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section .th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section .th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section .tbody {\n  overflow-y: scroll;\n}\n.table-section .tbody::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section .tbody::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tbody::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tbody .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tbody .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tbody .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tbody .td span {\n  font-size: 1.4em;\n}\n.table-section .tbody .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .tfoot {\n  overflow-y: scroll;\n}\n.table-section .tfoot::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section .tfoot::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .tfoot .tr {\n  border-top: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section .tfoot .tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section .tfoot .td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.68em;\n  font-size: 1em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.table-section .tfoot .td {\n  font-size: 1.4em;\n}\n.table-section .tfoot .tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n\n.table-section .tfoot b {\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst DAY_MS = 86400000;\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  getDashboardParameter();\n  linkEvent();\n  makeHead();\n\n  if (!custom.isSample) {\n    let loadedAttribute = await loadAttribute();\n    let loadedInitialData = await loadInitialData();\n    let loadedData = await loadData();\n    custom.mainData = preprocessData(loadedAttribute, loadedInitialData, loadedData);\n  }\n  sortData();\n  makeBody();\n  makeFoot();\n  insertData();\n  self.onResize();\n  self.ctx.detectChanges();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$thead = $('.thead', $container);\n  custom.$tbody = $('.tbody', $container);\n  custom.$tfoot = $('.tfoot', $container);\n\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  let now = moment().valueOf();\n  custom.startTs = moment(now).startOf('month').valueOf();\n  custom.endTs = now;\n  custom.selectedIndex = 0;\n  custom.t = t;\n  custom.mainData = [];\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n  if (custom.dashboardParams) {\n    if (custom.dashboardParams.startTs) {\n      custom.startTs = custom.dashboardParams.startTs;\n    }\n    if (custom.dashboardParams.endTs) {\n      custom.endTs = custom.dashboardParams.endTs;\n    }\n  }\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'ASC') {\n        $scope.thList[th.index].order = 'ASC';\n      } else {\n        $scope.thList[th.index].order = 'DESC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'ASC';\n    }\n    sortData();\n    insertData();\n  };\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [\n    {\n      index: 0,\n      key: 'customerL2Name',\n      label: t('thingplus.label.customerL2-name'),\n      order: 'ASC',\n    },\n    {\n      index: 1,\n      key: 'deviceName',\n      label: t('thingplus.label.device-name'),\n      order: '',\n    },\n    {\n      index: 2,\n      key: 'operationTime',\n      label: t('thingplus.label.operation-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 3,\n      key: 'waitingTime',\n      label: t('thingplus.label.waiting-time'),\n      order: '',\n      formatter: d => {\n        return toTime(_.floor(d / 1000));\n      },\n    },\n    {\n      index: 4,\n      key: 'operationRatio',\n      label: t('thingplus.label.operation-rate-with-unit'),\n      order: '',\n      formatter: d => {\n        return _.round(d, 1);\n      },\n    },\n  ];\n}\n\nfunction loadAttribute() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'customerL2Name';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(`/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/attributes?keys=${key}`)\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction loadInitialData() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'TEST_AnalysisState';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=1&agg=NONE&keys=${key}&startTs=0&endTs=${custom.startTs}&useStrictDataTypes=true&orderBy=ASC`\n      )\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction loadData() {\n  let { custom, $scope } = self.ctx;\n  let observables = [];\n  let key = 'TEST_AnalysisState,TP_PlannedWorkTimeDay';\n  for (let i in custom.mainDatasources) {\n    let entityId = custom.mainDatasources[i].entity.id;\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?limit=50000&agg=NONE&keys=${key}&startTs=${custom.startTs}&endTs=${custom.endTs}&useStrictDataTypes=true&orderBy=ASC`\n      )\n    );\n  }\n\n  return new Promise((resolve, reject) => {\n    try {\n      self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n        resolve(datas);\n      });\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nfunction preprocessData(loadedAttribute, loadedInitialData, loadedData) {\n  let { custom, $scope } = self.ctx;\n  let result = [];\n\n  // 데이터 정리\n  let analysisState = [];\n  let plannedWorkTimeDay = [];\n  for (let i in custom.mainDatasources) {\n    if (_.isNil(analysisState[i])) {\n      analysisState[i] = [];\n    }\n    if (loadedInitialData[i].TEST_AnalysisState) {\n      loadedInitialData[i].TEST_AnalysisState[0].ts = custom.startTs;\n      analysisState[i] = analysisState[i].concat(loadedInitialData[i].TEST_AnalysisState);\n    }\n    if (loadedData[i].TEST_AnalysisState) {\n      analysisState[i] = analysisState[i].concat(loadedData[i].TEST_AnalysisState);\n    }\n    analysisState[i] = _.orderBy(analysisState[i], ['ts'], ['asc']);\n\n    if (_.isNil(plannedWorkTimeDay[i])) {\n      plannedWorkTimeDay[i] = 0;\n    }\n    for (let j in loadedData[i].TP_PlannedWorkTimeDay) {\n      plannedWorkTimeDay[i] += loadedData[i].TP_PlannedWorkTimeDay[j].value;\n    }\n  }\n\n  // TEST_AnalysisState 상태값에 따라서 데이터 행 생성\n  for (let i in analysisState) {\n    let newObj = {\n      customerL2Name: loadedAttribute[i][0].value,\n      deviceName: custom.mainDatasources[i].entityLabel,\n      operationTime: 0,\n      waitingTime: 0,\n      operationRatio: 0,\n    };\n    for (let j = 0; j < analysisState[i].length; j++) {\n      // 대기, 가동상태인 경우만 조회\n      if (analysisState[i][j].value == '1' || analysisState[i][j].value == '2' || analysisState[i][j].value == '3') {\n        let start = analysisState[i][j].ts;\n        let end = custom.endTs;\n        // 변화한 데이터로 구성되므로 다음 데이터는 항상 전과 다른 상태 (기존 상태가 끝난 시점)\n        if (!_.isNil(analysisState[i][j + 1])) {\n          end = analysisState[i][j + 1].ts;\n        } else {\n          // 분석이 매 시간 0분에 진행되므로 조회 마지막 날이 오늘이면 현재시간의 0분까지로 설정\n          end = custom.endTs;\n          if (moment(end).startOf('day').valueOf() == moment().startOf('day').valueOf()) {\n            end = moment().startOf('hour').valueOf();\n          }\n        }\n        if (analysisState[i][j].value == '1') {\n          newObj.waitingTime += end - start;\n        }\n        if (analysisState[i][j].value == '2' || analysisState[i][j].value == '3') {\n          newObj.operationTime += end - start;\n        }\n      }\n    }\n    if (plannedWorkTimeDay[i] != 0) {\n      newObj.operationRatio = (newObj.operationTime / plannedWorkTimeDay[i]) * 100;\n    }\n\n    result.push(newObj);\n  }\n  return result;\n}\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  // subscribe하는 데이터 키의 레이블 중 정렬기준으로 선택된 레이블의 인덱스 추출\n  // 정렬에 사용할 객체를 깊은 복사\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  if (selectedOrder == 'ASC') {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    });\n  } else {\n    custom.mainData.sort((a, b) => {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    });\n  }\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  for (let i in custom.mainData) {\n    let tdList = [];\n    for (let j in $scope.thList) {\n      tdList.push({ index: j, name: $scope.thList[j].key, style: '', value: '-' });\n    }\n    $scope.trList.push({\n      tdList: tdList,\n    });\n  }\n}\n\nfunction makeFoot() {\n  let { custom, $scope } = self.ctx;\n  $scope.tfootList = $scope.thList.slice(2).map(x => {\n    return {\n      key: x.key,\n      value: '',\n    };\n  });\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  let total = {};\n  for (let i in $scope.tfootList) {\n    total[$scope.tfootList[i].key] = 0;\n  }\n\n  for (let i in custom.mainData) {\n    for (let j in $scope.thList) {\n      let key = $scope.thList[j].key;\n      let data = custom.mainData[i][key];\n      $scope.trList[i].tdList[j].value = data;\n      if ($scope.thList[j].formatter) {\n        $scope.trList[i].tdList[j].value = $scope.thList[j].formatter(data);\n      }\n\n      // 만약 키가 tfootList에 존재한다면 total에 더해줌\n      if (total[key] !== undefined) {\n        total[key] += data;\n      }\n    }\n  }\n\n  for (let i in total) {\n    let targetIndex = $scope.tfootList.findIndex(x => x.key == i);\n    if (targetIndex !== -1) {\n      if (i == 'waitingTime' || i == 'operationTime') {\n        $scope.tfootList[targetIndex].value = toStringTime(total[i] / 1000);\n      } else {\n        $scope.tfootList[targetIndex].value = _.round(total[i] / custom.mainDatasources.length, 1);\n      }\n    }\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  let theadHeight = custom.$thead.outerHeight(true);\n  let tfootHeight = custom.$tfoot.outerHeight(true);\n  custom.$tbody.css('max-height', `calc(100% - ${theadHeight + tfootHeight}px)`);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toTime(value) {\n  let hour = Math.floor(value / 3600);\n  let min = Math.floor((value % 3600) / 60);\n  return `${addZero(hour, 2)}:${addZero(min, 2)}`;\n}\n\nfunction toStringTime(value) {\n  let hour = Math.floor(value / 3600);\n  let minute = Math.floor((value % 3600) / 60);\n  return t('thingplus.time-format.hm-acc-em', { hour, minute });\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainDatasources[0].entity.id,\n    custom.mainDatasources[0].entityName,\n    {},\n    custom.mainDatasources[0].entityLabel\n  );\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.9670066538212023,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Total Work Report Test\",\"showTitleIcon\":false,\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"titleTooltip\":\"\",\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"}}"
      }
    }
  ]
}