{
  "widgetsBundle": {
    "alias": "moldmecca_main_widgets",
    "title": "Moldmecca Main Widgets",
    "image": null,
    "description": null
  },
  "widgetTypes": [
    {
      "alias": "summary_entity",
      "name": "Summary Entity",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 2,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"center center\">\n  <main class=\"widget-content\">\n    <section\n      class=\"card-section\"\n      fxLayoutAlign=\"space-between center\"\n      fxLayoutGap=\"var(--tb-config-padding)\"\n      fxLayout.lt-md=\"column\"\n      fxLayoutAlign.lt-md=\"space-between stretch\"\n      fxLayoutGap.lt-md=\"0px\"\n    >\n      <div\n        class=\"card-container\"\n        *ngFor=\"let card of cardList\"\n        fxFlex\n        fxLayout=\"column\"\n        fxLayout.lt-md=\"row\"\n        [ngStyle]=\"{color: card.color}\"\n      >\n        <div class=\"card-header\" fxFlex=\"35\" fxLayoutAlign=\"space-between center\" fxLayout.lt-md=\"row-reverse\">\n          <label class=\"card-label\">{{card.label}}</label>\n          <img class=\"card-icon\" [src]=\"card.icon\" />\n        </div>\n        <div class=\"card-value\" fxFlex=\"65\" fxLayoutAlign=\"start center\" fxLayoutAlign.lt-md=\"end center\">\n          {{card.value}}\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n  height: 100%;\n}\n\nsection.card-section {\n  width: 100%;\n  height: 100%;\n}\n.card-section .card-container {\n  height: 100%;\n  background-color: currentColor;\n  box-shadow: 0px 2px 10px 0 rgba(0, 0, 0, 0.04);\n}\n.card-section .card-header {\n  background-color: rgba(0, 0, 0, 0.1);\n  padding: 1em var(--tb-config-padding);\n  padding-right: 1em;\n}\n.card-section .card-label {\n  font-size: 1.4em;\n  color: var(--tb-service-font-0);\n  opacity: 0.8;\n}\n.card-section .card-icon {\n  width: 2.8em;\n  height: 2.8em;\n}\n.card-section .card-value {\n  font-size: 3.2em;\n  padding: 0px calc(var(--tb-config-padding) / 3);\n  font-weight: 500;\n  color: var(--tb-service-font-0);\n}\n",
        "controllerScript": "self.onInit = function () {\n  self.ctx.custom = {};\n  defineVariables();\n  createCard();\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  insertData();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.cardList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.rootEntity = custom.ownerDatasource.entity;\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  custom.t = t;\n}\n\nfunction createCard() {\n  let { custom, $scope } = self.ctx;\n  $scope.cardList = [];\n  for (let i in custom.originDataKeys) {\n    $scope.cardList.push({\n      key: custom.originDataKeys[i].name,\n      label: t(custom.originDataKeys[i].label),\n      value: 0,\n      color: custom.originDataKeys[i].color,\n      icon: self.ctx.sanitizer.bypassSecurityTrustResourceUrl(ICON_LIST[i]),\n    });\n  }\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n}\n\nfunction insertData() {\n  let { $scope } = self.ctx;\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let key = target.dataKey.name;\n      let data = target.data[0][1];\n      let targetIndex = $scope.cardList.findIndex(x => x.key == key);\n      if (targetIndex != -1) {\n        if (_.isNil(data) || data == '') {\n          data = 0;\n        }\n        $scope.cardList[targetIndex].value = data;\n      }\n    }\n  }\n  self.ctx.detectChanges();\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\nconst ICON_LIST = [\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyOCAyOCI+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNDE3IC0yMjgpIj4KICAgICAgICA8cmVjdCB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIHJ4PSI0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0MTcgMjI4KSIgc3R5bGU9Im9wYWNpdHk6LjA5O2ZpbGw6I2ZmZiIvPgogICAgICAgIDxwYXRoIGQ9Ik0xNzEuMjcxIDI3OS44Nzd2LTEuMjRoMS4yNHYxLjI0em0wLTguMDM0di0xLjIxaDEuMjR2MS4yMXptMy4zODEgMTEuNDE1di0xLjI0aDEuMjR2MS4yNHptLS4wMDgtMTQuNzQ3di0xLjI0aDEuMjYxdjEuMjR6bTcuOTkyIDE0Ljc0N3YtMS4yNGgxLjI0djEuMjR6bS0uMDA4LTE0Ljc0N3YtMS4yNGgxLjI2MXYxLjI0em0zLjM4OSAxMS40NjV2LTEuMjRoMS4yNHYxLjI0em0tLjAwOC04LjE2M1YyNzAuNmgxLjI2MXYxLjIxem0tMTEuMzE2IDguMTIxdi05LjMxaDkuMTQxdjkuMzF6bTEuMjQtMS4yNGg2LjY2di02LjgyOWgtNi42NnptMy4zMzQtMy40MjJ6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNTEuNzI5IC0zMy4yNzEpIiBzdHlsZT0iZmlsbDojZmZmIi8+CiAgICA8L2c+Cjwvc3ZnPgo=',\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCIgdmlld0JveD0iMCAwIDI4IDI4Ij4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE2NzI2MiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTU4NiAtMTQwKSI+CiAgICAgICAgPHBhdGggZD0iTTEwNi40NjItODQ3LjZoMS40di03LjAxOGgtMS40em0zLjQ1NSAwaDEuNHYtNy4wMThoLTEuNHptLTEuMDI0IDUuMzgxYTguNjYgOC42NiAwIDAgMS0zLjQ2Ny0uNyA4Ljk3OSA4Ljk3OSAwIDAgMS0yLjgyMy0xLjkgOC45NzYgOC45NzYgMCAwIDEtMS45LTIuODIyIDguNjUyIDguNjUyIDAgMCAxLS43LTMuNDY2IDguNjYgOC42NiAwIDAgMSAuNy0zLjQ2NyA4Ljk4MSA4Ljk4MSAwIDAgMSAxLjktMi44MjMgOC45NzYgOC45NzYgMCAwIDEgMi44MjItMS45IDguNjUyIDguNjUyIDAgMCAxIDMuNDY2LS43IDguNjYxIDguNjYxIDAgMCAxIDMuNDY3LjcgOC45ODEgOC45ODEgMCAwIDEgMi44MjMgMS45IDguOTc2IDguOTc2IDAgMCAxIDEuOSAyLjgyMiA4LjY1MiA4LjY1MiAwIDAgMSAuNyAzLjQ2NiA4LjY2IDguNjYgMCAwIDEtLjcgMy40NjcgOC45OCA4Ljk4IDAgMCAxLTEuOSAyLjgyMyA4Ljk3NSA4Ljk3NSAwIDAgMS0yLjgyMiAxLjkgOC42NTIgOC42NTIgMCAwIDEtMy40NjYuN3ptMC0xLjRhNy4yMjUgNy4yMjUgMCAwIDAgNS4zMDctMi4xODEgNy4yMjUgNy4yMjUgMCAwIDAgMi4xNzYtNS4zMTEgNy4yMjUgNy4yMjUgMCAwIDAtMi4xNzYtNS4zMTEgNy4yMjUgNy4yMjUgMCAwIDAtNS4zMTEtMi4xNzYgNy4yMjUgNy4yMjUgMCAwIDAtNS4zMTEgMi4xNzYgNy4yMjUgNy4yMjUgMCAwIDAtMi4xNzYgNS4zMTEgNy4yMjUgNy4yMjUgMCAwIDAgMi4xNzYgNS4zMTEgNy4yMjUgNy4yMjUgMCAwIDAgNS4zMTMgMi4xNzd6bS0uMDAyLTcuNDl6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg0OTAuOTk2IDEwMDQuOTk5KSIgc3R5bGU9ImZpbGw6I2ZmZiIvPgogICAgICAgIDxyZWN0IGRhdGEtbmFtZT0i7IKs6rCB7ZiVIDE1MTA4OSIgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiByeD0iNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTg2IDE0MCkiIHN0eWxlPSJvcGFjaXR5Oi4xO2ZpbGw6I2ZmZiIvPgogICAgPC9nPgo8L3N2Zz4K',\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyOCAyOCI+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtODY3IC0yMjgpIj4KICAgICAgICA8cGF0aCBkPSJNMTIyLjY0NyAyMjMuNjMyaDEuMjd2LTUuNDg1aC0xLjI3em0zLjIxNiAwaDEuMjd2LTUuNDg1aC0xLjI3em0tLjk2NSA2LjE0NmE4LjcgOC43IDAgMCAxLTMuNDU1LS42OTIgOC45MiA4LjkyIDAgMCAxLTQuNzQ4LTQuNzM1QTguNjU0IDguNjU0IDAgMCAxIDExNiAyMjAuOWE5LjEzNCA5LjEzNCAwIDAgMSAuMTc5LTEuODExIDguNDE5IDguNDE5IDAgMCAxIC41NDgtMS43MjdsLjk5Mi45OTJhOS41ODkgOS41ODkgMCAwIDAtLjMyNyAxLjI0OSA2Ljg0NSA2Ljg0NSAwIDAgMC0uMTIyIDEuMjg5IDcuNjMyIDcuNjMyIDAgMSAwIDcuNjIzLTcuNjE5IDcuNTQ4IDcuNTQ4IDAgMCAwLTEuMjc5LjExIDkgOSAwIDAgMC0xLjI2OC4zMTVsLS45NzctLjk3N2ExNS4zNDQgMTUuMzQ0IDAgMCAxIDEuNy0uNTA5IDcuNTg3IDcuNTg3IDAgMCAxIDEuNzY0LS4yMDkgOC43NjEgOC43NjEgMCAwIDEgMy40NzguNjkgOS4wMjMgOS4wMjMgMCAwIDEgNC43NjcgNC43NDUgOC41NjMgOC41NjMgMCAwIDEgLjcgMy40NDYgOC42ODIgOC42ODIgMCAwIDEtLjY5NCAzLjQ1NCA4Ljk0NyA4Ljk0NyAwIDAgMS00LjczOSA0Ljc0OCA4LjYyNyA4LjYyNyAwIDAgMS0zLjQ0NS42OTN6bS01Ljk1Ni0xMy42NzFhMS4xNzEgMS4xNzEgMCAxIDEgLjgyMi0uMzQzIDEuMTIxIDEuMTIxIDAgMCAxLS44MjEuMzQzem01Ljk0OCA0Ljc4M3oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDc1Ni4xMSAyMS4zMzIpIiBzdHlsZT0iZmlsbDojZmZmIi8+CiAgICAgICAgPHJlY3Qgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiByeD0iNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODY3IDIyOCkiIHN0eWxlPSJvcGFjaXR5Oi4yO2ZpbGw6I2ZmZiIvPgogICAgPC9nPgo8L3N2Zz4K',\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyOCAyOCI+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNjQyIC0yMjgpIj4KICAgICAgICA8cmVjdCB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIHJ4PSI0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2NDIgMjI4KSIgc3R5bGU9Im9wYWNpdHk6LjI7ZmlsbDojZmZmIi8+CiAgICAgICAgPHBhdGggZD0iTTEyNS41MjEgMzE0LjQ2M0gxMzkuN2ExLjM3NyAxLjM3NyAwIDAgMSAxLjAyMi40MjkgMS40IDEuNCAwIDAgMSAuNDIxIDEuMDEzdjkuNjM0YTEuNCAxLjQgMCAwIDEtLjQyMSAxLjAxMyAxLjM4IDEuMzggMCAwIDEtMS4wMjQuNDI5aC02LjAyNnYtMS4xNWg2LjAyOGEuMjg0LjI4NCAwIDAgMCAuMy0uMjk1di05LjYzYS4yODQuMjg0IDAgMCAwLS4zLS4zaC0xNC4xNzdhLjI4NC4yODQgMCAwIDAtLjMuM3YxLjQ4MmgtMS4xNXYtMS40ODJhMS40NjcgMS40NjcgMCAwIDEgMS40NDMtMS40NDV6bS0xLjQ0MyAxMi41MTloMS42NjlhMS42NzIgMS42NzIgMCAwIDAtMS42NjktMS42ODF6bTMuNjY3IDBoMS4xNWE0LjgxNCA0LjgxNCAwIDAgMC00LjgxNi00LjgyOHYxLjE1YTMuNiAzLjYgMCAwIDEgMi42IDEuMDg2IDMuNTMgMy41MyAwIDAgMSAxLjA2NiAyLjU5MnptLTMuNjY3LTcuOTc2djEuMTUxYTYuNjQ3IDYuNjQ3IDAgMCAxIDIuNjQ5LjUzIDYuODA3IDYuODA3IDAgMCAxIDIuMTY3IDEuNDY3IDYuOTcgNi45NyAwIDAgMSAxLjQ2NSAyLjE3NSA2LjYyOCA2LjYyOCAwIDAgMSAuNTM0IDIuNjUyaDEuMTVhNy44MDcgNy44MDcgMCAwIDAtLjYyMi0zLjExNSA3Ljk4MSA3Ljk4MSAwIDAgMC00LjIzLTQuMjM0IDcuNzU1IDcuNzU1IDAgMCAwLTMuMTEzLS42MjZ6bTcuOTU5IDIuMjk0eiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNTIzLjAzMyAtNzguNDYzKSIgc3R5bGU9ImZpbGw6I2ZmZiIvPgogICAgPC9nPgo8L3N2Zz4K',\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyOCAyOCI+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTA5MiAtMjI4KSI+CiAgICAgICAgPHBhdGggZD0ibTEwNS4wMTggMjMyLjEzOC0uOS0uODc0YTQuMDM0IDQuMDM0IDAgMCAwIC41NzgtMS4xNDUgNC4xMTkgNC4xMTkgMCAwIDAgLjItMS4yNTQgMy42MSAzLjYxIDAgMCAwLS4zMDYtMS40NzIgNi4yNjkgNi4yNjkgMCAwIDAtLjc5MS0xLjMxOWwuODktLjg5YTUuOTEzIDUuOTEzIDAgMCAxIDEuMDc4IDEuNzEyIDUuMTU4IDUuMTU4IDAgMCAxIC4zODYgMS45NzkgNS4zIDUuMyAwIDAgMS0uMjgzIDEuNzA5IDUuMTY2IDUuMTY2IDAgMCAxLS44NTIgMS41NTR6bS0yLjM3NS0yLjM1MS0yLjYxNy0yLjYxN2ExLjI0MyAxLjI0MyAwIDAgMSAuNDQ0LS4xOTQgMi4xOTUgMi4xOTUgMCAwIDEgLjQ3OC0uMDU0IDEuOTU1IDEuOTU1IDAgMCAxIDEuOTQzIDEuOTQzIDIuMzQ3IDIuMzQ3IDAgMCAxLS4wNS40NzggMS4xMzUgMS4xMzUgMCAwIDEtLjE5OC40NDR6bTQuNzM0IDQuNzc0LS44NjYtLjkxNGE4LjIyNSA4LjIyNSAwIDAgMCAxLjMzLTIuMjMyIDYuOTI5IDYuOTI5IDAgMCAwLS4wOTQtNS4zNDEgOC42MTYgOC42MTYgMCAwIDAtMS41NzctMi4zNzRsLjg5LS44OWE4LjQ0NSA4LjQ0NSAwIDAgMSAyLjUyNyA2LjA1NSA4LjU5MSA4LjU5MSAwIDAgMS0uNTU3IDMuMDYxIDcuODM2IDcuODM2IDAgMCAxLTEuNjUyIDIuNjM1em0xLjEyMyA0LjkzOS02Ljk4MS02Ljk4MXY2LjA1MWgtMS4xMjl2LTcuMThsLTMuMjYzLTMuMjc5YTEuNyAxLjcgMCAwIDAtLjA5My4zNjQgMi42MDYgMi42MDYgMCAwIDAtLjAyNy4zNjkgNy4wODkgNy4wODkgMCAwIDAgLjMwOSAxLjUyMiAzLjE1OCAzLjE1OCAwIDAgMCAuNzg5IDEuMjkzbC0uODkuODlhNS4yNTcgNS4yNTcgMCAwIDEtMS4wODQtMS42OTEgNS4zMTcgNS4zMTcgMCAwIDEtLjM4LTEuOTkxIDguMDIxIDguMDIxIDAgMCAxIC4wNTMtLjkzNCAyLjM5MSAyLjM5MSAwIDAgMSAuMjY4LS44NTdsLTEuNjQ2LTEuNjUxYTYuMjE0IDYuMjE0IDAgMCAwLS42NTEgMS42NTEgNy43NiA3Ljc2IDAgMCAwLS4yMDUgMS43OSA2Ljc1MiA2Ljc1MiAwIDAgMCAuNTggMi43NjcgOC40NjkgOC40NjkgMCAwIDAgMS41OCAyLjM3NGwtLjg5Ljg5YTcuOTI0IDcuOTI0IDAgMCAxLTEuODgxLTIuNzQ0IDguNTQyIDguNTQyIDAgMCAxLS42NDYtMy4yODggOS4xMzIgOS4xMzIgMCAwIDEgLjI4Mi0yLjI2NCA3LjM0NSA3LjM0NSAwIDAgMSAuOS0yLjFsLTEuNjg1LTEuNjg1LjgxOC0uNzc4IDE2LjY0MiAxNi42NDJ6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMDA1LjMwMSAxMS4yOTUpIiBzdHlsZT0iZmlsbDojZmZmIi8+CiAgICAgICAgPHJlY3Qgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiByeD0iNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTA5MiAyMjgpIiBzdHlsZT0ib3BhY2l0eTouMTQ7ZmlsbDojZmZmIi8+CiAgICA8L2c+Cjwvc3ZnPgo=',\n  'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyOCAyOCI+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTMxNyAtMjI4KSI+CiAgICAgICAgPHJlY3Qgd2lkdGg9IjI4IiBoZWlnaHQ9IjI4IiByeD0iNCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTMxNyAyMjgpIiBzdHlsZT0ib3BhY2l0eTouMTU7ZmlsbDojZmZmIi8+CiAgICAgICAgPHBhdGggZD0iTTIxMi4zMzQgMjM0LjkxNWg0LjQ5M3YtLjczOGgtMy42NDhsMy42NDgtNC4yODl2LS43MzhoLTQuNDkzdi43MzhoMy42NDhsLTMuNjQ4IDQuMjg5em0tNC45ODcgMy45NjV2LTEuMjcyaDEuMjUzdi02LjY0M2E1LjkxNSA1LjkxNSAwIDAgMSAxLjQtMy44ODQgNS42NTEgNS42NTEgMCAwIDEgMy42MDktMi4wMzV2LTEuNGEuOTIyLjkyMiAwIDAgMSAuMjc2LS42OC45MzMuOTMzIDAgMCAxIC42ODYtLjI3NS45NDMuOTQzIDAgMCAxIC42ODguMjc1LjkxOS45MTkgMCAwIDEgLjI3OS42ODJ2MS4zOTVhNS42ODcgNS42ODcgMCAwIDEgMy42MTEgMi4wMTcgNS44ODggNS44ODggMCAwIDEgMS40MDggMy45djYuNjQzaDEuMjUydjEuMjcyem03LjIzMS03LjEwN3ptLS4wMDYgMTAuMTIxYTEuNjQ5IDEuNjQ5IDAgMCAxLTEuNjU3LTEuNjYzaDMuMzI1YTEuNiAxLjYgMCAwIDEtLjQ4MiAxLjE4NyAxLjYyMyAxLjYyMyAwIDAgMS0xLjE4Ni40NzZ6bS00LjctNC4yODZoOS40MnYtNi42NDFhNC43MSA0LjcxIDAgMSAwLTkuNDIgMHoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDExMTYuNDUzIDkuNzA2KSIgc3R5bGU9ImZpbGw6I2ZmZiIvPgogICAgPC9nPgo8L3N2Zz4K',\n];\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.6135145608617525,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Cos\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.7660017785097148,\"funcBody\":\"return Math.round(1000*Math.cos(time/5000));\"},{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random 2\",\"color\":\"#ffc107\",\"settings\":{},\"_hash\":0.7666126837866614,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Summary Entity\",\"showTitleIcon\":false,\"dropShadow\":true,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "summary_operation_ratio",
      "name": "Summary Operation Ratio",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 8,
        "sizeY": 2,
        "resources": [],
        "templateHtml": "<div id=\"widget\">\n  <main class=\"widget-content\" fxLayout=\"column\" fxLayoutAlign=\"space-between center\">\n    <section class=\"compare-section\" fxFlex fxLayoutAlign=\"space-between start\">\n      <div class=\"day-section\" fxLayoutAlign=\"space-between start\">\n        <div class=\"value-container\" fxLayout=\"column\" fxLayoutAlign=\"space-between start\">\n          <div class=\"value-title\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n            <div class=\"day-line\" [ngStyle]=\"{'backgroundColor': ratioColor}\"></div>\n            <div class=\"title\" translate>thingplus.energy.day-ratio</div>\n          </div>\n          <div class=\"value-value\">{{ dayRatio }}%</div>\n        </div>\n        <div class=\"compare-container\" fxLayout=\"column\" fxLayoutAlign=\"start end\">\n          <div\n            class=\"compare-value\"\n            [ngClass]=\"{'high': dayCompare > 0, 'low': dayCompare < 0}\"\n            fxLayoutAlign=\"end center\"\n            fxLayoutGap=\"1em\"\n          >\n            <i class=\"material-icons\"\n              >{{ dayCompare > 0 ? 'arrow_upward' : (dayCompare < 0 ? 'arrow_downward' : '')}}</i\n            >\n            {{ dayCompare }}%\n          </div>\n          <div class=\"compare-title\" translate>thingplus.energy.compare-last-day</div>\n        </div>\n      </div>\n      <div class=\"month-section\" fxLayoutAlign=\"space-between start\">\n        <div class=\"value-container\" fxLayout=\"column\" fxLayoutAlign=\"space-between start\">\n          <div class=\"value-title\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n            <div class=\"month-line\"></div>\n            <div class=\"title\" translate>thingplus.energy.month-ratio</div>\n          </div>\n          <div class=\"value-value\">{{ monthRatio }}%</div>\n        </div>\n        <div class=\"compare-container\" fxLayout=\"column\" fxLayoutAlign=\"start end\">\n          <div\n            class=\"compare-value\"\n            [ngClass]=\"{'high': monthCompare > 0, 'low': monthCompare < 0}\"\n            fxLayoutAlign=\"end center\"\n            fxLayoutGap=\"1em\"\n          >\n            <i class=\"material-icons\"\n              >{{ monthCompare > 0 ? 'arrow_upward' : (monthCompare < 0 ? 'arrow_downward' : '')}}</i\n            >\n            {{ monthCompare }}%\n          </div>\n          <div class=\"compare-title\" translate>thingplus.energy.compare-last-month</div>\n        </div>\n      </div>\n    </section>\n    <section class=\"operation-section\">\n      <div class=\"operation-container\">\n        <div class=\"background\"></div>\n        <div class=\"foreground foreground-month\" [ngStyle]=\"{'width': monthRatio + '%'}\"></div>\n        <div\n          class=\"foreground foreground-day\"\n          [ngStyle]=\"{'width': dayRatio + '%', 'backgroundColor': ratioColor}\"\n        ></div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n.widget-header-right-section .ratio-container {\n  font-size: 2.4em;\n  letter-spacing: -0.1em;\n  color: var(--tb-service-font-5);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n  height: 100%;\n}\n\nsection.compare-section {\n  width: 100%;\n  padding: 1.6em 2.4em;\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.compare-section .day-section,\n.compare-section .month-section {\n  width: 50%;\n  height: 100%;\n}\n.compare-section .day-section {\n  border-right: 1px solid var(--tb-service-border-1);\n  padding-right: 1.6em;\n}\n.compare-section .month-section {\n  padding-left: 1.6em;\n}\n.compare-section .value-container {\n  height: 100%;\n}\n.compare-section .day-line {\n  width: 1em;\n  height: 0.4em;\n  background-color: var(--tb-service-background-4);\n}\n.compare-section .month-line {\n  width: 1em;\n  height: 1.2em;\n  background-color: var(--tb-service-background-5);\n  border-right: 1px solid var(--tb-service-font-5);\n}\n.compare-section .value-title .title {\n  font-size: 1.4em;\n  color: var(--tb-service-font-4);\n}\n.compare-section .value-value {\n  font-size: 2em;\n  color: var(--tb-service-font-5);\n  font-weight: 600;\n}\n.compare-section .compare-title {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.compare-section .compare-value {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.compare-section .compare-value i {\n  display: none;\n  font-size: 1.2em;\n  font-weight: 600;\n}\n.compare-section .compare-value.high i,\n.compare-section .compare-value.low i {\n  display: block;\n}\n.compare-section .compare-value.high {\n  color: var(--tb-service-compare-high);\n}\n.compare-section .compare-value.low {\n  color: var(--tb-service-compare-low);\n}\n\nsection.operation-section {\n  width: 100%;\n  height: 4em;\n  padding: 2em 1.4em;\n}\n.operation-section .operation-container {\n  width: 100%;\n  height: 100%;\n  position: relative;\n}\n.operation-section .background,\n.operation-section .foreground {\n  position: absolute;\n  top: 50%;\n  left: 0%;\n  transform: translateY(-50%);\n  height: 0.4em;\n}\n\n.operation-section .background {\n  width: 100%;\n  background-color: var(--tb-service-background-4);\n}\n.operation-section .foreground {\n  background-color: var(--tb-service-background-5);\n  transition-property: width, background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.operation-section .foreground.foreground-month {\n  height: 1.2em;\n  background-color: var(--tb-service-background-5);\n  border-right: 1px solid var(--tb-service-font-5);\n}\n\n@media (max-width: 599px) {\n  .operation-section .background,\n  .operation-section .foreground {\n    height: 0.8em;\n  }\n  .operation-section .foreground.foreground-month {\n    height: 2.4em;\n  }\n}\n",
        "controllerScript": "self.onInit = function () {\n  self.ctx.custom = {};\n  defineVariables();\n  setTitle();\n  \n  if(!self.ctx.custom.isSample){\n      console.log(self.ctx)\n        let option = _.cloneDeep(self.ctx.defaultSubscription.options)\n        option.datasources[1].dataKeys[0].name = 'TP_InactivatedDevice'\n        delete option.datasources[0]\n        console.log(option)\n        let subscription = self.ctx.subscriptionApi.createSubscription(option)\n        subscription.subscribe((data)=>{\n            console.log('data : ', data)\n        })\n  }\n\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n    console.log(self.ctx.data)\n  if (!self.ctx.custom.isSample) {\n    self.ctx.custom.loadThrottle();\n  }\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.ratio = 0;\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.loadThrottle = _.throttle(loadData, 60000, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.rootEntity = custom.ownerDatasource.entity;\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  custom.t = t;\n  custom.computedStyle = getComputedStyle($container[0]);\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction loadData() {\n  let { custom } = self.ctx;\n  let now = moment().valueOf();\n  let currentDate = moment(now).date();\n  let prevMaxDate = moment(now).startOf('month').subtract(1, 'hours').date();\n  let targetDate = currentDate > prevMaxDate ? prevMaxDate : currentDate;\n  custom.timeInfo = [\n    {\n      start: moment(now).startOf('day').valueOf(),\n      end: now,\n    },\n    {\n      start: moment(now).startOf('month').valueOf(),\n      end: now,\n    },\n    {\n      start: moment(now).subtract(1, 'days').startOf('day').valueOf(),\n      end: now - 86400000,\n    },\n    {\n      start: moment(now).subtract(1, 'months').startOf('month').valueOf(),\n      end: moment(now).subtract(1, 'months').startOf('month').date(targetDate).valueOf(),\n    },\n  ];\n\n  let observables = [];\n  let entityId = self.ctx.defaultSubscription.configuredDatasources[1].entity.id.id;\n  let entityType = self.ctx.defaultSubscription.configuredDatasources[1].entity.id.entityType;\n  for (let i in custom.timeInfo) {\n    observables.push(\n      self.ctx.http.get(\n        `/api/plugins/telemetry/${entityType}/${entityId}/values/timeseries?agg=NONE&limit=50000&interval=86400000&keys=${custom.originDataKeys\n          .map(x => x.name)\n          .join(',')}&startTs=${custom.timeInfo[i].start}&endTs=${custom.timeInfo[i].end}`\n      )\n    );\n  }\n\n  self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n    custom.mainData = [\n      { actual: 0, plan: 0 },\n      { actual: 0, plan: 0 },\n      { actual: 0, plan: 0 },\n      { actual: 0, plan: 0 },\n    ];\n    for (let i in datas) {\n      if (datas[i].TP_WorkTimeRaw) {\n        datas[i].TP_WorkTimeRaw.forEach(element => {\n          custom.mainData[i].actual += Number(element.value);\n        });\n      }\n      if (datas[i].TP_PlannedWorkTimeDay) {\n        datas[i].TP_PlannedWorkTimeDay.forEach(element => {\n          custom.mainData[i].plan += Number(element.value);\n        });\n      }\n    }\n\n    insertData();\n  });\n}\n\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  $scope.dayRatio = _.round((custom.mainData[0].actual / custom.mainData[0].plan) * 100, 1);\n  $scope.monthRatio = _.round((custom.mainData[1].actual / custom.mainData[1].plan) * 100, 1);\n  $scope.yesterdayRatio = (custom.mainData[2].actual / custom.mainData[2].plan) * 100;\n  $scope.lastMonthRatio = (custom.mainData[3].actual / custom.mainData[3].plan) * 100;\n  $scope.dayCompare = _.round((($scope.dayRatio - $scope.yesterdayRatio) / $scope.yesterdayRatio) * 100, 1);\n  $scope.monthCompare = _.round((($scope.monthRatio - $scope.lastMonthRatio) / $scope.lastMonthRatio) * 100, 1);\n  if (isNaN($scope.yesterdayRatio)) {\n    $scope.dayCompare = 0;\n  }\n  if (isNaN($scope.monthCompare)) {\n    $scope.monthCompare = 0;\n  }\n\n  $scope.ratioColor = getHsl($scope.dayRatio);\n  self.ctx.detectChanges();\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction getHsl(value) {\n  if (value > 100) {\n    value = 100;\n  }\n  return tinycolor(getStyle('--tb-service-progress'))\n    .brighten(_.round((100 - value) / 4))\n    .toHexString();\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random 2\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.06456950264555084,\"funcBody\":\"var value = Math.random() * 100\\nreturn value;\",\"units\":null,\"decimals\":null,\"usePostProcessing\":null,\"postFuncBody\":null}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Summary Operation Ratio\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":true,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"-0.04em\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "summary_device",
      "name": "Summary Device",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 9.5,
        "sizeY": 5.5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"center center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\" fxShow.xs=\"false\">\n      <div class=\"widget-title\">title</div>\n    </section>\n    <section class=\"widget-header-center-section\" fxFlex fxLayoutAlign=\"center center\" fxLayoutGap=\"1em\">\n      <section class=\"legend-section\" fxLayoutAlign=\"center center\" fxLayoutGap=\"2em\">\n        <div\n          class=\"legend-box\"\n          *ngFor=\"let legend of legendList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.6em\"\n          [ngClass]=\"{'hidden': legend.isHidden}\"\n          (click)=\"toggleLegend($event, legend)\"\n        >\n          <div class=\"legend-circle\" [ngStyle]=\"{'color': legend.color}\"></div>\n          <div class=\"legend-label\">{{legend.label}}</div>\n        </div>\n      </section>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <section class=\"view-section\" fxLayoutAlign=\"center center\">\n        <div\n          class=\"view-box\"\n          *ngFor=\"let view of viewList\"\n          [ngClass]=\"{'active' : view.isActive}\"\n          (click)=\"changeView($event, view)\"\n        >\n          <i class=\"material-icons\">{{view.icon}}</i>\n        </div>\n      </section>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"device-section\" *ngIf=\"currentLevel < 2\">\n      <div class=\"device-group\" *ngFor=\"let group of groupList\" [ngClass]=\"{'fold': group.isFold}\">\n        <div class=\"group-title-box\" fxLayoutAlign=\"space-between center\">\n          <div class=\"group-title\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n            <span class=\"title-name\">{{group.title}}</span>\n            <label class=\"title-label\" translate>thingplus.label.customerL1</label>\n          </div>\n          <i class=\"material-icons fold-icon\" (click)=\"toggleFold(e, group)\">expand_less</i>\n        </div>\n        <div class=\"group-content\">\n          <div\n            class=\"sub-device-group\"\n            *ngFor=\"let subGroup of group.subGroupList\"\n            [ngClass]=\"{'fold': subGroup.isFold}\"\n          >\n            <div class=\"sub-group-title-box\" fxLayoutAlign=\"space-between center\">\n              <div class=\"group-title sub\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n                <span class=\"title-name\">{{subGroup.title}}</span>\n                <label class=\"title-label\" translate>thingplus.label.customerL2</label>\n              </div>\n              <i class=\"material-icons sub-fold-icon\" (click)=\"toggleFold(e, subGroup)\">expand_less</i>\n            </div>\n            <div\n              class=\"card-group-content\"\n              [ngStyle]=\"{'grid-template-columns': 'repeat(' + cardColumns + ', 1fr)'}\"\n              *ngIf=\"selectedView == 'CARD' && subGroup.deviceList.length > 0\"\n            >\n              <section\n                class=\"card-section tooltip-{{device.index}}\"\n                fxLayout=\"column\"\n                fxLayoutAlign=\"space-between center\"\n                *ngFor=\"let device of subGroup.deviceList\"\n                (click)=\"selectDevice($event, device)\"\n                [ngClass]=\"{'hidden': filterList.includes(device.state)}\"\n              >\n                <div class=\"card-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"0.5em\">\n                  <div class=\"card-title\">{{device.label}}</div>\n                  <div\n                    class=\"card-state\"\n                    fxLayoutAlign=\"center center\"\n                    [ngClass]=\"device.state != undefined && stateList[device.state] ? stateList[device.state].key : ''\"\n                  >\n                    {{device.state != undefined && stateList[device.state] ? stateList[device.state].label : ''}}\n                  </div>\n                </div>\n                <div class=\"card-content\" fxLayout=\"column\" fxLayoutGap=\"1em\">\n                  <div class=\"content-value-box\" fxLayoutAlign=\"space-between center\">\n                    <label class=\"device-label\" translate>thingplus.energy.operation-rate</label>\n                    <span class=\"device-value\">{{device.ratio}} %</span>\n                  </div>\n                  <div class=\"content-progress-box\">\n                    <div class=\"background\"></div>\n                    <div\n                      class=\"foreground\"\n                      [ngStyle]=\"{'width': (device.ratio > 100 ? 100 : device.ratio) + '%', 'backgroundColor': device.ratioColor}\"\n                    ></div>\n                  </div>\n                </div>\n              </section>\n            </div>\n            <div class=\"list-group-content\" *ngIf=\"selectedView == 'LIST' && subGroup.deviceList.length > 0\">\n              <section class=\"table-section\">\n                <table class=\"table\">\n                  <thead>\n                    <tr>\n                      <th\n                        *ngFor=\"let th of thList\"\n                        (click)=\"changeSort($event, subGroup, th)\"\n                        [ngClass]=\"{'DESC': th.index == subGroup.orderIndex && subGroup.orderDirection == 'DESC',\n                                    'ASC': th.index == subGroup.orderIndex && subGroup.orderDirection == 'ASC'}\"\n                      >\n                        <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                          <span class=\"th-label\">{{th.label}}</span>\n                          <i class=\"th-sort material-icons\">arrow_upward</i>\n                        </div>\n                      </th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    <tr\n                      *ngFor=\"let device of subGroup.deviceList\"\n                      (click)=\"selectDevice($event, device)\"\n                      [ngClass]=\"{'hidden': filterList.includes(device.state)}\"\n                    >\n                      <td *ngFor=\"let td of device.tdList\" [style]=\"td.style\" [innerHTML]=\"td.content\"></td>\n                    </tr>\n                  </tbody>\n                </table>\n              </section>\n            </div>\n          </div>\n        </div>\n      </div>\n    </section>\n    <section class=\"device-section\" *ngIf=\"currentLevel == 2\">\n      <div class=\"sub-device-group\" *ngFor=\"let subGroup of groupList\" [ngClass]=\"{'fold': subGroup.isFold}\">\n        <div class=\"sub-group-title-box\" fxLayoutAlign=\"space-between center\">\n          <div class=\"group-title sub\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n            <span class=\"title-name\">{{subGroup.title}}</span>\n            <label class=\"title-label\" translate>thingplus.label.customerL2</label>\n          </div>\n          <i class=\"material-icons sub-fold-icon\" (click)=\"toggleFold(e, subGroup)\">expand_less</i>\n        </div>\n        <div\n          class=\"card-group-content\"\n          [ngStyle]=\"{'grid-template-columns': 'repeat(' + cardColumns + ', 1fr)'}\"\n          *ngIf=\"selectedView == 'CARD' && subGroup.deviceList.length > 0\"\n        >\n          <section\n            class=\"card-section tooltip-{{device.index}}\"\n            fxFlex\n            fxLayout=\"column\"\n            fxLayoutAlign=\"space-between center\"\n            *ngFor=\"let device of subGroup.deviceList\"\n            (click)=\"selectDevice($event, device)\"\n            [ngClass]=\"{'hidden': filterList.includes(device.state)}\"\n          >\n            <div class=\"card-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"0.5em\">\n              <div class=\"card-title\">{{device.label}}</div>\n              <div\n                class=\"card-state\"\n                fxLayoutAlign=\"center center\"\n                [ngClass]=\"device.state != undefined && stateList[device.state] ? stateList[device.state].key : ''\"\n              >\n                {{device.state != undefined && stateList[device.state] ? stateList[device.state].label : ''}}\n              </div>\n            </div>\n            <div class=\"card-content\" fxLayout=\"column\" fxLayoutGap=\"1em\">\n              <div class=\"content-value-box\" fxLayoutAlign=\"space-between center\">\n                <label class=\"device-label\" translate>thingplus.energy.operation-rate</label>\n                <span class=\"device-value\">{{device.ratio}} %</span>\n              </div>\n              <div class=\"content-progress-box\">\n                <div class=\"background\"></div>\n                <div\n                  class=\"foreground\"\n                  [ngStyle]=\"{'width': (device.ratio > 100 ? 100 : device.ratio) + '%', 'backgroundColor': device.ratioColor}\"\n                ></div>\n              </div>\n            </div>\n          </section>\n        </div>\n        <div class=\"list-group-content\" *ngIf=\"selectedView == 'LIST' && subGroup.deviceList.length > 0\">\n          <section class=\"table-section\">\n            <table class=\"table\">\n              <thead>\n                <tr>\n                  <th\n                    *ngFor=\"let th of thList\"\n                    (click)=\"changeSort($event, subGroup, th)\"\n                    [ngClass]=\"{'DESC': th.index == subGroup.orderIndex && subGroup.orderDirection == 'DESC',\n                                'ASC': th.index == subGroup.orderIndex && subGroup.orderDirection == 'ASC'}\"\n                  >\n                    <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                      <span class=\"th-label\">{{th.label}}</span>\n                      <i class=\"th-sort material-icons\">arrow_upward</i>\n                    </div>\n                  </th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr\n                  *ngFor=\"let device of subGroup.deviceList\"\n                  (click)=\"selectDevice($event, device)\"\n                  [ngClass]=\"{'hidden': filterList.includes(device.state)}\"\n                >\n                  <td *ngFor=\"let td of device.tdList\" [style]=\"td.style\" [innerHtml]=\"td.content\"></td>\n                </tr>\n              </tbody>\n            </table>\n          </section>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/* widget-header-center-section */\n.widget-header-center-section .legend-circle {\n  width: 0.6em;\n  height: 0.6em;\n  background-color: currentColor;\n}\n.widget-header-center-section .legend-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.widget-header-center-section .legend-box.hidden .legend-label {\n  text-decoration: line-through;\n}\n\n/* widget-header-right-section */\n.widget-header-right-section .view-box {\n  color: var(--tb-service-font-2);\n  border: 1px solid var(--tb-service-border-0);\n  background-color: var(--tb-service-background-2);\n  cursor: pointer;\n  transition-property: border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .view-box.active {\n  background-color: var(--tb-service-background-0);\n  color: var(--tb-service-accent);\n}\n.widget-header-right-section .view-box:not(.active):hover {\n  border-color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .view-box:not(.active):active {\n  border-color: var(--tb-service-accent-pressed);\n}\n.widget-header-right-section .view-box i {\n  font-size: 2em;\n  padding: 0.2em;\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n  padding: 2em;\n  padding-top: 0em;\n}\n\n/* .device-section */\nsection.device-section {\n  width: 100%;\n  height: 100%;\n  overflow-y: auto;\n  overflow-x: hidden;\n}\nsection.device-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\nsection.device-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\nsection.device-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.device-section .device-group {\n  width: 100%;\n  margin-bottom: 2em;\n}\n.device-section .group-title-box,\n.device-section .sub-group-title-box {\n  width: 100%;\n  border-top: 1px solid var(--tb-service-border-2);\n  border-bottom: 1px solid var(--tb-service-border-2);\n}\n.device-section .group-title-box {\n  border-top: 1px solid var(--tb-service-accent);\n  background-color: var(--tb-service-background-0);\n}\n.device-section .sub-group-title-box {\n  margin-top: -1px;\n  background-color: var(--tb-service-background-3);\n}\n\n.device-section .group-title {\n  padding: 2em;\n  color: var(--tb-service-font-5);\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n.device-section .group-title.sub {\n  margin-left: 2em;\n}\n.device-section .group-title .title-name {\n  font-size: 1.6em;\n}\n.device-section .group-title .title-label {\n  font-size: 1em;\n  padding: 0.4em 0.8em;\n  border-radius: 2em;\n  color: var(--tb-service-accent);\n  background-color: var(--tb-service-accent-a100);\n}\n.device-section .group-title.sub .title-label {\n  color: var(--tb-service-customerL2);\n  background-color: var(--tb-service-blur-customerL2);\n}\n.device-section .fold-icon,\n.device-section .sub-fold-icon {\n  font-size: 2em;\n  padding: 0.5em;\n  margin: 0em 0.5em;\n  color: var(--tb-service-accent);\n  cursor: pointer;\n  transition-property: color, transform;\n  transition-duration: var(--tb-config-color-duration);\n}\n.device-section .fold-icon:hover,\n.device-section .sub-fold-icon:hover {\n  color: var(--tb-service-accent-hover);\n}\n.device-section .fold-icon:active,\n.device-section .sub-fold-icon:active {\n  color: var(--tb-service-accent-pressed);\n}\n.device-section .device-group.fold .fold-icon {\n  transform: rotate(180deg);\n}\n.device-section .sub-device-group.fold .sub-fold-icon {\n  transform: rotate(180deg);\n}\n.device-section .group-content,\n.device-section .card-group-content,\n.device-section .list-group-content {\n  width: 100%;\n  overflow: hidden;\n  transition-property: height;\n  transition-duration: var(--tb-config-color-duration);\n}\n.device-section .card-group-content {\n  padding: 2em;\n  gap: 2em;\n  display: grid;\n  grid-template-columns: repeat(6, 1fr);\n  background-color: var(--tb-service-background-6);\n}\n.device-section .device-group.fold .group-content {\n  height: 0px !important;\n}\n.device-section .sub-device-group.fold .card-group-content,\n.device-section .sub-device-group.fold .list-group-content {\n  height: 0px !important;\n  padding: 0px;\n}\n\n/* card-section */\n.card-section {\n  width: 100%;\n  min-width: 250px;\n  background-color: var(--tb-service-background-0);\n  box-shadow: 0 0.2em 1em 0 rgba(0, 0, 0, 0.1);\n  border: 1px solid var(--tb-service-border-0);\n  cursor: pointer;\n  transition-property: box-shadow;\n  transition-duration: var(--tb-config-color-duration);\n}\n.card-section.hidden {\n  display: none !important;\n}\n.card-section:hover {\n  box-shadow: 0 0.2em 1em 0 rgba(0, 0, 0, 0.3);\n}\n.card-section:active {\n  box-shadow: 0 0.2em 1em 0 rgba(0, 0, 0, 0.5);\n}\n.card-section .card-header {\n  width: 100%;\n  padding: 1.4em;\n  border-bottom: 1px solid var(--tb-service-border-0);\n}\n.card-section .card-title {\n  font-size: 1.4em;\n  color: var(--tb-service-font-5);\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n.card-section .card-state {\n  width: 5em;\n  min-width: 50px;\n  height: 2em;\n  min-height: 20px;\n  border: 1px solid currentColor;\n  font-size: 1em;\n  text-align: center;\n}\n.card-section .card-state.working {\n  color: var(--tb-service-working);\n  background-color: var(--tb-service-blur-working);\n}\n.card-section .card-state.waiting {\n  color: var(--tb-service-waiting);\n  background-color: var(--tb-service-blur-waiting);\n}\n.card-section .card-state.stopped {\n  color: var(--tb-service-stopped);\n  background-color: var(--tb-service-blur-stopped);\n}\n.card-section .card-state.unconnected {\n  color: var(--tb-service-unconnected);\n  background-color: var(--tb-service-blur-unconnected);\n}\n.card-section .card-state.inactivated {\n  color: var(--tb-service-inactivated);\n  background-color: var(--tb-service-blur-inactivated);\n}\n.card-section .card-content {\n  width: 100%;\n  padding: 2em;\n}\n.card-section .device-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-2);\n}\n.card-section .device-value {\n  font-size: 1.2em;\n  color: var(--tb-service-font-5);\n}\n.card-section .content-progress-box {\n  width: 100%;\n  position: relative;\n}\n.device-section .background,\n.device-section .foreground {\n  position: absolute;\n  top: 50%;\n  left: 0%;\n  transform: translateY(-50%);\n  height: 0.4em;\n}\n.device-section .background {\n  width: 100%;\n  background-color: var(--tb-service-background-3);\n}\n.device-section .foreground {\n  background-color: var(--tb-service-background-3);\n  transition-property: width, background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  overflow: auto;\n}\n.table-section .table {\n  min-width: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-2);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  width: calc(100% / 6);\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  cursor: pointer;\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr.hidden {\n  display: none !important;\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section td {\n  line-height: 1;\n  color: var(--tb-service-font-4);\n  padding: 1.2em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section .td-state {\n  display: flex;\n  align-items: center;\n}\n.table-section .td-state,\n.table-section .td-operation {\n  font-size: calc(1em / 1.4);\n}\n.table-section .td-state-color {\n  width: 0.8em;\n  height: 0.8em;\n  margin-right: 1em;\n}\n.table-section .td-state-color.working {\n  background-color: var(--tb-service-working);\n}\n.table-section .td-state-color.waiting {\n  background-color: var(--tb-service-waiting);\n}\n.table-section .td-state-color.stopped {\n  background-color: var(--tb-service-stopped);\n}\n.table-section .td-state-color.unconnected {\n  background-color: var(--tb-service-unconnected);\n}\n.table-section .td-state-color.inactivated {\n  background-color: var(--tb-service-inactivated);\n}\n.table-section .td-state-label {\n  font-size: 1.4em;\n}\n.table-section .td-operation {\n  width: 100%;\n  display: flex;\n  justify-content: start;\n  align-items: center;\n}\n.table-section .td-progress-box {\n  width: 75%;\n  position: relative;\n  margin-right: 1em;\n}\n.table-section .td-operation-value {\n  font-size: 1.2em;\n}\n\n@media (max-width: 599px) {\n  .widget-header-center-section .legend-circle {\n    width: 1.6em;\n    height: 1.6em;\n  }\n  .widget-header-center-section .legend-label {\n    font-size: 2em;\n  }\n  .widget-header-right-section .view-box i {\n    font-size: 4em;\n    padding: 0.2em;\n  }\n}\n",
        "controllerScript": "const ENTITY_TYPE = ['TENANT', 'CUSTOMER_L1', 'CUSTOMER_L2'];\nconst STANDARD_WINDOW_SIZE = 1920 / 100;\nconst HOUR_MS = 3600000;\nconst OPERATION_MAP = {\n  WORK: 2,\n  WAIT: 1,\n  STOP: 0,\n  true: 2,\n  false: 0,\n};\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom, $scope } = self.ctx;\n  defineVariables();\n  setTitle();\n  linkEvent();\n  getDashboardParameter();\n  self.onResize();\n  custom.dashboardList = await getDashboardList();\n\n  if (!custom.isSample) {\n    // 현재 사용자의 Root 엔터티로부터 관계 트리 형성\n    custom.relations[custom.rootEntity.id.id] = {\n      id: custom.rootEntity.id,\n      name: custom.rootEntity.name,\n      parent: '',\n      child: [],\n    };\n    $scope.ownerLevel = await getCurrentLevel();\n    $scope.currentLevel = $scope.ownerLevel;\n    await getCustomer([custom.relations[custom.rootEntity.id.id]]);\n  }\n  makeGroup();\n  makeHead();\n  self.onResize();\n\n  loadApi();\n  custom.loadInterval = setInterval(() => {\n    // 매분 00초에 동작\n    if (moment().second() == 0) {\n      loadApi();\n    }\n  }, 1000);\n};\n\nself.onDataUpdated = function () {\n  let { custom, $scope } = self.ctx;\n  custom.latestData = {};\n  custom.attributeData = {};\n  for (let i in self.ctx.datasources) {\n    custom.latestData[self.ctx.datasources[i].entityId] = {};\n    custom.attributeData[self.ctx.datasources[i].entityId] = {};\n  }\n  let latestKey = ['TP_ActivationState', 'TP_PlannedWorkTimeDay', 'TP_ConnectionState', 'TP_OperationState'];\n  let attributeKey = ['model', 'manager'];\n  let inData = false;\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      inData = true;\n      let key = target.dataKey.name;\n      let entityId = target.datasource.entityId;\n      let data = target.data[0][1];\n      if (latestKey.includes(key)) {\n        custom.latestData[entityId][key] = data;\n      }\n      if (attributeKey.includes(key)) {\n        custom.attributeData[entityId][key] = data;\n      }\n    }\n  }\n  // 최초에 Socket이 API보다 더 느리게 동작하는 경우를 대비\n  if (custom.isApiLoaded && !custom.isSocketLoaded) {\n    startUpdate();\n  }\n  if (inData) {\n    custom.isSocketLoaded = true;\n  }\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDestroy = function () {\n  let { custom, $scope, $container } = self.ctx;\n  try {\n    if (custom.loadInterval) {\n      clearInterval(custom.loadInterval);\n    }\n    $('.tooltip', $container).tooltipster('destroy');\n  } catch (e) {\n    log(e);\n  }\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.ownerLevel = 2;\n  $scope.cardColumns = 6;\n  $scope.currentLevel = 2;\n  $scope.filterList = [];\n  $scope.stateList = [\n    {\n      key: 'stopped',\n      label: t('thingplus.state.stopped'),\n    },\n    {\n      key: 'waiting',\n      label: t('thingplus.state.waiting'),\n    },\n    {\n      key: 'working',\n      label: t('thingplus.state.working'),\n    },\n    {\n      key: 'trial',\n      label: t('thingplus.state.trial'),\n    },\n    {\n      key: 'unconnected',\n      label: t('thingplus.state.unconnected'),\n    },\n    {\n      key: 'inactivated',\n      label: t('thingplus.state.inactivated'),\n    },\n  ];\n  $scope.selectedView = 'CARD';\n  $scope.legendList = [\n    { value: 0, isHidden: false, color: 'var(--tb-service-stopped)', label: t('thingplus.state.stopped') },\n    { value: 1, isHidden: false, color: 'var(--tb-service-waiting)', label: t('thingplus.state.waiting') },\n    { value: 2, isHidden: false, color: 'var(--tb-service-working)', label: t('thingplus.state.working') },\n    { value: 4, isHidden: false, color: 'var(--tb-service-unconnected)', label: t('thingplus.state.unconnected') },\n    { value: 5, isHidden: false, color: 'var(--tb-service-inactivated)', label: t('thingplus.state.inactivated') },\n  ];\n  $scope.viewList = [\n    { index: 0, key: 'CARD', isActive: true, icon: 'dashboard' },\n    { index: 1, key: 'LIST', isActive: false, icon: 'list' },\n  ];\n  $scope.groupList = [];\n  $scope.thList = [];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.relations = {};\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.rootEntity = custom.ownerDatasource.entity;\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.targetDatasources = [];\n  custom.isInitialized = false;\n  custom.t = t;\n  custom.computedStyle = getComputedStyle($container[0]);\n  custom.isApiLoaded = false;\n  custom.isSocketLoaded = false;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(t(self.ctx.widget.config.title));\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction linkEvent() {\n  let { custom, $scope, $container } = self.ctx;\n  $scope.toggleLegend = function (e, legend) {\n    legend.isHidden = !legend.isHidden;\n    if (legend.isHidden) {\n      $scope.filterList.push(legend.value);\n    } else {\n      let targetIndex = $scope.filterList.indexOf(legend.value);\n      if (targetIndex != -1) {\n        $scope.filterList.splice(targetIndex, 1);\n      }\n    }\n    self.ctx.detectChanges();\n  };\n  $scope.changeView = function (e, view) {\n    for (let i in $scope.viewList) {\n      $scope.viewList[i].isActive = false;\n    }\n    view.isActive = !view.isActive;\n    $scope.selectedView = view.key;\n    self.ctx.detectChanges();\n  };\n  $scope.toggleFold = function (e, group) {\n    group.isFold = !group.isFold;\n  };\n  $scope.selectDevice = function (e, device) {\n    toDeviceDashboard(device);\n  };\n  $scope.changeSort = function (e, group, th) {\n    if (group.orderIndex == th.index) {\n      if (group.orderDirection == 'DESC') {\n        group.orderDirection = 'ASC';\n      } else {\n        group.orderDirection = 'DESC';\n      }\n    } else {\n      group.orderDirection = 'DESC';\n    }\n    group.orderIndex = th.index;\n    sortData(group);\n  };\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n    ``;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n}\n\nasync function getDashboardList() {\n  let dashboardList;\n  if (self.ctx.currentUser.authority == 'TENANT_ADMIN') {\n    dashboardList = await self.ctx.http.get(`/api/tenant/dashboards?pageSize=1024&page=0`).toPromise();\n  } else {\n    let customerId = self.ctx.currentUser.customerId;\n    dashboardList = await self.ctx.http.get(`/api/customer/${customerId}/dashboards?pageSize=1024&page=0`).toPromise();\n  }\n  let result = {};\n  for (let i in dashboardList.data) {\n    result[dashboardList.data[i].title] = dashboardList.data[i];\n  }\n  return result;\n}\n\nfunction resize() {\n  let { custom, $scope } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  $scope.cardColumns = Math.floor(self.ctx.width / 250) - 1;\n  if ($scope.cardColumns > 6) {\n    $scope.cardColumns = 6;\n  }\n  if ($scope.cardColumns < 1) {\n    $scope.cardColumns = 1;\n  }\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n  self.ctx.detectChanges();\n}\n\nasync function getCurrentLevel() {\n  let { custom } = self.ctx;\n  if (custom.rootEntity.id.entityType == 'TENANT') {\n    return 0;\n  } else {\n    let result = await self.ctx.attributeService\n      .getEntityAttributes(custom.rootEntity.id, 'SERVER_SCOPE', ['customerType'])\n      .toPromise();\n    if (result && result[0]) {\n      if (result[0].value == 'CUSTOMER_L1') {\n        return 1;\n      } else {\n        return 2;\n      }\n    }\n  }\n}\n\nfunction getCustomer(entities) {\n  return new Promise(resolve => {\n    let { custom } = self.ctx;\n    let promises = [];\n    if (entities.length > 0) {\n      for (let i = 0; i < entities.length; i++) {\n        promises.push(self.ctx.entityRelationService.findInfoByFrom(entities[i].id));\n      }\n      self.ctx.rxjs.forkJoin(promises).subscribe(async childs => {\n        let newChild = [];\n        for (let j = 0; j < childs.length; j++) {\n          for (let k = 0; k < childs[j].length; k++) {\n            if (childs[j][k].to.entityType === 'CUSTOMER' || childs[j][k].to.entityType === 'DEVICE') {\n              custom.relations[childs[j][k].to.id] = {\n                id: childs[j][k].to,\n                name: childs[j][k].toName,\n                parent: entities[j],\n                child: [],\n                type: 'CUSTOMER',\n              };\n              custom.relations[entities[j].id.id].child.push(custom.relations[childs[j][k].to.id]);\n            }\n            if (childs[j][k].to.entityType === 'DEVICE') {\n              custom.relations[childs[j][k].to.id].type = 'DEVICE';\n            }\n            if (childs[j][k].to.entityType === 'CUSTOMER') {\n              newChild.push(custom.relations[childs[j][k].to.id]);\n            }\n          }\n        }\n        await getCustomer(newChild);\n        resolve();\n      });\n    } else {\n      distributeLevel();\n      resolve();\n    }\n  });\n}\n\n// hierarchy 레벨에 따라 배열에 따로 저장\nfunction distributeLevel() {\n  let { custom, $scope } = self.ctx;\n  let depth = $scope.ownerLevel;\n  let root = custom.relations[custom.rootEntity.id.id];\n  root.type = ENTITY_TYPE[depth];\n  for (let i in root.child) {\n    if (root.child[i].type == 'CUSTOMER') {\n      root.child[i].type = ENTITY_TYPE[depth + 1];\n    }\n    for (let j in root.child[i].child) {\n      if (root.child[i].child[j].type == 'CUSTOMER') {\n        root.child[i].child[j].type = ENTITY_TYPE[depth + 2];\n      }\n    }\n  }\n  if (custom.dashboardParams.entityId) {\n    let targetIndex = ENTITY_TYPE.indexOf(custom.relations[custom.dashboardParams.entityId.id].type);\n    if (targetIndex != -1) {\n      $scope.currentLevel = targetIndex;\n    }\n  }\n\n  custom.customerL1List = [];\n  custom.customerL2List = [];\n\n  for (let i in custom.relations) {\n    if (custom.relations[i].type == ENTITY_TYPE[1]) {\n      if ($scope.currentLevel == 1 && custom.dashboardParams.entityId) {\n        if (custom.relations[i].id.id == custom.dashboardParams.entityId.id) {\n          custom.customerL1List.push(custom.relations[i]);\n        }\n      } else {\n        custom.customerL1List.push(custom.relations[i]);\n      }\n    }\n    if (custom.relations[i].type == ENTITY_TYPE[2]) {\n      if ($scope.currentLevel == 2 && custom.dashboardParams.entityId) {\n        if (custom.relations[i].id.id == custom.dashboardParams.entityId.id) {\n          custom.customerL2List.push(custom.relations[i]);\n        }\n      } else if ($scope.currentLevel == 1 && custom.dashboardParams.entityId) {\n        if (custom.relations[custom.relations[i].id.id].parent.id.id == custom.dashboardParams.entityId.id) {\n          custom.customerL2List.push(custom.relations[i]);\n        }\n      } else {\n        custom.customerL2List.push(custom.relations[i]);\n      }\n    }\n  }\n  self.ctx.detectChanges();\n}\n\nfunction makeGroup() {\n  let { custom, $scope } = self.ctx;\n  if ($scope.currentLevel < 2) {\n    for (let i in custom.customerL1List) {\n      let subGroupList = [];\n      for (let j in custom.customerL1List[i].child) {\n        let deviceList = [];\n        for (let k in custom.customerL1List[i].child[j].child) {\n          let targetDevice = {};\n          custom.customerL1List[i].child[j].child[k].group = targetDevice;\n          deviceList.push(targetDevice);\n        }\n        let targetSubGroup = {\n          index: j,\n          type: 2,\n          title: custom.customerL1List[i].child[j].name,\n          isFold: false,\n          orderIndex: 0,\n          orderDirection: 'DESC',\n          deviceList: deviceList,\n        };\n        custom.customerL1List[i].child[j].group = targetSubGroup;\n        subGroupList.push(targetSubGroup);\n      }\n      subGroupList.sort((a, b) => {\n        if (a.title > b.title) return 1;\n        if (a.title < b.title) return -1;\n        return 0;\n      });\n      let targetGroup = {\n        index: i,\n        type: 1,\n        title: custom.customerL1List[i].name,\n        isFold: false,\n        state: 5,\n        subGroupList: subGroupList,\n      };\n      custom.customerL1List[i].group = targetGroup;\n      $scope.groupList.push(targetGroup);\n    }\n    $scope.groupList.sort((a, b) => {\n      if (a.title > b.title) return 1;\n      if (a.title < b.title) return -1;\n      return 0;\n    });\n  } else {\n    for (let i in custom.customerL2List) {\n      let deviceList = [];\n      for (let j in custom.customerL2List[i].child) {\n        let targetDevice = {};\n        custom.customerL2List[i].child[j].group = targetDevice;\n        deviceList.push(targetDevice);\n      }\n      let targetSubGroup = {\n        index: i,\n        type: 2,\n        title: custom.customerL2List[i].name,\n        isFold: false,\n        orderIndex: 0,\n        orderDirection: 'DESC',\n        deviceList: deviceList,\n      };\n      custom.customerL2List[i].group = targetSubGroup;\n      $scope.groupList.push(targetSubGroup);\n    }\n    $scope.groupList.sort((a, b) => {\n      if (a.title > b.title) return 1;\n      if (a.title < b.title) return -1;\n      return 0;\n    });\n  }\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [];\n  for (let i in custom.originDataKeys) {\n    $scope.thList.push({\n      index: i,\n      key: custom.originDataKeys[i].name,\n      label: t(custom.originDataKeys[i].label),\n    });\n  }\n}\n\nasync function loadApi() {\n  let { custom, $scope } = self.ctx;\n  custom.now = moment().valueOf();\n  custom.startTs = moment(custom.now).startOf('day').valueOf();\n  custom.analysisEndTs = moment(custom.now).subtract(1, 'hours').startOf('hours').valueOf();\n  custom.endTs = custom.now;\n\n  if (custom.isSample) return;\n  custom.initData = await loadInitData();\n  custom.telemetryData = await loadTelemetryData();\n  custom.timeline = {};\n  for (let i in custom.mainDatasources) {\n    let targetId = custom.mainDatasources[i].entityId;\n    custom.timeline[targetId] = createTimeline(custom.initData[targetId], custom.telemetryData[targetId]);\n  }\n  custom.isApiLoaded = true;\n  if (custom.isApiLoaded && custom.isSocketLoaded) {\n    startUpdate();\n  }\n}\n\nfunction startUpdate() {\n  let { custom, $scope } = self.ctx;\n  custom.mainData = preprocessData(custom.timeline, custom.telemetryData, custom.latestData, custom.attributeData);\n  postprocessData();\n  if ($scope.currentLevel < 2) {\n    for (let i in $scope.groupList) {\n      for (let j in $scope.groupList[i].subGroupList) {\n        sortData($scope.groupList[i].subGroupList[j]);\n      }\n    }\n  } else {\n    for (let i in $scope.groupList) {\n      sortData($scope.groupList[i]);\n    }\n  }\n  self.ctx.detectChanges();\n  self.onResize();\n}\n\nfunction loadInitData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let keys = ['TP_AnalysisState', 'TP_ModifiedState'];\n    let observables = [];\n    for (let i in custom.mainDatasources) {\n      let entityId = custom.mainDatasources[i].entity.id;\n      observables.push(\n        self.ctx.http.get(\n          `/api/plugins/telemetry/${entityId.entityType}/${\n            entityId.id\n          }/values/timeseries?limit=1&agg=NONE&keys=${keys.join(',')}&startTs=0&endTs=${\n            custom.startTs\n          }&useStrictDataTypes=true`\n        )\n      );\n    }\n    self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n      let result = {};\n      for (let i in datas) {\n        // 분석 데이터 삭제\n        if (custom.now - custom.startTs < HOUR_MS) {\n          delete datas[i].TP_AnalysisState;\n        }\n        if (datas[i].TP_ModifiedState) {\n          let value = datas[i].TP_ModifiedState[0].value;\n          if (value.endTs < custom.now) {\n            delete datas[i].TP_ModifiedState;\n          } else {\n            value.startTs = custom.startTs;\n          }\n        }\n        result[custom.mainDatasources[i].entityId] = datas[i];\n      }\n      resolve(result);\n    });\n  });\n}\n\nfunction loadTelemetryData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let keys = [\n      'TP_AnalysisState',\n      'TP_OperationState',\n      'TP_ConnectionState',\n      'TP_ModifiedState',\n      'TP_TotalPowerUsageRaw',\n    ];\n    let observables = [];\n    for (let i in custom.mainDatasources) {\n      let entityId = custom.mainDatasources[i].entity.id;\n      observables.push(\n        self.ctx.http.get(\n          `/api/plugins/telemetry/${entityId.entityType}/${\n            entityId.id\n          }/values/timeseries?limit=50000&agg=NONE&keys=${keys.join(',')}&startTs=${custom.startTs}&endTs=${\n            custom.endTs\n          }&useStrictDataTypes=true`\n        )\n      );\n    }\n\n    self.ctx.rxjs.forkJoin(observables).subscribe(datas => {\n      let result = {};\n      for (let i in datas) {\n        result[custom.mainDatasources[i].entityId] = datas[i];\n      }\n      resolve(result);\n    });\n  });\n}\n\nfunction createTimeline(initData, telemetryData) {\n  let { custom } = self.ctx;\n  let timeline = [];\n\n  // 상태 데이터 병합\n  if (initData.TP_AnalysisState) {\n    timeline.push({ ts: custom.startTs, value: initData.TP_AnalysisState[0].value });\n  }\n  if (telemetryData.TP_AnalysisState) {\n    timeline = timeline.concat(telemetryData.TP_AnalysisState);\n  }\n\n  // 분석 데이터가 없는 경우 통신이상으로 표시\n  if (timeline.length == 0) {\n    timeline.push({ ts: custom.startTs, value: 4 });\n  }\n  for (let i in telemetryData.TP_OperationState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_OperationState[i].ts > custom.analysisEndTs) {\n      telemetryData.TP_OperationState[i].value = OPERATION_MAP[telemetryData.TP_OperationState[i].value];\n      timeline.push(telemetryData.TP_OperationState[i]);\n    }\n  }\n  for (let i in telemetryData.TP_ConnectionState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_ConnectionState[i].ts > custom.analysisEndTs) {\n      if (telemetryData.TP_ConnectionState[i].value == 'false') {\n        timeline.push({ ts: telemetryData.TP_ConnectionState[i].ts, value: 4 });\n      }\n    }\n  }\n\n  // 수정된 부분 적용\n  let modifiedData = [];\n  if (initData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(initData.TP_ModifiedState);\n  }\n  if (telemetryData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(telemetryData.TP_ModifiedState);\n  }\n  for (let i in modifiedData) {\n    let targetData = modifiedData[i].value;\n    for (let j = 0; j < timeline.length; j++) {\n      // case 1 : 수정된 데이터가 기존 데이터와 같은 경우\n      if (timeline[j].ts == targetData.startTs && timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        timeline[j].value = targetData.state;\n        // case 1-1: 이전 값이 수정된 값과 같은 경우 삭제\n        if (timeline[j - 1] && timeline[j - 1].value == targetData.state) {\n          timeline.splice(j, 1);\n        }\n        // case 1-2: 다음 값이 수정된 값과 같은 경우 삭제\n        if (timeline[j + 1] && timeline[j + 1].value == targetData.state) {\n          timeline.splice(j + 1, 1);\n        }\n        break;\n      }\n      // case 2 : 수정된 데이터와 기존 데이터의 시작 시간이 같은 경우\n      else if (timeline[j].ts == targetData.startTs) {\n        timeline[j].ts = targetData.endTs;\n        // 이전 값이 수정된 값과 다른 경우 추가\n        if (!timeline[j - 1] || timeline[j - 1].value != targetData.state) {\n          timeline.splice(j, 0, { ts: targetData.startTs, value: timeline[j].value });\n        }\n        break;\n      }\n      // case 3 : 수정된 데이터와 기존 데이터의 종료 시간이 같은 경우\n      else if (timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        if (timeline[j + 1].value == targetData.state) {\n          timeline[j + 1].ts = targetData.startTs;\n        } else {\n          timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        }\n        break;\n      }\n      // case 4 : 수정된 데이터가 기존 데이터의 시작 시간과 종료 시간 사이에 있는 경우\n      else if (\n        timeline[j].ts < targetData.startTs &&\n        ((timeline[j + 1] && timeline[j + 1].ts > targetData.endTs) || !timeline[j + 1])\n      ) {\n        timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        if (timeline[j + 1]) {\n          timeline.splice(j + 2, 0, { ts: targetData.endTs, value: timeline[j].value });\n        } else {\n          timeline.splice(j + 2, 0, { ts: custom.endTs, value: timeline[j].value });\n        }\n\n        break;\n      }\n    }\n  }\n  timeline.sort((a, b) => {\n    return a.ts - b.ts;\n  });\n\n  let result = [];\n  for (let i = 0; i < timeline.length; i++) {\n    result.push({\n      startTs: timeline[i].ts,\n      endTs: _.isNil(timeline[i + 1]) ? custom.endTs : timeline[i + 1].ts,\n      value: timeline[i].value,\n    });\n  }\n\n  return result;\n}\n\nfunction preprocessData(timeline, telemetryData, latestData, attributeData) {\n  let { custom } = self.ctx;\n  let result = [];\n  for (let i in custom.mainDatasources) {\n    let targetGroup = custom.relations[custom.mainDatasources[i].entityId].group;\n    targetGroup.index = i;\n    targetGroup.id = custom.mainDatasources[i].entity.id;\n    targetGroup.name = custom.mainDatasources[i].entityName;\n    targetGroup.label = custom.mainDatasources[i].entityLabel;\n    targetGroup.operationTime = 0;\n    targetGroup.usage = 0;\n    targetGroup.state = 5;\n\n    for (let j in timeline[targetGroup.id.id]) {\n      if (timeline[targetGroup.id.id][j].value == 2 || timeline[targetGroup.id.id][j].value == 3) {\n        targetGroup.operationTime += timeline[targetGroup.id.id][j].endTs - timeline[targetGroup.id.id][j].startTs;\n      }\n    }\n    if (telemetryData[targetGroup.id.id].TP_TotalPowerUsageRaw) {\n      targetGroup.usage = telemetryData[targetGroup.id.id].TP_TotalPowerUsageRaw.reduce((acc, cur) => {\n        return acc + cur.value;\n      }, 0);\n    }\n    for (let j in latestData[targetGroup.id.id]) {\n      targetGroup[j] = latestData[targetGroup.id.id][j];\n    }\n    for (let j in attributeData[targetGroup.id.id]) {\n      targetGroup[j] = attributeData[targetGroup.id.id][j];\n    }\n\n    if (targetGroup.TP_ActivationState == 'false') {\n      targetGroup.state = 5;\n    } else if (targetGroup.TP_ConnectionState == 'false') {\n      targetGroup.state = 4;\n    } else if (targetGroup.TP_OperationState == 'STOP') {\n      targetGroup.state = 0;\n    } else if (targetGroup.TP_OperationState == 'WAIT') {\n      targetGroup.state = 1;\n    } else if (targetGroup.TP_OperationState == 'WORK') {\n      targetGroup.state = 2;\n    }\n\n    // ratio 계산하기\n    targetGroup.ratio = _.round((targetGroup.operationTime / targetGroup.TP_PlannedWorkTimeDay) * 100, 1);\n    targetGroup.ratioColor = getHsl(targetGroup.ratio);\n\n    targetGroup.tdList = [];\n    for (let j in custom.originDataKeys) {\n      targetGroup.tdList.push({ style: {}, content: '' });\n    }\n    for (let j in targetGroup) {\n      let targetIndex = custom.originDataKeys.findIndex(x => x.name == 'v_' + j);\n\n      if (targetIndex != -1) {\n        targetGroup.tdList[targetIndex].content = targetGroup[j];\n        if (custom.originDataKeys[targetIndex].settings.useCellStyleFunction) {\n          let styleFunction = new Function(\n            'value',\n            'group',\n            'ctx',\n            custom.originDataKeys[targetIndex].settings.cellStyleFunction\n          );\n          targetGroup.tdList[targetIndex].style = styleFunction(targetGroup[j], targetGroup, self.ctx);\n        }\n        if (custom.originDataKeys[targetIndex].settings.useCellContentFunction) {\n          let contentFunction = new Function(\n            'value',\n            'group',\n            'ctx',\n            custom.originDataKeys[targetIndex].settings.cellContentFunction\n          );\n\n          let newContent = contentFunction(targetGroup[j], targetGroup, self.ctx);\n          newContent = self.ctx.sanitizer.bypassSecurityTrustHtml(newContent);\n          targetGroup.tdList[targetIndex].content = newContent;\n        }\n      }\n    }\n\n    result.push(targetGroup);\n  }\n  self.ctx.detectChanges();\n\n  return result;\n}\n\n// 데이터 삽입\nfunction postprocessData() {\n  let { custom, $scope, $container } = self.ctx;\n  for (let i in custom.mainData) {\n    let $content = createTooltip(custom.mainData[i]);\n    $(`.tooltip-${i}`, $container).tooltipster({\n      content: $content,\n      interactive: true,\n      position: 'right',\n      theme: 'tooltipster-transparent',\n      trigger: 'hover',\n      debug: false,\n    });\n  }\n}\n\nfunction sortData(group) {\n  let { custom, $scope } = self.ctx;\n  let targetKey = $scope.thList[group.orderIndex].key;\n  targetKey = targetKey.replace('v_', '');\n  if (group.orderDirection == 'DESC') {\n    group.deviceList.sort((a, b) => {\n      if (a[targetKey] > b[targetKey]) return 1;\n      if (a[targetKey] < b[targetKey]) return -1;\n      return 0;\n    });\n  }\n  if (group.orderDirection == 'ASC') {\n    group.deviceList.sort((a, b) => {\n      if (a[targetKey] > b[targetKey]) return -1;\n      if (a[targetKey] < b[targetKey]) return 1;\n      return 0;\n    });\n  }\n  self.ctx.detectChanges();\n}\n\nfunction toDeviceDashboard(device) {\n  let { custom, $scope } = self.ctx;\n  let stateObj = [\n    {\n      id: 'default',\n      params: {\n        entityId: device.id,\n        entityName: device.name,\n        entityLabel: device.label,\n      },\n    },\n  ];\n  let dashboardId = custom.dashboardList['Device Details'].id.id;\n  const state = self.ctx.utils.objToBase64URI(stateObj);\n  let regex = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/;\n  if (regex.test(dashboardId)) {\n    let url = `/dashboards/${dashboardId}?state=${state}`;\n    self.ctx.router.navigateByUrl(url);\n  }\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction createTooltip(data) {\n  let { custom, $scope } = self.ctx;\n  let $content = $('<div></div>').css({\n    color: 'var(--tb-service-font-0)',\n    backgroundColor: 'rgba(25,25,25,0.9)',\n    lineHeight: 1.5,\n    width: `${180 / STANDARD_WINDOW_SIZE}vw`,\n    padding: `${16 / STANDARD_WINDOW_SIZE}vw`,\n    borderRadius: `${8 / STANDARD_WINDOW_SIZE}vw`,\n  });\n\n  let $target = $(`<div>${data.label}</div>`).css({\n    fontSize: `${12 / STANDARD_WINDOW_SIZE}vw`,\n    fontWeight: 'bold',\n    paddingBottom: `${10 / STANDARD_WINDOW_SIZE}vw`,\n    borderBottom: '1px solid rgba(255,255,255,0.2)',\n  });\n\n  let $datas = $('<div></div>').css({\n    fontSize: `${12 / STANDARD_WINDOW_SIZE}vw`,\n    paddingTop: `${10 / STANDARD_WINDOW_SIZE}vw`,\n  });\n\n  let rowList = [\n    { label: t('thingplus.label.device-state'), value: data.state },\n    { label: t('thingplus.label.planned-time'), value: data.TP_PlannedWorkTimeDay },\n    { label: t('thingplus.label.working-time'), value: data.operationTime },\n  ];\n  for (let i in rowList) {\n    let $row = $(`<div></div>`).css({\n      display: 'flex',\n      justifyContent: 'space-between',\n      alignItems: 'center',\n      gap: `${10 / STANDARD_WINDOW_SIZE}vw`,\n    });\n    let $label = $(`<div>${rowList[i].label}</div>`).css({\n      color: 'var(--tb-service-font-1)',\n    });\n    let $value = $(`<div>${rowList[i].value}</div>`);\n    if (i == '0') {\n      $value = $(`<div><span>${$scope.stateList[rowList[i].value].label}</span></div>`).css({\n        display: 'flex',\n        justifyContent: 'end',\n        alignItems: 'center',\n      });\n      let $circle = $('<div></div>').css({\n        backgroundColor: `var(--tb-service-${$scope.stateList[rowList[i].value].key})`,\n        width: `${6 / STANDARD_WINDOW_SIZE}vw`,\n        height: `${6 / STANDARD_WINDOW_SIZE}vw`,\n        borderRadius: '50%',\n        marginRight: `${6 / STANDARD_WINDOW_SIZE}vw`,\n      });\n      $value.prepend($circle);\n    } else {\n      let hour = Math.floor(rowList[i].value / 3600000);\n      let temp = rowList[i].value % 3600000;\n      let minute = Math.floor(temp / 60000);\n      $value = $(`<div>${t('thingplus.time-format.hm-acc', { hour, minute })}</div>`);\n    }\n\n    $row.append($label);\n    $row.append($value);\n    $datas.append($row);\n  }\n\n  $content.append($target);\n  $content.append($datas);\n\n  return $content;\n}\n\nfunction getHsl(value) {\n  if (value > 100) {\n    value = 100;\n  }\n  return tinycolor(getStyle('--tb-service-progress'))\n    .brighten(_.round((100 - value) / 4))\n    .toHexString();\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n\nfunction log() {\n  console.log(t(self.ctx.widget.config.title) + '\\r\\n', ...arguments);\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{\n  \"schema\": {\n    \"type\": \"object\",\n    \"title\": \"DataKeySettings\",\n    \"properties\": {\n      \"hidden\": {\n        \"title\": \"Hide from table\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"useCellStyleFunction\": {\n        \"title\": \"Use cell style function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellStyleFunction\": {\n        \"title\": \"Cell style function: f(value, group, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"useCellContentFunction\": {\n        \"title\": \"Use cell content function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellContentFunction\": {\n        \"title\": \"Cell content function: f(value, group, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      }\n    },\n    \"required\": []\n  },\n  \"form\": [\n    \"hidden\",\n    \"useCellStyleFunction\",\n    {\n      \"key\": \"cellStyleFunction\",\n      \"type\": \"javascript\"\n    },\n    \"useCellContentFunction\",\n    {\n      \"key\": \"cellContentFunction\",\n      \"type\": \"javascript\"\n    }\n  ]\n}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.19753596929435746,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"rgba(255,255,255,0)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Summary Device\",\"showTitleIcon\":false,\"dropShadow\":true,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"titleTooltip\":\"\",\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"2em\",\"font-weight\":500,\"letter-spacing\":\"-0.05em\",\"color\":\"var(--tb-service-font-5)\"}}"
      }
    },
    {
      "alias": "device_details",
      "name": "Device Details",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 3.5,
        "sizeY": 6.5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main\n    class=\"widget-content\"\n    fxLayout=\"column\"\n    fxLayoutAlign=\"start center\"\n    fxLayout.sm=\"row\"\n    fxLayoutAlign.sm=\"space-between start\"\n  >\n    <section class=\"image-section\" fxLayoutAlign=\"center center\" fxflex.sm=\"50\">\n      <img class=\"device-image\" [src]=\"imageSource\" />\n    </section>\n    <div class=\"details-wrapper\" fxflex.sm=\"50\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n      <section class=\"title-section\">\n        <div class=\"device-label\">{{label}}</div>\n        <div class=\"device-model\">{{model}}</div>\n      </section>\n      <section class=\"detail-section\">\n        <div\n          class=\"detail-row\"\n          *ngFor=\"let details of detailList\"\n          fxLayoutAlign=\"space-between center\"\n          fxLayoutGap=\"0.5em\"\n        >\n          <div fxFlex=\"50\" class=\"detail-label\">{{details.label}}</div>\n          <div fxFlex=\"50\" class=\"detail-value\">{{details.value}}</div>\n        </div>\n      </section>\n    </div>\n    <section class=\"layout-section\" [ngClass]=\"dataState\" translate>thingplus.state.nodata</section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n\n/*\n  Widget Content Area\n*/\n.widget-content {\n  position: relative;\n  width: 100%;\n}\n\n/* image-section */\nsection.image-section {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  background-color: var(--tb-service-background-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.image-section .device-image {\n  max-width: 20em;\n  max-height: 20em;\n  width: auto;\n  height: 20em;\n}\n.details-wrapper {\n  width: 100%;\n  overflow-y: auto;\n}\n/* title-section */\nsection.title-section {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n.title-section .device-label {\n  font-size: 2em;\n  font-weight: 600;\n  color: var(--tb-service-font-5);\n}\n.title-section .device-model {\n  font-size: 1.2em;\n  color: var(--tb-service-accent);\n}\n\nsection.detail-section {\n  width: 100%;\n  overflow-y: auto;\n}\n.detail-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.detail-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.detail-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.detail-section .detail-row {\n  border-top: 1px solid var(--tb-service-border-0);\n  padding: 1em 2em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n.detail-section .detail-row:nth-child(odd) {\n  background-color: var(--tb-service-background-1);\n}\n.detail-section .detail-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n  white-space: pre-wrap;\n  word-break: keep-all;\n}\n.detail-section .detail-value {\n  font-size: 1.2em;\n  color: var(--tb-service-font-5);\n  text-align: end;\n  white-space: pre-wrap;\n  word-break: keep-all;\n}\n\n.layout-section {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  display: none;\n  background-color: var(--tb-service-background-0);\n  color: var(--tb-service-font-5);\n  font-size: 1.6em;\n}\n.layout-section.NODATA {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}\n\n@media (min-width: 600px) and (max-width: 959px) {\n  section.image-section {\n    width: 50%;\n    height: 100%;\n  }\n  .image-section .device-image {\n    max-width: none;\n    max-height: none;\n    width: 75%;\n    height: auto;\n  }\n  .details-wrapper {\n    width: 50%;\n  }\n}\n",
        "controllerScript": "self.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom, $scope } = self.ctx;\n  defineVariables();\n  setTitle();\n\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom, $scope } = self.ctx;\n  if ($scope.dataState != 'NODATA') {\n    custom.mainData = preprocessData();\n    insertData();\n    setDetails();\n  }\n\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$imageSection = $('.image-section', $container);\n  custom.$detailsWrapper = $('.details-wrapper', $container);\n  custom.$titleSection = $('.title-section', $container);\n  custom.$detailSection = $('.detail-section', $container);\n\n  $scope.model = '';\n  $scope.detailList = [];\n  $scope.dataState = '';\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.previousModel = '';\n  custom.t = t;\n\n  if (custom.mainDatasources.length == 0) {\n    $scope.dataState = 'NODATA';\n  }\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n\n  if (!self.ctx.isMobile || self.ctx.width <= 600) {\n    let imageSection = custom.$imageSection.outerHeight(true);\n    custom.$detailsWrapper.css('height', `calc(100% - ${imageSection}px)`);\n  }\n}\n\nfunction preprocessData() {\n  let result = [];\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let name = target.dataKey.name;\n      let data = target.data[0][1];\n      result[name] = data;\n    }\n  }\n  return result;\n}\n\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  $scope.label = custom.mainDatasources[0].entityLabel;\n}\n\nfunction setDetails() {\n  let { custom, $scope } = self.ctx;\n  if (custom.previousModel != custom.mainData.model) {\n    custom.previousModel == custom.mainData.model;\n    let content = t('thingplus.device-model.' + custom.mainData.model);\n    $scope.model = custom.mainData.model;\n    if (content.label && content.value) {\n      let labels = content.label.split(';');\n      let values = content.value.split(';');\n      $scope.detailList = [{ label: t('thingplus.label.model'), value: content.summary }];\n\n      for (let i in labels) {\n        $scope.detailList.push({ label: labels[i], value: values[i] });\n      }\n    }\n    $scope.imageSource = `https://tp-resource.thingplus.net/service/moldmecca/model/${custom.mainData.model}.png`;\n  }\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.8341520075561346,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Device Details\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"-0.04em\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "device_state",
      "name": "Device State",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 2,
        "resources": [],
        "templateHtml": "<div id=\"widget\">\n  <main class=\"widget-content\" fxLayoutAlign=\"space-between center\">\n    <div class=\"state-box\" fxLayout=\"column\" fxLayoutAlign=\"center start\" fxLayoutGap=\"0.3em\">\n      <div class=\"card-label\">실시간 상태</div>\n      <div class=\"device-state\" fxLayoutAlign=\"center center\" [ngClass]=\"state ? state.key : ''\">\n        {{state ? state.label : ''}}\n      </div>\n    </div>\n    <img class=\"state-icon\" [src]=\"stateIcon\" />\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-0);\n}\n/*\n  Widget Content Area\n*/\n\nmain.widget-content {\n  width: 100%;\n  height: 100%;\n  padding: var(--tb-config-padding);\n}\n\n.widget-content .card-label {\n  font-size: 1.2em;\n  font-weight: 500;\n  color: var(--tb-service-font-4);\n}\n.widget-content .device-state {\n  font-size: 2em;\n  font-weight: bold;\n  transition-property: color, background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-content .device-state.working {\n  color: var(--tb-service-working);\n}\n.widget-content .device-state.waiting {\n  color: var(--tb-service-waiting);\n}\n.widget-content .device-state.stopped {\n  color: var(--tb-service-stopped);\n}\n.widget-content .device-state.unconnected {\n  color: var(--tb-service-unconnected);\n}\n.widget-content .device-state.inactivated {\n  color: var(--tb-service-inactivated);\n}\n.widget-content .device-state.nodata {\n  color: var(--tb-service-inactivated);\n}\n.widget-content .state-icon {\n  width: 4em;\n  height: 4em;\n}\n",
        "controllerScript": "self.onInit = async function () {\n  self.ctx.custom = {};\n  defineVariables();\n  setTitle();\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  if (!custom.isNodata) {\n    custom.mainData = preprocessData();\n    insertData();\n  }\n\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.stateList = [\n    {\n      key: 'inactivated',\n      label: t('thingplus.state.inactivated'),\n    },\n    {\n      key: 'unconnected',\n      label: t('thingplus.state.unconnected'),\n    },\n    {\n      key: 'stopped',\n      label: t('thingplus.state.stopped'),\n    },\n    {\n      key: 'waiting',\n      label: t('thingplus.state.waiting'),\n    },\n    {\n      key: 'working',\n      label: t('thingplus.state.working'),\n    },\n    {\n      key: 'nodata',\n      label: t('thingplus.state.nodata'),\n    },\n  ];\n  $scope.state = $scope.stateList[5];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.previousModel = '';\n  custom.isNodata = false;\n  custom.t = t;\n\n  if (custom.mainDatasources.length == 0) {\n    custom.isNodata = true;\n    $scope.state = $scope.stateList[5];\n    $scope.stateIcon = self.ctx.sanitizer.bypassSecurityTrustResourceUrl(SVG_ICON.nodata);\n  }\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction preprocessData() {\n  let result = [];\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let name = target.dataKey.name;\n      let data = target.data[0][1];\n      result[name] = data;\n    }\n  }\n  return result;\n}\n\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  let state = 5;\n  if (custom.mainData.TP_ActivationState == 'false') {\n    state = 0;\n  } else if (custom.mainData.TP_ConnectionState == 'false') {\n    state = 1;\n  } else if (custom.mainData.TP_OperationState == 'WAIT') {\n    state = 3;\n  } else if (custom.mainData.TP_OperationState == 'WORK') {\n    state = 4;\n  } else if (custom.mainData.TP_OperationState == 'STOP') {\n    state = 2;\n  }\n  $scope.state = $scope.stateList[state];\n  $scope.stateIcon = self.ctx.sanitizer.bypassSecurityTrustResourceUrl(SVG_ICON[$scope.stateList[state].key]);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nconst SVG_ICON = {\n  working:\n    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE3NDQ4MyI+CiAgICAgICAgPGcgZGF0YS1uYW1lPSLqt7jro7kgMTc0NDc2Ij4KICAgICAgICAgICAgPHBhdGggZD0iTTE0Ny45MjMtNzM2LjY2N2gtOC41OXEwLS4zLS4wMTgtLjY0MXQtLjAyMS0uNjQxaDguNjI4YTEgMSAwIDAgMCAuNzM3LS4yODkgMSAxIDAgMCAwIC4yODgtLjczN3YtMTguNzE4YTEgMSAwIDAgMC0uMjg4LS43MzcgMSAxIDAgMCAwLS43MzctLjI4OGgtMjUuMzgzYTEuMDEzIDEuMDEzIDAgMCAwLS43MjEuMjg4Ljk3MS45NzEgMCAwIDAtLjMuNzM3djEuODkxcS0uMyAwLS42My0uMDIxdC0uNjUyLS4wMTh2LTEuODUzYTIuMjE1IDIuMjE1IDAgMCAxIC42OS0xLjYxNyAyLjIxNSAyLjIxNSAwIDAgMSAxLjYxNy0uNjloMjUuMzg1YTIuMiAyLjIgMCAwIDEgMS42My42OSAyLjIzNSAyLjIzNSAwIDAgMSAuNjc4IDEuNjE3djE4LjcxOGEyLjIzNSAyLjIzNSAwIDAgMS0uNjc4IDEuNjE3IDIuMiAyLjIgMCAwIDEtMS42MzUuNjkyeiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTExNS4yMyA3NjguNzUpIiBzdHlsZT0iZmlsbDojODA4Yzk5Ii8+CiAgICAgICAgICAgIDxwYXRoIGRhdGEtbmFtZT0iY2FzdF9GSUxMMF93Z2h0MjAwX0dSQUQwX29wc3o0OCIgZD0iTTEyMC4yMzEtNzM4LjM3MXYtMi44OTFhMi42ODEgMi42ODEgMCAwIDEgMS45ODcuODU0IDIuODE2IDIuODE2IDAgMCAxIC44MzMgMi4wMzd6bTcuMTc5IDBhNi45ODggNi45ODggMCAwIDAtMi4xLTUuMSA3IDcgMCAwIDAtNS4wODMtMi4xNXYtMS4yNzlhOC4xMjMgOC4xMjMgMCAwIDEgNiAyLjQ4OCA4LjI2OSA4LjI2OSAwIDAgMSAyLjQ2NCA2LjA0NHptNi4yODIgMGExMy4yNzIgMTMuMjcyIDAgMCAwLTEuMDU1LTUuMjY4IDEzLjczIDEzLjczIDAgMCAwLTIuODcyLTQuMzA4IDEzLjQxOCAxMy40MTggMCAwIDAtNC4yNzEtMi45IDEzLjEzOCAxMy4xMzggMCAwIDAtNS4yNjQtMS4wNTl2LTEuMjgyYTE0LjI0MSAxNC4yNDEgMCAwIDEgNS43NjEgMS4xNyAxNC45OTEgMTQuOTkxIDAgMCAxIDQuNjc1IDMuMTczIDE0Ljg5NCAxNC44OTQgMCAwIDEgMy4xNTEgNC43MDkgMTQuNTA3IDE0LjUwNyAwIDAgMSAxLjE1NiA1Ljc2MnoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMTUuMjMgNzcwLjQ1NCkiIHN0eWxlPSJmaWxsOiMwMGE0YWEiLz4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPgo=',\n  waiting:\n    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE3NDQ5MSI+CiAgICAgICAgPGcgZGF0YS1uYW1lPSLqt7jro7kgMTc0NDc3Ij4KICAgICAgICAgICAgPHBhdGggZD0iTTEzNS4wMDYtODEwYTE0LjY3NiAxNC42NzYgMCAwIDEtNS44NS0xLjE3NiAxNS4xNjEgMTUuMTYxIDAgMCAxLTQuNzY1LTMuMTkxIDE1LjA3MSAxNS4wNzEgMCAwIDEtMy4yMDgtNC43NCAxNC40ODkgMTQuNDg5IDAgMCAxLTEuMTgyLTUuODMgMTUuNjIzIDE1LjYyMyAwIDAgMSAuMjY5LTIuOTE3IDE2LjQ0NCAxNi40NDQgMCAwIDEgLjc4NS0yLjc3OGwuOTc4Ljk3OGExNS45NzYgMTUuOTc2IDAgMCAwLS41NTggMi4zIDE0LjQyOSAxNC40MjkgMCAwIDAtLjE5MiAyLjM1NCAxMy4yNDEgMTMuMjQxIDAgMCAwIDMuOTg2IDkuNzMxIDEzLjIzNSAxMy4yMzUgMCAwIDAgOS43MzEgMy45ODcgMTMuMjQ3IDEzLjI0NyAwIDAgMCA5LjczMi0zLjk4NiAxMy4yMzEgMTMuMjMxIDAgMCAwIDMuOTg2LTkuNzMyIDEzLjIzNyAxMy4yMzcgMCAwIDAtMy45OTItOS43MzIgMTMuMjYxIDEzLjI2MSAwIDAgMC05Ljc0My0zLjk4OSAxNC44MjMgMTQuODIzIDAgMCAwLTIuMzE1LjE4MyAxMi45MjkgMTIuOTI5IDAgMCAwLTIuMjU3LjU2N2wtMS4wMTktLjk4N2EyMi43NDIgMjIuNzQyIDAgMCAxIDIuNjI3LS43NSAxMi41MzcgMTIuNTM3IDAgMCAxIDIuNzItLjI5NSAxNS4wMjcgMTUuMDI3IDAgMCAxIDUuOTA5IDEuMTY4IDE1LjQ4NiAxNS40ODYgMCAwIDEgNC44NTIgMy4yMSAxNS4yIDE1LjIgMCAwIDEgMy4yOTQgNC43NzZBMTQuMyAxNC4zIDAgMCAxIDE1MC04MjVhMTQuNjEzIDE0LjYxMyAwIDAgMS0xLjE4MSA1Ljg0OCAxNS4xNTggMTUuMTU4IDAgMCAxLTMuMjA1IDQuNzY1IDE1LjE0MyAxNS4xNDMgMCAwIDEtNC43NjEgMy4yMDggMTQuNTg5IDE0LjU4OSAwIDAgMS01Ljg0NyAxLjE3OXoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMTUgODQ1KSIgc3R5bGU9ImZpbGw6IzgwOGM5OSIvPgogICAgICAgICAgICA8cGF0aCBkYXRhLW5hbWU9Im1vdGlvbl9waG90b3NfcGF1c2VkX0ZJTEwwX3dnaHQyMDBfR1JBRDBfb3BzejQ4IiBkPSJNMTMwLjktODIxLjM4M2gxLjI4MnYtOC42MDZIMTMwLjl6bTUuNTM4IDBoMS4yODJ2LTguNjA2aC0xLjI4MnptLTEyLjM5Ni0xMy4zMjdhMS4yMTUgMS4yMTUgMCAwIDEtLjktLjM4NyAxLjI0NyAxLjI0NyAwIDAgMS0uMzgtLjkgMS4yMTQgMS4yMTQgMCAwIDEgLjM4Ny0uOSAxLjI0NyAxLjI0NyAwIDAgMSAuOS0uMzggMS4yMTQgMS4yMTQgMCAwIDEgLjkuMzg3IDEuMjQ3IDEuMjQ3IDAgMCAxIC4zOC45IDEuMjE0IDEuMjE0IDAgMCAxLS4zODcuOSAxLjI0NyAxLjI0NyAwIDAgMS0uOS4zOHoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMTQuMzA4IDg0NS42ODEpIiBzdHlsZT0iZmlsbDojMWY1Yjk4Ii8+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4K',\n  stopped:\n    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE3NDQ5MCI+CiAgICAgICAgPGcgZGF0YS1uYW1lPSLqt7jro7kgMTc0NDc4Ij4KICAgICAgICAgICAgPHBhdGggZD0iTTEzNS4wMDYtODEwYTE0LjQ4MiAxNC40ODIgMCAwIDEtNS44MjUtMS4xODEgMTUuMjgyIDE1LjI4MiAwIDAgMS00Ljc3LTMuMjI2IDE1LjI2OCAxNS4yNjggMCAwIDEtMy4yMjktNC43NjYgMTQuNDUyIDE0LjQ1MiAwIDAgMS0xLjE4Mi01LjgyMSAxNC42MiAxNC42MiAwIDAgMSAxLjE4MS01Ljg1IDE0Ljk4NCAxNC45ODQgMCAwIDEgMy4yMjYtNC43NjUgMTUuNDQ5IDE1LjQ0OSAwIDAgMSA0Ljc2Ni0zLjIwOCAxNC40NTMgMTQuNDUzIDAgMCAxIDUuODIxLTEuMTgzIDE0LjYxOSAxNC42MTkgMCAwIDEgNS44NSAxLjE4MSAxNS4xNTggMTUuMTU4IDAgMCAxIDQuNzY1IDMuMjA1IDE1LjE0MSAxNS4xNDEgMCAwIDEgMy4yMDggNC43NjEgMTQuNTg5IDE0LjU4OSAwIDAgMSAxLjE4MyA1Ljg0NyAxNC40ODIgMTQuNDgyIDAgMCAxLTEuMTgxIDUuODI1IDE1LjQ2NSAxNS40NjUgMCAwIDEtMy4yMDUgNC43NyAxNC45NjggMTQuOTY4IDAgMCAxLTQuNzYxIDMuMjI5IDE0LjU4OSAxNC41ODkgMCAwIDEtNS44NDcgMS4xODJ6bS0uMDA2LTEuMjgyYTEzLjIyNCAxMy4yMjQgMCAwIDAgOS43MjEtNCAxMy4yMzcgMTMuMjM3IDAgMCAwIDQtOS43MTYgMTMuMjMyIDEzLjIzMiAwIDAgMC00LTkuNzIxIDEzLjIzMiAxMy4yMzIgMCAwIDAtOS43MjEtNCAxMy4yMzcgMTMuMjM3IDAgMCAwLTkuNzE2IDQgMTMuMjI0IDEzLjIyNCAwIDAgMC00IDkuNzIxIDEzLjIyOSAxMy4yMjkgMCAwIDAgNCA5LjcxNiAxMy4yMjggMTMuMjI4IDAgMCAwIDkuNzE2IDR6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTE1IDg0NSkiIHN0eWxlPSJmaWxsOiM4MDhjOTkiLz4KICAgICAgICAgICAgPHBhdGggZGF0YS1uYW1lPSJwYXVzZV9jaXJjbGVfRklMTDBfd2dodDIwMF9HUkFEMF9vcHN6NDgiIGQ9Ik0xMjkuMjMxLTgyMWgxLjI4MnYtMTEuNjY3aC0xLjI4MnptNS42NDEgMGgxLjI4MnYtMTEuNjY3aC0xLjI4MnoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMTIuNjkyIDg0Ni44MzMpIiBzdHlsZT0iZmlsbDojMzE0ZDY4Ii8+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4K',\n  unconnected:\n    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE3NDQ4OCI+CiAgICAgICAgPGcgZGF0YS1uYW1lPSLqt7jro7kgMTc0NDg2Ij4KICAgICAgICAgICAgPHBhdGggZGF0YS1uYW1lPSLrubzquLAgMTMiIGQ9Ik0xNi4wMjYgMjcuNjhoLTEuMjgzVjE1LjYzNWwxLjIyOCAxLjIxNy4wNTYuMDU0djEwLjc3M3pNNC41NjMgMjEuNjQyYTE0LjkgMTQuOSAwIDAgMS0zLjM3LTQuOTI2QTE1LjEgMTUuMSAwIDAgMSAwIDEwLjgyM2ExNS45MzMgMTUuOTMzIDAgMCAxIC41NDktNC4xNDYgMTMuMzE3IDEzLjMxNyAwIDAgMSAxLjY1OC0zLjc0NGMuMjc2LjI5MS41ODkuNjE2Ljg4Ni45MjRhMTIuNjQzIDEyLjY0MyAwIDAgMC0xLjQgMy4zIDE0LjQ1NyAxNC40NTcgMCAwIDAtLjQ3MiAzLjY2OSAxMy44MjEgMTMuODIxIDAgMCAwIDEuMDg5IDUuNDE2IDE0LjEwNyAxNC4xMDcgMCAwIDAgMy4xMDkgNC41NTVsLS44NTIuODQ4em0yMi4wODktLjQwNS0uODc5LS44NWExNS4xMTUgMTUuMTE1IDAgMCAwIDIuNzg4LTQuNDM4IDEzLjU3MyAxMy41NzMgMCAwIDAgLjk5Mi01LjEyNUExMy43NDkgMTMuNzQ5IDAgMCAwIDI4LjQ2IDUuNCAxNC4yNDUgMTQuMjQ1IDAgMCAwIDI1LjM1Ny44NWwuODQ4LS44NWExNS40NTMgMTUuNDUzIDAgMCAxIDMuMzc2IDQuOTQ3IDE0Ljk1OSAxNC45NTkgMCAwIDEgMS4xODggNS44NzYgMTUuMDY0IDE1LjA2NCAwIDAgMS00LjExNiAxMC40MTN6TTguMzM0IDE3Ljg3MWExMC4zMjcgMTAuMzI3IDAgMCAxLTIuMS0zLjIzOSAxMC4wODkgMTAuMDg5IDAgMCAxLS43MzQtMy44MDkgMTEuMjEzIDExLjIxMyAwIDAgMSAuMTc4LTJBNi45IDYuOSAwIDAgMSA2LjI0MiA3LjFsLjM1OS4zNjVjLjA4OS4wOTMuMTguMTg2LjI3My4yNzlMNy4xMyA4YTcuNzUgNy43NSAwIDAgMC0uMzA2IDEuMyAxMS4wNzkgMTEuMDc5IDAgMCAwLS4xIDEuNTI3IDkuMzc5IDkuMzc5IDAgMCAwIC42MTcgMy4zNTUgNy42MTEgNy42MTEgMCAwIDAgMS44NzcgMi44MTNsLS44NzkuODh6bTE0LjQ4NS0uNDY2LS44NDktLjg1MmExMCAxMCAwIDAgMCAxLjUzLTIuNjgzIDguNTU5IDguNTU5IDAgMCAwIC41NS0zLjA0NyA5LjEyNCA5LjEyNCAwIDAgMC0uNjIyLTMuMzM4bC0uMTQ2LS4zNS0xLjctMi41MTYuODUzLS44NWExMC4xMDYgMTAuMTA2IDAgMCAxIDIuMTEgMy4yNzEgMTAuMzE4IDEwLjMxOCAwIDAgMSAuNzIxIDMuODEyIDEwLjAzNCAxMC4wMzQgMCAwIDEtLjYyNCAzLjUgOS43MzkgOS43MzkgMCAwIDEtMS44MjUgMy4wNDl6bS00LjkyOS00LjkyOS00LjE1OC00LjE1N2EyLjA3NiAyLjA3NiAwIDAgMSAuNzcxLS40IDMuMDQ1IDMuMDQ1IDAgMCAxIC44ODQtLjEyNSAzLjAwNiAzLjAwNiAwIDAgMSAzLjAyMSAzLjAyNSAzLjIwNiAzLjIwNiAwIDAgMS0uMTIxLjg3NyAyLjI2MiAyLjI2MiAwIDAgMS0uNC43NzV6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1IDUuMjI5KSIgc3R5bGU9ImZpbGw6IzgwOGM5OSIvPgogICAgICAgICAgICA8cGF0aCBkPSJNMTM5LjYyOS03OTUuNTM1Yy0yMS44NTgtMjEuMTUzLTI4LjgtMjguOC0yOC44LTI4LjhsLjkyNi0uODk0IDI4Ljc2OSAyOC43Njl6IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTA1Ljc1MSA4MzAuMjMpIiBzdHlsZT0iZmlsbDojZGI0ZTA1Ii8+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4K',\n  inactivated:\n    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICAgIDxnIGRhdGEtbmFtZT0i6re466O5IDE3NDQ4NSI+CiAgICAgICAgPGcgZGF0YS1uYW1lPSLqt7jro7kgMTc0NDc5Ij4KICAgICAgICAgICAgPHBhdGggZD0iTTE4MC04MDkuMzU5di0xLjI4MmgzLjR2LTEzLjAwNmE5LjAxMyA5LjAxMyAwIDAgMSAyLjA5NS01LjkgOC43MjYgOC43MjYgMCAwIDEgNS40MDUtMy4xMjZ2LTEuMTc2YTEuNDcxIDEuNDcxIDAgMCAxIC40MzctMS4xMiAxLjYgMS42IDAgMCAxIDEuMTQ5LS40MTUgMS42MzUgMS42MzUgMCAwIDEgMS4xNTkuNDE1IDEuNDU0IDEuNDU0IDAgMCAxIC40NDcgMS4xMnYxLjE3NmE4Ljc0NiA4Ljc0NiAwIDAgMSA1LjQxIDMuMTI2IDkgOSAwIDAgMSAyLjEgNS45djEzLjAwNkgyMDV2MS4yODJ6bTEyLjUgNC44MDhhMi42NDQgMi42NDQgMCAwIDEtMS44ODUtLjc3MSAyLjU0NyAyLjU0NyAwIDAgMS0uODA4LTEuOTIxaDUuMzg1YTIuNjA4IDIuNjA4IDAgMCAxLS43NzEgMS45MjEgMi42MDggMi42MDggMCAwIDEtMS45MjEuNzcxem0tNy44MTQtNi4wOWgxNS42Mzh2LTEzLjAwNmE3LjU3NSA3LjU3NSAwIDAgMC0yLjI2OS01LjU1NSA3LjUyNyA3LjUyNyAwIDAgMC01LjU0NS0yLjI3OSA3LjU0MyA3LjU0MyAwIDAgMC01LjU1IDIuMjc5IDcuNTY3IDcuNTY3IDAgMCAwLTIuMjc0IDUuNTU1eiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE3Mi40OTkgODQwLjM4NSkiIHN0eWxlPSJmaWxsOiM4MDhjOTkiLz4KICAgICAgICAgICAgPHBhdGggZGF0YS1uYW1lPSJub3RpZmljYXRpb25zX3BhdXNlZF9GSUxMMF93Z2h0MjAwX0dSQUQwX29wc3o0OCIgZD0iTTE4Ny4wMS04MTcuMDY0aDcuNDg0di0xLjMwOGgtNS44MDhsNS44MDgtNy40OXYtMS4zMDhoLTcuNDg0djEuMzA4aDUuOGwtNS44IDcuNDl6bTMuNzM3LTUuOTM2eiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE3MC43NDYgODQyLjQzOSkiIHN0eWxlPSJmaWxsOiM2ODg0OWMiLz4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPgo=',\n  nodata:\n    'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIj4KICAgIDxwYXRoIGQ9Ik0xNDQuNDY3LTgwNC45MzkgMTQzLjQxLTgwNnYtMTUuNjgzYTEgMSAwIDAgMC0uMjg4LS43MzcgMSAxIDAgMCAwLS43MzctLjI4OGgtMTQuMTc0bC0yLjk0OS0yLjk0OWgtMS40NzhsLTEuMjgyLTEuMjgyaDMuMjg4bDIuOTQ5IDIuOTQ5aDEzLjY0NGEyLjIyNCAyLjIyNCAwIDAgMSAxLjYzMy42NzUgMi4yMjUgMi4yMjUgMCAwIDEgLjY3NSAxLjYzM3YxNS43NjlhMi4yNjYgMi4yNjYgMCAwIDEtLjA1Ni40OSAyLjEyIDIuMTIgMCAwIDEtLjE2OC40ODF6bS43MjQgNi43MDgtNS4zNzEtNS4zNjlIMTE3YTIuMjIzIDIuMjIzIDAgMCAxLTEuNjM0LS42NzUgMi4yMjYgMi4yMjYgMCAwIDEtLjY3My0xLjYzM3YtMTguNzE4YTIuMjI2IDIuMjI2IDAgMCAxIC42NzMtMS42MzMgMi4yMjMgMi4yMjMgMCAwIDEgMS42MzQtLjY3NWgxLjI4OGwxLjI4MiAxLjI4MkgxMTdhMSAxIDAgMCAwLS43MzcuMjg4IDEgMSAwIDAgMC0uMjg4LjczN3YxOC43MThhMSAxIDAgMCAwIC4yODguNzM3IDEgMSAwIDAgMCAuNzM3LjI4OGgyMS41MzhsLTI0LjA3Ny0yNC4wNDUuOTE3LS45MTcgMzAuNyAzMC43LS44ODUuOTE3em0tMTcuMDM4LTE3LjAzOHptNS40NDctLjU3N3oiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0xMTAuMjUzIDgzNC4wNTUpIiBzdHlsZT0iZmlsbDojODA4Yzk5IiBkYXRhLW5hbWU9Iuq3uOujuSAxNzQ3MTEiLz4KPC9zdmc+Cg==',\n};\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Device State\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"-0.04em\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "device_operation",
      "name": "Device Operation",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 3.5,
        "sizeY": 4.5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"operation-section\" fxLayout=\"column\" fxLayoutAlign=\"center center\" fxLayoutGap=\"2.4em\">\n      <div class=\"progress-container\">\n        <svg viewBox=\"0 0 200 200\" class=\"circle-box\">\n          <path class=\"circle background-circle\" [attr.d]=\"path\" />\n        </svg>\n        <svg viewBox=\"0 0 200 200\" class=\"circle-box\">\n          <path\n            class=\"circle foreground-circle\"\n            [attr.d]=\"path\"\n            [ngStyle]=\"{'stroke-dasharray': gauge, 'stroke': ratioColor}\"\n          />\n        </svg>\n        <div class=\"content-box\" fxLayout=\"column\" fxLayoutAlign=\"center center\" fxLayoutGap=\"0.5em\">\n          <div class=\"value-box\" fxLayoutAlign=\"center end\" fxLayoutGap=\"0.1em\">\n            <div class=\"value\">{{ratio}}</div>\n            <div class=\"unit\">%</div>\n          </div>\n          <div class=\"label-box\" translate>thingplus.label.operation-rate</div>\n        </div>\n      </div>\n      <div class=\"detail-container\" fxLayoutAlign=\"center center\">\n        <div class=\"detail-box\" *ngFor=\"let detail of detailList\" fxLayoutAlign=\"center center\" fxLayoutGap=\"0.4em\">\n          <div class=\"detail-label\">{{detail.label}}</div>\n          <div class=\"detail-value\" [innerHTML]=\"detail.value\"></div>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/* operation-section */\n.operation-section {\n  width: 100%;\n  height: 100%;\n}\n.operation-section .progress-container {\n  position: relative;\n  height: 75%;\n  aspect-ratio: 1 / 1;\n}\n.operation-section .circle-box {\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  width: 100%;\n}\n.operation-section .circle {\n  stroke-width: 5;\n  fill: none;\n}\n.operation-section .background-circle {\n  stroke: var(--tb-service-background-4);\n}\n.operation-section .foreground-circle {\n  stroke: var(--tb-service-background-4);\n  transition-property: stroke, stroke-dasharray;\n  transition-duration: var(--tb-config-color-duration);\n}\n.operation-section .foreground-circle.disabled {\n  stroke: var(--tb-service-inactivated);\n}\n.operation-section .content-box {\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  transform: translate(-50%, -50%);\n  width: 50%;\n  height: 50%;\n}\n.operation-section .value-box {\n  color: var(--tb-service-font-5);\n}\n.operation-section .value {\n  font-size: 2.4em;\n  font-weight: 500;\n}\n.operation-section .unit {\n  font-size: 1.6em;\n  font-weight: 600;\n  line-height: 2em;\n}\n.operation-section .label-box {\n  font-size: 1.2em;\n  color: var(--tb-service-font-3);\n}\n.operation-section .detail-box {\n  padding: 0 1.2em;\n}\n.operation-section .detail-box:first-child {\n  border-right: 1px solid var(--tb-service-border-4);\n}\n.operation-section .detail-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.operation-section .detail-value {\n  font-size: 1.2em;\n  font-weight: 600;\n  color: var(--tb-service-font-5);\n}\n",
        "controllerScript": "const HOUR_MS = 3600000;\nconst RADIUS = 95;\nconst OPERATION_MAP = {\n  WORK: 2,\n  WAIT: 1,\n  STOP: 0,\n  true: 2,\n  false: 0,\n};\n\nself.onInit = function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  createGauge(RADIUS);\n  self.onResize();\n\n  startUpdate();\n\n  custom.loadInterval = setInterval(() => {\n    // 매분 00초에 동작\n    if (moment().second() == 0) {\n      startUpdate();\n    }\n  }, 1000);\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDestroy = function () {\n  let { custom } = self.ctx;\n  if (custom.loadInterval) {\n    clearInterval(custom.loadInterval);\n  }\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.today = moment().format(t('thingplus.time-format.ymdhm'));\n  $scope.inactivated = false;\n  $scope.detailList = [\n    { label: t('thingplus.energy.operation-time'), value: '-' },\n    { label: t('thingplus.energy.planned-time'), value: '-' },\n  ];\n\n  // Define Normal Variables\n  custom.now = moment().valueOf();\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.previousModel = '';\n  custom.t = t;\n  custom.log = log;\n  custom.computedStyle = getComputedStyle($container[0]);\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction createGauge(radius) {\n  let { $scope } = self.ctx;\n  $scope.path = `M100 ${100 - radius} a ${radius} ${radius} 0 0 1 0 ${radius * 2} a ${radius} ${radius} 0 0 1 0 ${\n    radius * -2\n  }`;\n}\n\nasync function startUpdate() {\n  let { custom } = self.ctx;\n  if (custom.isSample) return;\n  let timeline = await drawTimeline();\n  let latestData = await loadLatestData();\n  custom.mainData = processData(timeline, latestData);\n  insertData();\n  self.ctx.detectChanges();\n}\n\nasync function drawTimeline() {\n  let { custom } = self.ctx;\n  custom.now = moment().valueOf();\n  custom.startTs = moment(custom.now).startOf('day').valueOf();\n  custom.analysisEndTs = moment(custom.now).subtract(1, 'hours').startOf('hours').valueOf();\n  custom.endTs = custom.now;\n\n  let initData = await loadInitData();\n  let telemetryData = await loadTelemetryData();\n  let timelineData = createTimeline(initData, telemetryData);\n  return timelineData;\n}\n\nfunction loadInitData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let entityId = custom.mainDatasources[0].entity.id;\n    let keys = ['TP_AnalysisState', 'TP_ModifiedState'];\n    self.ctx.http\n      .get(\n        `/api/plugins/telemetry/${entityId.entityType}/${\n          entityId.id\n        }/values/timeseries?limit=1&agg=NONE&keys=${keys.join(',')}&startTs=0&endTs=${\n          custom.startTs\n        }&useStrictDataTypes=true`\n      )\n      .subscribe(datas => {\n        // 분석 데이터 삭제\n        if (custom.now - custom.startTs < HOUR_MS) {\n          delete datas.TP_AnalysisState;\n        }\n        if (datas.TP_ModifiedState) {\n          let value = datas.TP_ModifiedState[0].value;\n          if (value.endTs < custom.now) {\n            delete datas.TP_ModifiedState;\n          } else {\n            value.startTs = custom.startTs;\n          }\n        }\n        resolve(datas);\n      });\n  });\n}\n\nfunction loadTelemetryData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let entityId = custom.mainDatasources[0].entity.id;\n    let keys = ['TP_AnalysisState', 'TP_OperationState', 'TP_ConnectionState', 'TP_ModifiedState'];\n    self.ctx.http\n      .get(\n        `/api/plugins/telemetry/${entityId.entityType}/${\n          entityId.id\n        }/values/timeseries?limit=50000&agg=NONE&keys=${keys.join(',')}&startTs=${custom.startTs}&endTs=${\n          custom.endTs\n        }&useStrictDataTypes=true`\n      )\n      .subscribe(datas => {\n        resolve(datas);\n      });\n  });\n}\n\nfunction createTimeline(initData, telemetryData) {\n  let { custom } = self.ctx;\n  let timeline = [];\n\n  // 상태 데이터 병합\n  if (initData.TP_AnalysisState) {\n    timeline.push({ ts: custom.startTs, value: initData.TP_AnalysisState[0].value });\n  }\n  if (telemetryData.TP_AnalysisState) {\n    timeline = timeline.concat(telemetryData.TP_AnalysisState);\n  }\n\n  // 분석 데이터가 없는 경우 통신이상으로 표시\n  if (timeline.length == 0) {\n    timeline.push({ ts: custom.startTs, value: 4 });\n  }\n  for (let i in telemetryData.TP_OperationState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_OperationState[i].ts > custom.analysisEndTs) {\n      telemetryData.TP_OperationState[i].value = OPERATION_MAP[telemetryData.TP_OperationState[i].value];\n      timeline.push(telemetryData.TP_OperationState[i]);\n    }\n  }\n  for (let i in telemetryData.TP_ConnectionState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_ConnectionState[i].ts > custom.analysisEndTs) {\n      if (telemetryData.TP_ConnectionState[i].value == 'false') {\n        timeline.push({ ts: telemetryData.TP_ConnectionState[i].ts, value: 4 });\n      }\n    }\n  }\n\n  // 수정된 부분 적용\n  let modifiedData = [];\n  if (initData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(initData.TP_ModifiedState);\n  }\n  if (telemetryData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(telemetryData.TP_ModifiedState);\n  }\n  for (let i in modifiedData) {\n    let targetData = modifiedData[i].value;\n    for (let j = 0; j < timeline.length; j++) {\n      // case 1 : 수정된 데이터가 기존 데이터와 같은 경우\n      if (timeline[j].ts == targetData.startTs && timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        timeline[j].value = targetData.state;\n        // case 1-1: 이전 값이 수정된 값과 같은 경우 삭제\n        if (timeline[j - 1] && timeline[j - 1].value == targetData.state) {\n          timeline.splice(j, 1);\n        }\n        // case 1-2: 다음 값이 수정된 값과 같은 경우 삭제\n        if (timeline[j + 1] && timeline[j + 1].value == targetData.state) {\n          timeline.splice(j + 1, 1);\n        }\n        break;\n      }\n      // case 2 : 수정된 데이터와 기존 데이터의 시작 시간이 같은 경우\n      else if (timeline[j].ts == targetData.startTs) {\n        timeline[j].ts = targetData.endTs;\n        // 이전 값이 수정된 값과 다른 경우 추가\n        if (!timeline[j - 1] || timeline[j - 1].value != targetData.state) {\n          timeline.splice(j, 0, { ts: targetData.startTs, value: timeline[j].value });\n        }\n        break;\n      }\n      // case 3 : 수정된 데이터와 기존 데이터의 종료 시간이 같은 경우\n      else if (timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        if (timeline[j + 1].value == targetData.state) {\n          timeline[j + 1].ts = targetData.startTs;\n        } else {\n          timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        }\n        break;\n      }\n      // case 4 : 수정된 데이터가 기존 데이터의 시작 시간과 종료 시간 사이에 있는 경우\n      else if (\n        timeline[j].ts < targetData.startTs &&\n        ((timeline[j + 1] && timeline[j + 1].ts > targetData.endTs) || !timeline[j + 1])\n      ) {\n        timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        if (timeline[j + 1]) {\n          timeline.splice(j + 2, 0, { ts: targetData.endTs, value: timeline[j].value });\n        } else {\n          timeline.splice(j + 2, 0, { ts: custom.endTs, value: timeline[j].value });\n        }\n\n        break;\n      }\n    }\n  }\n  timeline.sort((a, b) => {\n    return a.ts - b.ts;\n  });\n\n  let result = [];\n  for (let i = 0; i < timeline.length; i++) {\n    result.push({\n      startTs: timeline[i].ts,\n      endTs: _.isNil(timeline[i + 1]) ? custom.endTs : timeline[i + 1].ts,\n      value: timeline[i].value,\n    });\n  }\n  log('result : ', result);\n\n  return result;\n}\n\nfunction loadLatestData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let entityId = custom.mainDatasources[0].entity.id;\n    let keys = ['TP_PlannedWorkTimeDay', 'TP_ActivationState'];\n    self.ctx.http\n      .get(\n        `/api/plugins/telemetry/${entityId.entityType}/${\n          entityId.id\n        }/values/timeseries?limit=1&agg=NONE&keys=${keys.join(',')}&startTs=0&endTs=${\n          custom.now\n        }&useStrictDataTypes=true`\n      )\n      .subscribe(datas => {\n        resolve(datas);\n      });\n  });\n}\n\nfunction processData(timelineData, latestData) {\n  let { custom } = self.ctx;\n  let result = {\n    operationTime: 0,\n    plannedTime: 0,\n    activation: false,\n  };\n\n  if (latestData.TP_PlannedWorkTimeDay) {\n    result.plannedTime = latestData.TP_PlannedWorkTimeDay[0].value;\n  }\n  if (latestData.TP_ActivationState) {\n    result.activation = latestData.TP_ActivationState[0].value;\n  }\n\n  // 가동 시간 계산\n  for (let i in timelineData) {\n    if (timelineData[i].value == 2 || timelineData[i].value == 3) {\n      result.operationTime += timelineData[i].endTs - timelineData[i].startTs;\n    }\n  }\n\n  return result;\n}\n\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n\n  $scope.inactivated = custom.mainData.activation != 'true';\n  $scope.detailList[0].value = toStringTime(custom.mainData.operationTime / 1000) || '-';\n  $scope.detailList[1].value = toStringTime(custom.mainData.plannedTime / 1000) || '-';\n  if (!custom.mainData.operationTime || !custom.mainData.plannedTime || custom.mainData.plannedTime == 0) {\n    $scope.ratio = 0;\n  } else {\n    $scope.ratio = _.round((custom.mainData.operationTime / custom.mainData.plannedTime) * 100, 1) || 0;\n  }\n  $scope.ratioColor = getHsl($scope.ratio);\n\n  let circleLength = 2 * RADIUS * Math.PI;\n  $scope.gauge = `${(($scope.ratio > 100 ? 100 : $scope.ratio) * circleLength) / 100}, ${circleLength}`;\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction getHsl(value) {\n  if (value > 100) {\n    value = 100;\n  }\n  return tinycolor(getStyle('--tb-service-progress'))\n    .brighten(_.round((100 - value) / 4))\n    .toHexString();\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n\nfunction toStringTime(value) {\n  let hour = Math.floor(value / 3600);\n  let minute = Math.floor((value % 3600) / 60);\n  return t('thingplus.time-format.hm-acc-em', { hour, minute: addZero(minute, 2) });\n}\n\nfunction addZero(value, pos) {\n  let result = value.toString();\n  for (let i = result.length; i < pos; i++) {\n    result = '0' + result;\n  }\n  return result;\n}\n\nfunction log() {\n  console.log(t(self.ctx.widget.config.title) + '\\r\\n', ...arguments);\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Device Operation\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"-0.04em\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "compare_chart",
      "name": "Compare Chart",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 4.5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-action\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n        <div\n          class=\"widget-header-action\"\n          *ngFor=\"let headerAction of headerActionList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (click)=\"headerAction.action($event)\"\n        >\n          <i class=\"material-icons\">{{headerAction.icon}}</i>\n        </div>\n      </div>\n    </section>\n  </header>\n  <section class=\"compare-section\" fxLayoutAlign=\"space-between start\">\n    <div\n      class=\"compare-box\"\n      *ngFor=\"let compare of compareList\"\n      fxLayout=\"column\"\n      fxLayoutAlign=\"start start\"\n      fxLayoutGap=\"0.2em\"\n    >\n      <label class=\"compare-label\" translate>{{compare.label}}</label>\n      <div class=\"compare-value-box\" fxLayoutAlign=\"center center\" fxLayoutGap=\"0.2em\">\n        <span class=\"compare-value\">{{compare.value}}%</span>\n        <span class=\"compare-direction material-icons {{compare.direction}}\">{{compare.icon}}</span>\n      </div>\n    </div>\n  </section>\n  <section class=\"chart-section\">\n    <canvas class=\"chart\"></canvas>\n  </section>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n\n.widget-header-right-section .widget-header-action {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .widget-header-action i {\n  font-size: 2em;\n  font-weight: bold;\n}\n.widget-header-right-section .widget-header-action:hover {\n  color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .widget-header-action:active {\n  color: var(--tb-service-accent-pressed);\n}\n\n/*\n  Widget Content Area\n*/\n.compare-section {\n  width: 100%;\n  height: 6em;\n  padding: var(--tb-config-padding);\n  padding-bottom: 0px;\n}\n.compare-section .compare-box {\n  height: 100%;\n}\n.compare-section .compare-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.compare-section .compare-value {\n  font-size: 1.6em;\n  font-weight: 600;\n  color: var(--tb-service-font-5);\n}\n.compare-section .compare-direction {\n  display: none;\n  font-size: 1.2em;\n}\n.compare-section .compare-direction.high {\n  display: inline-block;\n  color: var(--tb-service-compare-high);\n}\n.compare-section .compare-direction.low {\n  display: inline-block;\n  color: var(--tb-service-compare-low);\n}\n\n/* chart-section */\n.chart-section {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n.chart-section .chart-box {\n  width: 100%;\n  height: 100%;\n}\n",
        "controllerScript": "self.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  createDataset();\n  createChart();\n  self.onResize();\n\n  custom.isInitialize = true;\n  self.onDataUpdated();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n  };\n};\n\nself.onDataUpdated = async function () {\n  let { custom } = self.ctx;\n\n  if (!custom.isSample) {\n    if (!custom.isUpdated) {\n      custom.isUpdated = true;\n      custom.mainData = await loadData();\n    }\n    custom.mainData = await custom.loadThrottle();\n    if (!custom.mainData) {\n      custom.mainData = [];\n    }\n    insertData();\n    custom.chart.update();\n    self.ctx.detectChanges();\n    self.onResize();\n  }\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$compareSection = $('.compare-section', $container);\n  custom.$chartSection = $('.chart-section', $container);\n  custom.$chart = $('.chart', $container);\n\n  $scope.comparePercentage = '';\n  $scope.compareDirection = '';\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.loadThrottle = _.throttle(loadData, 60000, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.targetKey = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys[0];\n  custom.isInitialize = false;\n  custom.chartLabels = [\n    t('thingplus.time-format.today2'),\n    t('thingplus.time-format.last-day'),\n    t('thingplus.time-format.last-week'),\n    t('thingplus.time-format.last-month'),\n  ];\n  custom.chartData = [0, 0, 0, 0];\n  custom.t = t;\n  const originWidth = self.ctx.settings.widget.originWidth;\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.computedStyle = getComputedStyle($container[0]);\n  custom.units = custom.targetKey.units ? custom.targetKey.units : '';\n  custom.decimals = custom.targetKey.decimals ? custom.targetKey.decimals : '';\n  custom.mainData = [];\n  custom.isUpdated = false;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction loadData() {\n  let { custom } = self.ctx;\n  return new Promise(resolve => {\n    if (custom.mainDatasources[0]) {\n      let startTs = moment().subtract(1, 'months').startOf('day').valueOf();\n      let endTs = moment().valueOf();\n      self.ctx.attributeService\n        .getEntityTimeseries(\n          custom.mainDatasources[0].entity.id,\n          [custom.targetKey.name],\n          startTs,\n          endTs,\n          50000,\n          'NONE',\n          0,\n          'DESC',\n          true\n        )\n        .subscribe(datas => {\n          resolve(datas[custom.targetKey.name]);\n        });\n    } else {\n      resolve([]);\n    }\n  });\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  let compareSectionHeight = custom.$compareSection.outerHeight(true);\n  custom.$chartSection.css('height', `calc(100% - ${headerHeight + compareSectionHeight}px)`);\n\n  if (custom.chart) {\n    custom.chart.options.scales.xAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.scales.yAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.tooltips.xPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.yPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.bodySpacing = custom.widgetFontSize * 0.9;\n    custom.chart.options.tooltips.titleMarginBottom = custom.widgetFontSize;\n    custom.chart.resize();\n  }\n}\n\nfunction createDataset(title, labels) {\n  let { custom } = self.ctx;\n  custom.dataSet = {\n    labels: custom.chartLabels,\n    datasets: [\n      {\n        data: custom.chartData,\n        categoryPercentage: 0.25,\n        fill: true,\n        backgroundColor: [\n          getStyle('--tb-service-accent'),\n          getStyle('--tb-service-compare-bar'),\n          getStyle('--tb-service-compare-bar'),\n          getStyle('--tb-service-compare-bar'),\n        ],\n        hoverBackgroundColor: [\n          tinycolor(getStyle('--tb-service-accent')).darken(),\n          tinycolor(getStyle('--tb-service-compare-bar')).darken(),\n          tinycolor(getStyle('--tb-service-compare-bar')).darken(),\n          tinycolor(getStyle('--tb-service-compare-bar')).darken(),\n        ],\n      },\n    ],\n  };\n}\n\n// 차트생성\nfunction createChart() {\n  let { custom, $scope } = self.ctx;\n  custom.chart = new Chart(custom.$chart, {\n    type: 'horizontalBar',\n    data: custom.dataSet,\n    options: {\n      responsive: true,\n      maintainAspectRatio: false,\n      tooltips: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n        xPadding: custom.widgetFontSize,\n        yPadding: custom.widgetFontSize,\n        bodySpacing: custom.widgetFontSize * 0.9,\n        callbacks: {\n          title: function (tooltipItem, data) {\n            let date = moment();\n            if (tooltipItem[0].index == 0) {\n              date = moment();\n            }\n            if (tooltipItem[0].index == 1) {\n              date = moment().subtract(1, 'days');\n              if (moment().isoWeekday() == 1) {\n                date = moment().subtract(3, 'days');\n              }\n            }\n            if (tooltipItem[0].index == 2) {\n              date = moment().subtract(1, 'weeks');\n            }\n            if (tooltipItem[0].index == 3) {\n              date = moment().subtract(1, 'months');\n              if (date.isoWeekday() == 6) {\n                date = date.subtract(1, 'days');\n              }\n              if (date.isoWeekday() == 7) {\n                date = date.subtract(2, 'days');\n              }\n            }\n            return moment(date).format('YYYY-MM-DD');\n          },\n          label: function (tooltipItem, data) {\n            let label = data.datasets[tooltipItem.datasetIndex].label || '';\n\n            if (label) {\n              label += ': ';\n            }\n            label += _.round(tooltipItem.xLabel, custom.decimals) + ' ' + custom.units;\n\n            return label;\n          },\n        },\n      },\n      hover: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n      },\n      legend: {\n        display: false,\n      },\n      scales: {\n        xAxes: [\n          {\n            display: true,\n            ticks: {\n              suggestedMax: 1,\n              min: 0,\n              maxTicksLimit: 4,\n              fontColor: getStyle('--tb-service-font-2'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n            },\n            gridLines: {\n              display: false,\n              color: getStyle('--tb-service-border-1'),\n              zeroLineColor: getStyle('--tb-service-border-1'),\n            },\n          },\n        ],\n        yAxes: [\n          {\n            display: true,\n            type: 'category',\n            ticks: {\n              fontColor: getStyle('--tb-service-font-4'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n            },\n          },\n        ],\n      },\n    },\n  });\n}\n\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  custom.accDatas = {\n    prevMonth: 0,\n    prevWeek: 0,\n    prevDay: 0,\n    currDay: 0,\n  };\n  let dataLength = custom.mainData.length;\n  let prevMonthStart = moment().subtract(1, 'months').startOf('day').valueOf();\n  let prevMonthEnd = moment().subtract(1, 'months').valueOf();\n  if (moment(prevMonthStart).isoWeekday() == 6) {\n    prevMonthStart = moment(prevMonthStart).subtract(1, 'days').valueOf();\n    prevMonthEnd = moment(prevMonthEnd).subtract(1, 'days').valueOf();\n  }\n  if (moment(prevMonthStart).isoWeekday() == 7) {\n    prevMonthStart = moment(prevMonthStart).subtract(2, 'days').valueOf();\n    prevMonthEnd = moment(prevMonthEnd).subtract(2, 'days').valueOf();\n  }\n  let prevWeekStart = moment().subtract(1, 'weeks').startOf('day').valueOf();\n  let prevWeekEnd = moment().subtract(1, 'weeks').valueOf();\n  let prevDayStart = moment().subtract(1, 'days').startOf('day').valueOf();\n  let prevDayEnd = moment().subtract(1, 'days').valueOf();\n  if (moment().isoWeekday() == 1) {\n    prevDayStart = moment().subtract(3, 'days').startOf('day').valueOf();\n    prevDayEnd = moment().subtract(3, 'days').valueOf();\n  }\n  let currDayStart = moment().startOf('day').valueOf();\n  let currDayEnd = moment().valueOf();\n\n  for (let i = 0; i < dataLength; i++) {\n    let targetTs = custom.mainData[i].ts;\n    if (targetTs >= prevMonthStart && targetTs <= prevMonthEnd) {\n      custom.accDatas.prevMonth += custom.mainData[i].value;\n    }\n    if (targetTs >= prevWeekStart && targetTs <= prevWeekEnd) {\n      custom.accDatas.prevWeek += custom.mainData[i].value;\n    }\n    if (targetTs >= prevDayStart && targetTs <= prevDayEnd) {\n      custom.accDatas.prevDay += custom.mainData[i].value;\n    }\n    if (targetTs >= currDayStart && targetTs <= currDayEnd) {\n      custom.accDatas.currDay += custom.mainData[i].value;\n    }\n  }\n\n  if (custom.targetKey.postFuncBody) {\n    let dataFunction = new Function('value', custom.targetKey.postFuncBody);\n    for (let i in custom.accDatas) {\n      custom.accDatas[i] = dataFunction(custom.accDatas[i]);\n      let decimals = custom.targetKey.decimals;\n      if (decimals && !isNaN(Number(custom.accDatas[i]))) {\n        custom.accDatas[i] = _.round(custom.accDatas[i], decimals);\n      }\n    }\n  }\n\n  custom.chartData[0] = custom.accDatas.currDay;\n  custom.chartData[1] = custom.accDatas.prevDay;\n  custom.chartData[2] = custom.accDatas.prevWeek;\n  custom.chartData[3] = custom.accDatas.prevMonth;\n\n  let dayDiff = custom.accDatas.currDay - custom.accDatas.prevDay;\n  let weekDiff = custom.accDatas.currDay - custom.accDatas.prevWeek;\n  let monthDiff = custom.accDatas.currDay - custom.accDatas.prevMonth;\n\n  $scope.compareList = [\n    {\n      label: 'thingplus.energy.compare-last-day',\n      value: custom.accDatas.prevDay > 0 ? _.round(Math.abs(dayDiff / custom.accDatas.prevDay) * 100) : 0,\n      direction: dayDiff > 0 ? 'high' : dayDiff < 0 ? 'low' : '',\n      icon: dayDiff > 0 ? 'arrow_upward' : dayDiff < 0 ? 'arrow_downward' : '',\n    },\n    {\n      label: 'thingplus.energy.compare-last-week',\n      value: custom.accDatas.prevWeek > 0 ? _.round(Math.abs(weekDiff / custom.accDatas.prevWeek) * 100) : 0,\n      direction: weekDiff > 0 ? 'high' : weekDiff < 0 ? 'low' : '',\n      icon: weekDiff > 0 ? 'arrow_upward' : weekDiff < 0 ? 'arrow_downward' : '',\n    },\n    {\n      label: 'thingplus.energy.compare-last-month',\n      value: custom.accDatas.prevMonth > 0 ? _.round(Math.abs(monthDiff / custom.accDatas.prevMonth) * 100) : 0,\n      direction: monthDiff > 0 ? 'high' : monthDiff < 0 ? 'low' : '',\n      icon: monthDiff > 0 ? 'arrow_upward' : monthDiff < 0 ? 'arrow_downward' : '',\n    },\n  ];\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainDatasources[0].entity.id,\n    custom.mainDatasources[0].entityName,\n    {},\n    custom.mainDatasources[0].entityLabel\n  );\n}\n\nfunction log() {\n  console.log(t(self.ctx.widget.config.title) + '\\r\\n', ...arguments);\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.49036244891566994,\"funcBody\":\"return Math.random() * 100\",\"units\":null,\"decimals\":null,\"usePostProcessing\":null,\"postFuncBody\":null}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Compare Chart\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "electric_parameter",
      "name": "Electric Parameter",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 6.5,
        "sizeY": 4.5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\" fxLayout=\"column\" fxLayoutAlign=\"stretch center\">\n    <section class=\"main-section\" fxFlex>\n      <div class=\"title-row\" fxLayoutAlign=\"space-between center\">\n        <div class=\"title\" fxFlex=\"50\" translate>thingplus.parameter.volt</div>\n        <div class=\"title\" fxFlex=\"50\" translate>thingplus.parameter.curr</div>\n      </div>\n      <div class=\"sub-row\" *ngFor=\"let row of rowList\" fxLayoutAlign=\"space-between center\">\n        <div\n          fxFlex=\"50\"\n          class=\"target\"\n          [ngClass]=\"{'error': target.isError}\"\n          *ngFor=\"let target of row.targetList\"\n          fxLayoutAlign=\"space-between center\"\n          fxLayoutGap=\"1em\"\n        >\n          <span class=\"target-label\" *ngIf=\"!target.isError\">{{target.label}}</span>\n          <span class=\"target-error\" *ngIf=\"target.isError\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.4em\">\n            <i class=\"material-icons\">info</i>\n            <span>{{target.errorMsg}}</span>\n          </span>\n          <div class=\"target-value-box\" fxLayoutAlign=\"end center\" fxLayoutGap=\"0.8em\">\n            <span class=\"target-value\">{{target.value}}</span>\n            <span class=\"target-unit\">{{target.unit}}</span>\n          </div>\n        </div>\n      </div>\n    </section>\n    <section class=\"sub-section\" fxFlex fxLayoutAlign=\"space-between start\" fxLayoutGap=\"1em\">\n      <div\n        fxFlex=\"33.33\"\n        class=\"sub-box\"\n        *ngFor=\"let sub of subList\"\n        fxLayout=\"column\"\n        fxLayoutAlign=\"center start\"\n        fxLayoutGap=\"0.2em\"\n      >\n        <label class=\"sub-label\" translate>{{sub.label}}</label>\n        <span class=\"sub-value\">{{sub.value}}</span>\n        <span class=\"sub-unit\">{{sub.unit}}</span>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-0);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* main-section */\n.main-section {\n  width: 100%;\n}\n.main-section .title-row {\n  width: 100%;\n  border-bottom: 1px solid var(--tb-service-border-0);\n  padding: 0em 2em;\n}\n.main-section .title {\n  font-size: 1.4em;\n  color: var(--tb-service-font-4);\n  border-right: 1px solid var(--tb-service-border-0);\n  padding: 0.71em 0em;\n}\n.main-section .title:last-child {\n  border-right: none;\n  padding-left: 0.71em;\n}\n.main-section .sub-row {\n  width: 100%;\n  border-bottom: 1px solid var(--tb-service-border-0);\n}\n.main-section .target {\n  border-right: 1px solid var(--tb-service-border-0);\n  padding: 1em 0em;\n  padding-left: 2em;\n  padding-right: 1em;\n}\n.main-section .target.error {\n  background-color: rgba(var(--tb-service-warn-rgb), 0.02);\n}\n.main-section .target:last-child {\n  border-right: none;\n  padding-left: 1em;\n  padding-right: 2em;\n}\n.main-section .target-label {\n  color: var(--tb-service-accent);\n  font-size: 1.2em;\n}\n.main-section .target-error {\n  color: var(--tb-alarm-critical);\n  font-size: 1.2em;\n}\n.main-section .target-error i {\n  font-size: 1.2em;\n}\n.main-section .target-value {\n  color: var(--tb-service-font-5);\n  font-weight: 600;\n  font-size: 1.6em;\n}\n.main-section .target.error .target-value {\n  color: var(--tb-alarm-critical);\n  font-weight: bold;\n}\n.main-section .target-unit {\n  color: var(--tb-service-font-3);\n  font-size: 1.2em;\n}\n.main-section .target.error .target-unit {\n  color: var(--tb-alarm-critical);\n  font-weight: 500;\n}\n\n.sub-section {\n  width: 100%;\n  padding: 2em 0em;\n}\n.sub-section .sub-box {\n  height: 100%;\n  padding: 0em 2em;\n  border-right: 1px solid var(--tb-service-border-1);\n}\n.sub-section .sub-box:last-child {\n  border-right: none;\n}\n.sub-section .sub-label {\n  color: var(--tb-service-font-4);\n  font-size: 1.2em;\n}\n.sub-section .sub-value {\n  color: var(--tb-service-font-5);\n  font-weight: 600;\n  font-size: 2em;\n}\n.sub-section .sub-unit {\n  color: var(--tb-service-font-3);\n  font-size: 1.2em;\n}\n",
        "controllerScript": "self.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  preprocessData();\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.rowList = [\n    {\n      targetList: [\n        { label: 'R', value: '-', unit: 'V' },\n        { label: 'R', value: '-', unit: 'A' },\n      ],\n    },\n    {\n      targetList: [\n        { label: 'S', value: '-', unit: 'V' },\n        { label: 'S', value: '-', unit: 'A' },\n      ],\n    },\n    {\n      targetList: [\n        { label: 'T', value: '-', unit: 'V' },\n        { label: 'T', value: '-', unit: 'A' },\n      ],\n    },\n    {\n      targetList: [\n        {\n          label: t('thingplus.parameter.imbalance'),\n          value: '-',\n          unit: '%',\n        },\n        {\n          label: t('thingplus.parameter.imbalance'),\n          value: '-',\n          unit: '%',\n        },\n      ],\n    },\n  ];\n  $scope.subList = [\n    { label: t('thingplus.parameter.power-usage'), value: '-', unit: 'kWh' },\n    { label: t('thingplus.parameter.active-power'), value: '-', unit: 'kW' },\n    { label: t('thingplus.parameter.reactive-power'), value: '-', unit: 'kVar' },\n  ];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys;\n  custom.t = t;\n  custom.keyMap = {\n    f1_volt1: ['rowList', 0, 0],\n    f1_volt2: ['rowList', 1, 0],\n    f1_volt3: ['rowList', 2, 0],\n    f1_amp1: ['rowList', 0, 1],\n    f1_amp2: ['rowList', 1, 1],\n    f1_amp3: ['rowList', 2, 1],\n    unbal: ['rowList', 3, 0],\n    f1_unbal: ['rowList', 3, 1],\n    TP_TotalPowerUsageDay: ['subList', 0],\n    f1_watt: ['subList', 1],\n    f1_var: ['subList', 2],\n  };\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction preprocessData() {\n  let { custom, $scope } = self.ctx;\n  custom.limitInfo = {};\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let name = target.dataKey.name;\n      let data = target.data[0][1];\n      let decimals = target.dataKey.decimals;\n\n      if (name == 'electricLimit') {\n        custom.limitInfo = JSON.parse(data);\n        continue;\n      }\n      if (decimals && !isNaN(Number(data))) {\n        data = _.round(data, decimals);\n      }\n\n      let pos = custom.keyMap[name];\n\n      if (pos) {\n        if (pos[0] == 'rowList') {\n          $scope[pos[0]][pos[1]].targetList[pos[2]].value = data;\n        } else {\n          $scope[pos[0]][pos[1]].value = data;\n        }\n      }\n    }\n  }\n  $scope.rowList[3].targetList[0].isError = false;\n  $scope.rowList[3].targetList[1].isError = false;\n\n  for (let i in custom.limitInfo) {\n    if (!_.isNil(custom.limitInfo[i])) {\n      if (i == 'voltImbal') {\n        if ($scope.rowList[3].targetList[0].value > custom.limitInfo[i]) {\n          $scope.rowList[3].targetList[0].isError = true;\n          $scope.rowList[3].targetList[0].errorMsg = t('thingplus.help.error-imbalance', {\n            limit: custom.limitInfo[i],\n          });\n        }\n      }\n      if (i == 'currImbal') {\n        if (!_.isNil(custom.limitInfo[i]) && $scope.rowList[3].targetList[1].value > custom.limitInfo[i]) {\n          $scope.rowList[3].targetList[1].isError = true;\n          $scope.rowList[3].targetList[1].errorMsg = t('thingplus.help.error-imbalance', {\n            limit: custom.limitInfo[i],\n          });\n        }\n      }\n    }\n  }\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{\"row\":0,\"group\":0,\"cell\":0},\"_hash\":0.11363884944380387,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Electric Parameter\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "electric_quality",
      "name": "Electric Quality",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"main-section\" fxLayout=\"column\" fxLayoutAlign=\"stretch center\">\n      <div\n        class=\"row\"\n        [ngClass]=\"{'error': row.isError}\"\n        fxFlex\n        *ngFor=\"let row of rowList\"\n        fxLayoutAlign=\"space-between center\"\n      >\n        <span class=\"row-label\" *ngIf=\"!row.isError\">{{row.label}}</span>\n        <span class=\"row-error\" *ngIf=\"row.isError\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.4em\">\n          <i class=\"material-icons\">info</i>\n          <span>{{row.errorMsg}}</span>\n        </span>\n        <div class=\"row-value-box\" fxLayoutAlign=\"end center\" fxLayoutGap=\"0.4em\">\n          <span class=\"row-value\">{{row.value}}</span>\n          <span class=\"row-unit\">{{row.unit}}</span>\n        </div>\n      </div>\n    </section>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* main-section */\n.main-section {\n  width: 100%;\n  height: 100%;\n}\n.main-section .row {\n  width: 100%;\n  border-bottom: 1px solid var(--tb-service-border-1);\n  padding: 0em 2em;\n}\n.main-section .row.error {\n  background-color: rgba(var(--tb-service-warn-rgb), 0.02);\n}\n.main-section .row:last-child {\n  border-bottom: none;\n}\n.main-section .row-error {\n  color: var(--tb-alarm-critical);\n  font-size: 1.6em;\n}\n.main-section .row-error i {\n  font-size: 1.2em;\n}\n.main-section .row-label {\n  color: var(--tb-service-font-4);\n  font-size: 1.6em;\n}\n.main-section .row-value {\n  color: var(--tb-service-font-5);\n  font-size: 2em;\n  font-weight: 600;\n}\n.main-section .row.error .row-value {\n  color: var(--tb-alarm-critical);\n  font-weight: bold;\n}\n.main-section .row-unit {\n  color: var(--tb-service-font-5);\n  font-size: 1.4em;\n  font-weight: 500;\n}\n.main-section .row.error .row-unit {\n  color: var(--tb-alarm-critical);\n}\n",
        "controllerScript": "self.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  preprocessData();\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  $scope.rowList = [\n    { label: t('thingplus.parameter.power-factor'), value: '-', unit: '%' },\n    { label: t('thingplus.parameter.thd'), value: '-', unit: '%' },\n  ];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys;\n  custom.t = t;\n  custom.keyMap = {\n    f1_PF: 0,\n    f1_thd: 1,\n  };\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction preprocessData() {\n  let { custom, $scope } = self.ctx;\n  custom.limitInfo = {};\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let name = target.dataKey.name;\n      let data = target.data[0][1];\n      let decimals = target.dataKey.decimals;\n\n      if (name == 'electricLimit') {\n        custom.limitInfo = JSON.parse(data);\n        continue;\n      }\n\n      if (decimals && !isNaN(Number(data))) {\n        data = _.round(data, decimals);\n      }\n\n      let pos = custom.keyMap[name];\n      if (!_.isNil(pos)) {\n        $scope.rowList[pos].value = data;\n      }\n    }\n  }\n\n  $scope.rowList[0].isError = false;\n  $scope.rowList[1].isError = false;\n  for (let i in custom.limitInfo) {\n    if (!_.isNil(custom.limitInfo[i])) {\n      if (i == 'pf') {\n        if ($scope.rowList[0].value < custom.limitInfo[i]) {\n          $scope.rowList[0].isError = true;\n          $scope.rowList[0].errorMsg = t('thingplus.help.error-pf', { limit: custom.limitInfo[i] });\n        }\n      }\n      if (i == 'thd') {\n        if (!_.isNil(custom.limitInfo[i]) && $scope.rowList[1].value > custom.limitInfo[i]) {\n          $scope.rowList[1].isError = true;\n          $scope.rowList[1].errorMsg = t('thingplus.help.error-thd', { limit: custom.limitInfo[i] });\n        }\n      }\n    }\n  }\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{\n  \"schema\": {\n    \"title\": \"DataKeySettings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"row\": {\n        \"title\": \"Row\",\n        \"type\": \"number\",\n        \"default\": 0\n      },\n      \"group\": {\n        \"title\": \"Group\",\n        \"type\": \"number\",\n        \"default\": 0\n      },\n      \"cell\": {\n        \"title\": \"Cell\",\n        \"type\": \"number\",\n        \"default\": 0\n      }\n    }\n  },\n  \"form\": [\"row\", \"group\", \"cell\"]\n}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{\"row\":0,\"group\":0,\"cell\":0},\"_hash\":0.11840811185201616,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Electric Quality\",\"showTitleIcon\":false,\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"titleTooltip\":\"\",\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"}}"
      }
    },
    {
      "alias": "state_timeline_realtime",
      "name": "State Timeline Realtime",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "timeseries",
        "sizeX": 8,
        "sizeY": 2,
        "resources": [],
        "templateHtml": "<div id=\"widget\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\">title</div>\n    </section>\n    <section class=\"widget-header-center-section\" fxFlex=\"100\" fxLayoutAlign=\"center center\" fxLayoutGap=\"1em\">\n      <section class=\"legend-section\" fxLayoutAlign=\"center center\" fxLayoutGap=\"2em\">\n        <div\n          class=\"legend-box\"\n          *ngFor=\"let legend of legendList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (mouseenter)=\"legendEnter($event, legend)\"\n          (mouseleave)=\"legendLeave($event, legend)\"\n        >\n          <div class=\"legend-circle\" [ngStyle]=\"{'color': legend.color}\"></div>\n          <div class=\"legend-label\">{{legend.label}}</div>\n        </div>\n      </section>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"date-range\" fxShow.xs=\"false\">{{dateRange}}</div>\n      <button class=\"action-btn icon-btn\" (click)=\"toDetail($event)\">\n        <i class=\"material-icons\">arrow_forward</i>\n      </button>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"chart-section\"></section>\n  </main>\n</div>\n",
        "templateCss": "@import 'https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0';\n\n#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/* widget-header-center-section */\n.widget-header-center-section .legend-circle {\n  width: 0.6em;\n  height: 0.6em;\n  background-color: currentColor;\n}\n.widget-header-center-section .legend-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.widget-header-center-section .legend-box.hidden .legend-label {\n  text-decoration: line-through;\n}\n\n/* widget-header-right-section */\n.widget-header-right-section .date-range {\n  border: 1px solid var(--tb-service-border-0);\n  color: var(--tb-service-font-3);\n  font-size: 1em;\n  padding: 0.4em 0.8em;\n}\n.widget-header-right-section .action-btn {\n  all: unset;\n  line-height: 1;\n  cursor: pointer;\n  transition-property: background-color, border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .icon-btn {\n  background-color: var(--tb-service-background-0);\n  border: 1px solid var(--tb-service-border-0);\n}\n.widget-header-right-section .icon-btn:hover {\n  border-color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .icon-btn:active {\n  border-color: var(--tb-service-accent-pressed);\n}\n.widget-header-right-section .icon-btn i {\n  font-size: 1.2em;\n  padding: 0.4em;\n  color: var(--tb-service-accent);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* chart-section */\nsection.chart-section {\n  width: 100%;\n  height: 100%;\n  max-width: 100%;\n  overflow-x: auto;\n  overflow-y: hidden;\n  /* display: flex;\n  align-items: center; */\n}\nsection.chart-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\nsection.chart-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\nsection.chart-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.chart-section .domain {\n  display: none;\n}\n.chart-section .tooltip:hover {\n  stroke: var(--tb-service-font-5);\n}\n.chart-section svg {\n  width: 100%;\n  height: auto;\n  padding: auto auto;\n}\n.chart-section .chart-action {\n  cursor: pointer;\n  fill: var(--tb-service-font-3);\n  font-size: 20px;\n  transition-property: fill;\n  transition-duration: var(--tb-config-color-duration);\n}\n.chart-section .chart-action:hover {\n  fill: var(--tb-service-font-5);\n}\n.chart-section .bar-rect {\n  transition-property: transform, height;\n  transition-duration: var(--tb-config-color-duration);\n}\n.chart-section .bar-rect-active {\n  transform: translateY(2px);\n  height: 6px;\n}\n.chart-section .bar-rect-target {\n  transform: translateY(-2px);\n  height: 14px;\n}\n\n@media (min-width: 600px) and (max-width: 960px) {\n  /* chart-section */\n  .chart-section svg {\n    width: 225%;\n    height: auto;\n  }\n}\n\n@media (max-width: 599px) {\n  /* chart-section */\n  .chart-section svg {\n    width: 300%;\n    height: auto;\n  }\n}\n",
        "controllerScript": "const STATUS = {\n  stopped: { priority: 0, content: 'thingplus.state.stopped', color: 'var(--tb-service-state-stopped)' },\n  waiting: { priority: 1, content: 'thingplus.state.waiting', color: 'var(--tb-service-state-waiting)' },\n  working: { priority: 2, content: 'thingplus.state.working', color: 'var(--tb-service-state-working)' },\n  trial: { priority: 3, content: 'thingplus.state.trial', color: 'var(--tb-service-state-trial)' },\n  unconnected: { priority: 4, content: 'thingplus.state.unconnected', color: 'var(--tb-service-state-unconnected)' },\n};\nconst ANALYSIS_MAP = ['stopped', 'waiting', 'working', 'trial', 'unconnected'];\nconst OPERATION_MAP = {\n  WORK: 2,\n  WAIT: 1,\n  STOP: 0,\n  true: 2,\n  false: 0,\n};\nconst STANDARD_WINDOW_SIZE = 1920 / 100;\nconst HOUR_MS = 3600000;\nconst DAY_MS = 24 * HOUR_MS;\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom, $scope } = self.ctx;\n  defineVariables();\n  setTitle();\n  linkEvent();\n  getDashboardParameter();\n  self.onResize();\n  custom.dashboardList = await getDashboardList();\n  startUpdate();\n\n  custom.loadInterval = setInterval(() => {\n    // 매분 00초에 동작\n    if (moment().second() == 0) {\n      startUpdate();\n    }\n  }, 1000);\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDestroy = function () {\n  let { custom } = self.ctx;\n  if (custom.loadInterval) {\n    clearInterval(custom.loadInterval);\n  }\n};\n\nself.actionSources = function () {\n  return {\n    toEdit: {\n      name: 'To Edit',\n      multiple: false,\n    },\n    viewChart: {\n      name: 'View Chart',\n      multiple: false,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$dateRange = $('.date-range', $container);\n  custom.$chartSection = $('.chart-section', $container);\n\n  $scope.legendList = [\n    { key: 'stopped', color: 'var(--tb-service-state-stopped)', label: t('thingplus.state.stopped') },\n    { key: 'waiting', color: 'var(--tb-service-state-waiting)', label: t('thingplus.state.waiting') },\n    { key: 'working', color: 'var(--tb-service-state-working)', label: t('thingplus.state.working') },\n    { key: 'trial', color: 'var(--tb-service-state-trial)', label: t('thingplus.state.trial') },\n    { key: 'unconnected', color: 'var(--tb-service-state-unconnected)', label: t('thingplus.state.unconnected') },\n  ];\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.rootEntity = custom.ownerDatasource.entity;\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys;\n  custom.targetDatasources = custom.mainDatasources;\n  custom.t = t;\n  custom.isInitialize = false;\n  custom.isUpdate = false;\n  custom.onUpdate = _.throttle(() => updateView(), 60000);\n  custom.ymdhms = t('thingplus.time-format.ymdhms');\n  custom.ymdhm = t('thingplus.time-format.ymdhm');\n  custom.computedStyle = getComputedStyle($container[0]);\n  const originWidth = self.ctx.settings.widget.originWidth;\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(t(self.ctx.widget.config.title));\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction linkEvent() {\n  let { $scope } = self.ctx;\n  $scope.toDetail = function (e) {\n    toDetailDashboard();\n  };\n  $scope.legendEnter = function (e, d) {\n    $(`.bar-rect`).addClass('bar-rect-active');\n    $(`.bar-rect-${d.key}`).removeClass('bar-rect-active');\n    $(`.bar-rect-${d.key}`).addClass('bar-rect-target');\n  };\n  $scope.legendLeave = function (e, d) {\n    $(`.bar-rect`).removeClass('bar-rect-active');\n    $(`.bar-rect`).removeClass('bar-rect-target');\n  };\n}\n\nfunction getDashboardParameter() {\n  let { custom } = self.ctx;\n  if (custom.isSample) {\n    custom.dashboardParams = {};\n    return;\n  }\n  custom.dashboardParams = self.ctx.stateController.getStateParams();\n}\n\nasync function getDashboardList() {\n  let dashboardList;\n  if (self.ctx.currentUser.authority == 'TENANT_ADMIN') {\n    dashboardList = await self.ctx.http.get(`/api/tenant/dashboards?pageSize=1024&page=0`).toPromise();\n  } else {\n    let customerId = self.ctx.currentUser.customerId;\n    dashboardList = await self.ctx.http.get(`/api/customer/${customerId}/dashboards?pageSize=1024&page=0`).toPromise();\n  }\n  let result = {};\n  for (let i in dashboardList.data) {\n    result[dashboardList.data[i].title] = dashboardList.data[i];\n  }\n  return result;\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n    if (self.ctx.width < 600) {\n      originWidth = 600;\n    }\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nasync function startUpdate() {\n  let { custom, $scope } = self.ctx;\n  custom.now = moment().valueOf();\n  custom.startTs = moment(custom.now).subtract(7, 'days').valueOf();\n  custom.analysisEndTs = moment(custom.now).subtract(1, 'hours').startOf('hours').valueOf();\n  custom.endTs = custom.now;\n  $scope.dateRange = `${moment(custom.startTs).format(custom.ymdhms)} ~ ${moment(custom.endTs).format(custom.ymdhms)}`;\n\n  if (custom.isSample) return;\n\n  custom.timeline = await drawTimeline();\n  drawChart();\n  self.ctx.detectChanges();\n}\n\nasync function drawTimeline() {\n  let initData = await loadInitData();\n  let telemetryData = await loadTelemetryData();\n  let timelineData = createTimeline(initData, telemetryData);\n  return timelineData;\n}\n\nfunction loadInitData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let entityId = custom.mainDatasources[0].entity.id;\n    let keys = ['TP_AnalysisState', 'TP_ModifiedState'];\n    self.ctx.http\n      .get(\n        `/api/plugins/telemetry/${entityId.entityType}/${\n          entityId.id\n        }/values/timeseries?limit=1&agg=NONE&keys=${keys.join(',')}&startTs=0&endTs=${\n          custom.startTs\n        }&useStrictDataTypes=true`\n      )\n      .subscribe(datas => {\n        // 분석 데이터 삭제\n        if (custom.now - custom.startTs < HOUR_MS) {\n          delete datas.TP_AnalysisState;\n        }\n        if (datas.TP_ModifiedState) {\n          let value = datas.TP_ModifiedState[0].value;\n          if (value.endTs < custom.now) {\n            delete datas.TP_ModifiedState;\n          } else {\n            value.startTs = custom.startTs;\n          }\n        }\n        resolve(datas);\n      });\n  });\n}\n\nfunction loadTelemetryData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let entityId = custom.mainDatasources[0].entity.id;\n    let keys = ['TP_AnalysisState', 'TP_OperationState', 'TP_ConnectionState', 'TP_ModifiedState'];\n    self.ctx.http\n      .get(\n        `/api/plugins/telemetry/${entityId.entityType}/${\n          entityId.id\n        }/values/timeseries?limit=50000&agg=NONE&keys=${keys.join(',')}&startTs=${custom.startTs}&endTs=${\n          custom.endTs\n        }&useStrictDataTypes=true`\n      )\n      .subscribe(datas => {\n        resolve(datas);\n      });\n  });\n}\n\nfunction createTimeline(initData, telemetryData) {\n  let { custom } = self.ctx;\n  let timeline = [];\n\n  // 상태 데이터 병합\n  if (initData.TP_AnalysisState) {\n    timeline.push({ ts: custom.startTs, value: initData.TP_AnalysisState[0].value });\n  }\n  if (telemetryData.TP_AnalysisState) {\n    timeline = timeline.concat(telemetryData.TP_AnalysisState);\n  }\n\n  // 분석 데이터가 없는 경우 통신이상으로 표시\n  if (timeline.length == 0) {\n    timeline.push({ ts: custom.startTs, value: 4 });\n  }\n  for (let i in telemetryData.TP_OperationState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_OperationState[i].ts > custom.analysisEndTs) {\n      telemetryData.TP_OperationState[i].value = OPERATION_MAP[telemetryData.TP_OperationState[i].value];\n      timeline.push(telemetryData.TP_OperationState[i]);\n    }\n  }\n  for (let i in telemetryData.TP_ConnectionState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_ConnectionState[i].ts > custom.analysisEndTs) {\n      if (telemetryData.TP_ConnectionState[i].value == 'false') {\n        timeline.push({ ts: telemetryData.TP_ConnectionState[i].ts, value: 4 });\n      }\n    }\n  }\n  timeline.sort((a, b) => {\n    return a.ts - b.ts;\n  });\n\n  // 수정된 부분 적용\n  let modifiedData = [];\n  if (initData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(initData.TP_ModifiedState);\n  }\n  if (telemetryData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(telemetryData.TP_ModifiedState);\n  }\n  for (let i in modifiedData) {\n    let targetData = modifiedData[i].value;\n    for (let j = 0; j < timeline.length; j++) {\n      // case 1 : 수정된 데이터가 기존 데이터와 같은 경우\n      if (timeline[j].ts == targetData.startTs && timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        timeline[j].value = targetData.state;\n        if (\n          timeline[j - 1] &&\n          timeline[j - 1].value == targetData.state &&\n          timeline[j + 1] &&\n          timeline[j + 1].value == targetData.state\n        ) {\n          // case 1-1: 이전 값과 다음 값이 수정된 값과 같은 경우 현재 값과 다음 값 삭제\n          timeline.splice(j, 2);\n        } else if (timeline[j - 1] && timeline[j - 1].value == targetData.state) {\n          // case 1-1: 이전 값이 수정된 값과 같은 경우 현재 값 삭제\n          timeline.splice(j, 1);\n        } else if (timeline[j + 1] && timeline[j + 1].value == targetData.state) {\n          // case 1-1: 다음 값이 수정된 값과 같은 경우 다음 값 삭제\n          timeline.splice(j + 1, 1);\n        }\n        break;\n      }\n      // case 2 : 수정된 데이터와 기존 데이터의 시작 시간이 같은 경우\n      else if (timeline[j].ts == targetData.startTs) {\n        timeline[j].ts = targetData.endTs;\n        // 이전 값이 수정된 값과 다른 경우 추가\n        if (!timeline[j - 1] || timeline[j - 1].value != targetData.state) {\n          timeline.splice(j, 0, { ts: targetData.startTs, value: timeline[j].value });\n        }\n        break;\n      }\n      // case 3 : 수정된 데이터와 기존 데이터의 종료 시간이 같은 경우\n      else if (timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        if (timeline[j + 1].value == targetData.state) {\n          timeline[j + 1].ts = targetData.startTs;\n        } else {\n          timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        }\n        break;\n      }\n      // case 4 : 수정된 데이터가 기존 데이터의 시작 시간과 종료 시간 사이에 있는 경우\n      else if (\n        timeline[j].ts < targetData.startTs &&\n        ((timeline[j + 1] && timeline[j + 1].ts > targetData.endTs) || !timeline[j + 1])\n      ) {\n        timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        if (timeline[j + 1]) {\n          timeline.splice(j + 2, 0, { ts: targetData.endTs, value: timeline[j].value });\n        } else {\n          timeline.splice(j + 2, 0, { ts: custom.endTs, value: timeline[j].value });\n        }\n\n        break;\n      }\n    }\n  }\n  timeline.sort((a, b) => {\n    return a.ts - b.ts;\n  });\n\n  let result = [];\n  for (let i = 0; i < timeline.length; i++) {\n    result.push({\n      index: i,\n      startTs: timeline[i].ts,\n      endTs: _.isNil(timeline[i + 1]) ? custom.endTs : timeline[i + 1].ts,\n      value: timeline[i].value,\n    });\n  }\n\n  return result;\n}\n\nfunction drawChart() {\n  let { custom, $scope } = self.ctx;\n  custom.d3Config = {\n    viewWidth: 1920,\n    barHeight: 10,\n    barMargin: 30,\n    margin: {\n      top: 0,\n      right: 96,\n      bottom: 40,\n      left: 230,\n    },\n  };\n  custom.d3Config.viewHeight =\n    custom.d3Config.margin.top +\n    custom.d3Config.margin.bottom +\n    custom.mainDatasources.length * (2 * custom.d3Config.barMargin + custom.d3Config.barHeight);\n\n  custom.$chartSection.empty();\n  // svg 영역 정의\n  custom.$d3 = d3\n    .select(custom.$chartSection[0])\n    .append('svg')\n    .attr('viewBox', `0 0 ${custom.d3Config.viewWidth} ${custom.d3Config.viewHeight}`)\n    .attr('width', custom.d3Config.viewWidth)\n    .attr('height', custom.d3Config.viewHeight);\n\n  drawXAxis();\n  drawBar();\n}\n\nfunction drawXAxis() {\n  let { custom, $scope } = self.ctx;\n  let { viewWidth, viewHeight, margin } = custom.d3Config;\n  const width = viewWidth - margin.left - margin.right;\n  const height = margin.bottom;\n\n  // xAxis 그리기\n  custom.xAxis = d3\n    .scaleTime()\n    .domain(d3.extent([custom.startTs, custom.endTs]))\n    .range([0, width]);\n  custom.$xAxis = custom.$d3\n    .append('g')\n    .attr('class', 'axis')\n    .attr('transform', 'translate(' + margin.left + ', ' + (viewHeight - height) + ')')\n    .style('font-size', '12px')\n    .style('font-family', 'var(--tb-config-font-family)')\n    .style('color', 'var(--tb-service-font-4)')\n    .style('stroke-width', '0.1em')\n    .call(\n      d3\n        .axisBottom(custom.xAxis)\n        .ticks(7)\n        .tickFormat(date => formatDate(date))\n    );\n}\n\nfunction drawBar() {\n  let { custom, $scope, $container } = self.ctx;\n  let { viewWidth, viewHeight, barMargin, barHeight, margin } = custom.d3Config;\n  const x = custom.xAxis;\n  custom.$d3\n    .append('g')\n    .attr('class', 'bar-group')\n    .append('rect')\n    .attr('class', 'background')\n    .attr('width', viewWidth)\n    .attr('height', 2 * barMargin + barHeight)\n    .attr('fill', 'var(--tb-service-background-1)')\n    .attr('stroke', 'var(--tb-service-border-1)');\n\n  let dayLineList = [custom.startTs];\n  for (let i = custom.startTs; i < moment(custom.endTs).endOf('day').valueOf(); i += DAY_MS) {\n    if (moment(i).startOf('day').valueOf() > custom.startTs) {\n      dayLineList.push(moment(i).startOf('day').valueOf());\n    }\n  }\n  dayLineList.sort();\n  custom.$d3\n    .select(`.bar-group`)\n    .append('g')\n    .attr('class', `day-group`)\n    .selectAll('g')\n    .data(dayLineList)\n    .enter()\n    .append('rect')\n    .attr('class', 'day-line')\n    .attr('x', d => margin.left + x(d))\n    .attr('width', d => {\n      let endTs = d + DAY_MS;\n      if (endTs > custom.endTs) {\n        endTs = custom.endTs;\n      }\n      if (d == custom.startTs) {\n        endTs = moment(d).add(1, 'days').startOf('day').valueOf();\n      }\n      return x(endTs) - x(d);\n    })\n    .attr('height', 2 * barMargin + barHeight)\n    .attr('fill', (d, i) => {\n      return i % 2 == 0 ? 'var(--tb-service-background-4)' : 'var(--tb-service-background-2)';\n    })\n    .attr('opacity', 0.5)\n    .attr('stroke', 'var(--tb-service-border-1)');\n\n  // 상태 변화 막대 그리기\n  custom.$d3.select('.bar-group').append('g').attr('class', `bar`);\n  custom.$d3\n    .select(`.bar`)\n    .append('g')\n    .selectAll('g')\n    .data([custom.mainDatasources[0]])\n    .enter()\n    .append('text')\n    .text(function (d) {\n      if (d) {\n        return d.entityLabel;\n      }\n      return '';\n    })\n    .attr('width', margin.left - 40)\n    .attr('x', 20)\n    .attr('y', margin.top + barMargin + barHeight / 2 + 4)\n    .style('font-size', '14px')\n    .style('font-family', 'var(--tb-config-font-family)')\n    .style('fill', 'var(--tb-service-font-5)')\n    .call(dotme);\n\n  custom.$d3\n    .select(`.bar`)\n    .append('g')\n    .selectAll('g')\n    .data(custom.timeline)\n    .enter()\n    .append('rect')\n    .attr('class', d => `bar-rect bar-rect-${ANALYSIS_MAP[d.value]} tooltip tooltip-${d.index}`)\n    .attr('fill', d => {\n      return STATUS[ANALYSIS_MAP[d.value]].color;\n    })\n    .attr('x', d => margin.left + x(d.startTs))\n    .attr('y', margin.top + barMargin)\n    .attr('width', d => x(d.endTs) - x(d.startTs))\n    .attr('height', barHeight);\n\n  custom.$d3\n    .select(`.bar`)\n    .append('g')\n    .selectAll('g')\n    .data([custom.mainDatasources[0]])\n    .enter()\n    .append('text')\n    .attr('class', 'chart-action material-icons')\n    .text('edit')\n    .attr('x', viewWidth - margin.right + 22)\n    .attr('y', margin.top + barMargin + barHeight / 2 + 10)\n    .on('click', function (e, d, i) {\n      toEdit(d);\n    });\n\n  custom.$d3\n    .select(`.bar`)\n    .append('g')\n    .selectAll('g')\n    .data([custom.mainDatasources[0]])\n    .enter()\n    .append('text')\n    .attr('class', 'chart-action material-symbols-outlined')\n    .text('earthquake')\n    .attr('x', viewWidth - margin.right + 52)\n    .attr('y', margin.top + barMargin + barHeight / 2 + 10)\n    .on('click', function (e, d, i) {\n      openChart(d);\n    });\n  for (let i in custom.timeline) {\n    let $content = $('<div></div>');\n    $content.css({\n      color: 'var(--tb-service-font-0)',\n      backgroundColor: 'rgba(0,0,0,0.8)',\n      lineHeight: 1.5,\n      borderRadius: `${8 / STANDARD_WINDOW_SIZE}vw`,\n      padding: `${12 / STANDARD_WINDOW_SIZE}vw`,\n    });\n\n    let startTime = moment(custom.timeline[i].startTs).format(custom.ymdhm);\n    let endTime = moment(custom.timeline[i].endTs).format(custom.ymdhm);\n    let $date = $(`<div>${startTime} ~ ${endTime}</div>`);\n    $date.css({\n      textAlign: 'center',\n      fontSize: `${12 / STANDARD_WINDOW_SIZE}vw`,\n    });\n\n    let $description = $(`<div></div>`);\n    if (!_.isNil(custom.timeline[i].value) && custom.timeline[i].value !== '') {\n      $description.html(`(${t(STATUS[ANALYSIS_MAP[custom.timeline[i].value]].content)})`);\n    }\n    $description.css({\n      textAlign: 'center',\n      fontSize: `${12 / STANDARD_WINDOW_SIZE}vw`,\n    });\n\n    $content.append($date);\n    $content.append($description);\n\n    $(`.tooltip-${custom.timeline[i].index}`, $container).tooltipster({\n      content: $content,\n      interactive: true,\n      theme: 'tooltipster-transparent',\n      trigger: 'hover',\n      delay: 200,\n    });\n  }\n}\n\nfunction formatDate(date) {\n  if (d3.timeHour(date) < date) {\n    return d3.timeFormat(t('thingplus.time-format.d3-hm'))(date);\n  } else if (d3.timeDay(date) < date) {\n    return d3.timeFormat(t('thingplus.time-format.d3-dh'))(date);\n  } else {\n    return d3.timeFormat(t('thingplus.time-format.d3-md'))(date);\n  }\n}\n\nfunction toDetailDashboard() {\n  let { custom, $scope } = self.ctx;\n  let stateObj = [\n    {\n      id: 'default',\n      params: custom.dashboardParams,\n    },\n  ];\n  let dashboardId = custom.dashboardList['State Timeline'].id.id;\n  const state = self.ctx.utils.objToBase64URI(stateObj);\n  let regex = /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/;\n  if (regex.test(dashboardId)) {\n    let url = `/dashboards/${dashboardId}?state=${state}`;\n    self.ctx.router.navigateByUrl(url);\n  }\n}\n\nfunction dotme(text) {\n  text.each(function () {\n    let text = d3.select(this);\n    let words = Array.from(text.text());\n\n    let ellipsis = text.text('').append('tspan').attr('class', 'elip').text('...');\n    let width = parseFloat(text.attr('width')) - ellipsis.node().getComputedTextLength();\n    let numWords = words.length;\n\n    let tspan = text.insert('tspan', ':first-child').text(words.join(''));\n    while (tspan.node().getComputedTextLength() > width && words.length) {\n      words.pop();\n      tspan.text(words.join(''));\n    }\n\n    if (words.length === numWords) {\n      ellipsis.remove();\n    }\n  });\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction toEdit(data) {\n  let { custom, $scope } = self.ctx;\n  let descriptors = self.ctx.actionsApi.getActionDescriptors('toEdit');\n  self.ctx.actionsApi.handleWidgetAction({}, descriptors[0], data.entity.id, data.entityName, custom, data.entityLabel);\n}\n\nfunction openChart(data) {\n  let { custom, $scope } = self.ctx;\n  let descriptors = self.ctx.actionsApi.getActionDescriptors('viewChart');\n  self.ctx.actionsApi.handleWidgetAction({}, descriptors[0], data.entity.id, data.entityName, custom, data.entityLabel);\n}\n\nfunction log() {\n  console.log(t(self.ctx.widget.config.title) + '\\r\\n', ...arguments);\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"First\",\"color\":\"#2196f3\",\"settings\":{\"showLines\":true,\"fillLines\":true,\"showPoints\":false},\"_hash\":0.8587686344902596,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#f44336\",\"settings\":{},\"_hash\":0.014738469932256137,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"State Timeline Realtime\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"mobileHeight\":null,\"showTitleIcon\":false,\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"legendConfig\":{\"direction\":\"column\",\"position\":\"bottom\",\"sortDataKeys\":false,\"showMin\":false,\"showMax\":false,\"showAvg\":true,\"showTotal\":false},\"useDashboardTimewindow\":true}"
      }
    },
    {
      "alias": "alarm_list",
      "name": "Alarm List",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "alarm",
        "sizeX": 10.5,
        "sizeY": 6.5,
        "resources": [],
        "templateHtml": "<tb-alarms-table-widget [ctx]=\"ctx\"> </tb-alarms-table-widget>\n<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"center center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\">\n    <section class=\"widget-header-left-section\" fxFlex fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\">{{title}}</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n              <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <span class=\"th-label\">{{th.label}}</span>\n                <i class=\"th-sort material-icons\">arrow_downward</i>\n              </div>\n            </th>\n            <th *ngIf=\"hasCellAction\" [ngStyle]=\"{'width': actionSize}\"></th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr *ngFor=\"let tr of trList\">\n            <td\n              *ngFor=\"let td of tr.tdList\"\n              [ngStyle]=\"td.style\"\n              [innerHTML]=\"td.value\"\n              (click)=\"td.action && td.action($event)\"\n            ></td>\n            <td *ngIf=\"hasCellAction\" class=\"action\">\n              <div class=\"cell-action-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <i\n                  *ngFor=\"let cellAction of cellActionList\"\n                  class=\"material-icons cell-action\"\n                  (click)=\"cellAction.action($event, tr.index)\"\n                >\n                  {{cellAction.icon}}\n                </i>\n              </div>\n            </td>\n          </tr>\n        </tbody>\n      </table>\n    </section>\n  </main>\n  <footer class=\"widget-footer\" fxLayoutAlign=\"end center\">\n    <section class=\"page-section\" fxLayoutAlign=\"end center\" fxLayoutGap=\"0.5em\">\n      <div class=\"material-icons page-button first-button\" (click)=\"getFirstPage()\">first_page</div>\n      <div class=\"material-icons page-button prev-button\" (click)=\"getPrevPage()\">keyboard_arrow_left</div>\n      <div\n        class=\"page-button page-number-button\"\n        [class.big]=\"page.isBig\"\n        [class.active]=\"page.isActive\"\n        *ngFor=\"let page of pageList\"\n        (click)=\"changePage($event, page)\"\n      >\n        {{page.number}}\n      </div>\n      <div class=\"material-icons page-button next-button\" (click)=\"getNextPage()\">keyboard_arrow_right</div>\n      <div class=\"material-icons page-button last-button\" (click)=\"getLastPage()\">last_page</div>\n    </section>\n  </footer>\n</div>\n",
        "templateCss": "tb-alarms-table-widget {\n  display: none;\n}\n\n#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section td {\n  line-height: 1;\n}\n.table-section td:not(.action) {\n  color: var(--tb-service-font-4);\n  padding: 1.2em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section td.action {\n  font-size: 1em;\n  padding: 0em 1.68em;\n  text-overflow: initial;\n}\n.table-section .cell-action {\n  font-size: 2em;\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .cell-action:hover {\n  color: var(--tb-service-font-5);\n}\n.table-section .cell-action.active {\n  color: var(--tb-service-accent);\n}\n.table-section .activate-switch {\n  position: relative;\n  width: 3.6em;\n  height: 1.6em;\n  border-radius: 0.8em;\n  background-color: var(--tb-service-font-3);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n  margin: auto;\n  cursor: pointer;\n}\n.table-section .activate-switch.active {\n  background-color: var(--tb-service-accent);\n}\n.table-section .activate-switch .ball {\n  position: absolute;\n  top: 50%;\n  left: 0.8em;\n  transform: translate(-50%, -50%);\n  width: 1.2em;\n  height: 1.2em;\n  border-radius: 0.6em;\n  background-color: var(--tb-service-background-0);\n  transition-property: left;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .activate-switch.active .ball {\n  left: calc(100% - 0.8em);\n}\n\n/*\n  Widget Footer Area\n*/\nfooter.widget-footer {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/* page-section */\n.page-section .page-button {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 2em;\n  min-width: 20px;\n  height: 2em;\n  min-height: 20px;\n  font-size: 1.2em;\n  background-color: var(--tb-service-background-0);\n  border: 1px solid var(--tb-service-border-0);\n  cursor: pointer;\n  color: var(--tb-service-font-4);\n  transition-property: border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.page-section .first-button,\n.page-section .last-button,\n.page-section .prev-button,\n.page-section .next-button {\n  font-size: 1.6em;\n  width: 1.5em;\n  height: 1.5em;\n}\n.page-section .page-button:not(.active):hover {\n  border: 1px solid var(--tb-service-accent-hover);\n}\n.page-section .page-button:not(.active):active {\n  border: 1px solid var(--tb-service-accent-pressed);\n}\n.page-section .page-button.big-page {\n  width: 3.5em;\n  min-width: 35px;\n}\n.page-section .page-number-button.active {\n  border: 1px solid var(--tb-service-accent);\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const ALARM_MAP = {\n  createdTime: { name: 'createdTime', type: 'ts' },\n  startTime: { name: 'startTs', type: 'ts' },\n  endTime: { name: 'endTs', type: 'ts' },\n  ackTime: { name: 'ackTs', type: 'ts' },\n  clearTime: { name: 'clearTs', type: 'ts' },\n  originator: { name: 'originatorName', type: 'string' },\n  originatorType: { name: 'originator', type: 'object' },\n  type: { name: 'type', type: 'string' },\n  severity: { name: 'severity', type: 'string' },\n  status: { name: 'status', type: 'string' },\n};\n\nself.onInit = function () {\n  self.ctx.custom = {};\n  defineVariables();\n  makeHead();\n  setTitle();\n  linkEvent();\n};\n\nself.onDataUpdated = function () {\n  setEntity();\n  initPage();\n  makeBody();\n  self.onResize();\n  sortData();\n  insertData();\n  self.ctx.detectChanges();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n    actionCellButton: {\n      name: 'widget-action.action-cell-button',\n      multiple: true,\n    },\n    customAction: {\n      name: 'Custom Action',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetAction = $('.widget-action', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$table = $('.table', $container);\n  custom.$theadTr = $('.table thead tr', $container);\n  custom.$tbody = $('.table tbody', $container);\n  custom.$widgetFooter = $('.widget-footer', $container);\n\n  // Define Scope Variables\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.pageList = [];\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n  $scope.cellActionList = self.ctx.actionsApi.getActionDescriptors('actionCellButton').map(x => {\n    return { name: x.name, icon: x.icon, action: (e, i) => handleCellAction(x, i) };\n  });\n  $scope.hasCellAction = $scope.cellActionList.length > 0;\n  $scope.actionSize = `${$scope.cellActionList.length * 2 + 3.36 + ($scope.cellActionList.length - 1) * 0.5}em`;\n\n  // Define Normal Variables\n  custom.relations = {};\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.mainDatasource = self.ctx.defaultSubscription.alarmSource;\n  custom.isSample = custom.mainDatasource.type == 'function';\n  custom.originDataKeys = custom.mainDatasource.dataKeys.filter(x => x.settings.hidden !== true);\n  custom.alarms = self.ctx.defaultSubscription.alarms.data;\n  custom.targetAlarms = [];\n  custom.alarmNames = custom.mainDatasource.dataKeys.map(x => x.name);\n  custom.alarmLabels = custom.mainDatasource.dataKeys.map(x => x.label);\n  custom.isInitialized = false;\n  custom.selectedIndex = 0;\n  custom.currentPage = 1;\n  custom.countPerPage = 10;\n  custom.t = t;\n}\n\nfunction setEntity() {\n  let { custom, $scope, $container } = self.ctx;\n  custom.mainDatasource = self.ctx.defaultSubscription.alarmSource;\n  custom.originDataKeys = custom.mainDatasource.dataKeys.filter(x => x.settings.hidden !== true);\n  custom.alarms = self.ctx.defaultSubscription.alarms.data;\n  custom.alarmNames = custom.mainDatasource.dataKeys.map(x => x.name);\n  custom.alarmLabels = custom.mainDatasource.dataKeys.map(x => x.label);\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom, $scope } = self.ctx;\n  $scope.title = t(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.getPrevPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage--;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.getNextPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage++;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.getFirstPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage = 1;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.getLastPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage = custom.totalPage;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.changePage = function (e, page) {\n    if (!page.isActive) {\n      custom.currentPage = page.number;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'DESC') {\n        $scope.thList[th.index].order = 'DESC';\n      } else {\n        $scope.thList[th.index].order = 'ASC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'DESC';\n    }\n    initPage();\n    makeBody();\n    sortData();\n    insertData();\n  };\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header와 Footer Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  let footerHeight = custom.$widgetFooter.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight + footerHeight}px)`);\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [];\n  for (let i in custom.originDataKeys) {\n    $scope.thList.push({\n      index: i,\n      key: custom.originDataKeys[i].name,\n      label: t(custom.originDataKeys[i].label),\n      order: custom.selectedIndex == i ? 'DESC' : '',\n    });\n  }\n}\n\n// 페이지에 맞는 데이터 출력 및 페이지 표시\nfunction initPage() {\n  let { custom, $scope } = self.ctx;\n  custom.totalPage = Math.ceil(custom.alarms.length / custom.countPerPage);\n  // 현재 페이지 기준 왼쪽이 5개 오른쪽이 4개가 되도록\n  custom.startPage = custom.currentPage - 5;\n  // 6번까지는 왼쪽이 5개 이하이므로 시작을 1로 고정\n  if (custom.currentPage <= 6) {\n    custom.startPage = 1;\n  }\n  // 마지막에서 5칸 아래페이지 부터는 오른쪽이 4개 이하이므로 시작을 마지막에서 9을 뺀것으로 고정\n  if (custom.totalPage >= 10 && custom.currentPage > custom.totalPage - 5) {\n    custom.startPage = custom.totalPage - 9;\n  }\n  custom.endPage = custom.startPage + 9;\n  // 끝 페이지가 총 페이지보다 크면 총페이지를 끝 페이지로\n  if (custom.endPage > custom.totalPage) {\n    custom.endPage = custom.totalPage;\n  }\n\n  // 페이지 리스트 구성\n  $scope.pageList = [];\n  for (let i = custom.startPage; i <= custom.endPage; i++) {\n    $scope.pageList.push({\n      number: i,\n      isBig: i > 99,\n      isActive: custom.currentPage == i,\n    });\n  }\n\n  custom.startIndex = (custom.currentPage - 1) * custom.countPerPage;\n  custom.endIndex = custom.currentPage * custom.countPerPage - 1;\n  // 끝 페이지가 데이터 소스의 길이보다 많으면 데이터 소스의 길이로 변경\n  if (custom.endIndex > custom.alarms.length - 1) {\n    custom.endIndex = custom.alarms.length - 1;\n  }\n  custom.targetAlarms = custom.alarms.slice(custom.startIndex, custom.endIndex + 1);\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  // 현재 페이지의 데이터 수 만큼 행 출력\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    let tdList = [];\n    for (let j in custom.originDataKeys) {\n      tdList.push({ index: j, name: custom.originDataKeys[j].name, style: '', value: '' });\n    }\n    $scope.trList.push({\n      index: i,\n      tdList: tdList,\n    });\n  }\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n  // 정렬에 사용할 객체를 깊은 복사\n  custom.mainData = custom.alarms.map(x => x);\n  // details.data는 Device Profile상에서 detail 기입시 생겨나는 항목으로 string 형태를 json으로 파싱하여 복합 데이터 추출\n  custom.mainData.forEach(x => {\n    try {\n      x.details.data = JSON.parse(x.details.data);\n    } catch (err) {\n      // JSON으로 파싱 실패시 일반값 기입\n    }\n  });\n\n  custom.mainData.sort((a, b) => {\n    let targetA, targetB;\n    if (a.details && b.details && /^details\\./.test(selectedKey)) {\n      // selectedKey가 details로 시작하면 하위 요소로 정렬\n      targetA = a.details[selectedKey.split('details.')[1]];\n      targetB = b.details[selectedKey.split('details.')[1]];\n    } else {\n      if (selectedKey == 'originator') {\n        targetA = a.originator.entityType;\n        targetB = b.originator.entityType;\n      } else {\n        targetA = a[selectedKey];\n        targetB = b[selectedKey];\n      }\n    }\n    if (selectedOrder == 'DESC') {\n      if (targetA > targetB) return -1;\n      if (targetA < targetB) return 1;\n      return 0;\n    } else {\n      if (targetA > targetB) return 1;\n      if (targetA < targetB) return -1;\n      return 0;\n    }\n  });\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    for (let j in custom.originDataKeys) {\n      let originKey = custom.originDataKeys[j].name;\n      let key = originKey;\n      let data = '-';\n      if (ALARM_MAP[originKey]) {\n        key = ALARM_MAP[originKey].name;\n        data = custom.mainData[i][key];\n      } else {\n        if (/^details\\./.test(originKey)) {\n          // details.로 시작하면 하위요소를 출력\n          let detail = originKey.split('details.')[1];\n          if (custom.mainData[i].details) {\n            data = custom.mainData[i].details[detail];\n          } else {\n            data = '-';\n          }\n        }\n      }\n\n      // Apply cell style function\n      if (custom.originDataKeys[j].settings.useCellStyleFunction) {\n        try {\n          let styleFunction = new Function('value', 'ctx', custom.originDataKeys[j].settings.cellStyleFunction);\n          let style = styleFunction(data, self.ctx);\n          $scope.trList[i - custom.startIndex].tdList[j].style = style;\n        } catch (err) {\n          console.error(err);\n        }\n      }\n      // Apply cell content function\n      if (custom.originDataKeys[j].settings.useCellContentFunction) {\n        try {\n          let contentFunction = new Function('value', 'ctx', custom.originDataKeys[j].settings.cellContentFunction);\n          data = contentFunction(data, self.ctx);\n        } catch (err) {\n          console.error(err);\n        }\n      }\n\n      $scope.trList[i - custom.startIndex].tdList[j].value = data;\n    }\n  }\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.ownerDatasource.entity.id,\n    custom.ownerDatasource.entityName,\n    {},\n    custom.ownerDatasource.entityLabel\n  );\n}\n\nfunction handleCellAction(descriptor, index) {\n  let { custom, $scope } = self.ctx;\n  let realIndex = $scope.trList[index - custom.startIndex].index;\n  self.ctx.actionsApi.handleWidgetAction({}, descriptor, custom.alarms[realIndex].id, '', custom.alarms[realIndex], '');\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      },\n      \"alarmsTitle\": {\n        \"title\": \"Alarms table title\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"enableSelection\": {\n        \"title\": \"Enable alarms selection\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"enableSearch\": {\n        \"title\": \"Enable alarms search\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"enableSelectColumnDisplay\": {\n        \"title\": \"Enable select columns to display\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"enableFilter\": {\n        \"title\": \"Enable alarm filter\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"enableStickyHeader\": {\n        \"title\": \"Always display header\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"enableStickyAction\": {\n        \"title\": \"Always display actions column\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"reserveSpaceForHiddenAction\": {\n        \"title\": \"Hidden cell button actions display mode\",\n        \"type\": \"string\",\n        \"default\": \"true\"\n      },\n      \"displayDetails\": {\n        \"title\": \"Display alarm details\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"allowAcknowledgment\": {\n        \"title\": \"Allow alarms acknowledgment\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"allowClear\": {\n        \"title\": \"Allow alarms clear\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"displayPagination\": {\n        \"title\": \"Display pagination\",\n        \"type\": \"boolean\",\n        \"default\": true\n      },\n      \"defaultPageSize\": {\n        \"title\": \"Default page size\",\n        \"type\": \"number\",\n        \"default\": 10\n      },\n      \"defaultSortOrder\": {\n        \"title\": \"Default sort order\",\n        \"type\": \"string\",\n        \"default\": \"-createdTime\"\n      },\n      \"useRowStyleFunction\": {\n        \"title\": \"Use row style function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"rowStyleFunction\": {\n        \"title\": \"Row style function: f(alarm, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      }\n    }\n  },\n  \"form\": [\n    [\"widget.originWidth\"],\n    [\n      \"alarmsTitle\",\n      \"enableSelection\",\n      \"enableSearch\",\n      \"enableSelectColumnDisplay\",\n      \"enableFilter\",\n      \"enableStickyHeader\",\n      \"enableStickyAction\",\n      {\n        \"key\": \"reserveSpaceForHiddenAction\",\n        \"type\": \"rc-select\",\n        \"multiple\": false,\n        \"items\": [\n          {\n            \"value\": \"true\",\n            \"label\": \"Show empty space instead of hidden cell button action\"\n          },\n          {\n            \"value\": \"false\",\n            \"label\": \"Don't reserve space for hidden action buttons\"\n          }\n        ]\n      },\n      \"displayDetails\",\n      \"allowAcknowledgment\",\n      \"allowClear\",\n      \"displayPagination\",\n      \"defaultPageSize\",\n      \"defaultSortOrder\",\n      \"useRowStyleFunction\",\n      {\n        \"key\": \"rowStyleFunction\",\n        \"type\": \"javascript\",\n        \"helpId\": \"widget/lib/alarm/row_style_fn\",\n        \"condition\": \"model.useRowStyleFunction === true\"\n      }\n    ]\n  ],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    },\n    {\n      \"formIndex\": 1,\n      \"GroupTitle\": \"Advanced\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{\n  \"schema\": {\n    \"type\": \"object\",\n    \"title\": \"DataKeySettings\",\n    \"properties\": {\n      \"hidden\": {\n        \"title\": \"Hide from table\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"useCellStyleFunction\": {\n        \"title\": \"Use cell style function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellStyleFunction\": {\n        \"title\": \"Cell style function: f(value, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"useCellContentFunction\": {\n        \"title\": \"Use cell content function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellContentFunction\": {\n        \"title\": \"Cell content function: f(value, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"useCellActionFunction\": {\n        \"title\": \"Use cell action function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellActionFunction\": {\n        \"title\": \"Cell action function: f(value, tr, td, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      }\n    },\n    \"required\": []\n  },\n  \"form\": [\n    \"hidden\",\n    \"useCellStyleFunction\",\n    {\n      \"key\": \"cellStyleFunction\",\n      \"type\": \"javascript\"\n    },\n    \"useCellContentFunction\",\n    {\n      \"key\": \"cellContentFunction\",\n      \"type\": \"javascript\"\n    },\n    \"useCellActionFunction\",\n    {\n      \"key\": \"cellActionFunction\",\n      \"type\": \"javascript\"\n    }\n  ]\n}\n",
        "defaultConfig": "{\"timewindow\":{\"hideInterval\":false,\"hideAggregation\":false,\"hideAggInterval\":false,\"hideTimezone\":false,\"selectedTab\":0,\"realtime\":{\"realtimeType\":0,\"timewindowMs\":2592000000,\"quickInterval\":\"CURRENT_DAY\",\"interval\":1000},\"aggregation\":{\"type\":\"NONE\",\"limit\":200}},\"showTitle\":false,\"backgroundColor\":\"rgb(255, 255, 255)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630},\"enableSelection\":true,\"enableSearch\":true,\"enableSelectColumnDisplay\":true,\"enableFilter\":true,\"enableStickyHeader\":true,\"reserveSpaceForHiddenAction\":\"true\",\"displayDetails\":true,\"allowAcknowledgment\":true,\"allowClear\":true,\"displayPagination\":true,\"defaultPageSize\":10,\"defaultSortOrder\":\"-createdTime\"},\"title\":\"Alarm List\",\"dropShadow\":false,\"enableFullscreen\":false,\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"useDashboardTimewindow\":false,\"showLegend\":false,\"alarmSource\":{\"type\":\"function\",\"dataKeys\":[{\"name\":\"createdTime\",\"type\":\"alarm\",\"label\":\"Created time\",\"color\":\"#2196f3\",\"settings\":{\"useCellStyleFunction\":false,\"cellStyleFunction\":\"\",\"useCellContentFunction\":false,\"cellContentFunction\":\"\"},\"_hash\":0.021092237451093787},{\"name\":\"originator\",\"type\":\"alarm\",\"label\":\"Originator\",\"color\":\"#4caf50\",\"settings\":{\"useCellStyleFunction\":false,\"cellStyleFunction\":\"\",\"useCellContentFunction\":false,\"cellContentFunction\":\"\"},\"_hash\":0.2780007688856758},{\"name\":\"type\",\"type\":\"alarm\",\"label\":\"Type\",\"color\":\"#f44336\",\"settings\":{\"useCellStyleFunction\":false,\"cellStyleFunction\":\"\",\"useCellContentFunction\":false,\"cellContentFunction\":\"\"},\"_hash\":0.7323586880398418},{\"name\":\"severity\",\"type\":\"alarm\",\"label\":\"Severity\",\"color\":\"#ffc107\",\"settings\":{\"useCellStyleFunction\":false,\"useCellContentFunction\":false},\"_hash\":0.09927019860088193},{\"name\":\"status\",\"type\":\"alarm\",\"label\":\"Status\",\"color\":\"#607d8b\",\"settings\":{\"useCellStyleFunction\":false,\"cellStyleFunction\":\"\",\"useCellContentFunction\":false,\"cellContentFunction\":\"\"},\"_hash\":0.6588418951443418}],\"entityAliasId\":null,\"name\":\"alarms\"},\"alarmSearchStatus\":\"ANY\",\"alarmsPollingInterval\":5,\"showTitleIcon\":false,\"titleIcon\":\"more_horiz\",\"iconColor\":\"rgba(0, 0, 0, 0.87)\",\"iconSize\":\"24px\",\"titleTooltip\":\"\",\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"displayTimewindow\":false,\"actions\":{},\"alarmStatusList\":[],\"alarmSeverityList\":[],\"alarmTypeList\":[],\"searchPropagatedAlarms\":true,\"noDataDisplayMessage\":\"\"}"
      }
    },
    {
      "alias": "manager_info",
      "name": "Manager Info",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\" fxLayout=\"column\" fxLayoutAlign=\"space-evenly center\">\n    <div class=\"row\" *ngFor=\"let info of infoList\" fxLayoutAlign=\"space-between center\">\n      <div class=\"label-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n        <i class=\"info-icon material-icons\">{{info.icon}}</i>\n        <label class=\"info-label\">{{info.label}}</label>\n      </div>\n      <div class=\"info-value\">{{info.value}}</div>\n    </div>\n  </main>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n  padding: 0 2em;\n}\n\n.widget-content .row {\n  width: 100%;\n  padding: 1em 0em;\n  border-bottom: 1px solid var(--tb-service-border-0);\n}\n.widget-content .row:last-child {\n  border: none;\n}\n.widget-content .info-icon {\n  color: var(--tb-service-accent);\n  font-size: 2em;\n}\n.widget-content .info-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.widget-content .info-value {\n  font-size: 1.4em;\n  color: var(--tb-service-font-5);\n}\n",
        "controllerScript": "self.onInit = function () {\n  self.ctx.custom = {};\n  defineVariables();\n  setTitle();\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDataUpdated = function () {\n  let { custom } = self.ctx;\n  custom.mainData = preprocessData();\n  self.ctx.detectChanges();\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.userDatasource = self.ctx.defaultSubscription.configuredDatasources[2];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.userDatasources = self.ctx.datasources.filter(x => x.entityAliasId == custom.userDatasource.entityAliasId);\n  custom.t = t;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight}px)`);\n}\n\nfunction preprocessData() {\n  let { custom, $scope } = self.ctx;\n  $scope.infoList = [];\n  for (let i in self.ctx.data) {\n    let target = self.ctx.data[i];\n    if (!_.isNil(target.data[0])) {\n      let label = target.dataKey.label;\n      let data = target.data[0][1];\n      let icon = target.dataKey.settings.icon;\n      // Apply cell content function\n      if (target.dataKey.settings.useCellContentFunction) {\n        try {\n          let contentFunction = new Function('value', 'ctx', target.dataKey.settings.cellContentFunction);\n          data = contentFunction(data, self.ctx);\n        } catch (err) {\n          console.error(err);\n        }\n      }\n      if (custom.userDatasources.length > 0) {\n        if (target.datasource.entityAliasId == custom.userDatasource.entityAliasId) {\n          $scope.infoList.push({\n            icon: icon,\n            label: t(label),\n            value: data,\n          });\n        }\n      } else {\n        $scope.infoList.push({\n          icon: icon,\n          label: t(label),\n          value: data,\n        });\n      }\n    }\n  }\n  return {};\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"icon\": {\n        \"title\": \"Icon\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"useCellStyleFunction\": {\n        \"title\": \"Use cell style function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellStyleFunction\": {\n        \"title\": \"Cell style function: f(value, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"useCellContentFunction\": {\n        \"title\": \"Use cell content function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellContentFunction\": {\n        \"title\": \"Cell content function: f(value, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      }\n    }\n  },\n  \"form\": [\n    \"icon\",\n    \"useCellStyleFunction\",\n    {\n      \"key\": \"cellStyleFunction\",\n      \"type\": \"javascript\"\n    },\n    \"useCellContentFunction\",\n    {\n      \"key\": \"cellContentFunction\",\n      \"type\": \"javascript\"\n    }\n  ]\n}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{\"icon\":\"\"},\"_hash\":0.6402472371259578,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin 2\",\"color\":\"#f44336\",\"settings\":{\"icon\":\"\"},\"_hash\":0.5560619520614971,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Manager Info\",\"showTitleIcon\":false,\"titleIcon\":\"\",\"iconColor\":\"rgba(0, 0, 0, 0.87)\",\"iconSize\":\"24px\",\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"-0.05em\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    },
    {
      "alias": "alarm_realtime",
      "name": "Alarm Realtime",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 7.5,
        "sizeY": 3,
        "resources": [],
        "templateHtml": "<div id=\"widget\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\">\n    <section class=\"widget-header-left-section\" fxFlex fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\">title</div>\n    </section>\n  </header>\n  <main class=\"widget-content\">\n    <section class=\"table-section\">\n      <table class=\"table\">\n        <thead>\n          <tr>\n            <th *ngFor=\"let th of thList\" (click)=\"changeSort($event, th)\" [ngClass]=\"th.order\">\n              <div class=\"th-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <span class=\"th-label\">{{th.label}}</span>\n                <i class=\"th-sort material-icons\">arrow_downward</i>\n              </div>\n            </th>\n            <th *ngIf=\"hasCellAction\" [ngStyle]=\"{'width': actionSize}\"></th>\n          </tr>\n        </thead>\n        <tbody>\n          <tr *ngFor=\"let tr of trList\">\n            <td\n              *ngFor=\"let td of tr.tdList\"\n              [ngStyle]=\"td.style\"\n              [innerHTML]=\"td.value\"\n              (click)=\"td.action && td.action($event)\"\n            ></td>\n            <td *ngIf=\"hasCellAction\" class=\"action\">\n              <div class=\"cell-action-box\" fxLayoutAlign=\"start center\" fxLayoutGap=\"0.5em\">\n                <i\n                  *ngFor=\"let cellAction of cellActionList\"\n                  class=\"material-icons cell-action\"\n                  [ngClass]=\"{'disabled': cellAction.name == 'Ack' && tr.acked == 'disabled', 'acked': cellAction.name == 'Ack' && tr.acked == 'acked' }\"\n                  (click)=\"cellAction.action($event, tr.index, tr)\"\n                >\n                  {{cellAction.icon}}\n                </i>\n              </div>\n            </td>\n          </tr>\n        </tbody>\n      </table>\n    </section>\n  </main>\n  <footer class=\"widget-footer\" fxLayoutAlign=\"end center\">\n    <section class=\"page-section\" fxLayoutAlign=\"end center\" fxLayoutGap=\"0.5em\">\n      <div class=\"material-icons page-button first-button\" (click)=\"getFirstPage()\">first_page</div>\n      <div class=\"material-icons page-button prev-button\" (click)=\"getPrevPage()\">keyboard_arrow_left</div>\n      <div\n        class=\"page-button page-number-button\"\n        [class.big]=\"page.isBig\"\n        [class.active]=\"page.isActive\"\n        *ngFor=\"let page of pageList\"\n        (click)=\"changePage($event, page)\"\n      >\n        {{page.number}}\n      </div>\n      <div class=\"material-icons page-button next-button\" (click)=\"getNextPage()\">keyboard_arrow_right</div>\n      <div class=\"material-icons page-button last-button\" (click)=\"getLastPage()\">last_page</div>\n    </section>\n  </footer>\n</div>\n",
        "templateCss": "@import 'https://fonts.googleapis.com/icon?family=Material+Icons+Outlined';\n\n#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/*\n  Widget Content Area\n*/\nmain.widget-content {\n  width: 100%;\n}\n\n/* table-section */\n.table-section {\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n.table-section::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n.table-section::-webkit-scrollbar-thumb {\n  border: 2px solid #00000000;\n  background-clip: padding-box;\n  background-color: var(--tb-service-accent);\n}\n.table-section::-webkit-scrollbar-thumb:hover {\n  border: 1px solid #00000000;\n}\n.table-section .table {\n  min-width: 100%;\n  border-spacing: 0px;\n  box-sizing: border-box;\n  table-layout: fixed;\n  border-collapse: collapse;\n  white-space: nowrap;\n}\n.table-section thead tr {\n  background-color: var(--tb-service-background-1);\n  border-top: 1px solid var(--tb-service-border-1);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n.table-section th {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  padding: 1.68em;\n  text-align: left;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  font-size: 1em;\n  line-height: 1;\n}\n.table-section th .th-label {\n  font-size: 1.2em;\n  margin-right: 0.5em;\n}\n.table-section th .th-sort {\n  font-size: 1.4em;\n  opacity: 0;\n  vertical-align: top;\n  transition-property: transform, opacity;\n  transition-duration: var(--tb-config-color-duration);\n  color: var(--tb-service-accent);\n}\n.table-section th:not(.DESC):not(.ASC):hover .th-sort {\n  opacity: 0.4;\n}\n.table-section th.DESC .th-sort {\n  opacity: 1;\n  transform: rotate(0deg);\n}\n.table-section th.ASC .th-sort {\n  opacity: 1;\n  transform: rotate(180deg);\n}\n.table-section tbody tr {\n  border-bottom: 1px solid var(--tb-service-border-1);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section tbody tr:nth-child(odd) {\n  background-color: var(--tb-service-background-0);\n}\n.table-section tbody tr:nth-child(even) {\n  background-color: var(--tb-service-background-1);\n}\n.table-section td {\n  line-height: 1;\n}\n.table-section td:not(.action) {\n  color: var(--tb-service-font-4);\n  padding: 1.2em;\n  font-size: 1.4em;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  user-select: text;\n}\n.table-section tbody tr:hover {\n  background-color: var(--tb-service-background-2);\n}\n.table-section td.action {\n  font-size: 1em;\n  padding: 0em 1.68em;\n  text-overflow: initial;\n}\n.table-section .cell-action {\n  font-size: 2em;\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .cell-action.disabled {\n  color: var(--tb-service-font-1);\n  opacity: 0.5;\n  cursor: default;\n}\n.table-section .cell-action.acked {\n  color: var(--tb-service-accent);\n  cursor: default;\n}\n.table-section .cell-action:not(.disabled):not(.acked):hover {\n  color: var(--tb-service-font-5);\n}\n.table-section .cell-action.active:not(.disabled) {\n  color: var(--tb-service-accent);\n}\n.table-section .activate-switch {\n  position: relative;\n  width: 3.6em;\n  height: 1.6em;\n  border-radius: 0.8em;\n  background-color: var(--tb-service-font-3);\n  transition-property: background-color;\n  transition-duration: var(--tb-config-color-duration);\n  margin: auto;\n  cursor: pointer;\n}\n.table-section .activate-switch.active {\n  background-color: var(--tb-service-accent);\n}\n.table-section .activate-switch .ball {\n  position: absolute;\n  top: 50%;\n  left: 0.8em;\n  transform: translate(-50%, -50%);\n  width: 1.2em;\n  height: 1.2em;\n  border-radius: 0.6em;\n  background-color: var(--tb-service-background-0);\n  transition-property: left;\n  transition-duration: var(--tb-config-color-duration);\n}\n.table-section .activate-switch.active .ball {\n  left: calc(100% - 0.8em);\n}\n.severity-box {\n  display: flex;\n  justify-content: start;\n  align-items: center;\n  gap: 0.5em;\n}\n.severity-box i {\n  font-size: 1.4em;\n}\n.severity-box.CRITICAL i {\n  color: var(--tb-alarm-critical);\n}\n.severity-box.MAJOR i {\n  color: var(--tb-alarm-major);\n}\n.severity-box.MINOR i {\n  color: var(--tb-alarm-minor);\n}\n.severity-box.WARNING i {\n  color: var(--tb-alarm-warning);\n}\n.severity-box.INTERMIDIATE i {\n  color: var(--tb-alarm-intermidiate);\n}\n\n/*\n  Widget Footer Area\n*/\nfooter.widget-footer {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n\n/* page-section */\n.page-section .page-button {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  width: 2em;\n  min-width: 20px;\n  height: 2em;\n  min-height: 20px;\n  font-size: 1.2em;\n  background-color: var(--tb-service-background-0);\n  border: 1px solid var(--tb-service-border-0);\n  cursor: pointer;\n  color: var(--tb-service-font-4);\n  transition-property: border-color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.page-section .first-button,\n.page-section .last-button,\n.page-section .prev-button,\n.page-section .next-button {\n  font-size: 1.6em;\n  width: 1.5em;\n  height: 1.5em;\n}\n.page-section .page-button:not(.active):hover {\n  border: 1px solid var(--tb-service-accent-hover);\n}\n.page-section .page-button:not(.active):active {\n  border: 1px solid var(--tb-service-accent-pressed);\n}\n.page-section .page-button.big-page {\n  width: 3.5em;\n  min-width: 35px;\n}\n.page-section .page-number-button.active {\n  border: 1px solid var(--tb-service-accent);\n  color: var(--tb-service-accent);\n}\n",
        "controllerScript": "const ANALYSIS_MAP = ['stopped', 'waiting', 'working'];\nconst OPERATION_MAP = {\n  STOP: 'stopped',\n  WAIT: 'waiting',\n  WORK: 'working',\n};\n\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  linkEvent();\n  makeHead();\n\n  if (custom.isSample) return;\n\n  processData();\n  custom.interval = setInterval(() => {\n    processData();\n  }, 60000);\n  self.onResize();\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDestroy = function () {\n  let { custom } = self.ctx;\n  clearInterval(custom.interval);\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n    actionCellButton: {\n      name: 'widget-action.action-cell-button',\n      multiple: true,\n    },\n    customAction: {\n      name: 'Custom Action',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$widgetAction = $('.widget-action', $container);\n  custom.$widgetContent = $('.widget-content', $container);\n  custom.$table = $('.table', $container);\n  custom.$theadTr = $('.table thead tr', $container);\n  custom.$tbody = $('.table tbody', $container);\n  custom.$widgetFooter = $('.widget-footer', $container);\n\n  // Define Scope Variables\n  $scope.thList = [];\n  $scope.trList = [];\n  $scope.pageList = [];\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n  $scope.cellActionList = self.ctx.actionsApi.getActionDescriptors('actionCellButton').map(x => {\n    return { name: x.name, icon: x.icon, action: (e, i, tr) => handleCellAction(x, i, tr) };\n  });\n  $scope.hasCellAction = $scope.cellActionList.length > 0;\n  $scope.actionSize = `${$scope.cellActionList.length * 2 + 3.36 + ($scope.cellActionList.length - 1) * 0.5}em`;\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.originDataKeys = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys.filter(\n    x => x.settings.hidden !== true\n  );\n  custom.selectedIndex = 0;\n  custom.currentPage = 1;\n  custom.countPerPage = 10;\n  custom.t = t;\n  let now = moment().valueOf();\n  custom.startTs = moment(now).subtract(7, 'days').valueOf();\n  custom.endTs = now;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(t(self.ctx.widget.config.title));\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nfunction linkEvent() {\n  let { custom, $scope } = self.ctx;\n  $scope.getPrevPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage--;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.getNextPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage++;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.getFirstPage = function () {\n    if (custom.currentPage > 1) {\n      custom.currentPage = 1;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.getLastPage = function () {\n    if (custom.currentPage < custom.totalPage) {\n      custom.currentPage = custom.totalPage;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.changePage = function (e, page) {\n    if (!page.isActive) {\n      custom.currentPage = page.number;\n      initPage();\n      makeBody();\n      insertData();\n    }\n  };\n  $scope.changeSort = function (e, th) {\n    if (th.isAction) return;\n    if (th.index == custom.selectedIndex) {\n      if (th.order != 'DESC') {\n        $scope.thList[th.index].order = 'DESC';\n      } else {\n        $scope.thList[th.index].order = 'ASC';\n      }\n    } else {\n      $scope.thList.forEach(x => (x.order = ''));\n      custom.selectedIndex = th.index;\n      $scope.thList[th.index].order = 'DESC';\n    }\n    initPage();\n    makeBody();\n    sortData();\n    insertData();\n  };\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  let widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (widgetFontSize < 6.25) {\n    widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${widgetFontSize}px`);\n\n  // Header와 Footer Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  let footerHeight = custom.$widgetFooter.outerHeight(true);\n  custom.$widgetContent.css('height', `calc(100% - ${headerHeight + footerHeight}px)`);\n}\n\n// 헤더 부분 생성\nfunction makeHead() {\n  let { custom, $scope } = self.ctx;\n  $scope.thList = [];\n  for (let i in custom.originDataKeys) {\n    $scope.thList.push({\n      index: i,\n      key: custom.originDataKeys[i].name,\n      label: t(custom.originDataKeys[i].label),\n      order: custom.selectedIndex == i ? 'DESC' : '',\n    });\n  }\n}\n\nasync function processData() {\n  let { custom } = self.ctx;\n  let analysisEndTs = moment(custom.endTs).subtract(1, 'hours').startOf('hours').valueOf();\n  custom.loadedDatas = await self.ctx.rxjs\n    .forkJoin([\n      loadAttributes(custom.mainDatasources[0].entity.id, 'customerL1Name,customerL2Name'),\n      loadTimeseries(custom.mainDatasources[0].entity.id, custom.startTs, analysisEndTs, 'TP_AnalysisState'),\n      loadTimeseries(custom.mainDatasources[0].entity.id, analysisEndTs, custom.endTs, 'TP_OperationState'),\n      loadAlarm(custom.mainDatasources[0].entity.id, custom.startTs, custom.endTs),\n    ])\n    .toPromise();\n\n  custom.mainData = preprocessData(custom.loadedDatas);\n  initPage();\n  makeBody();\n  sortData();\n  insertData();\n  // self.onResize();\n  self.ctx.detectChanges();\n}\n\nfunction loadAttributes(entityId, keys) {\n  return self.ctx.http.get(\n    `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/attributes/SERVER_SCOPE?keys=${keys}`\n  );\n}\n\nfunction loadTimeseries(entityId, startTs, endTs, keys) {\n  return self.ctx.http.get(\n    `/api/plugins/telemetry/${entityId.entityType}/${entityId.id}/values/timeseries?keys=${keys}&startTs=${startTs}&endTs=${endTs}&limit=50000&agg=NONE&interval=0&orderBy=ASC&useStrictDataTypes=true`\n  );\n}\n\nfunction loadAlarm(entityId, startTime, endTime) {\n  return self.ctx.http.get(\n    `/api/alarm/${entityId.entityType}/${entityId.id}?searchStatus=ANY&pageSize=50000&page=0&startTime=${startTime}&endTime=${endTime}&fetchOriginator=true`\n  );\n}\n\nfunction preprocessData(loadedDatas) {\n  let { custom } = self.ctx;\n  let result = [];\n  let customerL1NameIndex = loadedDatas[0].findIndex(x => x.key == 'customerL1Name');\n  let customerL1Name = '';\n  if (customerL1NameIndex != -1) {\n    customerL1Name = loadedDatas[0][customerL1NameIndex].value;\n  }\n  let customerL2NameIndex = loadedDatas[0].findIndex(x => x.key == 'customerL2Name');\n  let customerL2Name = '';\n  if (customerL2NameIndex != -1) {\n    customerL2Name = loadedDatas[0][customerL2NameIndex].value;\n  }\n\n  if (loadedDatas[1].TP_AnalysisState) {\n    loadedDatas[1].TP_AnalysisState = loadedDatas[1].TP_AnalysisState.filter(x => x.value <= 2);\n    for (let i in loadedDatas[1].TP_AnalysisState) {\n      result.push({\n        createdTime: loadedDatas[1].TP_AnalysisState[i].ts,\n        customerL1Name: customerL1Name,\n        customerL2Name: customerL2Name,\n        originatorLabel: custom.mainDatasources[0].entityLabel,\n        category: 'state',\n        type: ANALYSIS_MAP[loadedDatas[1].TP_AnalysisState[i].value],\n        severity: 'INTERMIDIATE',\n        ackTs: 0,\n        clearTs: 0,\n      });\n    }\n  }\n  if (loadedDatas[2].TP_OperationState) {\n    for (let i in loadedDatas[2].TP_OperationState) {\n      result.push({\n        createdTime: loadedDatas[2].TP_OperationState[i].ts,\n        customerL1Name: customerL1Name,\n        customerL2Name: customerL2Name,\n        originatorLabel: custom.mainDatasources[0].entityLabel,\n        category: 'state',\n        type: OPERATION_MAP[loadedDatas[2].TP_OperationState[i].value],\n        severity: 'INTERMIDIATE',\n        ackTs: 0,\n        clearTs: 0,\n      });\n    }\n  }\n  for (let i in loadedDatas[3].data) {\n    result.push({\n      createdTime: loadedDatas[3].data[i].createdTime,\n      customerL1Name: customerL1Name,\n      customerL2Name: customerL2Name,\n      originatorLabel: custom.mainDatasources[0].entityLabel,\n      originator: custom.mainDatasources[0].entity.id,\n      category: loadedDatas[3].data[i].details.category,\n      type: loadedDatas[3].data[i].type,\n      severity: loadedDatas[3].data[i].severity,\n      ackTs: loadedDatas[3].data[i].ackTs,\n      clearTs: loadedDatas[3].data[i].clearTs,\n      id: loadedDatas[3].data[i].id,\n    });\n  }\n  result.sort((a, b) => a - b);\n  return result;\n}\n\n// 페이지에 맞는 데이터 출력 및 페이지 표시\nfunction initPage() {\n  let { custom, $scope } = self.ctx;\n  custom.totalPage = Math.ceil(custom.mainData.length / custom.countPerPage);\n  // 현재 페이지 기준 왼쪽이 5개 오른쪽이 4개가 되도록\n  custom.startPage = custom.currentPage - 5;\n  // 6번까지는 왼쪽이 5개 이하이므로 시작을 1로 고정\n  if (custom.currentPage <= 6) {\n    custom.startPage = 1;\n  }\n  // 마지막에서 5칸 아래페이지 부터는 오른쪽이 4개 이하이므로 시작을 마지막에서 9을 뺀것으로 고정\n  if (custom.totalPage >= 10 && custom.currentPage > custom.totalPage - 5) {\n    custom.startPage = custom.totalPage - 9;\n  }\n  custom.endPage = custom.startPage + 9;\n  // 끝 페이지가 총 페이지보다 크면 총페이지를 끝 페이지로\n  if (custom.endPage > custom.totalPage) {\n    custom.endPage = custom.totalPage;\n  }\n\n  // 페이지 리스트 구성\n  $scope.pageList = [];\n  for (let i = custom.startPage; i <= custom.endPage; i++) {\n    $scope.pageList.push({\n      number: i,\n      isBig: i > 99,\n      isActive: custom.currentPage == i,\n    });\n  }\n\n  custom.startIndex = (custom.currentPage - 1) * custom.countPerPage;\n  custom.endIndex = custom.currentPage * custom.countPerPage - 1;\n  // 끝 페이지가 데이터 소스의 길이보다 많으면 데이터 소스의 길이로 변경\n  if (custom.endIndex > custom.mainData.length - 1) {\n    custom.endIndex = custom.mainData.length - 1;\n  }\n}\n\n// 테이블 바디 생성\nfunction makeBody() {\n  let { custom, $scope } = self.ctx;\n  $scope.trList = [];\n  // 현재 페이지의 데이터 수 만큼 행 출력\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    let tdList = [];\n    for (let j in custom.originDataKeys) {\n      tdList.push({ index: j, name: custom.originDataKeys[j].name, style: '', value: '' });\n    }\n    $scope.trList.push({\n      index: i,\n      tdList: tdList,\n      acked: '',\n    });\n  }\n}\n\n// 데이터 재 정렬\nfunction sortData() {\n  let { custom, $scope } = self.ctx;\n  let selectedKey = $scope.thList[custom.selectedIndex].key;\n  let selectedOrder = $scope.thList[custom.selectedIndex].order;\n\n  custom.mainData.sort((a, b) => {\n    if (selectedOrder == 'DESC') {\n      if (a[selectedKey] > b[selectedKey]) return -1;\n      if (a[selectedKey] < b[selectedKey]) return 1;\n      return 0;\n    } else {\n      if (a[selectedKey] > b[selectedKey]) return 1;\n      if (a[selectedKey] < b[selectedKey]) return -1;\n      return 0;\n    }\n  });\n}\n\n// 데이터 삽입\nfunction insertData() {\n  let { custom, $scope } = self.ctx;\n  for (let i = custom.startIndex; i <= custom.endIndex; i++) {\n    for (let j in custom.originDataKeys) {\n      let key = custom.originDataKeys[j].name;\n      let data = custom.mainData[i][key];\n\n      if ((key == 'type' && data == 'working') || data == 'waiting' || data == 'stopped') {\n        $scope.trList[i - custom.startIndex].acked = 'disabled';\n      }\n      if (key == 'ackTs' && data != 0) {\n        $scope.trList[i - custom.startIndex].acked = 'acked';\n      }\n\n      if (custom.originDataKeys[j].settings.useCellStyleFunction) {\n        // Apply cell style function\n        try {\n          let styleFunction = new Function('value', 'ctx', custom.originDataKeys[j].settings.cellStyleFunction);\n          let style = styleFunction(data, self.ctx);\n          $scope.trList[i - custom.startIndex].tdList[j].style = style;\n        } catch (err) {\n          console.error(err);\n        }\n      }\n      // Apply cell content function\n      if (custom.originDataKeys[j].settings.useCellContentFunction) {\n        try {\n          let contentFunction = new Function('value', 'ctx', custom.originDataKeys[j].settings.cellContentFunction);\n          data = contentFunction(data, self.ctx);\n        } catch (err) {\n          console.error(err);\n        }\n      }\n\n      $scope.trList[i - custom.startIndex].tdList[j].value = data;\n    }\n  }\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.ownerDatasource.entity.id,\n    custom.ownerDatasource.entityName,\n    {},\n    custom.ownerDatasource.entityLabel\n  );\n}\n\nfunction handleCellAction(descriptor, index, tr) {\n  let { custom, $scope } = self.ctx;\n  if (descriptor.name == 'Ack' && tr.acked != '') {\n    return;\n  }\n  let realIndex = $scope.trList[index - custom.startIndex].index;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainData[realIndex].id,\n    '',\n    custom.mainData[realIndex],\n    ''\n  );\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{\n  \"schema\": {\n    \"type\": \"object\",\n    \"title\": \"DataKeySettings\",\n    \"properties\": {\n      \"hidden\": {\n        \"title\": \"Hide from table\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"useCellStyleFunction\": {\n        \"title\": \"Use cell style function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellStyleFunction\": {\n        \"title\": \"Cell style function: f(value, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"useCellContentFunction\": {\n        \"title\": \"Use cell content function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellContentFunction\": {\n        \"title\": \"Cell content function: f(value, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      },\n      \"useCellActionFunction\": {\n        \"title\": \"Use cell action function\",\n        \"type\": \"boolean\",\n        \"default\": false\n      },\n      \"cellActionFunction\": {\n        \"title\": \"Cell action function: f(value, tr, td, ctx)\",\n        \"type\": \"string\",\n        \"default\": \"\"\n      }\n    },\n    \"required\": []\n  },\n  \"form\": [\n    \"hidden\",\n    \"useCellStyleFunction\",\n    {\n      \"key\": \"cellStyleFunction\",\n      \"type\": \"javascript\"\n    },\n    \"useCellContentFunction\",\n    {\n      \"key\": \"cellContentFunction\",\n      \"type\": \"javascript\"\n    },\n    \"useCellActionFunction\",\n    {\n      \"key\": \"cellActionFunction\",\n      \"type\": \"javascript\"\n    }\n  ]\n}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{\"hidden\":false,\"useCellStyleFunction\":false,\"cellStyleFunction\":\"\",\"useCellContentFunction\":false,\"cellContentFunction\":\"\",\"useCellActionFunction\":false,\"cellActionFunction\":\"\"},\"_hash\":0.08239731356838775,\"funcBody\":\"return Math.round(1000*Math.sin(time/5000));\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Alarm Realtime\",\"showTitleIcon\":false,\"dropShadow\":true,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false,\"titleTooltip\":\"\",\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":600,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"}}"
      }
    },
    {
      "alias": "time_compare_chart",
      "name": "Time Compare Chart",
      "image": null,
      "description": null,
      "descriptor": {
        "type": "latest",
        "sizeX": 5,
        "sizeY": 4.5,
        "resources": [],
        "templateHtml": "<div id=\"widget\" fxLayout=\"column\" fxLayoutAlign=\"start center\">\n  <header class=\"widget-header\" fxLayoutAlign=\"space-between center\" fxLayoutGap=\"1em\">\n    <section class=\"widget-header-left-section\" fxFlex=\"100\" fxLayoutAlign=\"start center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-title\" translate>title</div>\n    </section>\n    <section class=\"widget-header-right-section\" fxFlex=\"100\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n      <div class=\"widget-action\" fxLayoutAlign=\"end center\" fxLayoutGap=\"1em\">\n        <div\n          class=\"widget-header-action\"\n          *ngFor=\"let headerAction of headerActionList\"\n          fxLayoutAlign=\"start center\"\n          fxLayoutGap=\"0.5em\"\n          (click)=\"headerAction.action($event)\"\n        >\n          <i class=\"material-icons\">{{headerAction.icon}}</i>\n        </div>\n      </div>\n    </section>\n  </header>\n  <section class=\"compare-section\" fxLayoutAlign=\"space-between start\">\n    <div\n      class=\"compare-box\"\n      *ngFor=\"let compare of compareList\"\n      fxLayout=\"column\"\n      fxLayoutAlign=\"start start\"\n      fxLayoutGap=\"0.2em\"\n    >\n      <label class=\"compare-label\" translate>{{compare.label}}</label>\n      <div class=\"compare-value-box\" fxLayoutAlign=\"center center\" fxLayoutGap=\"0.2em\">\n        <span class=\"compare-value\">{{compare.value}}%</span>\n        <span class=\"compare-direction material-icons {{compare.direction}}\">{{compare.icon}}</span>\n      </div>\n    </div>\n  </section>\n  <section class=\"chart-section\">\n    <canvas class=\"chart\"></canvas>\n  </section>\n</div>\n",
        "templateCss": "#widget {\n  width: 100%;\n  height: 100%;\n  font-size: 10px;\n  font-family: var(--tb-config-font-family);\n  user-select: none;\n  white-space: nowrap;\n  letter-spacing: var(--tb-config-letter-spacing);\n}\n\n/*\n  Widget Header Area\n*/\nheader.widget-header {\n  width: 100%;\n  padding: var(--tb-config-padding);\n  border-bottom: 1px solid var(--tb-service-border-1);\n}\n\n.widget-header-right-section .widget-header-action {\n  cursor: pointer;\n  color: var(--tb-service-font-3);\n  transition-property: color;\n  transition-duration: var(--tb-config-color-duration);\n}\n.widget-header-right-section .widget-header-action i {\n  font-size: 2em;\n  font-weight: bold;\n}\n.widget-header-right-section .widget-header-action:hover {\n  color: var(--tb-service-accent-hover);\n}\n.widget-header-right-section .widget-header-action:active {\n  color: var(--tb-service-accent-pressed);\n}\n\n/*\n  Widget Content Area\n*/\n.compare-section {\n  width: 100%;\n  height: 6em;\n  padding: var(--tb-config-padding);\n  padding-bottom: 0px;\n}\n.compare-section .compare-box {\n  height: 100%;\n}\n.compare-section .compare-label {\n  font-size: 1.2em;\n  color: var(--tb-service-font-4);\n}\n.compare-section .compare-value {\n  font-size: 1.6em;\n  font-weight: 600;\n  color: var(--tb-service-font-5);\n}\n.compare-section .compare-direction {\n  display: none;\n  font-size: 1.2em;\n}\n.compare-section .compare-direction.high {\n  display: inline-block;\n  color: var(--tb-service-compare-high);\n}\n.compare-section .compare-direction.low {\n  display: inline-block;\n  color: var(--tb-service-compare-low);\n}\n\n/* chart-section */\n.chart-section {\n  width: 100%;\n  padding: var(--tb-config-padding);\n}\n.chart-section .chart-box {\n  width: 100%;\n  height: 100%;\n}\n",
        "controllerScript": "const HOUR_MS = 60 * 60 * 1000;\nself.onInit = async function () {\n  self.ctx.custom = {};\n  let { custom } = self.ctx;\n  defineVariables();\n  setTitle();\n  createDataset();\n  createChart();\n  self.onResize();\n\n  startUpdate();\n  custom.loadInterval = setInterval(() => {\n    // 매분 00초에 동작\n    if (moment().second() == 0) {\n      startUpdate();\n    }\n  }, 1000);\n};\n\nself.onResize = function () {\n  self.ctx.custom.resizeThrottle();\n};\n\nself.onDestroy = function () {\n  let { custom, $scope, $container } = self.ctx;\n  try {\n    if (custom.loadInterval) {\n      clearInterval(custom.loadInterval);\n    }\n  } catch (e) {\n    log(e);\n  }\n};\n\nself.actionSources = function () {\n  return {\n    widgetHeaderButton: {\n      name: 'Custom Header Button',\n      multiple: true,\n    },\n  };\n};\n\nself.typeParameters = function () {\n  return {\n    maxDatasources: -1,\n    maxDataKeys: -1,\n    dataKeysOptional: true,\n  };\n};\n\n// Define Variables\nfunction defineVariables() {\n  let { custom, $scope, $container } = self.ctx;\n\n  // Define Tags\n  custom.$widget = $('#widget', $container);\n  custom.$widgetHeader = $('.widget-header', $container);\n  custom.$widgetTitle = $('.widget-title', $container);\n  custom.$compareSection = $('.compare-section', $container);\n  custom.$chartSection = $('.chart-section', $container);\n  custom.$chart = $('.chart', $container);\n\n  $scope.comparePercentage = '';\n  $scope.compareDirection = '';\n  $scope.headerActionList = self.ctx.actionsApi.getActionDescriptors('widgetHeaderButton').map(x => {\n    return { name: x.name, icon: x.icon, action: e => handleHeaderAction(x) };\n  });\n\n  // Define Normal Variables\n  custom.resizeThrottle = _.throttle(resize, 200, { trailing: true });\n  custom.ownerDatasource = self.ctx.defaultSubscription.configuredDatasources[0];\n  custom.isSample = custom.ownerDatasource.type == 'function';\n  custom.hiddenDatasources = self.ctx.datasources.filter(x => x.entityAliasId === custom.ownerDatasource.entityAliasId);\n  custom.mainDatasources = self.ctx.datasources.filter(x => x.entityAliasId !== custom.ownerDatasource.entityAliasId);\n  custom.targetKey = self.ctx.defaultSubscription.configuredDatasources[1].dataKeys[0];\n  custom.isInitialize = false;\n  custom.chartLabels = [\n    t('thingplus.time-format.today2'),\n    t('thingplus.time-format.last-day'),\n    t('thingplus.time-format.last-week'),\n    t('thingplus.time-format.last-month'),\n  ];\n  custom.chartData = [0, 0, 0, 0];\n  custom.t = t;\n  const originWidth = self.ctx.settings.widget.originWidth;\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.computedStyle = getComputedStyle($container[0]);\n  custom.units = custom.targetKey.units ? custom.targetKey.units : '';\n  custom.decimals = custom.targetKey.decimals ? custom.targetKey.decimals : '';\n  custom.mainData = [];\n  custom.isUpdated = false;\n}\n\n// Create Widget Title\nfunction setTitle() {\n  let { custom } = self.ctx;\n  custom.$widgetTitle.html(self.ctx.widget.config.title);\n  custom.$widgetTitle.css(self.ctx.widget.config.titleStyle);\n}\n\nasync function startUpdate() {\n  let { custom, $scope } = self.ctx;\n  custom.now = moment().valueOf();\n  custom.startTs = moment(custom.now).subtract(1, 'month').subtract(2, 'days').valueOf();\n  custom.analysisEndTs = moment(custom.now).subtract(1, 'hours').startOf('hours').valueOf();\n  custom.endTs = custom.now;\n\n  if (custom.isSample) return;\n\n  custom.timeline = await drawTimeline();\n  insertData(custom.timeline);\n  custom.chart.update();\n  self.ctx.detectChanges();\n  self.onResize();\n}\n\nasync function drawTimeline() {\n  let initData = await loadInitData();\n  let telemetryData = await loadTelemetryData();\n  let timelineData = createTimeline(initData, telemetryData);\n  return timelineData;\n}\n\nfunction loadInitData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let entityId = custom.mainDatasources[0].entity.id;\n    let keys = ['TP_AnalysisState', 'TP_ModifiedState'];\n    self.ctx.http\n      .get(\n        `/api/plugins/telemetry/${entityId.entityType}/${\n          entityId.id\n        }/values/timeseries?limit=1&agg=NONE&keys=${keys.join(',')}&startTs=0&endTs=${\n          custom.startTs\n        }&useStrictDataTypes=true`\n      )\n      .subscribe(datas => {\n        // 분석 데이터 삭제\n        if (custom.now - custom.startTs < HOUR_MS) {\n          delete datas.TP_AnalysisState;\n        }\n        if (datas.TP_ModifiedState) {\n          let value = datas.TP_ModifiedState[0].value;\n          if (value.endTs < custom.now) {\n            delete datas.TP_ModifiedState;\n          } else {\n            value.startTs = custom.startTs;\n          }\n        }\n        resolve(datas);\n      });\n  });\n}\n\nfunction loadTelemetryData() {\n  return new Promise((resolve, reject) => {\n    let { custom } = self.ctx;\n    let entityId = custom.mainDatasources[0].entity.id;\n    let keys = ['TP_AnalysisState', 'TP_OperationState', 'TP_ConnectionState', 'TP_ModifiedState'];\n    self.ctx.http\n      .get(\n        `/api/plugins/telemetry/${entityId.entityType}/${\n          entityId.id\n        }/values/timeseries?limit=50000&agg=NONE&keys=${keys.join(',')}&startTs=${custom.startTs}&endTs=${\n          custom.endTs\n        }&useStrictDataTypes=true`\n      )\n      .subscribe(datas => {\n        resolve(datas);\n      });\n  });\n}\n\nfunction createTimeline(initData, telemetryData) {\n  let { custom } = self.ctx;\n  let timeline = [];\n\n  // 상태 데이터 병합\n  if (initData.TP_AnalysisState) {\n    timeline.push({ ts: custom.startTs, value: initData.TP_AnalysisState[0].value });\n  }\n  if (telemetryData.TP_AnalysisState) {\n    timeline = timeline.concat(telemetryData.TP_AnalysisState);\n  }\n\n  // 분석 데이터가 없는 경우 통신이상으로 표시\n  if (timeline.length == 0) {\n    timeline.push({ ts: custom.startTs, value: 4 });\n  }\n  for (let i in telemetryData.TP_OperationState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_OperationState[i].ts > custom.analysisEndTs) {\n      telemetryData.TP_OperationState[i].value = OPERATION_MAP[telemetryData.TP_OperationState[i].value];\n      timeline.push(telemetryData.TP_OperationState[i]);\n    }\n  }\n  for (let i in telemetryData.TP_ConnectionState) {\n    // 분석이 완료되는 시점 이후의 데이터는 기본 데이터로 대체 (현 시간 정각의 1시간전)\n    if (telemetryData.TP_ConnectionState[i].ts > custom.analysisEndTs) {\n      if (telemetryData.TP_ConnectionState[i].value == 'false') {\n        timeline.push({ ts: telemetryData.TP_ConnectionState[i].ts, value: 4 });\n      }\n    }\n  }\n  timeline.sort((a, b) => {\n    return a.ts - b.ts;\n  });\n\n  // 수정된 부분 적용\n  let modifiedData = [];\n  if (initData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(initData.TP_ModifiedState);\n  }\n  if (telemetryData.TP_ModifiedState) {\n    modifiedData = modifiedData.concat(telemetryData.TP_ModifiedState);\n  }\n  for (let i in modifiedData) {\n    let targetData = modifiedData[i].value;\n    for (let j = 0; j < timeline.length; j++) {\n      // case 1 : 수정된 데이터가 기존 데이터와 같은 경우\n      if (timeline[j].ts == targetData.startTs && timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        timeline[j].value = targetData.state;\n        if (\n          timeline[j - 1] &&\n          timeline[j - 1].value == targetData.state &&\n          timeline[j + 1] &&\n          timeline[j + 1].value == targetData.state\n        ) {\n          // case 1-1: 이전 값과 다음 값이 수정된 값과 같은 경우 현재 값과 다음 값 삭제\n          timeline.splice(j, 2);\n        } else if (timeline[j - 1] && timeline[j - 1].value == targetData.state) {\n          // case 1-1: 이전 값이 수정된 값과 같은 경우 현재 값 삭제\n          timeline.splice(j, 1);\n        } else if (timeline[j + 1] && timeline[j + 1].value == targetData.state) {\n          // case 1-1: 다음 값이 수정된 값과 같은 경우 다음 값 삭제\n          timeline.splice(j + 1, 1);\n        }\n        break;\n      }\n      // case 2 : 수정된 데이터와 기존 데이터의 시작 시간이 같은 경우\n      else if (timeline[j].ts == targetData.startTs) {\n        timeline[j].ts = targetData.endTs;\n        // 이전 값이 수정된 값과 다른 경우 추가\n        if (!timeline[j - 1] || timeline[j - 1].value != targetData.state) {\n          timeline.splice(j, 0, { ts: targetData.startTs, value: timeline[j].value });\n        }\n        break;\n      }\n      // case 3 : 수정된 데이터와 기존 데이터의 종료 시간이 같은 경우\n      else if (timeline[j + 1] && timeline[j + 1].ts == targetData.endTs) {\n        if (timeline[j + 1].value == targetData.state) {\n          timeline[j + 1].ts = targetData.startTs;\n        } else {\n          timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        }\n        break;\n      }\n      // case 4 : 수정된 데이터가 기존 데이터의 시작 시간과 종료 시간 사이에 있는 경우\n      else if (\n        timeline[j].ts < targetData.startTs &&\n        ((timeline[j + 1] && timeline[j + 1].ts > targetData.endTs) || !timeline[j + 1])\n      ) {\n        timeline.splice(j + 1, 0, { ts: targetData.startTs, value: targetData.state });\n        if (timeline[j + 1]) {\n          timeline.splice(j + 2, 0, { ts: targetData.endTs, value: timeline[j].value });\n        } else {\n          timeline.splice(j + 2, 0, { ts: custom.endTs, value: timeline[j].value });\n        }\n\n        break;\n      }\n    }\n  }\n  timeline.sort((a, b) => {\n    return a.ts - b.ts;\n  });\n\n  let result = [];\n  for (let i = 0; i < timeline.length; i++) {\n    result.push({\n      index: i,\n      startTs: timeline[i].ts,\n      endTs: _.isNil(timeline[i + 1]) ? custom.endTs : timeline[i + 1].ts,\n      value: timeline[i].value,\n    });\n  }\n\n  return result;\n}\n\nfunction resize() {\n  let { custom } = self.ctx;\n  // 위젯 전체 크기 조절\n  let originWidth = self.ctx.settings.widget.originWidth;\n  if (self.ctx.isMobile) {\n    originWidth = 960;\n  }\n  custom.widgetFontSize = _.round((self.ctx.width / originWidth) * 10, 2);\n  if (custom.widgetFontSize < 6.25) {\n    custom.widgetFontSize = 6.25;\n  }\n  custom.$widget.css('font-size', `${custom.widgetFontSize}px`);\n\n  // Header Height를 제외한 영역을 Main의 Height로 설정\n  let headerHeight = custom.$widgetHeader.outerHeight(true);\n  let compareSectionHeight = custom.$compareSection.outerHeight(true);\n  custom.$chartSection.css('height', `calc(100% - ${headerHeight + compareSectionHeight}px)`);\n\n  if (custom.chart) {\n    custom.chart.options.scales.xAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.scales.yAxes[0].ticks.fontSize = custom.widgetFontSize * 1.2;\n    custom.chart.options.tooltips.xPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.yPadding = custom.widgetFontSize;\n    custom.chart.options.tooltips.bodySpacing = custom.widgetFontSize * 0.9;\n    custom.chart.options.tooltips.titleMarginBottom = custom.widgetFontSize;\n    custom.chart.resize();\n  }\n}\n\nfunction createDataset(title, labels) {\n  let { custom } = self.ctx;\n  custom.dataSet = {\n    labels: custom.chartLabels,\n    datasets: [\n      {\n        data: custom.chartData,\n        categoryPercentage: 0.25,\n        fill: true,\n        backgroundColor: [\n          getStyle('--tb-service-accent'),\n          getStyle('--tb-service-compare-bar'),\n          getStyle('--tb-service-compare-bar'),\n          getStyle('--tb-service-compare-bar'),\n        ],\n        hoverBackgroundColor: [\n          tinycolor(getStyle('--tb-service-accent')).darken(),\n          tinycolor(getStyle('--tb-service-compare-bar')).darken(),\n          tinycolor(getStyle('--tb-service-compare-bar')).darken(),\n          tinycolor(getStyle('--tb-service-compare-bar')).darken(),\n        ],\n      },\n    ],\n  };\n}\n\n// 차트생성\nfunction createChart() {\n  let { custom, $scope } = self.ctx;\n  custom.chart = new Chart(custom.$chart, {\n    type: 'horizontalBar',\n    data: custom.dataSet,\n    options: {\n      responsive: true,\n      maintainAspectRatio: false,\n      tooltips: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n        xPadding: custom.widgetFontSize,\n        yPadding: custom.widgetFontSize,\n        bodySpacing: custom.widgetFontSize * 0.9,\n        callbacks: {\n          title: function (tooltipItem, data) {\n            let date = moment();\n            if (tooltipItem[0].index == 0) {\n              date = moment();\n            }\n            if (tooltipItem[0].index == 1) {\n              date = moment().subtract(1, 'days');\n              if (moment().isoWeekday() == 1) {\n                date = moment().subtract(3, 'days');\n              }\n            }\n            if (tooltipItem[0].index == 2) {\n              date = moment().subtract(1, 'weeks');\n            }\n            if (tooltipItem[0].index == 3) {\n              date = moment().subtract(1, 'months');\n              if (date.isoWeekday() == 6) {\n                date = date.subtract(1, 'days');\n              }\n              if (date.isoWeekday() == 7) {\n                date = date.subtract(2, 'days');\n              }\n            }\n            return moment(date).format('YYYY-MM-DD');\n          },\n          label: function (tooltipItem, data) {\n            let label = data.datasets[tooltipItem.datasetIndex].label || '';\n            if (label) {\n              label += ': ';\n            }\n            label += _.round(tooltipItem.xLabel, custom.decimals) + ' ' + custom.units;\n\n            return label;\n          },\n        },\n      },\n      hover: {\n        mode: 'index',\n        axis: 'y',\n        intersect: false,\n      },\n      legend: {\n        display: false,\n      },\n      scales: {\n        xAxes: [\n          {\n            display: true,\n            ticks: {\n              suggestedMax: 1,\n              min: 0,\n              maxTicksLimit: 4,\n              fontColor: getStyle('--tb-service-font-2'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n            },\n            gridLines: {\n              display: false,\n              color: getStyle('--tb-service-border-1'),\n              zeroLineColor: getStyle('--tb-service-border-1'),\n            },\n          },\n        ],\n        yAxes: [\n          {\n            display: true,\n            type: 'category',\n            ticks: {\n              fontColor: getStyle('--tb-service-font-4'),\n              fontFamily: getStyle('--tb-config-font-family'),\n              fontSize: custom.widgetFontSize * 1.2,\n            },\n          },\n        ],\n      },\n    },\n  });\n}\n\nfunction insertData(timeline) {\n  let { custom, $scope } = self.ctx;\n  custom.accDatas = [0, 0, 0, 0];\n  let prevMonthStart = moment().subtract(1, 'months').startOf('day').valueOf();\n  let prevMonthEnd = moment().subtract(1, 'months').valueOf();\n  let prevWeekStart = moment().subtract(1, 'weeks').startOf('day').valueOf();\n  let prevWeekEnd = moment().subtract(1, 'weeks').valueOf();\n  let prevDayStart = moment().subtract(1, 'days').startOf('day').valueOf();\n  let prevDayEnd = moment().subtract(1, 'days').valueOf();\n  let currDayStart = moment().startOf('day').valueOf();\n  let currDayEnd = moment().valueOf();\n\n  if (moment(prevMonthStart).isoWeekday() == 7) {\n    prevMonthStart = moment(prevMonthStart).subtract(2, 'days').valueOf();\n    prevMonthEnd = moment(prevMonthEnd).subtract(2, 'days').valueOf();\n  }\n  if (moment(prevMonthStart).isoWeekday() == 6) {\n    prevMonthStart = moment(prevMonthStart).subtract(1, 'days').valueOf();\n    prevMonthEnd = moment(prevMonthEnd).subtract(1, 'days').valueOf();\n  }\n\n  let range = [\n    [currDayStart, currDayEnd],\n    [prevDayStart, prevDayEnd],\n    [prevWeekStart, prevWeekEnd],\n    [prevMonthStart, prevMonthEnd],\n  ];\n\n  for (let i in range) {\n    for (let j in timeline) {\n      if (timeline[j].value == 2 || timeline[j].value == 3) {\n        // case 1 : 포함되는 경우\n        if (timeline[j].startTs >= range[i][0] && timeline[j].endTs <= range[i][1]) {\n          custom.accDatas[i] += timeline[j].endTs - timeline[j].startTs;\n        }\n        // case 2 : 앞쪽이 포함되는 경우\n        else if (\n          timeline[j].startTs >= range[i][0] &&\n          timeline[j].startTs < range[i][1] &&\n          timeline[j].endTs > range[i][1]\n        ) {\n          custom.accDatas[i] += range[i][1] - timeline[j].startTs;\n        }\n        // case 3 : 뒤쪽이 포함되는 경우\n        else if (\n          timeline[j].startTs < range[i][0] &&\n          timeline[j].endTs > range[i][0] &&\n          timeline[j].endTs <= range[i][1]\n        ) {\n          custom.accDatas[i] += timeline[j].endTs - range[i][0];\n        }\n        // case 4 : 역으로 포함되는 경우\n        else if (timeline[j].startTs < range[i][0] && timeline[j].endTs > range[i][1]) {\n          custom.accDatas[i] += range[i][1] - range[i][0];\n        }\n      }\n    }\n  }\n\n  if (custom.targetKey.postFuncBody) {\n    let dataFunction = new Function('value', custom.targetKey.postFuncBody);\n    for (let i in custom.accDatas) {\n      custom.accDatas[i] = dataFunction(custom.accDatas[i]);\n      let decimals = custom.targetKey.decimals;\n      if (decimals && !isNaN(Number(custom.accDatas[i]))) {\n        custom.accDatas[i] = _.round(custom.accDatas[i], decimals);\n      }\n    }\n  }\n\n  for (let i in custom.accDatas) {\n    custom.chartData[i] = custom.accDatas[i];\n  }\n\n  let dayDiff = custom.accDatas[0] - custom.accDatas[1];\n  let weekDiff = custom.accDatas[0] - custom.accDatas[2];\n  let monthDiff = custom.accDatas[0] - custom.accDatas[3];\n\n  $scope.compareList = [\n    {\n      label: 'thingplus.energy.compare-last-day',\n      value: custom.accDatas[1] > 0 ? _.round(Math.abs(dayDiff / custom.accDatas[1]) * 100) : 0,\n      direction: dayDiff > 0 ? 'high' : dayDiff < 0 ? 'low' : '',\n      icon: dayDiff > 0 ? 'arrow_upward' : dayDiff < 0 ? 'arrow_downward' : '',\n    },\n    {\n      label: 'thingplus.energy.compare-last-week',\n      value: custom.accDatas[2] > 0 ? _.round(Math.abs(weekDiff / custom.accDatas[2]) * 100) : 0,\n      direction: weekDiff > 0 ? 'high' : weekDiff < 0 ? 'low' : '',\n      icon: weekDiff > 0 ? 'arrow_upward' : weekDiff < 0 ? 'arrow_downward' : '',\n    },\n    {\n      label: 'thingplus.energy.compare-last-month',\n      value: custom.accDatas[3] > 0 ? _.round(Math.abs(monthDiff / custom.accDatas[3]) * 100) : 0,\n      direction: monthDiff > 0 ? 'high' : monthDiff < 0 ? 'low' : '',\n      icon: monthDiff > 0 ? 'arrow_upward' : monthDiff < 0 ? 'arrow_downward' : '',\n    },\n  ];\n}\n\nfunction getStyle(target) {\n  let { custom } = self.ctx;\n  return custom.computedStyle.getPropertyValue(target);\n}\n\nfunction t(key, data) {\n  let defaultKey = key;\n  if (typeof key === 'string') {\n    let keyArr = key.split('.');\n    defaultKey = keyArr[keyArr.length - 1];\n  }\n  let result = self.ctx.translate.instant(key, data);\n  if (result == key) {\n    return defaultKey;\n  }\n  return result;\n}\n\nfunction log() {\n  console.log(t(self.ctx.widget.config.title) + '\\r\\n', ...arguments);\n}\n\nfunction handleHeaderAction(descriptor) {\n  let { custom } = self.ctx;\n  self.ctx.actionsApi.handleWidgetAction(\n    {},\n    descriptor,\n    custom.mainDatasources[0].entity.id,\n    custom.mainDatasources[0].entityName,\n    {},\n    custom.mainDatasources[0].entityLabel\n  );\n}\n",
        "settingsSchema": "{\n  \"schema\": {\n    \"title\": \"Settings\",\n    \"type\": \"object\",\n    \"properties\": {\n      \"widget\": {\n        \"type\": \"object\",\n        \"required\": [\"originWidth\"],\n        \"properties\": {\n          \"originWidth\": {\n            \"title\": \"Origin Widget Width\",\n            \"type\": \"number\",\n            \"default\": 1630\n          }\n        }\n      }\n    }\n  },\n  \"form\": [[\"widget.originWidth\"]],\n  \"groupInfoes\": [\n    {\n      \"formIndex\": 0,\n      \"GroupTitle\": \"Widget\"\n    }\n  ]\n}\n",
        "dataKeySettingsSchema": "{}\n",
        "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]},{\"type\":\"function\",\"name\":\"function\",\"entityAliasId\":null,\"filterId\":null,\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Sin\",\"color\":\"#4caf50\",\"settings\":{},\"_hash\":0.49036244891566994,\"funcBody\":\"return Math.random() * 100\",\"units\":null,\"decimals\":null,\"usePostProcessing\":null,\"postFuncBody\":null}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"0px\",\"settings\":{\"widget\":{\"originWidth\":1630}},\"title\":\"Time Compare Chart\",\"showTitleIcon\":false,\"titleTooltip\":\"\",\"dropShadow\":false,\"enableFullscreen\":false,\"widgetStyle\":{\"cursor\":\"default\",\"box-shadow\":\"0px 2px 10px 0 rgba(0, 0, 0, 0.04)\"},\"titleStyle\":{\"font-family\":\"var(--tb-config-font-family)\",\"font-size\":\"1.6em\",\"font-weight\":500,\"letter-spacing\":\"var(--tb-config-letter-spacing)\",\"color\":\"var(--tb-service-font-5)\"},\"noDataDisplayMessage\":\"\",\"showLegend\":false}"
      }
    }
  ]
}